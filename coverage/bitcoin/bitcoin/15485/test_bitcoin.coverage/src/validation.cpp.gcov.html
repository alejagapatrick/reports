<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - test_bitcoin_coverage.info - src/validation.cpp</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">src</a> - validation.cpp<span style="font-size: 80%;"> (source / <a href="validation.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">test_bitcoin_coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1206</td>
            <td class="headerCovTableEntry">2202</td>
            <td class="headerCovTableEntryLo">54.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2000-01-01 12:00:00</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">96</td>
            <td class="headerCovTableEntry">139</td>
            <td class="headerCovTableEntryLo">69.1 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">1017</td>
            <td class="headerCovTableEntry">3270</td>
            <td class="headerCovTableEntryLo">31.1 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : // Copyright (c) 2009-2010 Satoshi Nakamoto</a>
<span class="lineNum">       2 </span>                :            : // Copyright (c) 2009-2018 The Bitcoin Core developers
<span class="lineNum">       3 </span>                :            : // Distributed under the MIT software license, see the accompanying
<span class="lineNum">       4 </span>                :            : // file COPYING or http://www.opensource.org/licenses/mit-license.php.
<span class="lineNum">       5 </span>                :            : 
<span class="lineNum">       6 </span>                :            : #include &lt;validation.h&gt;
<span class="lineNum">       7 </span>                :            : 
<span class="lineNum">       8 </span>                :            : #include &lt;arith_uint256.h&gt;
<span class="lineNum">       9 </span>                :            : #include &lt;chain.h&gt;
<span class="lineNum">      10 </span>                :            : #include &lt;chainparams.h&gt;
<span class="lineNum">      11 </span>                :            : #include &lt;checkpoints.h&gt;
<span class="lineNum">      12 </span>                :            : #include &lt;checkqueue.h&gt;
<span class="lineNum">      13 </span>                :            : #include &lt;consensus/consensus.h&gt;
<span class="lineNum">      14 </span>                :            : #include &lt;consensus/merkle.h&gt;
<span class="lineNum">      15 </span>                :            : #include &lt;consensus/tx_verify.h&gt;
<span class="lineNum">      16 </span>                :            : #include &lt;consensus/validation.h&gt;
<span class="lineNum">      17 </span>                :            : #include &lt;cuckoocache.h&gt;
<span class="lineNum">      18 </span>                :            : #include &lt;hash.h&gt;
<span class="lineNum">      19 </span>                :            : #include &lt;index/txindex.h&gt;
<span class="lineNum">      20 </span>                :            : #include &lt;policy/fees.h&gt;
<span class="lineNum">      21 </span>                :            : #include &lt;policy/policy.h&gt;
<span class="lineNum">      22 </span>                :            : #include &lt;policy/rbf.h&gt;
<span class="lineNum">      23 </span>                :            : #include &lt;pow.h&gt;
<span class="lineNum">      24 </span>                :            : #include &lt;primitives/block.h&gt;
<span class="lineNum">      25 </span>                :            : #include &lt;primitives/transaction.h&gt;
<span class="lineNum">      26 </span>                :            : #include &lt;random.h&gt;
<span class="lineNum">      27 </span>                :            : #include &lt;reverse_iterator.h&gt;
<span class="lineNum">      28 </span>                :            : #include &lt;script/script.h&gt;
<span class="lineNum">      29 </span>                :            : #include &lt;script/sigcache.h&gt;
<span class="lineNum">      30 </span>                :            : #include &lt;script/standard.h&gt;
<span class="lineNum">      31 </span>                :            : #include &lt;shutdown.h&gt;
<span class="lineNum">      32 </span>                :            : #include &lt;timedata.h&gt;
<span class="lineNum">      33 </span>                :            : #include &lt;tinyformat.h&gt;
<span class="lineNum">      34 </span>                :            : #include &lt;txdb.h&gt;
<span class="lineNum">      35 </span>                :            : #include &lt;txmempool.h&gt;
<span class="lineNum">      36 </span>                :            : #include &lt;ui_interface.h&gt;
<span class="lineNum">      37 </span>                :            : #include &lt;undo.h&gt;
<span class="lineNum">      38 </span>                :            : #include &lt;util/system.h&gt;
<span class="lineNum">      39 </span>                :            : #include &lt;util/moneystr.h&gt;
<span class="lineNum">      40 </span>                :            : #include &lt;util/strencodings.h&gt;
<span class="lineNum">      41 </span>                :            : #include &lt;validationinterface.h&gt;
<span class="lineNum">      42 </span>                :            : #include &lt;warnings.h&gt;
<span class="lineNum">      43 </span>                :            : 
<span class="lineNum">      44 </span>                :            : #include &lt;future&gt;
<span class="lineNum">      45 </span>                :            : #include &lt;sstream&gt;
<span class="lineNum">      46 </span>                :            : 
<span class="lineNum">      47 </span>                :            : #include &lt;boost/algorithm/string/replace.hpp&gt;
<span class="lineNum">      48 </span>                :            : #include &lt;boost/thread.hpp&gt;
<span class="lineNum">      49 </span>                :            : 
<span class="lineNum">      50 </span>                :            : #if defined(NDEBUG)
<span class="lineNum">      51 </span>                :            : # error &quot;Bitcoin cannot be compiled without assertions.&quot;
<span class="lineNum">      52 </span>                :            : #endif
<span class="lineNum">      53 </span>                :            : 
<span class="lineNum">      54 </span>                :            : #define MICRO 0.000001
<span class="lineNum">      55 </span>                :            : #define MILLI 0.001
<span class="lineNum">      56 </span>                :            : 
<span class="lineNum">      57 </span>                :            : /**
<span class="lineNum">      58 </span>                :            :  * Global state
<span class="lineNum">      59 </span>                :            :  */
<span class="lineNum">      60 </span>                :            : namespace {
<a name="61"><span class="lineNum">      61 </span>                :            :     struct CBlockIndexWorkComparator</a>
<span class="lineNum">      62 </span>                :            :     {
<span class="lineNum">      63 </span>                :<span class="lineCov">     612631 :         bool operator()(const CBlockIndex *pa, const CBlockIndex *pb) const {</span>
<span class="lineNum">      64 </span>                :            :             // First sort by most total work, ...
<span class="lineNum">      65 </span>        [<span class="branchCov" title="Branch 0 was taken 407555 times"> + </span><span class="branchCov" title="Branch 1 was taken 205076 times"> + </span>]:<span class="lineCov">     612631 :             if (pa-&gt;nChainWork &gt; pb-&gt;nChainWork) return false;</span>
<span class="lineNum">      66 </span>        [<span class="branchCov" title="Branch 0 was taken 15765 times"> + </span><span class="branchCov" title="Branch 1 was taken 391790 times"> + </span>]:<span class="lineCov">     407555 :             if (pa-&gt;nChainWork &lt; pb-&gt;nChainWork) return true;</span>
<span class="lineNum">      67 </span>                :            : 
<span class="lineNum">      68 </span>                :            :             // ... then by earliest time received, ...
<span class="lineNum">      69 </span>        [<span class="branchCov" title="Branch 0 was taken 15737 times"> + </span><span class="branchCov" title="Branch 1 was taken 28 times"> + </span>]:<span class="lineCov">      15765 :             if (pa-&gt;nSequenceId &lt; pb-&gt;nSequenceId) return false;</span>
<span class="lineNum">      70 </span>        [<span class="branchCov" title="Branch 0 was taken 15631 times"> + </span><span class="branchCov" title="Branch 1 was taken 106 times"> + </span>]:<span class="lineCov">      15737 :             if (pa-&gt;nSequenceId &gt; pb-&gt;nSequenceId) return true;</span>
<span class="lineNum">      71 </span>                :            : 
<span class="lineNum">      72 </span>                :            :             // Use pointer address as tie breaker (should only happen with blocks
<span class="lineNum">      73 </span>                :            :             // loaded from disk, as those all have id 0).
<span class="lineNum">      74 </span>        [<span class="branchCov" title="Branch 0 was taken 15631 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      15631 :             if (pa &lt; pb) return false;</span>
<span class="lineNum">      75 </span>        [<span class="branchCov" title="Branch 0 was taken 15631 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      15631 :             if (pa &gt; pb) return true;</span>
<span class="lineNum">      76 </span>                :            : 
<span class="lineNum">      77 </span>                :            :             // Identical blocks.
<span class="lineNum">      78 </span>                :<span class="lineCov">      15631 :             return false;</span>
<span class="lineNum">      79 </span>                :            :         }
<span class="lineNum">      80 </span>                :            :     };
<span class="lineNum">      81 </span>                :            : } // anon namespace
<span class="lineNum">      82 </span>                :            : 
<span class="lineNum">      83 </span>                :            : enum DisconnectResult
<span class="lineNum">      84 </span>                :            : {
<span class="lineNum">      85 </span>                :            :     DISCONNECT_OK,      // All good.
<span class="lineNum">      86 </span>                :            :     DISCONNECT_UNCLEAN, // Rolled back, but UTXO set was inconsistent with block.
<span class="lineNum">      87 </span>                :            :     DISCONNECT_FAILED   // Something else went wrong.
<span class="lineNum">      88 </span>                :            : };
<span class="lineNum">      89 </span>                :            : 
<span class="lineNum">      90 </span>                :            : class ConnectTrace;
<span class="lineNum">      91 </span>                :            : 
<span class="lineNum">      92 </span>                :            : /**
<span class="lineNum">      93 </span>                :            :  * CChainState stores and provides an API to update our local knowledge of the
<span class="lineNum">      94 </span>                :            :  * current best chain and header tree.
<span class="lineNum">      95 </span>                :            :  *
<span class="lineNum">      96 </span>                :            :  * It generally provides access to the current block tree, as well as functions
<span class="lineNum">      97 </span>                :            :  * to provide new data, which it will appropriately validate and incorporate in
<span class="lineNum">      98 </span>                :            :  * its state as necessary.
<span class="lineNum">      99 </span>                :            :  *
<span class="lineNum">     100 </span>                :            :  * Eventually, the API here is targeted at being exposed externally as a
<span class="lineNum">     101 </span>                :            :  * consumable libconsensus library, so any functions added must only call
<span class="lineNum">     102 </span>                :            :  * other class member functions, pure functions in other parts of the consensus
<span class="lineNum">     103 </span>                :            :  * library, callbacks via the validation interface, or read/write-to-disk
<a name="104"><span class="lineNum">     104 </span>                :            :  * functions (eventually this will also be via callbacks).</a>
<span class="lineNum">     105 </span>                :            :  */
<span class="lineNum">     106 </span>                :<span class="lineCov">        146 : class CChainState {</span>
<span class="lineNum">     107 </span>                :            : private:
<span class="lineNum">     108 </span>                :            :     /**
<span class="lineNum">     109 </span>                :            :      * The set of all CBlockIndex entries with BLOCK_VALID_TRANSACTIONS (for itself and all ancestors) and
<span class="lineNum">     110 </span>                :            :      * as good as our current tip or better. Entries may be failed, though, and pruning nodes may be
<span class="lineNum">     111 </span>                :            :      * missing the data for the block.
<span class="lineNum">     112 </span>                :            :      */
<span class="lineNum">     113 </span>                :            :     std::set&lt;CBlockIndex*, CBlockIndexWorkComparator&gt; setBlockIndexCandidates;
<span class="lineNum">     114 </span>                :            : 
<span class="lineNum">     115 </span>                :            :     /**
<span class="lineNum">     116 </span>                :            :      * Every received block is assigned a unique and increasing identifier, so we
<span class="lineNum">     117 </span>                :            :      * know which one to give priority in case of a fork.
<span class="lineNum">     118 </span>                :            :      */
<span class="lineNum">     119 </span>                :            :     CCriticalSection cs_nBlockSequenceId;
<span class="lineNum">     120 </span>                :            :     /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */
<span class="lineNum">     121 </span>                :            :     int32_t nBlockSequenceId = 1;
<span class="lineNum">     122 </span>                :            :     /** Decreasing counter (used by subsequent preciousblock calls). */
<span class="lineNum">     123 </span>                :            :     int32_t nBlockReverseSequenceId = -1;
<span class="lineNum">     124 </span>                :            :     /** chainwork for the last block that preciousblock has been applied to. */
<span class="lineNum">     125 </span>                :            :     arith_uint256 nLastPreciousChainwork = 0;
<span class="lineNum">     126 </span>                :            : 
<span class="lineNum">     127 </span>                :            :     /** In order to efficiently track invalidity of headers, we keep the set of
<span class="lineNum">     128 </span>                :            :       * blocks which we tried to connect and found to be invalid here (ie which
<span class="lineNum">     129 </span>                :            :       * were set to BLOCK_FAILED_VALID since the last restart). We can then
<span class="lineNum">     130 </span>                :            :       * walk this set and check if a new header is a descendant of something in
<span class="lineNum">     131 </span>                :            :       * this set, preventing us from having to walk mapBlockIndex when we try
<span class="lineNum">     132 </span>                :            :       * to connect a bad block and fail.
<span class="lineNum">     133 </span>                :            :       *
<span class="lineNum">     134 </span>                :            :       * While this is more complicated than marking everything which descends
<span class="lineNum">     135 </span>                :            :       * from an invalid block as invalid at the time we discover it to be
<span class="lineNum">     136 </span>                :            :       * invalid, doing so would require walking all of mapBlockIndex to find all
<span class="lineNum">     137 </span>                :            :       * descendants. Since this case should be very rare, keeping track of all
<span class="lineNum">     138 </span>                :            :       * BLOCK_FAILED_VALID blocks in a set should be just fine and work just as
<span class="lineNum">     139 </span>                :            :       * well.
<span class="lineNum">     140 </span>                :            :       *
<span class="lineNum">     141 </span>                :            :       * Because we already walk mapBlockIndex in height-order at startup, we go
<span class="lineNum">     142 </span>                :            :       * ahead and mark descendants of invalid blocks as FAILED_CHILD at that time,
<span class="lineNum">     143 </span>                :            :       * instead of putting things in this set.
<span class="lineNum">     144 </span>                :            :       */
<span class="lineNum">     145 </span>                :            :     std::set&lt;CBlockIndex*&gt; m_failed_blocks;
<span class="lineNum">     146 </span>                :            : 
<span class="lineNum">     147 </span>                :            :     /**
<span class="lineNum">     148 </span>                :            :      * the ChainState CriticalSection
<span class="lineNum">     149 </span>                :            :      * A lock that must be held when modifying this ChainState - held in ActivateBestChain()
<span class="lineNum">     150 </span>                :            :      */
<span class="lineNum">     151 </span>                :            :     CCriticalSection m_cs_chainstate;
<span class="lineNum">     152 </span>                :            : 
<span class="lineNum">     153 </span>                :            : public:
<span class="lineNum">     154 </span>                :            :     CChain chainActive;
<span class="lineNum">     155 </span>                :            :     BlockMap mapBlockIndex GUARDED_BY(cs_main);
<span class="lineNum">     156 </span>                :            :     std::multimap&lt;CBlockIndex*, CBlockIndex*&gt; mapBlocksUnlinked;
<span class="lineNum">     157 </span>                :            :     CBlockIndex *pindexBestInvalid = nullptr;
<span class="lineNum">     158 </span>                :            : 
<span class="lineNum">     159 </span>                :            :     bool LoadBlockIndex(const Consensus::Params&amp; consensus_params, CBlockTreeDB&amp; blocktree) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     160 </span>                :            : 
<span class="lineNum">     161 </span>                :            :     bool ActivateBestChain(CValidationState &amp;state, const CChainParams&amp; chainparams, std::shared_ptr&lt;const CBlock&gt; pblock);
<span class="lineNum">     162 </span>                :            : 
<span class="lineNum">     163 </span>                :            :     /**
<span class="lineNum">     164 </span>                :            :      * If a block header hasn't already been seen, call CheckBlockHeader on it, ensure
<span class="lineNum">     165 </span>                :            :      * that it doesn't descend from an invalid block, and then add it to mapBlockIndex.
<span class="lineNum">     166 </span>                :            :      */
<span class="lineNum">     167 </span>                :            :     bool AcceptBlockHeader(const CBlockHeader&amp; block, CValidationState&amp; state, const CChainParams&amp; chainparams, CBlockIndex** ppindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     168 </span>                :            :     bool AcceptBlock(const std::shared_ptr&lt;const CBlock&gt;&amp; pblock, CValidationState&amp; state, const CChainParams&amp; chainparams, CBlockIndex** ppindex, bool fRequested, const CDiskBlockPos* dbp, bool* fNewBlock) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     169 </span>                :            : 
<span class="lineNum">     170 </span>                :            :     // Block (dis)connection on a given view:
<span class="lineNum">     171 </span>                :            :     DisconnectResult DisconnectBlock(const CBlock&amp; block, const CBlockIndex* pindex, CCoinsViewCache&amp; view);
<span class="lineNum">     172 </span>                :            :     bool ConnectBlock(const CBlock&amp; block, CValidationState&amp; state, CBlockIndex* pindex,
<span class="lineNum">     173 </span>                :            :                       CCoinsViewCache&amp; view, const CChainParams&amp; chainparams, bool fJustCheck = false) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     174 </span>                :            : 
<span class="lineNum">     175 </span>                :            :     // Block disconnection on our pcoinsTip:
<span class="lineNum">     176 </span>                :            :     bool DisconnectTip(CValidationState&amp; state, const CChainParams&amp; chainparams, DisconnectedBlockTransactions* disconnectpool) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     177 </span>                :            : 
<span class="lineNum">     178 </span>                :            :     // Manual block validity manipulation:
<span class="lineNum">     179 </span>                :            :     bool PreciousBlock(CValidationState&amp; state, const CChainParams&amp; params, CBlockIndex* pindex) LOCKS_EXCLUDED(cs_main);
<span class="lineNum">     180 </span>                :            :     bool InvalidateBlock(CValidationState&amp; state, const CChainParams&amp; chainparams, CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     181 </span>                :            :     void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     182 </span>                :            : 
<span class="lineNum">     183 </span>                :            :     bool ReplayBlocks(const CChainParams&amp; params, CCoinsView* view);
<span class="lineNum">     184 </span>                :            :     bool RewindBlockIndex(const CChainParams&amp; params);
<span class="lineNum">     185 </span>                :            :     bool LoadGenesisBlock(const CChainParams&amp; chainparams);
<span class="lineNum">     186 </span>                :            : 
<span class="lineNum">     187 </span>                :            :     void PruneBlockIndexCandidates();
<span class="lineNum">     188 </span>                :            : 
<span class="lineNum">     189 </span>                :            :     void UnloadBlockIndex();
<span class="lineNum">     190 </span>                :            : 
<span class="lineNum">     191 </span>                :            : private:
<span class="lineNum">     192 </span>                :            :     bool ActivateBestChainStep(CValidationState&amp; state, const CChainParams&amp; chainparams, CBlockIndex* pindexMostWork, const std::shared_ptr&lt;const CBlock&gt;&amp; pblock, bool&amp; fInvalidFound, ConnectTrace&amp; connectTrace) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     193 </span>                :            :     bool ConnectTip(CValidationState&amp; state, const CChainParams&amp; chainparams, CBlockIndex* pindexNew, const std::shared_ptr&lt;const CBlock&gt;&amp; pblock, ConnectTrace&amp; connectTrace, DisconnectedBlockTransactions &amp;disconnectpool) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     194 </span>                :            : 
<span class="lineNum">     195 </span>                :            :     CBlockIndex* AddToBlockIndex(const CBlockHeader&amp; block) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     196 </span>                :            :     /** Create a new block index entry for a given block hash */
<span class="lineNum">     197 </span>                :            :     CBlockIndex* InsertBlockIndex(const uint256&amp; hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     198 </span>                :            :     /**
<span class="lineNum">     199 </span>                :            :      * Make various assertions about the state of the block index.
<span class="lineNum">     200 </span>                :            :      *
<span class="lineNum">     201 </span>                :            :      * By default this only executes fully when using the Regtest chain; see: fCheckBlockIndex.
<span class="lineNum">     202 </span>                :            :      */
<span class="lineNum">     203 </span>                :            :     void CheckBlockIndex(const Consensus::Params&amp; consensusParams);
<span class="lineNum">     204 </span>                :            : 
<span class="lineNum">     205 </span>                :            :     void InvalidBlockFound(CBlockIndex *pindex, const CValidationState &amp;state) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     206 </span>                :            :     CBlockIndex* FindMostWorkChain() EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     207 </span>                :            :     void ReceivedBlockTransactions(const CBlock&amp; block, CBlockIndex* pindexNew, const CDiskBlockPos&amp; pos, const Consensus::Params&amp; consensusParams) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     208 </span>                :            : 
<span class="lineNum">     209 </span>                :            : 
<span class="lineNum">     210 </span>                :            :     bool RollforwardBlock(const CBlockIndex* pindex, CCoinsViewCache&amp; inputs, const CChainParams&amp; params) EXCLUSIVE_LOCKS_REQUIRED(cs_main);
<span class="lineNum">     211 </span>                :<span class="lineCov">         73 : } g_chainstate;</span>
<span class="lineNum">     212 </span>                :            : 
<span class="lineNum">     213 </span>                :            : /**
<span class="lineNum">     214 </span>                :            :  * Mutex to guard access to validation specific variables, such as reading
<span class="lineNum">     215 </span>                :            :  * or changing the chainstate.
<span class="lineNum">     216 </span>                :            :  *
<span class="lineNum">     217 </span>                :            :  * This may also need to be locked when updating the transaction pool, e.g. on
<span class="lineNum">     218 </span>                :            :  * AcceptToMemoryPool. See CTxMemPool::cs comment for details.
<span class="lineNum">     219 </span>                :            :  *
<span class="lineNum">     220 </span>                :            :  * The transaction pool has a separate lock to allow reading from it and the
<span class="lineNum">     221 </span>                :            :  * chainstate at the same time.
<span class="lineNum">     222 </span>                :            :  */
<span class="lineNum">     223 </span>                :<span class="lineCov">         73 : RecursiveMutex cs_main;</span>
<span class="lineNum">     224 </span>                :            : 
<span class="lineNum">     225 </span>                :            : BlockMap&amp; mapBlockIndex = g_chainstate.mapBlockIndex;
<span class="lineNum">     226 </span>                :            : CChain&amp; chainActive = g_chainstate.chainActive;
<span class="lineNum">     227 </span>                :            : CBlockIndex *pindexBestHeader = nullptr;
<span class="lineNum">     228 </span>                :<span class="lineCov">         73 : Mutex g_best_block_mutex;</span>
<span class="lineNum">     229 </span>                :<span class="lineCov">         73 : std::condition_variable g_best_block_cv;</span>
<span class="lineNum">     230 </span>                :<span class="lineCov">         73 : uint256 g_best_block;</span>
<span class="lineNum">     231 </span>                :            : int nScriptCheckThreads = 0;
<span class="lineNum">     232 </span>                :            : std::atomic_bool fImporting(false);
<span class="lineNum">     233 </span>                :            : std::atomic_bool fReindex(false);
<span class="lineNum">     234 </span>                :            : bool fHavePruned = false;
<span class="lineNum">     235 </span>                :            : bool fPruneMode = false;
<span class="lineNum">     236 </span>                :            : bool fIsBareMultisigStd = DEFAULT_PERMIT_BAREMULTISIG;
<span class="lineNum">     237 </span>                :            : bool fRequireStandard = true;
<span class="lineNum">     238 </span>                :            : bool fCheckBlockIndex = false;
<span class="lineNum">     239 </span>                :            : bool fCheckpointsEnabled = DEFAULT_CHECKPOINTS_ENABLED;
<span class="lineNum">     240 </span>                :            : size_t nCoinCacheUsage = 5000 * 300;
<span class="lineNum">     241 </span>                :            : uint64_t nPruneTarget = 0;
<span class="lineNum">     242 </span>                :            : int64_t nMaxTipAge = DEFAULT_MAX_TIP_AGE;
<span class="lineNum">     243 </span>                :            : bool fEnableReplacement = DEFAULT_ENABLE_REPLACEMENT;
<span class="lineNum">     244 </span>                :            : 
<span class="lineNum">     245 </span>                :<span class="lineCov">         73 : uint256 hashAssumeValid;</span>
<span class="lineNum">     246 </span>                :<span class="lineCov">         73 : arith_uint256 nMinimumChainWork;</span>
<span class="lineNum">     247 </span>                :            : 
<span class="lineNum">     248 </span>                :<span class="lineCov">         73 : CFeeRate minRelayTxFee = CFeeRate(DEFAULT_MIN_RELAY_TX_FEE);</span>
<span class="lineNum">     249 </span>                :            : CAmount maxTxFee = DEFAULT_TRANSACTION_MAXFEE;
<span class="lineNum">     250 </span>                :            : 
<span class="lineNum">     251 </span>                :<span class="lineCov">         73 : CBlockPolicyEstimator feeEstimator;</span>
<span class="lineNum">     252 </span>                :<span class="lineCov">         73 : CTxMemPool mempool(&amp;feeEstimator);</span>
<span class="lineNum">     253 </span>                :            : std::atomic_bool g_is_mempool_loaded{false};
<span class="lineNum">     254 </span>                :            : 
<span class="lineNum">     255 </span>                :            : /** Constant stuff for coinbase transactions we create: */
<span class="lineNum">     256 </span>                :<span class="lineCov">         73 : CScript COINBASE_FLAGS;</span>
<span class="lineNum">     257 </span>                :            : 
<span class="lineNum">     258 </span>                :<span class="lineCov">         73 : const std::string strMessageMagic = &quot;Bitcoin Signed Message:\n&quot;;</span>
<span class="lineNum">     259 </span>                :            : 
<span class="lineNum">     260 </span>                :            : // Internal stuff
<span class="lineNum">     261 </span>                :            : namespace {
<span class="lineNum">     262 </span>                :            :     CBlockIndex *&amp;pindexBestInvalid = g_chainstate.pindexBestInvalid;
<span class="lineNum">     263 </span>                :            : 
<span class="lineNum">     264 </span>                :            :     /** All pairs A-&gt;B, where A (or one of its ancestors) misses transactions, but B has transactions.
<span class="lineNum">     265 </span>                :            :      * Pruned nodes may have entries where B is missing data.
<span class="lineNum">     266 </span>                :            :      */
<span class="lineNum">     267 </span>                :            :     std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;&amp; mapBlocksUnlinked = g_chainstate.mapBlocksUnlinked;
<span class="lineNum">     268 </span>                :            : 
<span class="lineNum">     269 </span>                :<span class="lineCov">         73 :     CCriticalSection cs_LastBlockFile;</span>
<span class="lineNum">     270 </span>                :<span class="lineCov">         73 :     std::vector&lt;CBlockFileInfo&gt; vinfoBlockFile;</span>
<span class="lineNum">     271 </span>                :            :     int nLastBlockFile = 0;
<span class="lineNum">     272 </span>                :            :     /** Global flag to indicate we should check to see if there are
<span class="lineNum">     273 </span>                :            :      *  block/undo files that should be deleted.  Set on startup
<span class="lineNum">     274 </span>                :            :      *  or if we allocate more file space when we're in prune mode
<span class="lineNum">     275 </span>                :            :      */
<span class="lineNum">     276 </span>                :            :     bool fCheckForPruning = false;
<span class="lineNum">     277 </span>                :            : 
<span class="lineNum">     278 </span>                :            :     /** Dirty block index entries. */
<span class="lineNum">     279 </span>                :<span class="lineCov">         73 :     std::set&lt;CBlockIndex*&gt; setDirtyBlockIndex;</span>
<span class="lineNum">     280 </span>                :            : 
<span class="lineNum">     281 </span>                :            :     /** Dirty block file entries. */
<span class="lineNum">     282 </span>                :<span class="lineCov">         73 :     std::set&lt;int&gt; setDirtyFileInfo;</span>
<a name="283"><span class="lineNum">     283 </span>                :            : } // anon namespace</a>
<span class="lineNum">     284 </span>                :            : 
<span class="lineNum">     285 </span>                :<span class="lineNoCov">          0 : CBlockIndex* FindForkInGlobalIndex(const CChain&amp; chain, const CBlockLocator&amp; locator)</span>
<span class="lineNum">     286 </span>                :            : {
<span class="lineNum">     287 </span>                :<span class="lineNoCov">          0 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">     288 </span>                :            : 
<span class="lineNum">     289 </span>                :            :     // Find the latest block common to locator and chain - we expect that
<span class="lineNum">     290 </span>                :            :     // locator.vHave is sorted descending by height.
<span class="lineNum">     291 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (const uint256&amp; hash : locator.vHave) {</span>
<span class="lineNum">     292 </span>                :<span class="lineNoCov">          0 :         CBlockIndex* pindex = LookupBlockIndex(hash);</span>
<span class="lineNum">     293 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex) {</span>
<span class="lineNum">     294 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (chain.Contains(pindex))</span>
<span class="lineNum">     295 </span>                :<span class="lineNoCov">          0 :                 return pindex;</span>
<span class="lineNum">     296 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (pindex-&gt;GetAncestor(chain.Height()) == chain.Tip()) {</span>
<span class="lineNum">     297 </span>                :            :                 return chain.Tip();
<span class="lineNum">     298 </span>                :            :             }
<span class="lineNum">     299 </span>                :            :         }
<span class="lineNum">     300 </span>                :            :     }
<span class="lineNum">     301 </span>                :            :     return chain.Genesis();
<span class="lineNum">     302 </span>                :            : }
<span class="lineNum">     303 </span>                :            : 
<span class="lineNum">     304 </span>                :<span class="lineCov">         73 : std::unique_ptr&lt;CCoinsViewDB&gt; pcoinsdbview;</span>
<span class="lineNum">     305 </span>                :<span class="lineCov">         73 : std::unique_ptr&lt;CCoinsViewCache&gt; pcoinsTip;</span>
<span class="lineNum">     306 </span>                :<span class="lineCov">         73 : std::unique_ptr&lt;CBlockTreeDB&gt; pblocktree;</span>
<span class="lineNum">     307 </span>                :            : 
<span class="lineNum">     308 </span>                :            : enum class FlushStateMode {
<span class="lineNum">     309 </span>                :            :     NONE,
<span class="lineNum">     310 </span>                :            :     IF_NEEDED,
<span class="lineNum">     311 </span>                :            :     PERIODIC,
<span class="lineNum">     312 </span>                :            :     ALWAYS
<span class="lineNum">     313 </span>                :            : };
<span class="lineNum">     314 </span>                :            : 
<span class="lineNum">     315 </span>                :            : // See definition for documentation
<span class="lineNum">     316 </span>                :            : static bool FlushStateToDisk(const CChainParams&amp; chainParams, CValidationState &amp;state, FlushStateMode mode, int nManualPruneHeight=0);
<span class="lineNum">     317 </span>                :            : static void FindFilesToPruneManual(std::set&lt;int&gt;&amp; setFilesToPrune, int nManualPruneHeight);
<span class="lineNum">     318 </span>                :            : static void FindFilesToPrune(std::set&lt;int&gt;&amp; setFilesToPrune, uint64_t nPruneAfterHeight);
<span class="lineNum">     319 </span>                :            : bool CheckInputs(const CTransaction&amp; tx, CValidationState &amp;state, const CCoinsViewCache &amp;inputs, bool fScriptChecks, unsigned int flags, bool cacheSigStore, bool cacheFullScriptStore, PrecomputedTransactionData&amp; txdata, std::vector&lt;CScriptCheck&gt; *pvChecks = nullptr);
<a name="320"><span class="lineNum">     320 </span>                :            : static FILE* OpenUndoFile(const CDiskBlockPos &amp;pos, bool fReadOnly = false);</a>
<span class="lineNum">     321 </span>                :            : 
<span class="lineNum">     322 </span>                :<span class="lineCov">        734 : bool CheckFinalTx(const CTransaction &amp;tx, int flags)</span>
<span class="lineNum">     323 </span>                :            : {
<span class="lineNum">     324 </span>                :<span class="lineCov">        734 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">     325 </span>                :            : 
<span class="lineNum">     326 </span>                :            :     // By convention a negative value for flags indicates that the
<span class="lineNum">     327 </span>                :            :     // current network-enforced consensus rules should be used. In
<span class="lineNum">     328 </span>                :            :     // a future soft-fork scenario that would mean checking which
<span class="lineNum">     329 </span>                :            :     // rules would be enforced for the next block and setting the
<span class="lineNum">     330 </span>                :            :     // appropriate flags. At the present time no soft-forks are
<span class="lineNum">     331 </span>                :            :     // scheduled, so no flags are set.
<span class="lineNum">     332 </span>                :<span class="lineCov">       1468 :     flags = std::max(flags, 0);</span>
<span class="lineNum">     333 </span>                :            : 
<span class="lineNum">     334 </span>                :            :     // CheckFinalTx() uses chainActive.Height()+1 to evaluate
<span class="lineNum">     335 </span>                :            :     // nLockTime because when IsFinalTx() is called within
<span class="lineNum">     336 </span>                :            :     // CBlock::AcceptBlock(), the height of the block *being*
<span class="lineNum">     337 </span>                :            :     // evaluated is what is used. Thus if we want to know if a
<span class="lineNum">     338 </span>                :            :     // transaction can be part of the *next* block, we need to call
<span class="lineNum">     339 </span>                :            :     // IsFinalTx() with one more than chainActive.Height().
<span class="lineNum">     340 </span>                :<span class="lineCov">       1468 :     const int nBlockHeight = chainActive.Height() + 1;</span>
<span class="lineNum">     341 </span>                :            : 
<span class="lineNum">     342 </span>                :            :     // BIP113 requires that time-locked transactions have nLockTime set to
<span class="lineNum">     343 </span>                :            :     // less than the median time of the previous block they're contained in.
<span class="lineNum">     344 </span>                :            :     // When the next block is created its previous block will be the current
<span class="lineNum">     345 </span>                :            :     // chain tip, so we use that to calculate the median time passed to
<span class="lineNum">     346 </span>                :            :     // IsFinalTx() if LOCKTIME_MEDIAN_TIME_PAST is set.
<span class="lineNum">     347 </span>                :<span class="lineCov">        734 :     const int64_t nBlockTime = (flags &amp; LOCKTIME_MEDIAN_TIME_PAST)</span>
<span class="lineNum">     348 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 726 times"> + </span>]:<span class="lineCov">        742 :                              ? chainActive.Tip()-&gt;GetMedianTimePast()</span>
<span class="lineNum">     349 </span>                :<span class="lineCov">        734 :                              : GetAdjustedTime();</span>
<span class="lineNum">     350 </span>                :            : 
<span class="lineNum">     351 </span>                :<span class="lineCov">        734 :     return IsFinalTx(tx, nBlockHeight, nBlockTime);</span>
<a name="352"><span class="lineNum">     352 </span>                :            : }</a>
<span class="lineNum">     353 </span>                :            : 
<span class="lineNum">     354 </span>                :<span class="lineNoCov">          0 : bool TestLockPointValidity(const LockPoints* lp)</span>
<span class="lineNum">     355 </span>                :            : {
<span class="lineNum">     356 </span>                :<span class="lineNoCov">          0 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">     357 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     assert(lp);</span>
<span class="lineNum">     358 </span>                :            :     // If there are relative lock times then the maxInputBlock will be set
<span class="lineNum">     359 </span>                :            :     // If there are no relative lock times, the LockPoints don't depend on the chain
<span class="lineNum">     360 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (lp-&gt;maxInputBlock) {</span>
<span class="lineNum">     361 </span>                :            :         // Check whether chainActive is an extension of the block at which the LockPoints
<span class="lineNum">     362 </span>                :            :         // calculation was valid.  If not LockPoints are no longer valid
<span class="lineNum">     363 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!chainActive.Contains(lp-&gt;maxInputBlock)) {</span>
<span class="lineNum">     364 </span>                :            :             return false;
<span class="lineNum">     365 </span>                :            :         }
<span class="lineNum">     366 </span>                :            :     }
<span class="lineNum">     367 </span>                :            : 
<span class="lineNum">     368 </span>                :            :     // LockPoints still valid
<span class="lineNum">     369 </span>                :            :     return true;
<span class="lineNum">     370 </span>                :            : }
<span class="lineNum">     371 </span>                :            : 
<span class="lineNum">     372 </span>                :<span class="lineCov">         11 : bool CheckSequenceLocks(const CTxMemPool&amp; pool, const CTransaction&amp; tx, int flags, LockPoints* lp, bool useExistingLockPoints)</span>
<span class="lineNum">     373 </span>                :            : {
<span class="lineNum">     374 </span>                :<span class="lineCov">         11 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">     375 </span>                :<span class="lineCov">         11 :     AssertLockHeld(pool.cs);</span>
<span class="lineNum">     376 </span>                :            : 
<span class="lineNum">     377 </span>                :<span class="lineCov">         22 :     CBlockIndex* tip = chainActive.Tip();</span>
<span class="lineNum">     378 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>]:<span class="lineCov">         11 :     assert(tip != nullptr);</span>
<span class="lineNum">     379 </span>                :            : 
<span class="lineNum">     380 </span>                :<span class="lineCov">         11 :     CBlockIndex index;</span>
<span class="lineNum">     381 </span>                :<span class="lineCov">         11 :     index.pprev = tip;</span>
<span class="lineNum">     382 </span>                :            :     // CheckSequenceLocks() uses chainActive.Height()+1 to evaluate
<span class="lineNum">     383 </span>                :            :     // height based locks because when SequenceLocks() is called within
<span class="lineNum">     384 </span>                :            :     // ConnectBlock(), the height of the block *being*
<span class="lineNum">     385 </span>                :            :     // evaluated is what is used.
<span class="lineNum">     386 </span>                :            :     // Thus if we want to know if a transaction can be part of the
<span class="lineNum">     387 </span>                :            :     // *next* block, we need to use one more than chainActive.Height()
<span class="lineNum">     388 </span>                :<span class="lineCov">         11 :     index.nHeight = tip-&gt;nHeight + 1;</span>
<span class="lineNum">     389 </span>                :            : 
<span class="lineNum">     390 </span>                :<span class="lineCov">         11 :     std::pair&lt;int, int64_t&gt; lockPair;</span>
<span class="lineNum">     391 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>]:<span class="lineCov">         11 :     if (useExistingLockPoints) {</span>
<span class="lineNum">     392 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         assert(lp);</span>
<span class="lineNum">     393 </span>                :<span class="lineNoCov">          0 :         lockPair.first = lp-&gt;height;</span>
<span class="lineNum">     394 </span>                :<span class="lineNoCov">          0 :         lockPair.second = lp-&gt;time;</span>
<span class="lineNum">     395 </span>                :            :     }
<span class="lineNum">     396 </span>                :            :     else {
<span class="lineNum">     397 </span>                :            :         // pcoinsTip contains the UTXO set for chainActive.Tip()
<span class="lineNum">     398 </span>                :<span class="lineCov">         22 :         CCoinsViewMemPool viewMemPool(pcoinsTip.get(), pool);</span>
<span class="lineNum">     399 </span>                :<span class="lineCov">         22 :         std::vector&lt;int&gt; prevheights;</span>
<span class="lineNum">     400 </span>        [<span class="branchCov" title="Branch 1 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         11 :         prevheights.resize(tx.vin.size());</span>
<span class="lineNum">     401 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>]:<span class="lineCov">         22 :         for (size_t txinIndex = 0; txinIndex &lt; tx.vin.size(); txinIndex++) {</span>
<span class="lineNum">     402 </span>                :<span class="lineCov">         22 :             const CTxIn&amp; txin = tx.vin[txinIndex];</span>
<span class="lineNum">     403 </span>                :<span class="lineNoCov">          0 :             Coin coin;</span>
<span class="lineNum">     404 </span>[<span class="branchCov" title="Branch 1 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 11 times"> + </span>]:<span class="lineCov">         11 :             if (!viewMemPool.GetCoin(txin.prevout, coin)) {</span>
<span class="lineNum">     405 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return error(&quot;%s: Missing input&quot;, __func__);</span>
<span class="lineNum">     406 </span>                :            :             }
<span class="lineNum">     407 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">         11 :             if (coin.nHeight == MEMPOOL_HEIGHT) {</span>
<span class="lineNum">     408 </span>                :            :                 // Assume all mempool transaction confirm in the next block
<span class="lineNum">     409 </span>                :<span class="lineCov">          4 :                 prevheights[txinIndex] = tip-&gt;nHeight + 1;</span>
<span class="lineNum">     410 </span>                :            :             } else {
<span class="lineNum">     411 </span>                :<span class="lineCov">          7 :                 prevheights[txinIndex] = coin.nHeight;</span>
<span class="lineNum">     412 </span>                :            :             }
<span class="lineNum">     413 </span>                :            :         }
<span class="lineNum">     414 </span>        [<span class="branchCov" title="Branch 1 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         11 :         lockPair = CalculateSequenceLocks(tx, flags, &amp;prevheights, index);</span>
<span class="lineNum">     415 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">         11 :         if (lp) {</span>
<span class="lineNum">     416 </span>                :<span class="lineCov">          3 :             lp-&gt;height = lockPair.first;</span>
<span class="lineNum">     417 </span>                :<span class="lineCov">          3 :             lp-&gt;time = lockPair.second;</span>
<span class="lineNum">     418 </span>                :            :             // Also store the hash of the block with the highest height of
<span class="lineNum">     419 </span>                :            :             // all the blocks which have sequence locked prevouts.
<span class="lineNum">     420 </span>                :            :             // This hash needs to still be on the chain
<span class="lineNum">     421 </span>                :            :             // for these LockPoint calculations to be valid
<span class="lineNum">     422 </span>                :            :             // Note: It is impossible to correctly calculate a maxInputBlock
<span class="lineNum">     423 </span>                :            :             // if any of the sequence locked inputs depend on unconfirmed txs,
<span class="lineNum">     424 </span>                :            :             // except in the special case where the relative lock time/height
<span class="lineNum">     425 </span>                :            :             // is 0, which is equivalent to no sequence lock. Since we assume
<span class="lineNum">     426 </span>                :            :             // input height of tip+1 for mempool txs and test the resulting
<span class="lineNum">     427 </span>                :            :             // lockPair from CalculateSequenceLocks against tip+1.  We know
<span class="lineNum">     428 </span>                :            :             // EvaluateSequenceLocks will fail if there was a non-zero sequence
<span class="lineNum">     429 </span>                :            :             // lock on a mempool input, so we can use the return value of
<span class="lineNum">     430 </span>                :            :             // CheckSequenceLocks to indicate the LockPoints validity
<span class="lineNum">     431 </span>                :<span class="lineCov">          3 :             int maxInputHeight = 0;</span>
<span class="lineNum">     432 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          6 :             for (const int height : prevheights) {</span>
<span class="lineNum">     433 </span>                :            :                 // Can ignore mempool inputs since we'll fail if they had non-zero locks
<span class="lineNum">     434 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :                 if (height != tip-&gt;nHeight+1) {</span>
<span class="lineNum">     435 </span>                :<span class="lineCov">          3 :                     maxInputHeight = std::max(maxInputHeight, height);</span>
<span class="lineNum">     436 </span>                :            :                 }
<span class="lineNum">     437 </span>                :            :             }
<span class="lineNum">     438 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :             lp-&gt;maxInputBlock = tip-&gt;GetAncestor(maxInputHeight);</span>
<span class="lineNum">     439 </span>                :            :         }
<span class="lineNum">     440 </span>                :            :     }
<span class="lineNum">     441 </span>                :<span class="lineCov">         11 :     return EvaluateSequenceLocks(index, lockPair);</span>
<span class="lineNum">     442 </span>                :            : }
<span class="lineNum">     443 </span>                :            : 
<span class="lineNum">     444 </span>                :            : // Returns the script flags which should be checked for a given block
<span class="lineNum">     445 </span>                :            : static unsigned int GetBlockScriptFlags(const CBlockIndex* pindex, const Consensus::Params&amp; chainparams);
<span class="lineNum">     446 </span>                :            : 
<span class="lineNum">     447 </span>                :<span class="lineCov">          1 : static void LimitMempoolSize(CTxMemPool&amp; pool, size_t limit, unsigned long age) {</span>
<span class="lineNum">     448 </span>                :<span class="lineCov">          1 :     int expired = pool.Expire(GetTime() - age);</span>
<span class="lineNum">     449 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :     if (expired != 0) {</span>
<span class="lineNum">     450 </span>                :<span class="lineNoCov">          0 :         LogPrint(BCLog::MEMPOOL, &quot;Expired %i transactions from the memory pool\n&quot;, expired);</span>
<span class="lineNum">     451 </span>                :            :     }
<span class="lineNum">     452 </span>                :            : 
<span class="lineNum">     453 </span>                :<span class="lineCov">          2 :     std::vector&lt;COutPoint&gt; vNoSpendsRemaining;</span>
<span class="lineNum">     454 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     pool.TrimToSize(limit, &amp;vNoSpendsRemaining);</span>
<span class="lineNum">     455 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :     for (const COutPoint&amp; removed : vNoSpendsRemaining)</span>
<span class="lineNum">     456 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         pcoinsTip-&gt;Uncache(removed);</span>
<span class="lineNum">     457 </span>                :<span class="lineCov">          1 : }</span>
<span class="lineNum">     458 </span>                :            : 
<span class="lineNum">     459 </span>                :            : /** Convert CValidationState to a human-readable message for logging */
<span class="lineNum">     460 </span>                :<span class="lineCov">        137 : std::string FormatStateMessage(const CValidationState &amp;state)</span>
<span class="lineNum">     461 </span>                :            : {
<span class="lineNum">     462 </span>                :            :     return strprintf(&quot;%s%s (code %i)&quot;,
<span class="lineNum">     463 </span>                :<span class="lineNoCov">          0 :         state.GetRejectReason(),</span>
<span class="lineNum">     464 </span>[<span class="branchCov" title="Branch 0 was taken 123 times"> + </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 123 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        288 :         state.GetDebugMessage().empty() ? &quot;&quot; : &quot;, &quot;+state.GetDebugMessage(),</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">         </span>  [<span class="branchCov" title="Branch 8 was taken 14 times"> + </span><span class="branchCov" title="Branch 9 was taken 123 times"> + </span><span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">     465 </span>        [<span class="branchCov" title="Branch 1 was taken 137 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        274 :         state.GetRejectCode());</span>
<a name="466"><span class="lineNum">     466 </span>                :            : }</a>
<span class="lineNum">     467 </span>                :            : 
<span class="lineNum">     468 </span>                :<span class="lineNoCov">          0 : static bool IsCurrentForFeeEstimation() EXCLUSIVE_LOCKS_REQUIRED(cs_main)</span>
<span class="lineNum">     469 </span>                :            : {
<span class="lineNum">     470 </span>                :<span class="lineNoCov">          0 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">     471 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (IsInitialBlockDownload())</span>
<span class="lineNum">     472 </span>                :            :         return false;
<span class="lineNum">     473 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (chainActive.Tip()-&gt;GetBlockTime() &lt; (GetTime() - MAX_FEE_ESTIMATION_TIP_AGE))</span>
<span class="lineNum">     474 </span>                :            :         return false;
<span class="lineNum">     475 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (chainActive.Height() &lt; pindexBestHeader-&gt;nHeight - 1)</span>
<span class="lineNum">     476 </span>                :            :         return false;
<span class="lineNum">     477 </span>                :<span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     478 </span>                :            : }
<span class="lineNum">     479 </span>                :            : 
<span class="lineNum">     480 </span>                :            : /* Make mempool consistent after a reorg, by re-adding or recursively erasing
<span class="lineNum">     481 </span>                :            :  * disconnected block transactions from the mempool, and also removing any
<span class="lineNum">     482 </span>                :            :  * other transactions from the mempool that are no longer valid given the new
<span class="lineNum">     483 </span>                :            :  * tip/height.
<span class="lineNum">     484 </span>                :            :  *
<span class="lineNum">     485 </span>                :            :  * Note: we assume that disconnectpool only contains transactions that are NOT
<span class="lineNum">     486 </span>                :            :  * confirmed in the current chain nor already in the mempool (otherwise,
<span class="lineNum">     487 </span>                :            :  * in-mempool descendants of such transactions would be removed).
<span class="lineNum">     488 </span>                :            :  *
<span class="lineNum">     489 </span>                :            :  * Passing fAddToMempool=false will skip trying to add the transactions back,
<span class="lineNum">     490 </span>                :            :  * and instead just erase from the mempool as needed.
<span class="lineNum">     491 </span>                :            :  */
<span class="lineNum">     492 </span>                :            : 
<span class="lineNum">     493 </span>                :<span class="lineCov">          1 : static void UpdateMempoolForReorg(DisconnectedBlockTransactions &amp;disconnectpool, bool fAddToMempool) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</span>
<span class="lineNum">     494 </span>                :            : {
<span class="lineNum">     495 </span>                :<span class="lineCov">          1 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">     496 </span>                :<span class="lineCov">          2 :     std::vector&lt;uint256&gt; vHashUpdate;</span>
<span class="lineNum">     497 </span>                :            :     // disconnectpool's insertion_order index sorts the entries from
<span class="lineNum">     498 </span>                :            :     // oldest to newest, but the oldest entry will be the last tx from the
<span class="lineNum">     499 </span>                :            :     // latest mined block that was disconnected.
<span class="lineNum">     500 </span>                :            :     // Iterate disconnectpool in reverse, so that we add transactions
<span class="lineNum">     501 </span>                :            :     // back to the mempool starting with the earliest transaction that had
<span class="lineNum">     502 </span>                :            :     // been previously seen in a block.
<span class="lineNum">     503 </span>                :<span class="lineCov">          1 :     auto it = disconnectpool.queuedTx.get&lt;insertion_order&gt;().rbegin();</span>
<span class="lineNum">     504 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          8 :     while (it != disconnectpool.queuedTx.get&lt;insertion_order&gt;().rend()) {</span>
<span class="lineNum">     505 </span>                :            :         // ignore validation errors in resurrected transactions
<span class="lineNum">     506 </span>                :<span class="lineCov">          7 :         CValidationState stateDummy;</span>
<span class="lineNum">     507 </span>[<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          7 :         if (!fAddToMempool || (*it)-&gt;IsCoinBase() ||</span>
<span class="lineNum">     508 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             !AcceptToMemoryPool(mempool, stateDummy, *it, nullptr /* pfMissingInputs */,</span>
<span class="lineNum">     509 </span>                :            :                                 nullptr /* plTxnReplaced */, true /* bypass_limits */, 0 /* nAbsurdFee */)) {
<span class="lineNum">     510 </span>                :            :             // If the transaction doesn't make it in to the mempool, remove any
<span class="lineNum">     511 </span>                :            :             // transactions that depend on it (which would now be orphans).
<span class="lineNum">     512 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :             mempool.removeRecursive(**it, MemPoolRemovalReason::REORG);</span>
<span class="lineNum">     513 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if (mempool.exists((*it)-&gt;GetHash())) {</span>
<span class="lineNum">     514 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             vHashUpdate.push_back((*it)-&gt;GetHash());</span>
<span class="lineNum">     515 </span>                :            :         }
<span class="lineNum">     516 </span>                :<span class="lineCov">          7 :         ++it;</span>
<span class="lineNum">     517 </span>                :            :     }
<span class="lineNum">     518 </span>                :<span class="lineCov">          2 :     disconnectpool.queuedTx.clear();</span>
<span class="lineNum">     519 </span>                :            :     // AcceptToMemoryPool/addUnchecked all assume that new mempool entries have
<span class="lineNum">     520 </span>                :            :     // no in-mempool children, which is generally not true when adding
<span class="lineNum">     521 </span>                :            :     // previously-confirmed transactions back to the mempool.
<span class="lineNum">     522 </span>                :            :     // UpdateTransactionsFromBlock finds descendants of any transactions in
<span class="lineNum">     523 </span>                :            :     // the disconnectpool that were added back and cleans up the mempool state.
<span class="lineNum">     524 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     mempool.UpdateTransactionsFromBlock(vHashUpdate);</span>
<span class="lineNum">     525 </span>                :            : 
<span class="lineNum">     526 </span>                :            :     // We also need to remove any now-immature transactions
<span class="lineNum">     527 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     mempool.removeForReorg(pcoinsTip.get(), chainActive.Tip()-&gt;nHeight + 1, STANDARD_LOCKTIME_VERIFY_FLAGS);</span>
<span class="lineNum">     528 </span>                :            :     // Re-limit mempool size, in case we added any transactions
<span class="lineNum">     529 </span>[<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          1 :     LimitMempoolSize(mempool, gArgs.GetArg(&quot;-maxmempool&quot;, DEFAULT_MAX_MEMPOOL_SIZE) * 1000000, gArgs.GetArg(&quot;-mempoolexpiry&quot;, DEFAULT_MEMPOOL_EXPIRY) * 60 * 60);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchCov" title="Branch 10 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 13 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 14 was not taken"> - </span>]
<span class="lineNum">     530 </span>                :<span class="lineCov">          1 : }</span>
<span class="lineNum">     531 </span>                :            : 
<a name="532"><span class="lineNum">     532 </span>                :            : // Used to avoid mempool polluting consensus critical paths if CCoinsViewMempool</a>
<span class="lineNum">     533 </span>                :            : // were somehow broken and returning the wrong scriptPubKeys
<span class="lineNum">     534 </span>                :<span class="lineCov">          3 : static bool CheckInputsFromMempoolAndCache(const CTransaction&amp; tx, CValidationState&amp; state, const CCoinsViewCache&amp; view, const CTxMemPool&amp; pool,</span>
<span class="lineNum">     535 </span>                :            :                  unsigned int flags, bool cacheSigStore, PrecomputedTransactionData&amp; txdata) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {
<span class="lineNum">     536 </span>                :<span class="lineCov">          3 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">     537 </span>                :            : 
<span class="lineNum">     538 </span>                :            :     // pool.cs should be locked already, but go ahead and re-take the lock here
<span class="lineNum">     539 </span>                :            :     // to enforce that mempool doesn't change between when we check the view
<span class="lineNum">     540 </span>                :            :     // and when we actually call through to CheckInputs
<span class="lineNum">     541 </span>                :<span class="lineCov">          6 :     LOCK(pool.cs);</span>
<span class="lineNum">     542 </span>                :            : 
<span class="lineNum">     543 </span>                :<span class="lineNoCov">          0 :     assert(!tx.IsCoinBase());</span>
<span class="lineNum">     544 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          6 :     for (const CTxIn&amp; txin : tx.vin) {</span>
<span class="lineNum">     545 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         const Coin&amp; coin = view.AccessCoin(txin.prevout);</span>
<span class="lineNum">     546 </span>                :            : 
<span class="lineNum">     547 </span>                :            :         // At this point we haven't actually checked if the coins are all
<span class="lineNum">     548 </span>                :            :         // available (or shouldn't assume we have, since CheckInputs does).
<span class="lineNum">     549 </span>                :            :         // So we just return failure if the inputs are not available here,
<span class="lineNum">     550 </span>                :            :         // and then only have to check equivalence for available inputs.
<span class="lineNum">     551 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         if (coin.IsSpent()) return false;</span>
<span class="lineNum">     552 </span>                :            : 
<span class="lineNum">     553 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         const CTransactionRef&amp; txFrom = pool.get(txin.prevout.hash);</span>
<span class="lineNum">     554 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         if (txFrom) {</span>
<span class="lineNum">     555 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             assert(txFrom-&gt;GetHash() == txin.prevout.hash);</span>
<span class="lineNum">     556 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             assert(txFrom-&gt;vout.size() &gt; txin.prevout.n);</span>
<span class="lineNum">     557 </span>                :<span class="lineNoCov">          0 :             assert(txFrom-&gt;vout[txin.prevout.n] == coin.out);</span>
<span class="lineNum">     558 </span>                :            :         } else {
<span class="lineNum">     559 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :             const Coin&amp; coinFromDisk = pcoinsTip-&gt;AccessCoin(txin.prevout);</span>
<span class="lineNum">     560 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :             assert(!coinFromDisk.IsSpent());</span>
<span class="lineNum">     561 </span>                :<span class="lineNoCov">          0 :             assert(coinFromDisk.out == coin.out);</span>
<span class="lineNum">     562 </span>                :            :         }
<span class="lineNum">     563 </span>                :            :     }
<span class="lineNum">     564 </span>                :            : 
<span class="lineNum">     565 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :     return CheckInputs(tx, state, view, true, flags, cacheSigStore, true, txdata);</span>
<span class="lineNum">     566 </span>                :            : }
<span class="lineNum">     567 </span>                :            : 
<span class="lineNum">     568 </span>                :<span class="lineCov">          4 : static bool AcceptToMemoryPoolWorker(const CChainParams&amp; chainparams, CTxMemPool&amp; pool, CValidationState&amp; state, const CTransactionRef&amp; ptx,</span>
<span class="lineNum">     569 </span>                :            :                               bool* pfMissingInputs, int64_t nAcceptTime, std::list&lt;CTransactionRef&gt;* plTxnReplaced,
<span class="lineNum">     570 </span>                :            :                               bool bypass_limits, const CAmount&amp; nAbsurdFee, std::vector&lt;COutPoint&gt;&amp; coins_to_uncache, bool test_accept) EXCLUSIVE_LOCKS_REQUIRED(cs_main)
<span class="lineNum">     571 </span>                :            : {
<span class="lineNum">     572 </span>                :<span class="lineCov">          4 :     const CTransaction&amp; tx = *ptx;</span>
<span class="lineNum">     573 </span>                :<span class="lineCov">          4 :     const uint256 hash = tx.GetHash();</span>
<span class="lineNum">     574 </span>                :<span class="lineCov">          4 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">     575 </span>                :<span class="lineCov">          8 :     LOCK(pool.cs); // mempool &quot;read lock&quot; (held through GetMainSignals().TransactionAddedToMempool())</span>
<span class="lineNum">     576 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          4 :     if (pfMissingInputs) {</span>
<span class="lineNum">     577 </span>                :<span class="lineNoCov">          0 :         *pfMissingInputs = false;</span>
<span class="lineNum">     578 </span>                :            :     }
<span class="lineNum">     579 </span>                :            : 
<span class="lineNum">     580 </span>[<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          4 :     if (!CheckTransaction(tx, state))</span>
<span class="lineNum">     581 </span>                :            :         return false; // state filled in by CheckTransaction
<span class="lineNum">     582 </span>                :            : 
<span class="lineNum">     583 </span>                :            :     // Coinbase is only valid in a block, not as a loose transaction
<span class="lineNum">     584 </span>                :<span class="lineCov">          1 :     if (tx.IsCoinBase())</span>
<span class="lineNum">     585 </span>[<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          2 :         return state.DoS(100, false, REJECT_INVALID, &quot;coinbase&quot;);</span>
<span class="lineNum">     586 </span>                :            : 
<span class="lineNum">     587 </span>                :            :     // Rather not work on nonstandard transactions (unless -testnet/-regtest)
<span class="lineNum">     588 </span>                :<span class="lineNoCov">          0 :     std::string reason;</span>
<span class="lineNum">     589 </span>[<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          3 :     if (fRequireStandard &amp;&amp; !IsStandardTx(tx, reason))</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]
<span class="lineNum">     590 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return state.DoS(0, false, REJECT_NONSTANDARD, reason);</span>
<span class="lineNum">     591 </span>                :            : 
<span class="lineNum">     592 </span>                :            :     // Do not work on transactions that are too small.
<span class="lineNum">     593 </span>                :            :     // A transaction with 1 segwit input and 1 P2WPHK output has non-witness size of 82 bytes.
<span class="lineNum">     594 </span>                :            :     // Transactions smaller than this are not relayed to reduce unnecessary malloc overhead.
<span class="lineNum">     595 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 3 times"> + </span>]:<span class="lineCov">          3 :     if (::GetSerializeSize(tx, PROTOCOL_VERSION | SERIALIZE_TRANSACTION_NO_WITNESS) &lt; MIN_STANDARD_TX_NONWITNESS_SIZE)</span>
<span class="lineNum">     596 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return state.DoS(0, false, REJECT_NONSTANDARD, &quot;tx-size-small&quot;);</span>
<span class="lineNum">     597 </span>                :            : 
<span class="lineNum">     598 </span>                :            :     // Only accept nLockTime-using transactions that can be mined in the next
<span class="lineNum">     599 </span>                :            :     // block; we don't want our mempool filled up with transactions that can't
<span class="lineNum">     600 </span>                :            :     // be mined yet.
<span class="lineNum">     601 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 3 times"> + </span>]:<span class="lineCov">          3 :     if (!CheckFinalTx(tx, STANDARD_LOCKTIME_VERIFY_FLAGS))</span>
<span class="lineNum">     602 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return state.DoS(0, false, REJECT_NONSTANDARD, &quot;non-final&quot;);</span>
<span class="lineNum">     603 </span>                :            : 
<span class="lineNum">     604 </span>                :            :     // is it already in the memory pool?
<span class="lineNum">     605 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 3 times"> + </span>]:<span class="lineCov">          3 :     if (pool.exists(hash)) {</span>
<span class="lineNum">     606 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return state.Invalid(false, REJECT_DUPLICATE, &quot;txn-already-in-mempool&quot;);</span>
<span class="lineNum">     607 </span>                :            :     }
<span class="lineNum">     608 </span>                :            : 
<span class="lineNum">     609 </span>                :            :     // Check for conflicts with in-memory transactions
<span class="lineNum">     610 </span>                :<span class="lineNoCov">          0 :     std::set&lt;uint256&gt; setConflicts;</span>
<span class="lineNum">     611 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          6 :     for (const CTxIn &amp;txin : tx.vin)</span>
<span class="lineNum">     612 </span>                :            :     {
<span class="lineNum">     613 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         const CTransaction* ptxConflicting = pool.GetConflictTx(txin.prevout);</span>
<span class="lineNum">     614 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         if (ptxConflicting) {</span>
<span class="lineNum">     615 </span>                :<span class="lineNoCov">          0 :             if (!setConflicts.count(ptxConflicting-&gt;GetHash()))</span>
<span class="lineNum">     616 </span>                :            :             {
<span class="lineNum">     617 </span>                :            :                 // Allow opt-out of transaction replacement by setting
<span class="lineNum">     618 </span>                :            :                 // nSequence &gt; MAX_BIP125_RBF_SEQUENCE (SEQUENCE_FINAL-2) on all inputs.
<span class="lineNum">     619 </span>                :            :                 //
<span class="lineNum">     620 </span>                :            :                 // SEQUENCE_FINAL-1 is picked to still allow use of nLockTime by
<span class="lineNum">     621 </span>                :            :                 // non-replaceable transactions. All inputs rather than just one
<span class="lineNum">     622 </span>                :            :                 // is for the sake of multi-party protocols, where we don't
<span class="lineNum">     623 </span>                :            :                 // want a single party to be able to disable replacement.
<span class="lineNum">     624 </span>                :            :                 //
<span class="lineNum">     625 </span>                :            :                 // The opt-out ignores descendants as anyone relying on
<span class="lineNum">     626 </span>                :            :                 // first-seen mempool behavior should be checking all
<span class="lineNum">     627 </span>                :            :                 // unconfirmed ancestors anyway; doing otherwise is hopelessly
<span class="lineNum">     628 </span>                :            :                 // insecure.
<span class="lineNum">     629 </span>                :<span class="lineNoCov">          0 :                 bool fReplacementOptOut = true;</span>
<span class="lineNum">     630 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (fEnableReplacement)</span>
<span class="lineNum">     631 </span>                :            :                 {
<span class="lineNum">     632 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     for (const CTxIn &amp;_txin : ptxConflicting-&gt;vin)</span>
<span class="lineNum">     633 </span>                :            :                     {
<span class="lineNum">     634 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (_txin.nSequence &lt;= MAX_BIP125_RBF_SEQUENCE)</span>
<span class="lineNum">     635 </span>                :            :                         {
<span class="lineNum">     636 </span>                :            :                             fReplacementOptOut = false;
<span class="lineNum">     637 </span>                :            :                             break;
<span class="lineNum">     638 </span>                :            :                         }
<span class="lineNum">     639 </span>                :            :                     }
<span class="lineNum">     640 </span>                :            :                 }
<span class="lineNum">     641 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (fReplacementOptOut) {</span>
<span class="lineNum">     642 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     return state.Invalid(false, REJECT_DUPLICATE, &quot;txn-mempool-conflict&quot;);</span>
<span class="lineNum">     643 </span>                :            :                 }
<span class="lineNum">     644 </span>                :            : 
<span class="lineNum">     645 </span>                :<span class="lineNoCov">          0 :                 setConflicts.insert(ptxConflicting-&gt;GetHash());</span>
<span class="lineNum">     646 </span>                :            :             }
<span class="lineNum">     647 </span>                :            :         }
<span class="lineNum">     648 </span>                :            :     }
<span class="lineNum">     649 </span>                :            : 
<span class="lineNum">     650 </span>                :            :     {
<span class="lineNum">     651 </span>                :<span class="lineNoCov">          0 :         CCoinsView dummy;</span>
<span class="lineNum">     652 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         CCoinsViewCache view(&amp;dummy);</span>
<span class="lineNum">     653 </span>                :            : 
<span class="lineNum">     654 </span>                :<span class="lineCov">          3 :         LockPoints lp;</span>
<span class="lineNum">     655 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         CCoinsViewMemPool viewMemPool(pcoinsTip.get(), pool);</span>
<span class="lineNum">     656 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         view.SetBackend(viewMemPool);</span>
<span class="lineNum">     657 </span>                :            : 
<span class="lineNum">     658 </span>                :            :         // do all inputs exist?
<span class="lineNum">     659 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          6 :         for (const CTxIn&amp; txin : tx.vin) {</span>
<span class="lineNum">     660 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 3 times"> + </span>]:<span class="lineCov">          3 :             if (!pcoinsTip-&gt;HaveCoinInCache(txin.prevout)) {</span>
<span class="lineNum">     661 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 coins_to_uncache.push_back(txin.prevout);</span>
<span class="lineNum">     662 </span>                :            :             }
<span class="lineNum">     663 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 3 times"> + </span>]:<span class="lineCov">          3 :             if (!view.HaveCoin(txin.prevout)) {</span>
<span class="lineNum">     664 </span>                :            :                 // Are inputs missing because we already have the tx?
<span class="lineNum">     665 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 for (size_t out = 0; out &lt; tx.vout.size(); out++) {</span>
<span class="lineNum">     666 </span>                :            :                     // Optimistically just do efficient check of cache for outputs
<span class="lineNum">     667 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if (pcoinsTip-&gt;HaveCoinInCache(COutPoint(hash, out))) {</span>
<span class="lineNum">     668 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         return state.Invalid(false, REJECT_DUPLICATE, &quot;txn-already-known&quot;);</span>
<span class="lineNum">     669 </span>                :            :                     }
<span class="lineNum">     670 </span>                :            :                 }
<span class="lineNum">     671 </span>                :            :                 // Otherwise assume this might be an orphan tx for which we just haven't seen parents yet
<span class="lineNum">     672 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (pfMissingInputs) {</span>
<span class="lineNum">     673 </span>                :<span class="lineNoCov">          0 :                     *pfMissingInputs = true;</span>
<span class="lineNum">     674 </span>                :            :                 }
<span class="lineNum">     675 </span>                :            :                 return false; // fMissingInputs and !state.IsInvalid() is used to detect this condition, don't set state.Invalid()
<span class="lineNum">     676 </span>                :            :             }
<span class="lineNum">     677 </span>                :            :         }
<span class="lineNum">     678 </span>                :            : 
<span class="lineNum">     679 </span>                :            :         // Bring the best block into scope
<span class="lineNum">     680 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         view.GetBestBlock();</span>
<span class="lineNum">     681 </span>                :            : 
<span class="lineNum">     682 </span>                :            :         // we have all inputs cached now, so switch back to dummy, so we don't need to keep lock on mempool
<span class="lineNum">     683 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         view.SetBackend(dummy);</span>
<span class="lineNum">     684 </span>                :            : 
<span class="lineNum">     685 </span>                :            :         // Only accept BIP68 sequence locked transactions that can be mined in the next
<span class="lineNum">     686 </span>                :            :         // block; we don't want our mempool filled up with transactions that can't
<span class="lineNum">     687 </span>                :            :         // be mined yet.
<span class="lineNum">     688 </span>                :            :         // Must keep pool.cs for this unless we change CheckSequenceLocks to take a
<span class="lineNum">     689 </span>                :            :         // CoinsViewCache instead of create its own
<span class="lineNum">     690 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         if (!CheckSequenceLocks(pool, tx, STANDARD_LOCKTIME_VERIFY_FLAGS, &amp;lp))</span>
<span class="lineNum">     691 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.DoS(0, false, REJECT_NONSTANDARD, &quot;non-BIP68-final&quot;);</span>
<span class="lineNum">     692 </span>                :            : 
<span class="lineNum">     693 </span>                :<span class="lineCov">          3 :         CAmount nFees = 0;</span>
<span class="lineNum">     694 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          3 :         if (!Consensus::CheckTxInputs(tx, state, view, GetSpendHeight(view), nFees)) {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 3 times"> + </span>]
<span class="lineNum">     695 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return error(&quot;%s: Consensus::CheckTxInputs: %s, %s&quot;, __func__, tx.GetHash().ToString(), FormatStateMessage(state));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">     696 </span>                :            :         }
<span class="lineNum">     697 </span>                :            : 
<span class="lineNum">     698 </span>                :            :         // Check for non-standard pay-to-script-hash in inputs
<span class="lineNum">     699 </span>[<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          3 :         if (fRequireStandard &amp;&amp; !AreInputsStandard(tx, view))</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]
<span class="lineNum">     700 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.Invalid(false, REJECT_NONSTANDARD, &quot;bad-txns-nonstandard-inputs&quot;);</span>
<span class="lineNum">     701 </span>                :            : 
<span class="lineNum">     702 </span>                :            :         // Check for non-standard witness in P2WSH
<span class="lineNum">     703 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          3 :         if (tx.HasWitness() &amp;&amp; fRequireStandard &amp;&amp; !IsWitnessStandard(tx, view))</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">     704 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.DoS(0, false, REJECT_NONSTANDARD, &quot;bad-witness-nonstandard&quot;, true);</span>
<span class="lineNum">     705 </span>                :            : 
<span class="lineNum">     706 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         int64_t nSigOpsCost = GetTransactionSigOpCost(tx, view, STANDARD_SCRIPT_VERIFY_FLAGS);</span>
<span class="lineNum">     707 </span>                :            : 
<span class="lineNum">     708 </span>                :            :         // nModifiedFees includes any fee deltas from PrioritiseTransaction
<span class="lineNum">     709 </span>                :<span class="lineCov">          3 :         CAmount nModifiedFees = nFees;</span>
<span class="lineNum">     710 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         pool.ApplyDelta(hash, nModifiedFees);</span>
<span class="lineNum">     711 </span>                :            : 
<span class="lineNum">     712 </span>                :            :         // Keep track of transactions that spend a coinbase, which we re-scan
<span class="lineNum">     713 </span>                :            :         // during reorgs to ensure COINBASE_MATURITY is still met.
<span class="lineNum">     714 </span>                :<span class="lineCov">          3 :         bool fSpendsCoinbase = false;</span>
<span class="lineNum">     715 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :         for (const CTxIn &amp;txin : tx.vin) {</span>
<span class="lineNum">     716 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :             const Coin &amp;coin = view.AccessCoin(txin.prevout);</span>
<span class="lineNum">     717 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :             if (coin.IsCoinBase()) {</span>
<span class="lineNum">     718 </span>                :            :                 fSpendsCoinbase = true;
<span class="lineNum">     719 </span>                :            :                 break;
<span class="lineNum">     720 </span>                :            :             }
<span class="lineNum">     721 </span>                :            :         }
<span class="lineNum">     722 </span>                :            : 
<span class="lineNum">     723 </span>                :<span class="lineCov">          6 :         CTxMemPoolEntry entry(ptx, nFees, nAcceptTime, chainActive.Height(),</span>
<span class="lineNum">     724 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :                               fSpendsCoinbase, nSigOpsCost, lp);</span>
<span class="lineNum">     725 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         unsigned int nSize = entry.GetTxSize();</span>
<span class="lineNum">     726 </span>                :            : 
<span class="lineNum">     727 </span>                :            :         // Check that the transaction doesn't have an excessive number of
<span class="lineNum">     728 </span>                :            :         // sigops, making it impossible to mine. Since the coinbase transaction
<span class="lineNum">     729 </span>                :            :         // itself can contain sigops MAX_STANDARD_TX_SIGOPS is less than
<span class="lineNum">     730 </span>                :            :         // MAX_BLOCK_SIGOPS; we still consider this an invalid rather than
<span class="lineNum">     731 </span>                :            :         // merely non-standard transaction.
<span class="lineNum">     732 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         if (nSigOpsCost &gt; MAX_STANDARD_TX_SIGOPS_COST)</span>
<span class="lineNum">     733 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.DoS(0, false, REJECT_NONSTANDARD, &quot;bad-txns-too-many-sigops&quot;, false,</span>
<span class="lineNum">     734 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 strprintf(&quot;%d&quot;, nSigOpsCost));</span>
<span class="lineNum">     735 </span>                :            : 
<span class="lineNum">     736 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          3 :         CAmount mempoolRejectFee = pool.GetMinFee(gArgs.GetArg(&quot;-maxmempool&quot;, DEFAULT_MAX_MEMPOOL_SIZE) * 1000000).GetFee(nSize);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchCov" title="Branch 10 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span>]
<span class="lineNum">     737 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          3 :         if (!bypass_limits &amp;&amp; mempoolRejectFee &gt; 0 &amp;&amp; nModifiedFees &lt; mempoolRejectFee) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">     738 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.DoS(0, false, REJECT_INSUFFICIENTFEE, &quot;mempool min fee not met&quot;, false, strprintf(&quot;%d &lt; %d&quot;, nModifiedFees, mempoolRejectFee));</span>
<span class="lineNum">     739 </span>                :            :         }
<span class="lineNum">     740 </span>                :            : 
<span class="lineNum">     741 </span>                :            :         // No transactions are allowed below minRelayTxFee except from disconnected blocks
<span class="lineNum">     742 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineCov">          3 :         if (!bypass_limits &amp;&amp; nModifiedFees &lt; ::minRelayTxFee.GetFee(nSize)) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">     743 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.DoS(0, false, REJECT_INSUFFICIENTFEE, &quot;min relay fee not met&quot;, false, strprintf(&quot;%d &lt; %d&quot;, nModifiedFees, ::minRelayTxFee.GetFee(nSize)));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">     744 </span>                :            :         }
<span class="lineNum">     745 </span>                :            : 
<span class="lineNum">     746 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          3 :         if (nAbsurdFee &amp;&amp; nFees &gt; nAbsurdFee)</span>
<span class="lineNum">     747 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.Invalid(false,</span>
<span class="lineNum">     748 </span>                :            :                 REJECT_HIGHFEE, &quot;absurdly-high-fee&quot;,
<span class="lineNum">     749 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 strprintf(&quot;%d &gt; %d&quot;, nFees, nAbsurdFee));</span>
<span class="lineNum">     750 </span>                :            : 
<span class="lineNum">     751 </span>                :            :         // Calculate in-mempool ancestors, up to a limit.
<span class="lineNum">     752 </span>                :<span class="lineNoCov">          0 :         CTxMemPool::setEntries setAncestors;</span>
<span class="lineNum">     753 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          3 :         size_t nLimitAncestors = gArgs.GetArg(&quot;-limitancestorcount&quot;, DEFAULT_ANCESTOR_LIMIT);</span>
<span class="lineNum">     754 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          3 :         size_t nLimitAncestorSize = gArgs.GetArg(&quot;-limitancestorsize&quot;, DEFAULT_ANCESTOR_SIZE_LIMIT)*1000;</span>
<span class="lineNum">     755 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          3 :         size_t nLimitDescendants = gArgs.GetArg(&quot;-limitdescendantcount&quot;, DEFAULT_DESCENDANT_LIMIT);</span>
<span class="lineNum">     756 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          3 :         size_t nLimitDescendantSize = gArgs.GetArg(&quot;-limitdescendantsize&quot;, DEFAULT_DESCENDANT_SIZE_LIMIT)*1000;</span>
<span class="lineNum">     757 </span>                :<span class="lineNoCov">          0 :         std::string errString;</span>
<span class="lineNum">     758 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         if (!pool.CalculateMemPoolAncestors(entry, setAncestors, nLimitAncestors, nLimitAncestorSize, nLimitDescendants, nLimitDescendantSize, errString)) {</span>
<span class="lineNum">     759 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.DoS(0, false, REJECT_NONSTANDARD, &quot;too-long-mempool-chain&quot;, false, errString);</span>
<span class="lineNum">     760 </span>                :            :         }
<span class="lineNum">     761 </span>                :            : 
<span class="lineNum">     762 </span>                :            :         // A transaction that spends outputs that would be replaced by it is invalid. Now
<span class="lineNum">     763 </span>                :            :         // that we have the set of all ancestors we can detect this
<span class="lineNum">     764 </span>                :            :         // pathological case by making sure setConflicts and setAncestors don't
<span class="lineNum">     765 </span>                :            :         // intersect.
<span class="lineNum">     766 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         for (CTxMemPool::txiter ancestorIt : setAncestors)</span>
<span class="lineNum">     767 </span>                :            :         {
<span class="lineNum">     768 </span>                :<span class="lineNoCov">          0 :             const uint256 &amp;hashAncestor = ancestorIt-&gt;GetTx().GetHash();</span>
<span class="lineNum">     769 </span>                :<span class="lineNoCov">          0 :             if (setConflicts.count(hashAncestor))</span>
<span class="lineNum">     770 </span>                :            :             {
<span class="lineNum">     771 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return state.DoS(10, false,</span>
<span class="lineNum">     772 </span>                :            :                                  REJECT_INVALID, &quot;bad-txns-spends-conflicting-tx&quot;, false,
<span class="lineNum">     773 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                  strprintf(&quot;%s spends conflicting transaction %s&quot;,</span>
<span class="lineNum">     774 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                            hash.ToString(),</span>
<span class="lineNum">     775 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                            hashAncestor.ToString()));</span>
<span class="lineNum">     776 </span>                :            :             }
<span class="lineNum">     777 </span>                :            :         }
<span class="lineNum">     778 </span>                :            : 
<span class="lineNum">     779 </span>                :            :         // Check if it's economically rational to mine this transaction rather
<span class="lineNum">     780 </span>                :            :         // than the ones it replaces.
<span class="lineNum">     781 </span>                :<span class="lineCov">          3 :         CAmount nConflictingFees = 0;</span>
<span class="lineNum">     782 </span>                :<span class="lineCov">          3 :         size_t nConflictingSize = 0;</span>
<span class="lineNum">     783 </span>                :<span class="lineCov">          3 :         uint64_t nConflictingCount = 0;</span>
<span class="lineNum">     784 </span>                :<span class="lineNoCov">          0 :         CTxMemPool::setEntries allConflicting;</span>
<span class="lineNum">     785 </span>                :            : 
<span class="lineNum">     786 </span>                :            :         // If we don't hold the lock allConflicting might be incomplete; the
<span class="lineNum">     787 </span>                :            :         // subsequent RemoveStaged() and addUnchecked() calls don't guarantee
<span class="lineNum">     788 </span>                :            :         // mempool consistency for us.
<span class="lineNum">     789 </span>                :<span class="lineCov">          3 :         const bool fReplacementTransaction = setConflicts.size();</span>
<span class="lineNum">     790 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         if (fReplacementTransaction)</span>
<span class="lineNum">     791 </span>                :            :         {
<span class="lineNum">     792 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             CFeeRate newFeeRate(nModifiedFees, nSize);</span>
<span class="lineNum">     793 </span>                :<span class="lineNoCov">          0 :             std::set&lt;uint256&gt; setConflictsParents;</span>
<span class="lineNum">     794 </span>                :<span class="lineNoCov">          0 :             const int maxDescendantsToVisit = 100;</span>
<span class="lineNum">     795 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             const CTxMemPool::setEntries setIterConflicting = pool.GetIterSet(setConflicts);</span>
<span class="lineNum">     796 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             for (const auto&amp; mi : setIterConflicting) {</span>
<span class="lineNum">     797 </span>                :            :                 // Don't allow the replacement to reduce the feerate of the
<span class="lineNum">     798 </span>                :            :                 // mempool.
<span class="lineNum">     799 </span>                :            :                 //
<span class="lineNum">     800 </span>                :            :                 // We usually don't want to accept replacements with lower
<span class="lineNum">     801 </span>                :            :                 // feerates than what they replaced as that would lower the
<span class="lineNum">     802 </span>                :            :                 // feerate of the next block. Requiring that the feerate always
<span class="lineNum">     803 </span>                :            :                 // be increased is also an easy-to-reason about way to prevent
<span class="lineNum">     804 </span>                :            :                 // DoS attacks via replacements.
<span class="lineNum">     805 </span>                :            :                 //
<span class="lineNum">     806 </span>                :            :                 // We only consider the feerates of transactions being directly
<span class="lineNum">     807 </span>                :            :                 // replaced, not their indirect descendants. While that does
<span class="lineNum">     808 </span>                :            :                 // mean high feerate children are ignored when deciding whether
<span class="lineNum">     809 </span>                :            :                 // or not to replace, we do require the replacement to pay more
<span class="lineNum">     810 </span>                :            :                 // overall fees too, mitigating most cases.
<span class="lineNum">     811 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 CFeeRate oldFeeRate(mi-&gt;GetModifiedFee(), mi-&gt;GetTxSize());</span>
<span class="lineNum">     812 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (newFeeRate &lt;= oldFeeRate)</span>
<span class="lineNum">     813 </span>                :            :                 {
<span class="lineNum">     814 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     return state.DoS(0, false,</span>
<span class="lineNum">     815 </span>                :            :                             REJECT_INSUFFICIENTFEE, &quot;insufficient fee&quot;, false,
<span class="lineNum">     816 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                             strprintf(&quot;rejecting replacement %s; new feerate %s &lt;= old feerate %s&quot;,</span>
<span class="lineNum">     817 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                   hash.ToString(),</span>
<span class="lineNum">     818 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                   newFeeRate.ToString(),</span>
<span class="lineNum">     819 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                   oldFeeRate.ToString()));</span>
<span class="lineNum">     820 </span>                :            :                 }
<span class="lineNum">     821 </span>                :            : 
<span class="lineNum">     822 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 for (const CTxIn &amp;txin : mi-&gt;GetTx().vin)</span>
<span class="lineNum">     823 </span>                :            :                 {
<span class="lineNum">     824 </span>                :<span class="lineNoCov">          0 :                     setConflictsParents.insert(txin.prevout.hash);</span>
<span class="lineNum">     825 </span>                :            :                 }
<span class="lineNum">     826 </span>                :            : 
<span class="lineNum">     827 </span>                :<span class="lineNoCov">          0 :                 nConflictingCount += mi-&gt;GetCountWithDescendants();</span>
<span class="lineNum">     828 </span>                :            :             }
<span class="lineNum">     829 </span>                :            :             // This potentially overestimates the number of actual descendants
<span class="lineNum">     830 </span>                :            :             // but we just want to be conservative to avoid doing too much
<span class="lineNum">     831 </span>                :            :             // work.
<span class="lineNum">     832 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (nConflictingCount &lt;= maxDescendantsToVisit) {</span>
<span class="lineNum">     833 </span>                :            :                 // If not too many to replace, then calculate the set of
<span class="lineNum">     834 </span>                :            :                 // transactions that would have to be evicted
<span class="lineNum">     835 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 for (CTxMemPool::txiter it : setIterConflicting) {</span>
<span class="lineNum">     836 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     pool.CalculateDescendants(it, allConflicting);</span>
<span class="lineNum">     837 </span>                :            :                 }
<span class="lineNum">     838 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 for (CTxMemPool::txiter it : allConflicting) {</span>
<span class="lineNum">     839 </span>                :<span class="lineNoCov">          0 :                     nConflictingFees += it-&gt;GetModifiedFee();</span>
<span class="lineNum">     840 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     nConflictingSize += it-&gt;GetTxSize();</span>
<span class="lineNum">     841 </span>                :            :                 }
<span class="lineNum">     842 </span>                :            :             } else {
<span class="lineNum">     843 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return state.DoS(0, false,</span>
<span class="lineNum">     844 </span>                :            :                         REJECT_NONSTANDARD, &quot;too many potential replacements&quot;, false,
<span class="lineNum">     845 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         strprintf(&quot;rejecting replacement %s; too many potential replacements (%d &gt; %d)\n&quot;,</span>
<span class="lineNum">     846 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                             hash.ToString(),</span>
<span class="lineNum">     847 </span>                :            :                             nConflictingCount,
<span class="lineNum">     848 </span>                :<span class="lineNoCov">          0 :                             maxDescendantsToVisit));</span>
<span class="lineNum">     849 </span>                :            :             }
<span class="lineNum">     850 </span>                :            : 
<span class="lineNum">     851 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             for (unsigned int j = 0; j &lt; tx.vin.size(); j++)</span>
<span class="lineNum">     852 </span>                :            :             {
<span class="lineNum">     853 </span>                :            :                 // We don't want to accept replacements that require low
<span class="lineNum">     854 </span>                :            :                 // feerate junk to be mined first. Ideally we'd keep track of
<span class="lineNum">     855 </span>                :            :                 // the ancestor feerates and make the decision based on that,
<span class="lineNum">     856 </span>                :            :                 // but for now requiring all new inputs to be confirmed works.
<span class="lineNum">     857 </span>                :<span class="lineNoCov">          0 :                 if (!setConflictsParents.count(tx.vin[j].prevout.hash))</span>
<span class="lineNum">     858 </span>                :            :                 {
<span class="lineNum">     859 </span>                :            :                     // Rather than check the UTXO set - potentially expensive -
<span class="lineNum">     860 </span>                :            :                     // it's cheaper to just check if the new input refers to a
<span class="lineNum">     861 </span>                :            :                     // tx that's in the mempool.
<span class="lineNum">     862 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if (pool.exists(tx.vin[j].prevout.hash)) {</span>
<span class="lineNum">     863 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         return state.DoS(0, false,</span>
<span class="lineNum">     864 </span>                :            :                                          REJECT_NONSTANDARD, &quot;replacement-adds-unconfirmed&quot;, false,
<span class="lineNum">     865 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                          strprintf(&quot;replacement %s adds unconfirmed input, idx %d&quot;,</span>
<span class="lineNum">     866 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                                   hash.ToString(), j));</span>
<span class="lineNum">     867 </span>                :            :                     }
<span class="lineNum">     868 </span>                :            :                 }
<span class="lineNum">     869 </span>                :            :             }
<span class="lineNum">     870 </span>                :            : 
<span class="lineNum">     871 </span>                :            :             // The replacement must pay greater fees than the transactions it
<span class="lineNum">     872 </span>                :            :             // replaces - if we did the bandwidth used by those conflicting
<span class="lineNum">     873 </span>                :            :             // transactions would not be paid for.
<span class="lineNum">     874 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (nModifiedFees &lt; nConflictingFees)</span>
<span class="lineNum">     875 </span>                :            :             {
<span class="lineNum">     876 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return state.DoS(0, false,</span>
<span class="lineNum">     877 </span>                :            :                                  REJECT_INSUFFICIENTFEE, &quot;insufficient fee&quot;, false,
<span class="lineNum">     878 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                  strprintf(&quot;rejecting replacement %s, less fees than conflicting txs; %s &lt; %s&quot;,</span>
<span class="lineNum">     879 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                           hash.ToString(), FormatMoney(nModifiedFees), FormatMoney(nConflictingFees)));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">     880 </span>                :            :             }
<span class="lineNum">     881 </span>                :            : 
<span class="lineNum">     882 </span>                :            :             // Finally in addition to paying more fees than the conflicts the
<span class="lineNum">     883 </span>                :            :             // new transaction must pay for its own bandwidth.
<span class="lineNum">     884 </span>                :<span class="lineNoCov">          0 :             CAmount nDeltaFees = nModifiedFees - nConflictingFees;</span>
<span class="lineNum">     885 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (nDeltaFees &lt; ::incrementalRelayFee.GetFee(nSize))</span>
<span class="lineNum">     886 </span>                :            :             {
<span class="lineNum">     887 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return state.DoS(0, false,</span>
<span class="lineNum">     888 </span>                :            :                         REJECT_INSUFFICIENTFEE, &quot;insufficient fee&quot;, false,
<span class="lineNum">     889 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         strprintf(&quot;rejecting replacement %s, not enough additional fees to relay; %s &lt; %s&quot;,</span>
<span class="lineNum">     890 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                               hash.ToString(),</span>
<span class="lineNum">     891 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                               FormatMoney(nDeltaFees),</span>
<span class="lineNum">     892 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                               FormatMoney(::incrementalRelayFee.GetFee(nSize))));</span>
<span class="lineNum">     893 </span>                :            :             }
<span class="lineNum">     894 </span>                :            :         }
<span class="lineNum">     895 </span>                :            : 
<span class="lineNum">     896 </span>                :<span class="lineCov">          3 :         constexpr unsigned int scriptVerifyFlags = STANDARD_SCRIPT_VERIFY_FLAGS;</span>
<span class="lineNum">     897 </span>                :            : 
<span class="lineNum">     898 </span>                :            :         // Check against previous transactions
<span class="lineNum">     899 </span>                :            :         // This is done last to help prevent CPU exhaustion denial-of-service attacks.
<span class="lineNum">     900 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         PrecomputedTransactionData txdata(tx);</span>
<span class="lineNum">     901 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         if (!CheckInputs(tx, state, view, true, scriptVerifyFlags, true, false, txdata)) {</span>
<span class="lineNum">     902 </span>                :            :             // SCRIPT_VERIFY_CLEANSTACK requires SCRIPT_VERIFY_WITNESS, so we
<span class="lineNum">     903 </span>                :            :             // need to turn both off, and compare against just turning off CLEANSTACK
<span class="lineNum">     904 </span>                :            :             // to see if the failure is specifically due to witness validation.
<span class="lineNum">     905 </span>                :<span class="lineNoCov">          0 :             CValidationState stateDummy; // Want reported failures to be from first CheckInputs</span>
<span class="lineNum">     906 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!tx.HasWitness() &amp;&amp; CheckInputs(tx, stateDummy, view, true, scriptVerifyFlags &amp; ~(SCRIPT_VERIFY_WITNESS | SCRIPT_VERIFY_CLEANSTACK), true, false, txdata) &amp;&amp;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">     907 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 !CheckInputs(tx, stateDummy, view, true, scriptVerifyFlags &amp; ~SCRIPT_VERIFY_CLEANSTACK, true, false, txdata)) {</span>
<span class="lineNum">     908 </span>                :            :                 // Only the witness is missing, so the transaction itself may be fine.
<span class="lineNum">     909 </span>                :            :                 state.SetCorruptionPossible();
<span class="lineNum">     910 </span>                :            :             }
<span class="lineNum">     911 </span>                :            :             return false; // state filled in by CheckInputs
<span class="lineNum">     912 </span>                :            :         }
<span class="lineNum">     913 </span>                :            : 
<span class="lineNum">     914 </span>                :            :         // Check again against the current block tip's script verification
<span class="lineNum">     915 </span>                :            :         // flags to cache our script execution flags. This is, of course,
<span class="lineNum">     916 </span>                :            :         // useless if the next block has different script flags from the
<span class="lineNum">     917 </span>                :            :         // previous one, but because the cache tracks script flags for us it
<span class="lineNum">     918 </span>                :            :         // will auto-invalidate and we'll just have a few blocks of extra
<span class="lineNum">     919 </span>                :            :         // misses on soft-fork activation.
<span class="lineNum">     920 </span>                :            :         //
<span class="lineNum">     921 </span>                :            :         // This is also useful in case of bugs in the standard flags that cause
<span class="lineNum">     922 </span>                :            :         // transactions to pass as valid when they're actually invalid. For
<span class="lineNum">     923 </span>                :            :         // instance the STRICTENC flag was incorrectly allowing certain
<span class="lineNum">     924 </span>                :            :         // CHECKSIG NOT scripts to pass, even though they were invalid.
<span class="lineNum">     925 </span>                :            :         //
<span class="lineNum">     926 </span>                :            :         // There is a similar check in CreateNewBlock() to prevent creating
<span class="lineNum">     927 </span>                :            :         // invalid blocks (using TestBlockValidity), however allowing such
<span class="lineNum">     928 </span>                :            :         // transactions into the mempool can be exploited as a DoS attack.
<span class="lineNum">     929 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         unsigned int currentBlockScriptVerifyFlags = GetBlockScriptFlags(chainActive.Tip(), chainparams.GetConsensus());</span>
<span class="lineNum">     930 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         if (!CheckInputsFromMempoolAndCache(tx, state, view, pool, currentBlockScriptVerifyFlags, true, txdata)) {</span>
<span class="lineNum">     931 </span>                :            :             return error(&quot;%s: BUG! PLEASE REPORT THIS! CheckInputs failed against latest-block but not STANDARD flags %s, %s&quot;,
<span class="lineNum">     932 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     __func__, hash.ToString(), FormatStateMessage(state));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">     933 </span>                :            :         }
<span class="lineNum">     934 </span>                :            : 
<span class="lineNum">     935 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :         if (test_accept) {</span>
<span class="lineNum">     936 </span>                :            :             // Tx was accepted, but not added
<span class="lineNum">     937 </span>                :            :             return true;
<span class="lineNum">     938 </span>                :            :         }
<span class="lineNum">     939 </span>                :            : 
<span class="lineNum">     940 </span>                :            :         // Remove conflicting transactions from the mempool
<span class="lineNum">     941 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         for (CTxMemPool::txiter it : allConflicting)</span>
<span class="lineNum">     942 </span>                :            :         {
<span class="lineNum">     943 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             LogPrint(BCLog::MEMPOOL, &quot;replacing tx %s with %s for %s BTC additional fees, %d delta bytes\n&quot;,</span>
<span class="lineNum">     944 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     it-&gt;GetTx().GetHash().ToString(),</span>
<span class="lineNum">     945 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     hash.ToString(),</span>
<span class="lineNum">     946 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     FormatMoney(nModifiedFees - nConflictingFees),</span>
<span class="lineNum">     947 </span>                :<span class="lineNoCov">          0 :                     (int)nSize - (int)nConflictingSize);</span>
<span class="lineNum">     948 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (plTxnReplaced)</span>
<span class="lineNum">     949 </span>                :<span class="lineNoCov">          0 :                 plTxnReplaced-&gt;push_back(it-&gt;GetSharedTx());</span>
<span class="lineNum">     950 </span>                :            :         }
<span class="lineNum">     951 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         pool.RemoveStaged(allConflicting, false, MemPoolRemovalReason::REPLACED);</span>
<span class="lineNum">     952 </span>                :            : 
<span class="lineNum">     953 </span>                :            :         // This transaction should only count for fee estimation if:
<span class="lineNum">     954 </span>                :            :         // - it isn't a BIP 125 replacement transaction (may not be widely supported)
<span class="lineNum">     955 </span>                :            :         // - it's not being re-added during a reorg which bypasses typical mempool fee limits
<span class="lineNum">     956 </span>                :            :         // - the node is not behind
<span class="lineNum">     957 </span>                :            :         // - the transaction is not dependent on any other transactions in the mempool
<span class="lineNum">     958 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineCov">          3 :         bool validForFeeEstimation = !fReplacementTransaction &amp;&amp; !bypass_limits &amp;&amp; IsCurrentForFeeEstimation() &amp;&amp; pool.HasNoInputsOf(tx);</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">     959 </span>                :            : 
<span class="lineNum">     960 </span>                :            :         // Store transaction in memory
<span class="lineNum">     961 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         pool.addUnchecked(entry, setAncestors, validForFeeEstimation);</span>
<span class="lineNum">     962 </span>                :            : 
<span class="lineNum">     963 </span>                :            :         // trim mempool and check if tx was trimmed
<span class="lineNum">     964 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         if (!bypass_limits) {</span>
<span class="lineNum">     965 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             LimitMempoolSize(pool, gArgs.GetArg(&quot;-maxmempool&quot;, DEFAULT_MAX_MEMPOOL_SIZE) * 1000000, gArgs.GetArg(&quot;-mempoolexpiry&quot;, DEFAULT_MEMPOOL_EXPIRY) * 60 * 60);</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>][<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>]
<span class="lineNum">     966 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!pool.exists(hash))</span>
<span class="lineNum">     967 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return state.DoS(0, false, REJECT_INSUFFICIENTFEE, &quot;mempool full&quot;);</span>
<span class="lineNum">     968 </span>                :            :         }
<span class="lineNum">     969 </span>                :            :     }
<span class="lineNum">     970 </span>                :            : 
<span class="lineNum">     971 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          3 :     GetMainSignals().TransactionAddedToMempool(ptx);</span>
<span class="lineNum">     972 </span>                :            : 
<span class="lineNum">     973 </span>                :            :     return true;
<span class="lineNum">     974 </span>                :            : }
<span class="lineNum">     975 </span>                :            : 
<span class="lineNum">     976 </span>                :            : /** (try to) add transaction to memory pool with a specified acceptance time **/
<span class="lineNum">     977 </span>                :<span class="lineCov">          4 : static bool AcceptToMemoryPoolWithTime(const CChainParams&amp; chainparams, CTxMemPool&amp; pool, CValidationState &amp;state, const CTransactionRef &amp;tx,</span>
<span class="lineNum">     978 </span>                :            :                         bool* pfMissingInputs, int64_t nAcceptTime, std::list&lt;CTransactionRef&gt;* plTxnReplaced,
<span class="lineNum">     979 </span>                :            :                         bool bypass_limits, const CAmount nAbsurdFee, bool test_accept) EXCLUSIVE_LOCKS_REQUIRED(cs_main)
<span class="lineNum">     980 </span>                :            : {
<span class="lineNum">     981 </span>                :<span class="lineCov">          8 :     std::vector&lt;COutPoint&gt; coins_to_uncache;</span>
<span class="lineNum">     982 </span>        [<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          4 :     bool res = AcceptToMemoryPoolWorker(chainparams, pool, state, tx, pfMissingInputs, nAcceptTime, plTxnReplaced, bypass_limits, nAbsurdFee, coins_to_uncache, test_accept);</span>
<span class="lineNum">     983 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          4 :     if (!res) {</span>
<span class="lineNum">     984 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         for (const COutPoint&amp; hashTx : coins_to_uncache)</span>
<span class="lineNum">     985 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             pcoinsTip-&gt;Uncache(hashTx);</span>
<span class="lineNum">     986 </span>                :            :     }
<span class="lineNum">     987 </span>                :            :     // After we've (potentially) uncached entries, ensure our coins cache is still within its size limits
<span class="lineNum">     988 </span>                :<span class="lineCov">          4 :     CValidationState stateDummy;</span>
<span class="lineNum">     989 </span>        [<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          4 :     FlushStateToDisk(chainparams, stateDummy, FlushStateMode::PERIODIC);</span>
<span class="lineNum">     990 </span>                :<span class="lineCov">          4 :     return res;</span>
<a name="991"><span class="lineNum">     991 </span>                :            : }</a>
<span class="lineNum">     992 </span>                :            : 
<span class="lineNum">     993 </span>                :<span class="lineCov">          4 : bool AcceptToMemoryPool(CTxMemPool&amp; pool, CValidationState &amp;state, const CTransactionRef &amp;tx,</span>
<span class="lineNum">     994 </span>                :            :                         bool* pfMissingInputs, std::list&lt;CTransactionRef&gt;* plTxnReplaced,
<span class="lineNum">     995 </span>                :            :                         bool bypass_limits, const CAmount nAbsurdFee, bool test_accept)
<span class="lineNum">     996 </span>                :            : {
<span class="lineNum">     997 </span>                :<span class="lineCov">          4 :     const CChainParams&amp; chainparams = Params();</span>
<span class="lineNum">     998 </span>                :<span class="lineCov">          4 :     return AcceptToMemoryPoolWithTime(chainparams, pool, state, tx, pfMissingInputs, GetTime(), plTxnReplaced, bypass_limits, nAbsurdFee, test_accept);</span>
<span class="lineNum">     999 </span>                :            : }
<span class="lineNum">    1000 </span>                :            : 
<span class="lineNum">    1001 </span>                :            : /**
<span class="lineNum">    1002 </span>                :            :  * Return transaction in txOut, and if it was found inside a block, its hash is placed in hashBlock.
<a name="1003"><span class="lineNum">    1003 </span>                :            :  * If blockIndex is provided, the transaction is fetched from the corresponding block.</a>
<span class="lineNum">    1004 </span>                :            :  */
<span class="lineNum">    1005 </span>                :<span class="lineNoCov">          0 : bool GetTransaction(const uint256&amp; hash, CTransactionRef&amp; txOut, const Consensus::Params&amp; consensusParams, uint256&amp; hashBlock, const CBlockIndex* const block_index)</span>
<span class="lineNum">    1006 </span>                :            : {
<span class="lineNum">    1007 </span>                :<span class="lineNoCov">          0 :     LOCK(cs_main);</span>
<span class="lineNum">    1008 </span>                :            : 
<span class="lineNum">    1009 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!block_index) {</span>
<span class="lineNum">    1010 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         CTransactionRef ptx = mempool.get(hash);</span>
<span class="lineNum">    1011 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ptx) {</span>
<span class="lineNum">    1012 </span>                :<span class="lineNoCov">          0 :             txOut = ptx;</span>
<span class="lineNum">    1013 </span>                :<span class="lineNoCov">          0 :             return true;</span>
<span class="lineNum">    1014 </span>                :            :         }
<span class="lineNum">    1015 </span>                :            : 
<span class="lineNum">    1016 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (g_txindex) {</span>
<span class="lineNum">    1017 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return g_txindex-&gt;FindTx(hash, hashBlock, txOut);</span>
<span class="lineNum">    1018 </span>                :            :         }
<span class="lineNum">    1019 </span>                :            :     } else {
<span class="lineNum">    1020 </span>                :<span class="lineNoCov">          0 :         CBlock block;</span>
<span class="lineNum">    1021 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ReadBlockFromDisk(block, block_index, consensusParams)) {</span>
<span class="lineNum">    1022 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             for (const auto&amp; tx : block.vtx) {</span>
<span class="lineNum">    1023 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (tx-&gt;GetHash() == hash) {</span>
<span class="lineNum">    1024 </span>                :<span class="lineNoCov">          0 :                     txOut = tx;</span>
<span class="lineNum">    1025 </span>                :<span class="lineNoCov">          0 :                     hashBlock = block_index-&gt;GetBlockHash();</span>
<span class="lineNum">    1026 </span>                :<span class="lineNoCov">          0 :                     return true;</span>
<span class="lineNum">    1027 </span>                :            :                 }
<span class="lineNum">    1028 </span>                :            :             }
<span class="lineNum">    1029 </span>                :            :         }
<span class="lineNum">    1030 </span>                :            :     }
<span class="lineNum">    1031 </span>                :            : 
<span class="lineNum">    1032 </span>                :            :     return false;
<span class="lineNum">    1033 </span>                :            : }
<span class="lineNum">    1034 </span>                :            : 
<span class="lineNum">    1035 </span>                :            : 
<span class="lineNum">    1036 </span>                :            : 
<span class="lineNum">    1037 </span>                :            : 
<span class="lineNum">    1038 </span>                :            : 
<span class="lineNum">    1039 </span>                :            : 
<span class="lineNum">    1040 </span>                :            : //////////////////////////////////////////////////////////////////////////////
<span class="lineNum">    1041 </span>                :            : //
<span class="lineNum">    1042 </span>                :            : // CBlock and CBlockIndex
<a name="1043"><span class="lineNum">    1043 </span>                :            : //</a>
<span class="lineNum">    1044 </span>                :            : 
<span class="lineNum">    1045 </span>                :<span class="lineCov">       1369 : static bool WriteBlockToDisk(const CBlock&amp; block, CDiskBlockPos&amp; pos, const CMessageHeader::MessageStartChars&amp; messageStart)</span>
<span class="lineNum">    1046 </span>                :            : {
<span class="lineNum">    1047 </span>                :            :     // Open history file to append
<span class="lineNum">    1048 </span>                :<span class="lineCov">       2738 :     CAutoFile fileout(OpenBlockFile(pos), SER_DISK, CLIENT_VERSION);</span>
<span class="lineNum">    1049 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1369 times"> + </span>]:<span class="lineCov">       1369 :     if (fileout.IsNull())</span>
<span class="lineNum">    1050 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;WriteBlockToDisk: OpenBlockFile failed&quot;);</span>
<span class="lineNum">    1051 </span>                :            : 
<span class="lineNum">    1052 </span>                :            :     // Write index header
<span class="lineNum">    1053 </span>                :<span class="lineCov">       1369 :     unsigned int nSize = GetSerializeSize(block, fileout.GetVersion());</span>
<span class="lineNum">    1054 </span>[<span class="branchCov" title="Branch 1 was taken 1369 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 1369 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       1369 :     fileout &lt;&lt; messageStart &lt;&lt; nSize;</span>
<span class="lineNum">    1055 </span>                :            : 
<span class="lineNum">    1056 </span>                :            :     // Write block
<span class="lineNum">    1057 </span>        [<span class="branchCov" title="Branch 1 was taken 1369 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1369 :     long fileOutPos = ftell(fileout.Get());</span>
<span class="lineNum">    1058 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1369 times"> + </span>]:<span class="lineCov">       1369 :     if (fileOutPos &lt; 0)</span>
<span class="lineNum">    1059 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;WriteBlockToDisk: ftell failed&quot;);</span>
<span class="lineNum">    1060 </span>                :<span class="lineCov">       1369 :     pos.nPos = (unsigned int)fileOutPos;</span>
<span class="lineNum">    1061 </span>        [<span class="branchCov" title="Branch 1 was taken 1369 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1369 :     fileout &lt;&lt; block;</span>
<span class="lineNum">    1062 </span>                :            : 
<span class="lineNum">    1063 </span>                :            :     return true;
<span class="lineNum">    1064 </span>                :            : }
<span class="lineNum">    1065 </span>                :            : 
<span class="lineNum">    1066 </span>                :<span class="lineCov">        430 : bool ReadBlockFromDisk(CBlock&amp; block, const CDiskBlockPos&amp; pos, const Consensus::Params&amp; consensusParams)</span>
<span class="lineNum">    1067 </span>                :            : {
<span class="lineNum">    1068 </span>                :<span class="lineCov">        430 :     block.SetNull();</span>
<span class="lineNum">    1069 </span>                :            : 
<span class="lineNum">    1070 </span>                :            :     // Open history file to read
<span class="lineNum">    1071 </span>                :<span class="lineCov">        860 :     CAutoFile filein(OpenBlockFile(pos, true), SER_DISK, CLIENT_VERSION);</span>
<span class="lineNum">    1072 </span>        [<span class="branchCov" title="Branch 0 was taken 104 times"> + </span><span class="branchCov" title="Branch 1 was taken 326 times"> + </span>]:<span class="lineCov">        430 :     if (filein.IsNull())</span>
<span class="lineNum">    1073 </span>[<span class="branchCov" title="Branch 1 was taken 104 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineCov">        208 :         return error(&quot;ReadBlockFromDisk: OpenBlockFile failed for %s&quot;, pos.ToString());</span>
<span class="lineNum">    1074 </span>                :            : 
<span class="lineNum">    1075 </span>                :            :     // Read block
<span class="lineNum">    1076 </span>                :            :     try {
<span class="lineNum">    1077 </span>        [<span class="branchCov" title="Branch 1 was taken 326 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        326 :         filein &gt;&gt; block;</span>
<span class="lineNum">    1078 </span>                :            :     }
<span class="lineNum">    1079 </span>                :<span class="lineNoCov">          0 :     catch (const std::exception&amp; e) {</span>
<span class="lineNum">    1080 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: Deserialize or I/O error - %s at %s&quot;, __func__, e.what(), pos.ToString());</span>
<span class="lineNum">    1081 </span>                :            :     }
<span class="lineNum">    1082 </span>                :            : 
<span class="lineNum">    1083 </span>                :            :     // Check the header
<span class="lineNum">    1084 </span>[<span class="branchCov" title="Branch 1 was taken 326 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 326 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        326 :     if (!CheckProofOfWork(block.GetHash(), block.nBits, consensusParams))</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 326 times"> + </span>]
<span class="lineNum">    1085 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;ReadBlockFromDisk: Errors in block header at %s&quot;, pos.ToString());</span>
<span class="lineNum">    1086 </span>                :            : 
<span class="lineNum">    1087 </span>                :            :     return true;
<span class="lineNum">    1088 </span>                :            : }
<span class="lineNum">    1089 </span>                :            : 
<span class="lineNum">    1090 </span>                :<span class="lineCov">        430 : bool ReadBlockFromDisk(CBlock&amp; block, const CBlockIndex* pindex, const Consensus::Params&amp; consensusParams)</span>
<span class="lineNum">    1091 </span>                :            : {
<span class="lineNum">    1092 </span>                :<span class="lineCov">        430 :     CDiskBlockPos blockPos;</span>
<span class="lineNum">    1093 </span>                :            :     {
<span class="lineNum">    1094 </span>                :<span class="lineCov">        430 :         LOCK(cs_main);</span>
<span class="lineNum">    1095 </span>                :<span class="lineCov">        430 :         blockPos = pindex-&gt;GetBlockPos();</span>
<span class="lineNum">    1096 </span>                :            :     }
<span class="lineNum">    1097 </span>                :            : 
<span class="lineNum">    1098 </span>        [<span class="branchCov" title="Branch 1 was taken 326 times"> + </span><span class="branchCov" title="Branch 2 was taken 104 times"> + </span>]:<span class="lineCov">        430 :     if (!ReadBlockFromDisk(block, blockPos, consensusParams))</span>
<span class="lineNum">    1099 </span>                :            :         return false;
<span class="lineNum">    1100 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 326 times"> + </span>]:<span class="lineCov">        326 :     if (block.GetHash() != pindex-&gt;GetBlockHash())</span>
<span class="lineNum">    1101 </span>                :            :         return error(&quot;ReadBlockFromDisk(CBlock&amp;, CBlockIndex*): GetHash() doesn't match index for %s at %s&quot;,
<span class="lineNum">    1102 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineCov">        430 :                 pindex-&gt;ToString(), pindex-&gt;GetBlockPos().ToString());</span>
<span class="lineNum">    1103 </span>                :            :     return true;
<span class="lineNum">    1104 </span>                :            : }
<span class="lineNum">    1105 </span>                :            : 
<span class="lineNum">    1106 </span>                :<span class="lineNoCov">          0 : bool ReadRawBlockFromDisk(std::vector&lt;uint8_t&gt;&amp; block, const CDiskBlockPos&amp; pos, const CMessageHeader::MessageStartChars&amp; message_start)</span>
<span class="lineNum">    1107 </span>                :            : {
<span class="lineNum">    1108 </span>                :<span class="lineNoCov">          0 :     CDiskBlockPos hpos = pos;</span>
<span class="lineNum">    1109 </span>                :<span class="lineNoCov">          0 :     hpos.nPos -= 8; // Seek back 8 bytes for meta header</span>
<span class="lineNum">    1110 </span>                :<span class="lineNoCov">          0 :     CAutoFile filein(OpenBlockFile(hpos, true), SER_DISK, CLIENT_VERSION);</span>
<span class="lineNum">    1111 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (filein.IsNull()) {</span>
<span class="lineNum">    1112 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: OpenBlockFile failed for %s&quot;, __func__, pos.ToString());</span>
<span class="lineNum">    1113 </span>                :            :     }
<span class="lineNum">    1114 </span>                :            : 
<span class="lineNum">    1115 </span>                :            :     try {
<span class="lineNum">    1116 </span>                :            :         CMessageHeader::MessageStartChars blk_start;
<span class="lineNum">    1117 </span>                :            :         unsigned int blk_size;
<span class="lineNum">    1118 </span>                :            : 
<span class="lineNum">    1119 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         filein &gt;&gt; blk_start &gt;&gt; blk_size;</span>
<span class="lineNum">    1120 </span>                :            : 
<span class="lineNum">    1121 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (memcmp(blk_start, message_start, CMessageHeader::MESSAGE_START_SIZE)) {</span>
<span class="lineNum">    1122 </span>                :<span class="lineNoCov">          0 :             return error(&quot;%s: Block magic mismatch for %s: %s versus expected %s&quot;, __func__, pos.ToString(),</span>
<span class="lineNum">    1123 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     HexStr(blk_start, blk_start + CMessageHeader::MESSAGE_START_SIZE),</span>
<span class="lineNum">    1124 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     HexStr(message_start, message_start + CMessageHeader::MESSAGE_START_SIZE));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    1125 </span>                :            :         }
<span class="lineNum">    1126 </span>                :            : 
<span class="lineNum">    1127 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (blk_size &gt; MAX_SIZE) {</span>
<span class="lineNum">    1128 </span>                :<span class="lineNoCov">          0 :             return error(&quot;%s: Block data is larger than maximum deserialization size for %s: %s versus %s&quot;, __func__, pos.ToString(),</span>
<span class="lineNum">    1129 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     blk_size, MAX_SIZE);</span>
<span class="lineNum">    1130 </span>                :            :         }
<span class="lineNum">    1131 </span>                :            : 
<span class="lineNum">    1132 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         block.resize(blk_size); // Zeroing of memory is intentional here</span>
<span class="lineNum">    1133 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         filein.read((char*)block.data(), blk_size);</span>
<span class="lineNum">    1134 </span>                :<span class="lineNoCov">          0 :     } catch(const std::exception&amp; e) {</span>
<span class="lineNum">    1135 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: Read from block file failed: %s for %s&quot;, __func__, e.what(), pos.ToString());</span>
<span class="lineNum">    1136 </span>                :            :     }
<span class="lineNum">    1137 </span>                :            : 
<span class="lineNum">    1138 </span>                :<span class="lineNoCov">          0 :     return true;</span>
<a name="1139"><span class="lineNum">    1139 </span>                :            : }</a>
<span class="lineNum">    1140 </span>                :            : 
<span class="lineNum">    1141 </span>                :<span class="lineNoCov">          0 : bool ReadRawBlockFromDisk(std::vector&lt;uint8_t&gt;&amp; block, const CBlockIndex* pindex, const CMessageHeader::MessageStartChars&amp; message_start)</span>
<span class="lineNum">    1142 </span>                :            : {
<span class="lineNum">    1143 </span>                :<span class="lineNoCov">          0 :     CDiskBlockPos block_pos;</span>
<span class="lineNum">    1144 </span>                :            :     {
<span class="lineNum">    1145 </span>                :<span class="lineNoCov">          0 :         LOCK(cs_main);</span>
<span class="lineNum">    1146 </span>                :<span class="lineNoCov">          0 :         block_pos = pindex-&gt;GetBlockPos();</span>
<span class="lineNum">    1147 </span>                :            :     }
<span class="lineNum">    1148 </span>                :            : 
<span class="lineNum">    1149 </span>                :<span class="lineNoCov">          0 :     return ReadRawBlockFromDisk(block, block_pos, message_start);</span>
<a name="1150"><span class="lineNum">    1150 </span>                :            : }</a>
<span class="lineNum">    1151 </span>                :            : 
<span class="lineNum">    1152 </span>                :<span class="lineCov">      18078 : CAmount GetBlockSubsidy(int nHeight, const Consensus::Params&amp; consensusParams)</span>
<span class="lineNum">    1153 </span>                :            : {
<span class="lineNum">    1154 </span>                :<span class="lineCov">      18078 :     int halvings = nHeight / consensusParams.nSubsidyHalvingInterval;</span>
<span class="lineNum">    1155 </span>                :            :     // Force block reward to zero when right shift is undefined.
<span class="lineNum">    1156 </span>        [<span class="branchCov" title="Branch 0 was taken 17515 times"> + </span><span class="branchCov" title="Branch 1 was taken 563 times"> + </span>]:<span class="lineCov">      18078 :     if (halvings &gt;= 64)</span>
<span class="lineNum">    1157 </span>                :            :         return 0;
<span class="lineNum">    1158 </span>                :            : 
<span class="lineNum">    1159 </span>                :<span class="lineCov">      17515 :     CAmount nSubsidy = 50 * COIN;</span>
<span class="lineNum">    1160 </span>                :            :     // Subsidy is cut in half every 210,000 blocks which will occur approximately every 4 years.
<span class="lineNum">    1161 </span>                :<span class="lineCov">      17515 :     nSubsidy &gt;&gt;= halvings;</span>
<span class="lineNum">    1162 </span>                :<span class="lineCov">      17515 :     return nSubsidy;</span>
<a name="1163"><span class="lineNum">    1163 </span>                :            : }</a>
<span class="lineNum">    1164 </span>                :            : 
<span class="lineNum">    1165 </span>                :<span class="lineCov">       6562 : bool IsInitialBlockDownload()</span>
<span class="lineNum">    1166 </span>                :            : {
<span class="lineNum">    1167 </span>                :            :     // Once this function has returned false, it must remain false.
<span class="lineNum">    1168 </span>                :            :     static std::atomic&lt;bool&gt; latchToFalse{false};
<span class="lineNum">    1169 </span>                :            :     // Optimization: pre-test latch before taking the lock.
<span class="lineNum">    1170 </span>        [<span class="branchCov" title="Branch 0 was taken 941 times"> + </span><span class="branchCov" title="Branch 1 was taken 5621 times"> + </span>]:<span class="lineCov">       6562 :     if (latchToFalse.load(std::memory_order_relaxed))</span>
<span class="lineNum">    1171 </span>                :            :         return false;
<span class="lineNum">    1172 </span>                :            : 
<span class="lineNum">    1173 </span>                :<span class="lineCov">        941 :     LOCK(cs_main);</span>
<span class="lineNum">    1174 </span>        [<span class="branchCov" title="Branch 0 was taken 941 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        941 :     if (latchToFalse.load(std::memory_order_relaxed))</span>
<span class="lineNum">    1175 </span>                :            :         return false;
<span class="lineNum">    1176 </span>[<span class="branchCov" title="Branch 0 was taken 941 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 941 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        941 :     if (fImporting || fReindex)</span>
<span class="lineNum">    1177 </span>                :            :         return true;
<span class="lineNum">    1178 </span>        [<span class="branchCov" title="Branch 0 was taken 941 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        941 :     if (chainActive.Tip() == nullptr)</span>
<span class="lineNum">    1179 </span>                :            :         return true;
<span class="lineNum">    1180 </span>        [<span class="branchCov" title="Branch 0 was taken 941 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        941 :     if (chainActive.Tip()-&gt;nChainWork &lt; nMinimumChainWork)</span>
<span class="lineNum">    1181 </span>                :            :         return true;
<span class="lineNum">    1182 </span>[<span class="branchCov" title="Branch 1 was taken 941 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 4 times"> + </span><span class="branchCov" title="Branch 4 was taken 937 times"> + </span>]:<span class="lineCov">        941 :     if (chainActive.Tip()-&gt;GetBlockTime() &lt; (GetTime() - nMaxTipAge))</span>
<span class="lineNum">    1183 </span>                :            :         return true;
<span class="lineNum">    1184 </span>        [<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          4 :     LogPrintf(&quot;Leaving InitialBlockDownload (latching to false)\n&quot;);</span>
<span class="lineNum">    1185 </span>                :<span class="lineCov">          4 :     latchToFalse.store(true, std::memory_order_relaxed);</span>
<span class="lineNum">    1186 </span>                :<span class="lineCov">          4 :     return false;</span>
<span class="lineNum">    1187 </span>                :            : }
<span class="lineNum">    1188 </span>                :            : 
<span class="lineNum">    1189 </span>                :            : CBlockIndex *pindexBestForkTip = nullptr, *pindexBestForkBase = nullptr;
<span class="lineNum">    1190 </span>                :            : 
<span class="lineNum">    1191 </span>                :<span class="lineNoCov">          0 : static void AlertNotify(const std::string&amp; strMessage)</span>
<span class="lineNum">    1192 </span>                :            : {
<span class="lineNum">    1193 </span>                :<span class="lineNoCov">          0 :     uiInterface.NotifyAlertChanged();</span>
<span class="lineNum">    1194 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :     std::string strCmd = gArgs.GetArg(&quot;-alertnotify&quot;, &quot;&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    1195 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (strCmd.empty()) return;</span>
<span class="lineNum">    1196 </span>                :            : 
<span class="lineNum">    1197 </span>                :            :     // Alert text should be plain ascii coming from a trusted source, but to
<span class="lineNum">    1198 </span>                :            :     // be safe we first strip anything not in safeChars, then add single quotes around
<span class="lineNum">    1199 </span>                :            :     // the whole string before passing it to the shell:
<span class="lineNum">    1200 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     std::string singleQuote(&quot;'&quot;);</span>
<span class="lineNum">    1201 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     std::string safeStatus = SanitizeString(strMessage);</span>
<span class="lineNum">    1202 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :     safeStatus = singleQuote+safeStatus+singleQuote;</span>
<span class="lineNum">    1203 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     boost::replace_all(strCmd, &quot;%s&quot;, safeStatus);</span>
<span class="lineNum">    1204 </span>                :            : 
<span class="lineNum">    1205 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     std::thread t(runCommand, strCmd);</span>
<span class="lineNum">    1206 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     t.detach(); // thread runs free</span>
<span class="lineNum">    1207 </span>                :            : }
<span class="lineNum">    1208 </span>                :            : 
<span class="lineNum">    1209 </span>                :<span class="lineCov">       1339 : static void CheckForkWarningConditions() EXCLUSIVE_LOCKS_REQUIRED(cs_main)</span>
<span class="lineNum">    1210 </span>                :            : {
<span class="lineNum">    1211 </span>                :<span class="lineCov">       1339 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    1212 </span>                :            :     // Before we get past initial download, we cannot reliably alert about forks
<span class="lineNum">    1213 </span>                :            :     // (we assume we don't get stuck on a fork before finishing our initial sync)
<span class="lineNum">    1214 </span>        [<span class="branchCov" title="Branch 1 was taken 1134 times"> + </span><span class="branchCov" title="Branch 2 was taken 205 times"> + </span>]:<span class="lineCov">       1339 :     if (IsInitialBlockDownload())</span>
<span class="lineNum">    1215 </span>                :            :         return;
<span class="lineNum">    1216 </span>                :            : 
<span class="lineNum">    1217 </span>                :            :     // If our best fork is no longer within 72 blocks (+/- 12 hours if no one mines it)
<span class="lineNum">    1218 </span>                :            :     // of our head, drop it
<span class="lineNum">    1219 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1134 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       1134 :     if (pindexBestForkTip &amp;&amp; chainActive.Height() - pindexBestForkTip-&gt;nHeight &gt;= 72)</span>
<span class="lineNum">    1220 </span>                :<span class="lineNoCov">          0 :         pindexBestForkTip = nullptr;</span>
<span class="lineNum">    1221 </span>                :            : 
<span class="lineNum">    1222 </span>[<span class="branchCov" title="Branch 0 was taken 1134 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchCov" title="Branch 3 was taken 1127 times"> + </span>]:<span class="lineCov">       1148 :     if (pindexBestForkTip || (pindexBestInvalid &amp;&amp; pindexBestInvalid-&gt;nChainWork &gt; chainActive.Tip()-&gt;nChainWork + (GetBlockProof(*chainActive.Tip()) * 6)))</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>][<span class="branchCov" title="Branch 8 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 10 was not taken"> - </span><span class="branchCov" title="Branch 11 was taken 7 times"> + </span>]
<span class="lineNum">    1223 </span>                :            :     {
<span class="lineNum">    1224 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!GetfLargeWorkForkFound() &amp;&amp; pindexBestForkBase)</span>
<span class="lineNum">    1225 </span>                :            :         {
<span class="lineNum">    1226 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             std::string warning = std::string(&quot;'Warning: Large-work fork detected, forking after block &quot;) +</span>
<span class="lineNum">    1227 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 pindexBestForkBase-&gt;phashBlock-&gt;ToString() + std::string(&quot;'&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    1228 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             AlertNotify(warning);</span>
<span class="lineNum">    1229 </span>                :            :         }
<span class="lineNum">    1230 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindexBestForkTip &amp;&amp; pindexBestForkBase)</span>
<span class="lineNum">    1231 </span>                :            :         {
<span class="lineNum">    1232 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             LogPrintf(&quot;%s: Warning: Large valid fork found\n  forking the chain at height %d (%s)\n  lasting to height %d (%s).\nChain state database corruption likely.\n&quot;, __func__,</span>
<span class="lineNum">    1233 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                    pindexBestForkBase-&gt;nHeight, pindexBestForkBase-&gt;phashBlock-&gt;ToString(),</span>
<span class="lineNum">    1234 </span>                :<span class="lineNoCov">          0 :                    pindexBestForkTip-&gt;nHeight, pindexBestForkTip-&gt;phashBlock-&gt;ToString());</span>
<span class="lineNum">    1235 </span>                :<span class="lineNoCov">          0 :             SetfLargeWorkForkFound(true);</span>
<span class="lineNum">    1236 </span>                :            :         }
<span class="lineNum">    1237 </span>                :            :         else
<span class="lineNum">    1238 </span>                :            :         {
<span class="lineNum">    1239 </span>                :<span class="lineNoCov">          0 :             LogPrintf(&quot;%s: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\nChain state database corruption likely.\n&quot;, __func__);</span>
<span class="lineNum">    1240 </span>                :<span class="lineCov">       1339 :             SetfLargeWorkInvalidChainFound(true);</span>
<span class="lineNum">    1241 </span>                :            :         }
<span class="lineNum">    1242 </span>                :            :     }
<span class="lineNum">    1243 </span>                :            :     else
<span class="lineNum">    1244 </span>                :            :     {
<span class="lineNum">    1245 </span>                :<span class="lineCov">       1134 :         SetfLargeWorkForkFound(false);</span>
<span class="lineNum">    1246 </span>                :<span class="lineCov">       1134 :         SetfLargeWorkInvalidChainFound(false);</span>
<span class="lineNum">    1247 </span>                :            :     }
<a name="1248"><span class="lineNum">    1248 </span>                :            : }</a>
<span class="lineNum">    1249 </span>                :            : 
<span class="lineNum">    1250 </span>                :<span class="lineCov">          3 : static void CheckForkWarningConditionsOnNewFork(CBlockIndex* pindexNewForkTip) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</span>
<span class="lineNum">    1251 </span>                :            : {
<span class="lineNum">    1252 </span>                :<span class="lineCov">          3 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    1253 </span>                :            :     // If we are on a fork that is sufficiently large, set a warning flag
<span class="lineNum">    1254 </span>                :<span class="lineCov">          3 :     CBlockIndex* pfork = pindexNewForkTip;</span>
<span class="lineNum">    1255 </span>                :<span class="lineCov">          3 :     CBlockIndex* plonger = chainActive.Tip();</span>
<span class="lineNum">    1256 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          6 :     while (pfork &amp;&amp; pfork != plonger)</span>
<span class="lineNum">    1257 </span>                :            :     {
<span class="lineNum">    1258 </span>[<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         while (plonger &amp;&amp; plonger-&gt;nHeight &gt; pfork-&gt;nHeight)</span>
<span class="lineNum">    1259 </span>                :<span class="lineNoCov">          0 :             plonger = plonger-&gt;pprev;</span>
<span class="lineNum">    1260 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :         if (pfork == plonger)</span>
<span class="lineNum">    1261 </span>                :            :             break;
<span class="lineNum">    1262 </span>                :<span class="lineCov">          3 :         pfork = pfork-&gt;pprev;</span>
<span class="lineNum">    1263 </span>                :            :     }
<span class="lineNum">    1264 </span>                :            : 
<span class="lineNum">    1265 </span>                :            :     // We define a condition where we should warn the user about as a fork of at least 7 blocks
<span class="lineNum">    1266 </span>                :            :     // with a tip within 72 blocks (+/- 12 hours if no one mines it) of ours
<span class="lineNum">    1267 </span>                :            :     // We use 7 blocks rather arbitrarily as it represents just under 10% of sustained network
<span class="lineNum">    1268 </span>                :            :     // hash rate operating on the fork.
<span class="lineNum">    1269 </span>                :            :     // or a chain that is entirely longer than ours and invalid (note that this should be detected by both)
<span class="lineNum">    1270 </span>                :            :     // We define it this way because it allows us to only store the highest fork tip (+ base) which meets
<span class="lineNum">    1271 </span>                :            :     // the 7-block condition and from this always have the most-likely-to-cause-warning fork
<span class="lineNum">    1272 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          6 :     if (pfork &amp;&amp; (!pindexBestForkTip || pindexNewForkTip-&gt;nHeight &gt; pindexBestForkTip-&gt;nHeight) &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 3 times"> + </span>]
<span class="lineNum">    1273 </span>[<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          9 :             pindexNewForkTip-&gt;nChainWork - pfork-&gt;nChainWork &gt; (GetBlockProof(*pfork) * 7) &amp;&amp;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 6 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>][<span class="branchNoExec" title="Branch 9 was not executed"> # </span><span class="branchNoExec" title="Branch 10 was not executed"> # </span>]
<span class="lineNum">    1274 </span>                :<span class="lineNoCov">          0 :             chainActive.Height() - pindexNewForkTip-&gt;nHeight &lt; 72)</span>
<span class="lineNum">    1275 </span>                :            :     {
<span class="lineNum">    1276 </span>                :<span class="lineNoCov">          0 :         pindexBestForkTip = pindexNewForkTip;</span>
<span class="lineNum">    1277 </span>                :<span class="lineNoCov">          0 :         pindexBestForkBase = pfork;</span>
<span class="lineNum">    1278 </span>                :            :     }
<span class="lineNum">    1279 </span>                :            : 
<span class="lineNum">    1280 </span>                :<span class="lineCov">          3 :     CheckForkWarningConditions();</span>
<span class="lineNum">    1281 </span>                :<span class="lineCov">          3 : }</span>
<span class="lineNum">    1282 </span>                :            : 
<span class="lineNum">    1283 </span>                :<span class="lineCov">          6 : void static InvalidChainFound(CBlockIndex* pindexNew) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</span>
<span class="lineNum">    1284 </span>                :            : {
<span class="lineNum">    1285 </span>  [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 4 times"> + </span>]:<span class="lineCov">         10 :     if (!pindexBestInvalid || pindexNew-&gt;nChainWork &gt; pindexBestInvalid-&gt;nChainWork)</span>
<span class="lineNum">    1286 </span>                :<span class="lineCov">          2 :         pindexBestInvalid = pindexNew;</span>
<span class="lineNum">    1287 </span>                :            : 
<span class="lineNum">    1288 </span>        [<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          6 :     LogPrintf(&quot;%s: invalid block=%s  height=%d  log2_work=%.8g  date=%s\n&quot;, __func__,</span>
<span class="lineNum">    1289 </span>        [<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          6 :       pindexNew-&gt;GetBlockHash().ToString(), pindexNew-&gt;nHeight,</span>
<span class="lineNum">    1290 </span>        [<span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :       log(pindexNew-&gt;nChainWork.getdouble())/log(2.0), FormatISO8601DateTime(pindexNew-&gt;GetBlockTime()));</span>
<span class="lineNum">    1291 </span>                :<span class="lineCov">         12 :     CBlockIndex *tip = chainActive.Tip();</span>
<span class="lineNum">    1292 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          6 :     assert (tip);</span>
<span class="lineNum">    1293 </span>        [<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          6 :     LogPrintf(&quot;%s:  current best=%s  height=%d  log2_work=%.8g  date=%s\n&quot;, __func__,</span>
<span class="lineNum">    1294 </span>[<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          6 :       tip-&gt;GetBlockHash().ToString(), chainActive.Height(), log(tip-&gt;nChainWork.getdouble())/log(2.0),</span>
<span class="lineNum">    1295 </span>                :<span class="lineCov">          6 :       FormatISO8601DateTime(tip-&gt;GetBlockTime()));</span>
<span class="lineNum">    1296 </span>                :<span class="lineCov">          6 :     CheckForkWarningConditions();</span>
<a name="1297"><span class="lineNum">    1297 </span>                :<span class="lineCov">          6 : }</span></a>
<span class="lineNum">    1298 </span>                :            : 
<span class="lineNum">    1299 </span>                :<span class="lineCov">          3 : void CChainState::InvalidBlockFound(CBlockIndex *pindex, const CValidationState &amp;state) {</span>
<span class="lineNum">    1300 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :     if (!state.CorruptionPossible()) {</span>
<span class="lineNum">    1301 </span>                :<span class="lineCov">          3 :         pindex-&gt;nStatus |= BLOCK_FAILED_VALID;</span>
<span class="lineNum">    1302 </span>                :<span class="lineCov">          6 :         m_failed_blocks.insert(pindex);</span>
<span class="lineNum">    1303 </span>                :<span class="lineCov">          3 :         setDirtyBlockIndex.insert(pindex);</span>
<span class="lineNum">    1304 </span>                :<span class="lineCov">          6 :         setBlockIndexCandidates.erase(pindex);</span>
<span class="lineNum">    1305 </span>                :<span class="lineCov">          3 :         InvalidChainFound(pindex);</span>
<span class="lineNum">    1306 </span>                :            :     }
<a name="1307"><span class="lineNum">    1307 </span>                :<span class="lineCov">          3 : }</span></a>
<span class="lineNum">    1308 </span>                :            : 
<span class="lineNum">    1309 </span>                :<span class="lineCov">      41504 : void UpdateCoins(const CTransaction&amp; tx, CCoinsViewCache&amp; inputs, CTxUndo &amp;txundo, int nHeight)</span>
<span class="lineNum">    1310 </span>                :            : {
<span class="lineNum">    1311 </span>                :            :     // mark inputs spent
<span class="lineNum">    1312 </span>                :            :     if (!tx.IsCoinBase()) {
<span class="lineNum">    1313 </span>                :<span class="lineCov">      34665 :         txundo.vprevout.reserve(tx.vin.size());</span>
<span class="lineNum">    1314 </span>        [<span class="branchCov" title="Branch 0 was taken 34666 times"> + </span><span class="branchCov" title="Branch 1 was taken 34665 times"> + </span>]:<span class="lineCov">      69331 :         for (const CTxIn &amp;txin : tx.vin) {</span>
<span class="lineNum">    1315 </span>                :<span class="lineCov">      34666 :             txundo.vprevout.emplace_back();</span>
<span class="lineNum">    1316 </span>                :<span class="lineCov">      34666 :             bool is_spent = inputs.SpendCoin(txin.prevout, &amp;txundo.vprevout.back());</span>
<span class="lineNum">    1317 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 34666 times"> + </span>]:<span class="lineCov">      34666 :             assert(is_spent);</span>
<span class="lineNum">    1318 </span>                :            :         }
<span class="lineNum">    1319 </span>                :            :     }
<span class="lineNum">    1320 </span>                :            :     // add outputs
<span class="lineNum">    1321 </span>                :<span class="lineCov">      41504 :     AddCoins(inputs, tx, nHeight);</span>
<a name="1322"><span class="lineNum">    1322 </span>                :<span class="lineCov">      41504 : }</span></a>
<span class="lineNum">    1323 </span>                :            : 
<span class="lineNum">    1324 </span>                :<span class="lineCov">          1 : void UpdateCoins(const CTransaction&amp; tx, CCoinsViewCache&amp; inputs, int nHeight)</span>
<span class="lineNum">    1325 </span>                :            : {
<span class="lineNum">    1326 </span>                :<span class="lineCov">          2 :     CTxUndo txundo;</span>
<span class="lineNum">    1327 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     UpdateCoins(tx, inputs, txundo, nHeight);</span>
<a name="1328"><span class="lineNum">    1328 </span>                :<span class="lineCov">          1 : }</span></a>
<span class="lineNum">    1329 </span>                :            : 
<span class="lineNum">    1330 </span>                :<span class="lineCov">     216397 : bool CScriptCheck::operator()() {</span>
<span class="lineNum">    1331 </span>                :<span class="lineCov">     432794 :     const CScript &amp;scriptSig = ptxTo-&gt;vin[nIn].scriptSig;</span>
<span class="lineNum">    1332 </span>                :<span class="lineCov">     216397 :     const CScriptWitness *witness = &amp;ptxTo-&gt;vin[nIn].scriptWitness;</span>
<span class="lineNum">    1333 </span>                :<span class="lineCov">     216397 :     return VerifyScript(scriptSig, m_tx_out.scriptPubKey, witness, nFlags, CachingTransactionSignatureChecker(ptxTo, nIn, m_tx_out.nValue, cacheStore, *txdata), &amp;error);</span>
<a name="1334"><span class="lineNum">    1334 </span>                :            : }</a>
<span class="lineNum">    1335 </span>                :            : 
<span class="lineNum">    1336 </span>                :<span class="lineCov">       1336 : int GetSpendHeight(const CCoinsViewCache&amp; inputs)</span>
<span class="lineNum">    1337 </span>                :            : {
<span class="lineNum">    1338 </span>                :<span class="lineCov">       1336 :     LOCK(cs_main);</span>
<span class="lineNum">    1339 </span>        [<span class="branchCov" title="Branch 1 was taken 1336 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1336 :     CBlockIndex* pindexPrev = LookupBlockIndex(inputs.GetBestBlock());</span>
<span class="lineNum">    1340 </span>                :<span class="lineCov">       1336 :     return pindexPrev-&gt;nHeight + 1;</span>
<span class="lineNum">    1341 </span>                :            : }
<span class="lineNum">    1342 </span>                :            : 
<span class="lineNum">    1343 </span>                :            : 
<span class="lineNum">    1344 </span>                :<span class="lineCov">         73 : static CuckooCache::cache&lt;uint256, SignatureCacheHasher&gt; scriptExecutionCache;</span>
<span class="lineNum">    1345 </span>                :<span class="lineCov">         73 : static uint256 scriptExecutionCacheNonce(GetRandHash());</span>
<span class="lineNum">    1346 </span>                :            : 
<span class="lineNum">    1347 </span>                :<span class="lineCov">        355 : void InitScriptExecutionCache() {</span>
<span class="lineNum">    1348 </span>                :            :     // nMaxCacheSize is unsigned. If -maxsigcachesize is set to zero,
<span class="lineNum">    1349 </span>                :            :     // setup_bytes creates the minimum possible cache (2 elements).
<span class="lineNum">    1350 </span>[<span class="branchCov" title="Branch 1 was taken 355 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 355 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        355 :     size_t nMaxCacheSize = std::min(std::max((int64_t)0, gArgs.GetArg(&quot;-maxsigcachesize&quot;, DEFAULT_MAX_SIG_CACHE_SIZE) / 2), MAX_MAX_SIG_CACHE_SIZE) * ((size_t) 1 &lt;&lt; 20);</span>
<span class="lineNum">    1351 </span>                :<span class="lineCov">        355 :     size_t nElems = scriptExecutionCache.setup_bytes(nMaxCacheSize);</span>
<span class="lineNum">    1352 </span>                :<span class="lineCov">        355 :     LogPrintf(&quot;Using %zu MiB out of %zu/2 requested for script execution cache, able to store %zu elements\n&quot;,</span>
<span class="lineNum">    1353 </span>                :<span class="lineCov">        710 :             (nElems*sizeof(uint256)) &gt;&gt;20, (nMaxCacheSize*2)&gt;&gt;20, nElems);</span>
<span class="lineNum">    1354 </span>                :<span class="lineCov">        355 : }</span>
<span class="lineNum">    1355 </span>                :            : 
<span class="lineNum">    1356 </span>                :            : /**
<span class="lineNum">    1357 </span>                :            :  * Check whether all inputs of this transaction are valid (no double spends, scripts &amp; sigs, amounts)
<span class="lineNum">    1358 </span>                :            :  * This does not modify the UTXO set.
<span class="lineNum">    1359 </span>                :            :  *
<span class="lineNum">    1360 </span>                :            :  * If pvChecks is not nullptr, script checks are pushed onto it instead of being performed inline. Any
<span class="lineNum">    1361 </span>                :            :  * script checks which are not necessary (eg due to script execution cache hits) are, obviously,
<span class="lineNum">    1362 </span>                :            :  * not pushed onto pvChecks/run.
<span class="lineNum">    1363 </span>                :            :  *
<span class="lineNum">    1364 </span>                :            :  * Setting cacheSigStore/cacheFullScriptStore to false will remove elements from the corresponding cache
<span class="lineNum">    1365 </span>                :            :  * which are matched. This is useful for checking blocks where we will likely never need the cache
<span class="lineNum">    1366 </span>                :            :  * entry again.
<span class="lineNum">    1367 </span>                :            :  *
<span class="lineNum">    1368 </span>                :            :  * Non-static (and re-declared) in src/test/txvalidationcache_tests.cpp
<span class="lineNum">    1369 </span>                :            :  */
<span class="lineNum">    1370 </span>                :<span class="lineCov">     259201 : bool CheckInputs(const CTransaction&amp; tx, CValidationState &amp;state, const CCoinsViewCache &amp;inputs, bool fScriptChecks, unsigned int flags, bool cacheSigStore, bool cacheFullScriptStore, PrecomputedTransactionData&amp; txdata, std::vector&lt;CScriptCheck&gt; *pvChecks) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</span>
<span class="lineNum">    1371 </span>                :            : {
<span class="lineNum">    1372 </span>                :            :     if (!tx.IsCoinBase())
<span class="lineNum">    1373 </span>                :            :     {
<span class="lineNum">    1374 </span>        [<span class="branchCov" title="Branch 0 was taken 130167 times"> + </span><span class="branchCov" title="Branch 1 was taken 129034 times"> + </span>]:<span class="lineCov">     259201 :         if (pvChecks)</span>
<span class="lineNum">    1375 </span>                :<span class="lineCov">     130167 :             pvChecks-&gt;reserve(tx.vin.size());</span>
<span class="lineNum">    1376 </span>                :            : 
<span class="lineNum">    1377 </span>                :            :         // The first loop above does all the inexpensive checks.
<span class="lineNum">    1378 </span>                :            :         // Only if ALL inputs pass do we perform expensive ECDSA signature checks.
<span class="lineNum">    1379 </span>                :            :         // Helps prevent CPU exhaustion attacks.
<span class="lineNum">    1380 </span>                :            : 
<span class="lineNum">    1381 </span>                :            :         // Skip script verification when connecting blocks under the
<span class="lineNum">    1382 </span>                :            :         // assumevalid block. Assuming the assumevalid block is valid this
<span class="lineNum">    1383 </span>                :            :         // is safe because block merkle hashes are still computed and checked,
<span class="lineNum">    1384 </span>                :            :         // Of course, if an assumed valid block is invalid due to false scriptSigs
<span class="lineNum">    1385 </span>                :            :         // this optimization would allow an invalid chain to be accepted.
<span class="lineNum">    1386 </span>        [<span class="branchCov" title="Branch 0 was taken 259201 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     259201 :         if (fScriptChecks) {</span>
<span class="lineNum">    1387 </span>                :            :             // First check if script executions have been cached with the same
<span class="lineNum">    1388 </span>                :            :             // flags. Note that this assumes that the inputs provided are
<span class="lineNum">    1389 </span>                :            :             // correct (ie that the transaction hash which is in tx's prevouts
<span class="lineNum">    1390 </span>                :            :             // properly commits to the scriptPubKey in the inputs view of that
<span class="lineNum">    1391 </span>                :            :             // transaction).
<span class="lineNum">    1392 </span>                :<span class="lineCov">     259201 :             uint256 hashCacheEntry;</span>
<span class="lineNum">    1393 </span>                :            :             // We only use the first 19 bytes of nonce to avoid a second SHA
<span class="lineNum">    1394 </span>                :            :             // round - giving us 19 + 32 + 4 = 55 bytes (+ 8 + 1 = 64)
<span class="lineNum">    1395 </span>                :            :             static_assert(55 - sizeof(flags) - 32 &gt;= 128/8, &quot;Want at least 128 bits of nonce for script execution cache&quot;);
<span class="lineNum">    1396 </span>                :<span class="lineCov">     259201 :             CSHA256().Write(scriptExecutionCacheNonce.begin(), 55 - sizeof(flags) - 32).Write(tx.GetWitnessHash().begin(), 32).Write((unsigned char*)&amp;flags, sizeof(flags)).Finalize(hashCacheEntry.begin());</span>
<span class="lineNum">    1397 </span>                :<span class="lineCov">     259201 :             AssertLockHeld(cs_main); //TODO: Remove this requirement by making CuckooCache not require external locks</span>
<span class="lineNum">    1398 </span>        [<span class="branchCov" title="Branch 1 was taken 195706 times"> + </span><span class="branchCov" title="Branch 2 was taken 63495 times"> + </span>]:<span class="lineCov">     259201 :             if (scriptExecutionCache.contains(hashCacheEntry, !cacheFullScriptStore)) {</span>
<span class="lineNum">    1399 </span>                :<span class="lineCov">     259201 :                 return true;</span>
<span class="lineNum">    1400 </span>                :            :             }
<span class="lineNum">    1401 </span>                :            : 
<span class="lineNum">    1402 </span>        [<span class="branchCov" title="Branch 0 was taken 214141 times"> + </span><span class="branchCov" title="Branch 1 was taken 132472 times"> + </span>]:<span class="lineCov">     346613 :             for (unsigned int i = 0; i &lt; tx.vin.size(); i++) {</span>
<span class="lineNum">    1403 </span>                :<span class="lineCov">     428282 :                 const COutPoint &amp;prevout = tx.vin[i].prevout;</span>
<span class="lineNum">    1404 </span>                :<span class="lineCov">     214141 :                 const Coin&amp; coin = inputs.AccessCoin(prevout);</span>
<span class="lineNum">    1405 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 214141 times"> + </span>]:<span class="lineCov">     214141 :                 assert(!coin.IsSpent());</span>
<span class="lineNum">    1406 </span>                :            : 
<span class="lineNum">    1407 </span>                :            :                 // We very carefully only pass in things to CScriptCheck which
<span class="lineNum">    1408 </span>                :            :                 // are clearly committed to by tx' witness hash. This provides
<span class="lineNum">    1409 </span>                :            :                 // a sanity check that our caching is not introducing consensus
<span class="lineNum">    1410 </span>                :            :                 // failures through additional data in, eg, the coins being
<span class="lineNum">    1411 </span>                :            :                 // spent being checked as a part of CScriptCheck.
<span class="lineNum">    1412 </span>                :            : 
<span class="lineNum">    1413 </span>                :            :                 // Verify signature
<span class="lineNum">    1414 </span>                :<span class="lineCov">     579189 :                 CScriptCheck check(coin.out, tx, i, flags, cacheSigStore, &amp;txdata);</span>
<span class="lineNum">    1415 </span>        [<span class="branchCov" title="Branch 0 was taken 66676 times"> + </span><span class="branchCov" title="Branch 1 was taken 147465 times"> + </span>]:<span class="lineCov">     214141 :                 if (pvChecks) {</span>
<span class="lineNum">    1416 </span>                :<span class="lineNoCov">          0 :                     pvChecks-&gt;push_back(CScriptCheck());</span>
<span class="lineNum">    1417 </span>                :<span class="lineCov">      66676 :                     check.swap(pvChecks-&gt;back());</span>
<span class="lineNum">    1418 </span>[<span class="branchCov" title="Branch 1 was taken 147465 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 63234 times"> + </span><span class="branchCov" title="Branch 4 was taken 84231 times"> + </span>]:<span class="lineCov">     147465 :                 } else if (!check()) {</span>
<span class="lineNum">    1419 </span>        [<span class="branchCov" title="Branch 0 was taken 63232 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">      63234 :                     if (flags &amp; STANDARD_NOT_MANDATORY_VERIFY_FLAGS) {</span>
<span class="lineNum">    1420 </span>                :            :                         // Check whether the failure was caused by a
<span class="lineNum">    1421 </span>                :            :                         // non-mandatory script verification check, such as
<span class="lineNum">    1422 </span>                :            :                         // non-standard DER encodings or non-null dummy
<span class="lineNum">    1423 </span>                :            :                         // arguments; if so, don't trigger DoS protection to
<span class="lineNum">    1424 </span>                :            :                         // avoid splitting the network between upgraded and
<span class="lineNum">    1425 </span>                :            :                         // non-upgraded nodes.
<span class="lineNum">    1426 </span>                :            :                         CScriptCheck check2(coin.out, tx, i,
<span class="lineNum">    1427 </span>                :<span class="lineCov">      16382 :                                 flags &amp; ~STANDARD_NOT_MANDATORY_VERIFY_FLAGS, cacheSigStore, &amp;txdata);</span>
<span class="lineNum">    1428 </span>[<span class="branchCov" title="Branch 1 was taken 63232 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 46850 times"> + </span><span class="branchCov" title="Branch 4 was taken 16382 times"> + </span>]:<span class="lineCov">      63232 :                         if (check2())</span>
<span class="lineNum">    1429 </span>[<span class="branchCov" title="Branch 1 was taken 46850 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 46850 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">      46850 :                             return state.Invalid(false, REJECT_NONSTANDARD, strprintf(&quot;non-mandatory-script-verify-flag (%s)&quot;, ScriptErrorString(check.GetScriptError())));</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 46850 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">    1430 </span>                :            :                     }
<span class="lineNum">    1431 </span>                :            :                     // Failures of other flags indicate a transaction that is
<span class="lineNum">    1432 </span>                :            :                     // invalid in new blocks, e.g. an invalid P2SH. We DoS ban
<span class="lineNum">    1433 </span>                :            :                     // such nodes as they are not following the protocol. That
<span class="lineNum">    1434 </span>                :            :                     // said during an upgrade careful thought should be taken
<span class="lineNum">    1435 </span>                :            :                     // as to the correct behavior - we may want to continue
<span class="lineNum">    1436 </span>                :            :                     // peering with non-upgraded nodes even after soft-fork
<span class="lineNum">    1437 </span>                :            :                     // super-majority signaling has occurred.
<span class="lineNum">    1438 </span>[<span class="branchCov" title="Branch 1 was taken 16384 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 16384 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">      32768 :                     return state.DoS(100,false, REJECT_INVALID, strprintf(&quot;mandatory-script-verify-flag-failed (%s)&quot;, ScriptErrorString(check.GetScriptError())));</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 16384 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">    1439 </span>                :            :                 }
<span class="lineNum">    1440 </span>                :            :             }
<span class="lineNum">    1441 </span>                :            : 
<span class="lineNum">    1442 </span>        [<span class="branchCov" title="Branch 0 was taken 63491 times"> + </span><span class="branchCov" title="Branch 1 was taken 68981 times"> + </span>]:<span class="lineCov">     132472 :             if (cacheFullScriptStore &amp;&amp; !pvChecks) {</span>
<span class="lineNum">    1443 </span>                :            :                 // We executed all of the provided scripts, and were told to
<span class="lineNum">    1444 </span>                :            :                 // cache the result. Do so now.
<span class="lineNum">    1445 </span>                :<span class="lineCov">     132472 :                 scriptExecutionCache.insert(hashCacheEntry);</span>
<span class="lineNum">    1446 </span>                :            :             }
<span class="lineNum">    1447 </span>                :            :         }
<span class="lineNum">    1448 </span>                :            :     }
<span class="lineNum">    1449 </span>                :            : 
<span class="lineNum">    1450 </span>                :            :     return true;
<span class="lineNum">    1451 </span>                :            : }
<span class="lineNum">    1452 </span>                :            : 
<a name="1453"><span class="lineNum">    1453 </span>                :            : namespace {</a>
<span class="lineNum">    1454 </span>                :            : 
<span class="lineNum">    1455 </span>                :<span class="lineCov">       1271 : bool UndoWriteToDisk(const CBlockUndo&amp; blockundo, CDiskBlockPos&amp; pos, const uint256&amp; hashBlock, const CMessageHeader::MessageStartChars&amp; messageStart)</span>
<span class="lineNum">    1456 </span>                :            : {
<span class="lineNum">    1457 </span>                :            :     // Open history file to append
<span class="lineNum">    1458 </span>                :<span class="lineCov">       2542 :     CAutoFile fileout(OpenUndoFile(pos), SER_DISK, CLIENT_VERSION);</span>
<span class="lineNum">    1459 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1271 times"> + </span>]:<span class="lineCov">       1271 :     if (fileout.IsNull())</span>
<span class="lineNum">    1460 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: OpenUndoFile failed&quot;, __func__);</span>
<span class="lineNum">    1461 </span>                :            : 
<span class="lineNum">    1462 </span>                :            :     // Write index header
<span class="lineNum">    1463 </span>        [<span class="branchCov" title="Branch 1 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1271 :     unsigned int nSize = GetSerializeSize(blockundo, fileout.GetVersion());</span>
<span class="lineNum">    1464 </span>[<span class="branchCov" title="Branch 1 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       1271 :     fileout &lt;&lt; messageStart &lt;&lt; nSize;</span>
<span class="lineNum">    1465 </span>                :            : 
<span class="lineNum">    1466 </span>                :            :     // Write undo data
<span class="lineNum">    1467 </span>        [<span class="branchCov" title="Branch 1 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1271 :     long fileOutPos = ftell(fileout.Get());</span>
<span class="lineNum">    1468 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1271 times"> + </span>]:<span class="lineCov">       1271 :     if (fileOutPos &lt; 0)</span>
<span class="lineNum">    1469 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: ftell failed&quot;, __func__);</span>
<span class="lineNum">    1470 </span>                :<span class="lineCov">       1271 :     pos.nPos = (unsigned int)fileOutPos;</span>
<span class="lineNum">    1471 </span>        [<span class="branchCov" title="Branch 1 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1271 :     fileout &lt;&lt; blockundo;</span>
<span class="lineNum">    1472 </span>                :            : 
<span class="lineNum">    1473 </span>                :            :     // calculate &amp; write checksum
<span class="lineNum">    1474 </span>                :<span class="lineCov">       1271 :     CHashWriter hasher(SER_GETHASH, PROTOCOL_VERSION);</span>
<span class="lineNum">    1475 </span>                :<span class="lineCov">       1271 :     hasher &lt;&lt; hashBlock;</span>
<span class="lineNum">    1476 </span>                :<span class="lineCov">       1271 :     hasher &lt;&lt; blockundo;</span>
<span class="lineNum">    1477 </span>        [<span class="branchCov" title="Branch 1 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1271 :     fileout &lt;&lt; hasher.GetHash();</span>
<span class="lineNum">    1478 </span>                :            : 
<span class="lineNum">    1479 </span>                :<span class="lineCov">       1271 :     return true;</span>
<a name="1480"><span class="lineNum">    1480 </span>                :            : }</a>
<span class="lineNum">    1481 </span>                :            : 
<span class="lineNum">    1482 </span>                :<span class="lineCov">          7 : static bool UndoReadFromDisk(CBlockUndo&amp; blockundo, const CBlockIndex *pindex)</span>
<span class="lineNum">    1483 </span>                :            : {
<span class="lineNum">    1484 </span>                :<span class="lineCov">          7 :     CDiskBlockPos pos = pindex-&gt;GetUndoPos();</span>
<span class="lineNum">    1485 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">          7 :     if (pos.IsNull()) {</span>
<span class="lineNum">    1486 </span>                :<span class="lineNoCov">          0 :         return error(&quot;%s: no undo data available&quot;, __func__);</span>
<span class="lineNum">    1487 </span>                :            :     }
<span class="lineNum">    1488 </span>                :            : 
<span class="lineNum">    1489 </span>                :            :     // Open history file to read
<span class="lineNum">    1490 </span>                :<span class="lineCov">          7 :     CAutoFile filein(OpenUndoFile(pos, true), SER_DISK, CLIENT_VERSION);</span>
<span class="lineNum">    1491 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">          7 :     if (filein.IsNull())</span>
<span class="lineNum">    1492 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: OpenUndoFile failed&quot;, __func__);</span>
<span class="lineNum">    1493 </span>                :            : 
<span class="lineNum">    1494 </span>                :            :     // Read block
<span class="lineNum">    1495 </span>                :<span class="lineCov">          7 :     uint256 hashChecksum;</span>
<span class="lineNum">    1496 </span>                :<span class="lineCov">          7 :     CHashVerifier&lt;CAutoFile&gt; verifier(&amp;filein); // We need a CHashVerifier as reserializing may lose data</span>
<span class="lineNum">    1497 </span>                :            :     try {
<span class="lineNum">    1498 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         verifier &lt;&lt; pindex-&gt;pprev-&gt;GetBlockHash();</span>
<span class="lineNum">    1499 </span>                :<span class="lineCov">          7 :         verifier &gt;&gt; blockundo;</span>
<span class="lineNum">    1500 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :         filein &gt;&gt; hashChecksum;</span>
<span class="lineNum">    1501 </span>                :            :     }
<span class="lineNum">    1502 </span>                :<span class="lineNoCov">          0 :     catch (const std::exception&amp; e) {</span>
<span class="lineNum">    1503 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: Deserialize or I/O error - %s&quot;, __func__, e.what());</span>
<span class="lineNum">    1504 </span>                :            :     }
<span class="lineNum">    1505 </span>                :            : 
<span class="lineNum">    1506 </span>                :            :     // Verify checksum
<span class="lineNum">    1507 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">          7 :     if (hashChecksum != verifier.GetHash())</span>
<span class="lineNum">    1508 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: Checksum mismatch&quot;, __func__);</span>
<span class="lineNum">    1509 </span>                :            : 
<span class="lineNum">    1510 </span>                :            :     return true;
<span class="lineNum">    1511 </span>                :            : }
<span class="lineNum">    1512 </span>                :            : 
<span class="lineNum">    1513 </span>                :            : /** Abort with a message */
<span class="lineNum">    1514 </span>                :<span class="lineNoCov">          0 : static bool AbortNode(const std::string&amp; strMessage, const std::string&amp; userMessage=&quot;&quot;)</span>
<span class="lineNum">    1515 </span>                :            : {
<span class="lineNum">    1516 </span>                :<span class="lineNoCov">          0 :     SetMiscWarning(strMessage);</span>
<span class="lineNum">    1517 </span>                :<span class="lineNoCov">          0 :     LogPrintf(&quot;*** %s\n&quot;, strMessage);</span>
<span class="lineNum">    1518 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :     uiInterface.ThreadSafeMessageBox(</span>
<span class="lineNum">    1519 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         userMessage.empty() ? _(&quot;Error: A fatal internal error occurred, see debug.log for details&quot;) : userMessage,</span>
<span class="lineNum">    1520 </span>                :            :         &quot;&quot;, CClientUIInterface::MSG_ERROR);
<span class="lineNum">    1521 </span>                :<span class="lineNoCov">          0 :     StartShutdown();</span>
<span class="lineNum">    1522 </span>                :<span class="lineNoCov">          0 :     return false;</span>
<a name="1523"><span class="lineNum">    1523 </span>                :            : }</a>
<span class="lineNum">    1524 </span>                :            : 
<span class="lineNum">    1525 </span>                :<span class="lineNoCov">          0 : static bool AbortNode(CValidationState&amp; state, const std::string&amp; strMessage, const std::string&amp; userMessage=&quot;&quot;)</span>
<span class="lineNum">    1526 </span>                :            : {
<span class="lineNum">    1527 </span>                :<span class="lineNoCov">          0 :     AbortNode(strMessage, userMessage);</span>
<span class="lineNum">    1528 </span>                :<span class="lineNoCov">          0 :     return state.Error(strMessage);</span>
<span class="lineNum">    1529 </span>                :            : }
<span class="lineNum">    1530 </span>                :            : 
<span class="lineNum">    1531 </span>                :            : } // namespace
<span class="lineNum">    1532 </span>                :            : 
<span class="lineNum">    1533 </span>                :            : /**
<span class="lineNum">    1534 </span>                :            :  * Restore the UTXO in a Coin at a given COutPoint
<span class="lineNum">    1535 </span>                :            :  * @param undo The Coin to be restored.
<span class="lineNum">    1536 </span>                :            :  * @param view The coins view to which to apply the changes.
<span class="lineNum">    1537 </span>                :            :  * @param out The out point that corresponds to the tx input.
<a name="1538"><span class="lineNum">    1538 </span>                :            :  * @return A DisconnectResult as an int</a>
<span class="lineNum">    1539 </span>                :            :  */
<span class="lineNum">    1540 </span>                :<span class="lineCov">       1703 : int ApplyTxInUndo(Coin&amp;&amp; undo, CCoinsViewCache&amp; view, const COutPoint&amp; out)</span>
<span class="lineNum">    1541 </span>                :            : {
<span class="lineNum">    1542 </span>                :<span class="lineCov">       1703 :     bool fClean = true;</span>
<span class="lineNum">    1543 </span>                :            : 
<span class="lineNum">    1544 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 1702 times"> + </span>]:<span class="lineCov">       1703 :     if (view.HaveCoin(out)) fClean = false; // overwriting transaction output</span>
<span class="lineNum">    1545 </span>                :            : 
<span class="lineNum">    1546 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1703 times"> + </span>]:<span class="lineCov">       1703 :     if (undo.nHeight == 0) {</span>
<span class="lineNum">    1547 </span>                :            :         // Missing undo metadata (height and coinbase). Older versions included this
<span class="lineNum">    1548 </span>                :            :         // information only in undo records for the last spend of a transactions'
<span class="lineNum">    1549 </span>                :            :         // outputs. This implies that it must be present for some other output of the same tx.
<span class="lineNum">    1550 </span>                :<span class="lineNoCov">          0 :         const Coin&amp; alternate = AccessByTxid(view, out.hash);</span>
<span class="lineNum">    1551 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!alternate.IsSpent()) {</span>
<span class="lineNum">    1552 </span>                :<span class="lineNoCov">          0 :             undo.nHeight = alternate.nHeight;</span>
<span class="lineNum">    1553 </span>                :<span class="lineNoCov">          0 :             undo.fCoinBase = alternate.fCoinBase;</span>
<span class="lineNum">    1554 </span>                :            :         } else {
<span class="lineNum">    1555 </span>                :            :             return DISCONNECT_FAILED; // adding output for transaction without known metadata
<span class="lineNum">    1556 </span>                :            :         }
<span class="lineNum">    1557 </span>                :            :     }
<span class="lineNum">    1558 </span>                :            :     // The potential_overwrite parameter to AddCoin is only allowed to be false if we know for
<span class="lineNum">    1559 </span>                :            :     // sure that the coin did not already exist in the cache. As we have queried for that above
<span class="lineNum">    1560 </span>                :            :     // using HaveCoin, we don't need to guess. When fClean is false, a coin already existed and
<span class="lineNum">    1561 </span>                :            :     // it is an overwrite.
<span class="lineNum">    1562 </span>                :<span class="lineCov">       1703 :     view.AddCoin(out, std::move(undo), !fClean);</span>
<span class="lineNum">    1563 </span>                :            : 
<span class="lineNum">    1564 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1702 times"> + </span>]:<span class="lineCov">       1703 :     return fClean ? DISCONNECT_OK : DISCONNECT_UNCLEAN;</span>
<span class="lineNum">    1565 </span>                :            : }
<span class="lineNum">    1566 </span>                :            : 
<a name="1567"><span class="lineNum">    1567 </span>                :            : /** Undo the effects of this block (with given index) on the UTXO set represented by coins.</a>
<span class="lineNum">    1568 </span>                :            :  *  When FAILED is returned, view is left in an indeterminate state. */
<span class="lineNum">    1569 </span>                :<span class="lineCov">          7 : DisconnectResult CChainState::DisconnectBlock(const CBlock&amp; block, const CBlockIndex* pindex, CCoinsViewCache&amp; view)</span>
<span class="lineNum">    1570 </span>                :            : {
<span class="lineNum">    1571 </span>                :<span class="lineCov">          7 :     bool fClean = true;</span>
<span class="lineNum">    1572 </span>                :            : 
<span class="lineNum">    1573 </span>                :<span class="lineCov">          7 :     CBlockUndo blockUndo;</span>
<span class="lineNum">    1574 </span>[<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 7 times"> + </span>]:<span class="lineCov">          7 :     if (!UndoReadFromDisk(blockUndo, pindex)) {</span>
<span class="lineNum">    1575 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         error(&quot;DisconnectBlock(): failure reading undo data&quot;);</span>
<span class="lineNum">    1576 </span>                :            :         return DISCONNECT_FAILED;
<span class="lineNum">    1577 </span>                :            :     }
<span class="lineNum">    1578 </span>                :            : 
<span class="lineNum">    1579 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">          7 :     if (blockUndo.vtxundo.size() + 1 != block.vtx.size()) {</span>
<span class="lineNum">    1580 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         error(&quot;DisconnectBlock(): block and undo data inconsistent&quot;);</span>
<span class="lineNum">    1581 </span>                :            :         return DISCONNECT_FAILED;
<span class="lineNum">    1582 </span>                :            :     }
<span class="lineNum">    1583 </span>                :            : 
<span class="lineNum">    1584 </span>                :            :     // undo transactions in reverse order
<span class="lineNum">    1585 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">         14 :     for (int i = block.vtx.size() - 1; i &gt;= 0; i--) {</span>
<span class="lineNum">    1586 </span>                :<span class="lineCov">         21 :         const CTransaction &amp;tx = *(block.vtx[i]);</span>
<span class="lineNum">    1587 </span>                :<span class="lineCov">          7 :         uint256 hash = tx.GetHash();</span>
<span class="lineNum">    1588 </span>                :<span class="lineCov">          7 :         bool is_coinbase = tx.IsCoinBase();</span>
<span class="lineNum">    1589 </span>                :            : 
<span class="lineNum">    1590 </span>                :            :         // Check that all outputs are available and match the outputs in the block itself
<span class="lineNum">    1591 </span>                :            :         // exactly.
<span class="lineNum">    1592 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">         14 :         for (size_t o = 0; o &lt; tx.vout.size(); o++) {</span>
<span class="lineNum">    1593 </span>                :<span class="lineCov">         21 :             if (!tx.vout[o].scriptPubKey.IsUnspendable()) {</span>
<span class="lineNum">    1594 </span>                :<span class="lineCov">         14 :                 COutPoint out(hash, o);</span>
<span class="lineNum">    1595 </span>                :<span class="lineCov">          7 :                 Coin coin;</span>
<span class="lineNum">    1596 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :                 bool is_spent = view.SpendCoin(out, &amp;coin);</span>
<span class="lineNum">    1597 </span>[<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         14 :                 if (!is_spent || tx.vout[o] != coin.out || pindex-&gt;nHeight != coin.nHeight || is_coinbase != coin.fCoinBase) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<span class="lineNum">    1598 </span>                :            :                     fClean = false; // transaction output mismatch
<span class="lineNum">    1599 </span>                :            :                 }
<span class="lineNum">    1600 </span>                :            :             }
<span class="lineNum">    1601 </span>                :            :         }
<span class="lineNum">    1602 </span>                :            : 
<span class="lineNum">    1603 </span>                :            :         // restore inputs
<span class="lineNum">    1604 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">          7 :         if (i &gt; 0) { // not coinbases</span>
<span class="lineNum">    1605 </span>                :<span class="lineNoCov">          0 :             CTxUndo &amp;txundo = blockUndo.vtxundo[i-1];</span>
<span class="lineNum">    1606 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (txundo.vprevout.size() != tx.vin.size()) {</span>
<span class="lineNum">    1607 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 error(&quot;DisconnectBlock(): transaction and undo data inconsistent&quot;);</span>
<span class="lineNum">    1608 </span>                :<span class="lineNoCov">          0 :                 return DISCONNECT_FAILED;</span>
<span class="lineNum">    1609 </span>                :            :             }
<span class="lineNum">    1610 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             for (unsigned int j = tx.vin.size(); j-- &gt; 0;) {</span>
<span class="lineNum">    1611 </span>                :<span class="lineNoCov">          0 :                 const COutPoint &amp;out = tx.vin[j].prevout;</span>
<span class="lineNum">    1612 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 int res = ApplyTxInUndo(std::move(txundo.vprevout[j]), view, out);</span>
<span class="lineNum">    1613 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (res == DISCONNECT_FAILED) return DISCONNECT_FAILED;</span>
<span class="lineNum">    1614 </span>                :<span class="lineNoCov">          0 :                 fClean = fClean &amp;&amp; res != DISCONNECT_UNCLEAN;</span>
<span class="lineNum">    1615 </span>                :            :             }
<span class="lineNum">    1616 </span>                :            :             // At this point, all of txundo.vprevout should have been moved out.
<span class="lineNum">    1617 </span>                :            :         }
<span class="lineNum">    1618 </span>                :            :     }
<span class="lineNum">    1619 </span>                :            : 
<span class="lineNum">    1620 </span>                :            :     // move best block pointer to prevout block
<span class="lineNum">    1621 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :     view.SetBestBlock(pindex-&gt;pprev-&gt;GetBlockHash());</span>
<span class="lineNum">    1622 </span>                :            : 
<span class="lineNum">    1623 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">          7 :     return fClean ? DISCONNECT_OK : DISCONNECT_UNCLEAN;</span>
<span class="lineNum">    1624 </span>                :            : }
<span class="lineNum">    1625 </span>                :            : 
<span class="lineNum">    1626 </span>                :<span class="lineCov">          2 : void static FlushBlockFile(bool fFinalize = false)</span>
<span class="lineNum">    1627 </span>                :            : {
<span class="lineNum">    1628 </span>                :<span class="lineCov">          2 :     LOCK(cs_LastBlockFile);</span>
<span class="lineNum">    1629 </span>                :            : 
<span class="lineNum">    1630 </span>                :<span class="lineCov">          4 :     CDiskBlockPos posOld(nLastBlockFile, 0);</span>
<span class="lineNum">    1631 </span>                :<span class="lineCov">          2 :     bool status = true;</span>
<span class="lineNum">    1632 </span>                :            : 
<span class="lineNum">    1633 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :     FILE *fileOld = OpenBlockFile(posOld);</span>
<span class="lineNum">    1634 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :     if (fileOld) {</span>
<span class="lineNum">    1635 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :         if (fFinalize)</span>
<span class="lineNum">    1636 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :             status &amp;= TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);</span>
<span class="lineNum">    1637 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :         status &amp;= FileCommit(fileOld);</span>
<span class="lineNum">    1638 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :         fclose(fileOld);</span>
<span class="lineNum">    1639 </span>                :            :     }
<span class="lineNum">    1640 </span>                :            : 
<span class="lineNum">    1641 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :     fileOld = OpenUndoFile(posOld);</span>
<span class="lineNum">    1642 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :     if (fileOld) {</span>
<span class="lineNum">    1643 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :         if (fFinalize)</span>
<span class="lineNum">    1644 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :             status &amp;= TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nUndoSize);</span>
<span class="lineNum">    1645 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :         status &amp;= FileCommit(fileOld);</span>
<span class="lineNum">    1646 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :         fclose(fileOld);</span>
<span class="lineNum">    1647 </span>                :            :     }
<span class="lineNum">    1648 </span>                :            : 
<span class="lineNum">    1649 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :     if (!status) {</span>
<span class="lineNum">    1650 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         AbortNode(&quot;Flushing block file to disk failed. This is likely the result of an I/O error.&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    1651 </span>                :            :     }
<span class="lineNum">    1652 </span>                :<span class="lineCov">          2 : }</span>
<span class="lineNum">    1653 </span>                :            : 
<span class="lineNum">    1654 </span>                :            : static bool FindUndoPos(CValidationState &amp;state, int nFile, CDiskBlockPos &amp;pos, unsigned int nAddSize);
<span class="lineNum">    1655 </span>                :            : 
<span class="lineNum">    1656 </span>                :<span class="lineCov">       1271 : static bool WriteUndoDataForBlock(const CBlockUndo&amp; blockundo, CValidationState&amp; state, CBlockIndex* pindex, const CChainParams&amp; chainparams)</span>
<span class="lineNum">    1657 </span>                :            : {
<span class="lineNum">    1658 </span>                :            :     // Write undo information to disk
<span class="lineNum">    1659 </span>        [<span class="branchCov" title="Branch 0 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1271 :     if (pindex-&gt;GetUndoPos().IsNull()) {</span>
<span class="lineNum">    1660 </span>                :<span class="lineCov">       1271 :         CDiskBlockPos _pos;</span>
<span class="lineNum">    1661 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1271 times"> + </span>]:<span class="lineCov">       1271 :         if (!FindUndoPos(state, pindex-&gt;nFile, _pos, ::GetSerializeSize(blockundo, CLIENT_VERSION) + 40))</span>
<span class="lineNum">    1662 </span>                :<span class="lineCov">       1271 :             return error(&quot;ConnectBlock(): FindUndoPos failed&quot;);</span>
<span class="lineNum">    1663 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1271 times"> + </span>]:<span class="lineCov">       1271 :         if (!UndoWriteToDisk(blockundo, _pos, pindex-&gt;pprev-&gt;GetBlockHash(), chainparams.MessageStart()))</span>
<span class="lineNum">    1664 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return AbortNode(state, &quot;Failed to write undo data&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    1665 </span>                :            : 
<span class="lineNum">    1666 </span>                :            :         // update nUndoPos in block index
<span class="lineNum">    1667 </span>                :<span class="lineCov">       1271 :         pindex-&gt;nUndoPos = _pos.nPos;</span>
<span class="lineNum">    1668 </span>                :<span class="lineCov">       1271 :         pindex-&gt;nStatus |= BLOCK_HAVE_UNDO;</span>
<span class="lineNum">    1669 </span>                :<span class="lineCov">       1271 :         setDirtyBlockIndex.insert(pindex);</span>
<span class="lineNum">    1670 </span>                :            :     }
<span class="lineNum">    1671 </span>                :            : 
<span class="lineNum">    1672 </span>                :            :     return true;
<span class="lineNum">    1673 </span>                :            : }
<span class="lineNum">    1674 </span>                :            : 
<a name="1675"><span class="lineNum">    1675 </span>                :<span class="lineCov">         73 : static CCheckQueue&lt;CScriptCheck&gt; scriptcheckqueue(128);</span></a>
<span class="lineNum">    1676 </span>                :            : 
<span class="lineNum">    1677 </span>                :<span class="lineCov">        132 : void ThreadScriptCheck() {</span>
<span class="lineNum">    1678 </span>                :<span class="lineCov">        132 :     RenameThread(&quot;bitcoin-scriptch&quot;);</span>
<span class="lineNum">    1679 </span>                :<span class="lineNoCov">          0 :     scriptcheckqueue.Thread();</span>
<span class="lineNum">    1680 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1681 </span>                :            : 
<a name="1682"><span class="lineNum">    1682 </span>                :<span class="lineCov">         73 : VersionBitsCache versionbitscache GUARDED_BY(cs_main);</span></a>
<span class="lineNum">    1683 </span>                :            : 
<span class="lineNum">    1684 </span>                :<span class="lineCov">      71959 : int32_t ComputeBlockVersion(const CBlockIndex* pindexPrev, const Consensus::Params&amp; params)</span>
<span class="lineNum">    1685 </span>                :            : {
<span class="lineNum">    1686 </span>                :<span class="lineCov">      71959 :     LOCK(cs_main);</span>
<span class="lineNum">    1687 </span>                :            :     int32_t nVersion = VERSIONBITS_TOP_BITS;
<span class="lineNum">    1688 </span>                :            : 
<span class="lineNum">    1689 </span>        [<span class="branchCov" title="Branch 0 was taken 215877 times"> + </span><span class="branchCov" title="Branch 1 was taken 71959 times"> + </span>]:<span class="lineCov">     287836 :     for (int i = 0; i &lt; (int)Consensus::MAX_VERSION_BITS_DEPLOYMENTS; i++) {</span>
<span class="lineNum">    1690 </span>        [<span class="branchCov" title="Branch 1 was taken 215877 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">     215877 :         ThresholdState state = VersionBitsState(pindexPrev, params, static_cast&lt;Consensus::DeploymentPos&gt;(i), versionbitscache);</span>
<span class="lineNum">    1691 </span>        [<span class="branchCov" title="Branch 0 was taken 10084 times"> + </span><span class="branchCov" title="Branch 1 was taken 205793 times"> + </span>]:<span class="lineCov">     215877 :         if (state == ThresholdState::LOCKED_IN || state == ThresholdState::STARTED) {</span>
<span class="lineNum">    1692 </span>        [<span class="branchCov" title="Branch 1 was taken 10084 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      10084 :             nVersion |= VersionBitsMask(params, static_cast&lt;Consensus::DeploymentPos&gt;(i));</span>
<span class="lineNum">    1693 </span>                :            :         }
<span class="lineNum">    1694 </span>                :            :     }
<span class="lineNum">    1695 </span>                :            : 
<span class="lineNum">    1696 </span>                :<span class="lineCov">      71959 :     return nVersion;</span>
<span class="lineNum">    1697 </span>                :            : }
<span class="lineNum">    1698 </span>                :            : 
<span class="lineNum">    1699 </span>                :            : /**
<span class="lineNum">    1700 </span>                :            :  * Threshold condition checker that triggers when unknown versionbits are seen on the network.
<span class="lineNum">    1701 </span>                :            :  */
<span class="lineNum">    1702 </span>                :            : class WarningBitsConditionChecker : public AbstractThresholdConditionChecker
<span class="lineNum">    1703 </span>                :            : {
<span class="lineNum">    1704 </span>                :            : private:
<span class="lineNum">    1705 </span>                :            :     int bit;
<span class="lineNum">    1706 </span>                :            : 
<span class="lineNum">    1707 </span>                :            : public:
<a name="1708"><span class="lineNum">    1708 </span>                :<span class="lineCov">      32712 :     explicit WarningBitsConditionChecker(int bitIn) : bit(bitIn) {}</span></a>
<a name="1709"><span class="lineNum">    1709 </span>                :            : </a>
<a name="1710"><span class="lineNum">    1710 </span>                :<span class="lineCov">      32712 :     int64_t BeginTime(const Consensus::Params&amp; params) const override { return 0; }</span></a>
<a name="1711"><span class="lineNum">    1711 </span>                :<span class="lineCov">      32712 :     int64_t EndTime(const Consensus::Params&amp; params) const override { return std::numeric_limits&lt;int64_t&gt;::max(); }</span></a>
<span class="lineNum">    1712 </span>                :<span class="lineCov">      32712 :     int Period(const Consensus::Params&amp; params) const override { return params.nMinerConfirmationWindow; }</span>
<a name="1713"><span class="lineNum">    1713 </span>                :<span class="lineCov">      32712 :     int Threshold(const Consensus::Params&amp; params) const override { return params.nRuleChangeActivationThreshold; }</span></a>
<span class="lineNum">    1714 </span>                :            : 
<span class="lineNum">    1715 </span>                :<span class="lineNoCov">          0 :     bool Condition(const CBlockIndex* pindex, const Consensus::Params&amp; params) const override</span>
<span class="lineNum">    1716 </span>                :            :     {
<span class="lineNum">    1717 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return ((pindex-&gt;nVersion &amp; VERSIONBITS_TOP_MASK) == VERSIONBITS_TOP_BITS) &amp;&amp;</span>
<span class="lineNum">    1718 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                ((pindex-&gt;nVersion &gt;&gt; bit) &amp; 1) != 0 &amp;&amp;</span>
<span class="lineNum">    1719 </span>                :<span class="lineNoCov">          0 :                ((ComputeBlockVersion(pindex-&gt;pprev, params) &gt;&gt; bit) &amp; 1) == 0;</span>
<span class="lineNum">    1720 </span>                :            :     }
<a name="1721"><span class="lineNum">    1721 </span>                :            : };</a>
<span class="lineNum">    1722 </span>                :            : 
<span class="lineNum">    1723 </span>[<span class="branchCov" title="Branch 0 was taken 2117 times"> + </span><span class="branchCov" title="Branch 1 was taken 73 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 2117 times"> + </span><span class="branchCov" title="Branch 4 was taken 73 times"> + </span>]:<span class="lineCov">       4453 : static ThresholdConditionCache warningcache[VERSIONBITS_NUM_BITS] GUARDED_BY(cs_main);</span>
<span class="lineNum">    1724 </span>                :            : 
<span class="lineNum">    1725 </span>                :            : // 0.13.0 was shipped with a segwit deployment defined for testnet, but not for
<span class="lineNum">    1726 </span>                :            : // mainnet. We no longer need to support disabling the segwit deployment
<a name="1727"><span class="lineNum">    1727 </span>                :            : // except for testing purposes, due to limitations of the functional test</a>
<span class="lineNum">    1728 </span>                :            : // environment. See test/functional/p2p-segwit.py.
<span class="lineNum">    1729 </span>                :<span class="lineCov">       2583 : static bool IsScriptWitnessEnabled(const Consensus::Params&amp; params)</span>
<span class="lineNum">    1730 </span>                :            : {
<span class="lineNum">    1731 </span>                :<span class="lineCov">       2583 :     return params.vDeployments[Consensus::DEPLOYMENT_SEGWIT].nTimeout != 0;</span>
<a name="1732"><span class="lineNum">    1732 </span>                :            : }</a>
<span class="lineNum">    1733 </span>                :            : 
<span class="lineNum">    1734 </span>                :<span class="lineCov">       2583 : static unsigned int GetBlockScriptFlags(const CBlockIndex* pindex, const Consensus::Params&amp; consensusparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {</span>
<span class="lineNum">    1735 </span>                :<span class="lineCov">       2583 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    1736 </span>                :            : 
<span class="lineNum">    1737 </span>                :<span class="lineCov">       2583 :     unsigned int flags = SCRIPT_VERIFY_NONE;</span>
<span class="lineNum">    1738 </span>                :            : 
<span class="lineNum">    1739 </span>                :            :     // BIP16 didn't become active until Apr 1 2012 (on mainnet, and
<span class="lineNum">    1740 </span>                :            :     // retroactively applied to testnet)
<span class="lineNum">    1741 </span>                :            :     // However, only one historical block violated the P2SH rules (on both
<span class="lineNum">    1742 </span>                :            :     // mainnet and testnet), so for simplicity, always leave P2SH
<span class="lineNum">    1743 </span>                :            :     // on except for the one violating block.
<span class="lineNum">    1744 </span>        [<span class="branchCov" title="Branch 0 was taken 127 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2710 :     if (consensusparams.BIP16Exception.IsNull() || // no bip16 exception on this chain</span>
<span class="lineNum">    1745 </span>[<span class="branchCov" title="Branch 0 was taken 127 times"> + </span><span class="branchCov" title="Branch 1 was taken 2456 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 127 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       2710 :         pindex-&gt;phashBlock == nullptr || // this is a new candidate block, eg from TestBlockValidity()</span>
<span class="lineNum">    1746 </span>                :<span class="lineCov">        254 :         *pindex-&gt;phashBlock != consensusparams.BIP16Exception) // this block isn't the historical exception</span>
<span class="lineNum">    1747 </span>                :            :     {
<span class="lineNum">    1748 </span>                :            :         flags |= SCRIPT_VERIFY_P2SH;
<span class="lineNum">    1749 </span>                :            :     }
<span class="lineNum">    1750 </span>                :            : 
<span class="lineNum">    1751 </span>                :            :     // Enforce WITNESS rules whenever P2SH is in effect (and the segwit
<span class="lineNum">    1752 </span>                :            :     // deployment is defined).
<span class="lineNum">    1753 </span>[<span class="branchCov" title="Branch 0 was taken 2583 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 2583 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       2583 :     if (flags &amp; SCRIPT_VERIFY_P2SH &amp;&amp; IsScriptWitnessEnabled(consensusparams)) {</span>
<span class="lineNum">    1754 </span>                :<span class="lineCov">       2583 :         flags |= SCRIPT_VERIFY_WITNESS;</span>
<span class="lineNum">    1755 </span>                :            :     }
<span class="lineNum">    1756 </span>                :            : 
<span class="lineNum">    1757 </span>                :            :     // Start enforcing the DERSIG (BIP66) rule
<span class="lineNum">    1758 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2583 times"> + </span>]:<span class="lineCov">       2583 :     if (pindex-&gt;nHeight &gt;= consensusparams.BIP66Height) {</span>
<span class="lineNum">    1759 </span>                :<span class="lineNoCov">          0 :         flags |= SCRIPT_VERIFY_DERSIG;</span>
<span class="lineNum">    1760 </span>                :            :     }
<span class="lineNum">    1761 </span>                :            : 
<span class="lineNum">    1762 </span>                :            :     // Start enforcing CHECKLOCKTIMEVERIFY (BIP65) rule
<span class="lineNum">    1763 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2583 times"> + </span>]:<span class="lineCov">       2583 :     if (pindex-&gt;nHeight &gt;= consensusparams.BIP65Height) {</span>
<span class="lineNum">    1764 </span>                :<span class="lineNoCov">          0 :         flags |= SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY;</span>
<span class="lineNum">    1765 </span>                :            :     }
<span class="lineNum">    1766 </span>                :            : 
<span class="lineNum">    1767 </span>                :            :     // Start enforcing BIP68 (sequence locks) and BIP112 (CHECKSEQUENCEVERIFY) using versionbits logic.
<span class="lineNum">    1768 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2583 times"> + </span>]:<span class="lineCov">       2583 :     if (VersionBitsState(pindex-&gt;pprev, consensusparams, Consensus::DEPLOYMENT_CSV, versionbitscache) == ThresholdState::ACTIVE) {</span>
<span class="lineNum">    1769 </span>                :<span class="lineNoCov">          0 :         flags |= SCRIPT_VERIFY_CHECKSEQUENCEVERIFY;</span>
<span class="lineNum">    1770 </span>                :            :     }
<span class="lineNum">    1771 </span>                :            : 
<span class="lineNum">    1772 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2583 times"> + </span>]:<span class="lineCov">       2583 :     if (IsNullDummyEnabled(pindex-&gt;pprev, consensusparams)) {</span>
<span class="lineNum">    1773 </span>                :<span class="lineNoCov">          0 :         flags |= SCRIPT_VERIFY_NULLDUMMY;</span>
<span class="lineNum">    1774 </span>                :            :     }
<span class="lineNum">    1775 </span>                :            : 
<span class="lineNum">    1776 </span>                :<span class="lineCov">       2583 :     return flags;</span>
<span class="lineNum">    1777 </span>                :            : }
<span class="lineNum">    1778 </span>                :            : 
<span class="lineNum">    1779 </span>                :            : 
<span class="lineNum">    1780 </span>                :            : 
<span class="lineNum">    1781 </span>                :            : static int64_t nTimeCheck = 0;
<span class="lineNum">    1782 </span>                :            : static int64_t nTimeForks = 0;
<span class="lineNum">    1783 </span>                :            : static int64_t nTimeVerify = 0;
<span class="lineNum">    1784 </span>                :            : static int64_t nTimeConnect = 0;
<span class="lineNum">    1785 </span>                :            : static int64_t nTimeIndex = 0;
<span class="lineNum">    1786 </span>                :            : static int64_t nTimeCallbacks = 0;
<span class="lineNum">    1787 </span>                :            : static int64_t nTimeTotal = 0;
<span class="lineNum">    1788 </span>                :            : static int64_t nBlocksTotal = 0;
<span class="lineNum">    1789 </span>                :            : 
<span class="lineNum">    1790 </span>                :            : /** Apply the effects of this block (with given index) on the UTXO set represented by coins.
<span class="lineNum">    1791 </span>                :            :  *  Validity checks that depend on the UTXO set are also done; ConnectBlock()
<span class="lineNum">    1792 </span>                :            :  *  can fail if those validity checks fail (among other reasons). */
<span class="lineNum">    1793 </span>                :<span class="lineCov">       2646 : bool CChainState::ConnectBlock(const CBlock&amp; block, CValidationState&amp; state, CBlockIndex* pindex,</span>
<span class="lineNum">    1794 </span>                :            :                   CCoinsViewCache&amp; view, const CChainParams&amp; chainparams, bool fJustCheck)
<span class="lineNum">    1795 </span>                :            : {
<span class="lineNum">    1796 </span>                :<span class="lineCov">       2646 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    1797 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2646 times"> + </span>]:<span class="lineCov">       2646 :     assert(pindex);</span>
<span class="lineNum">    1798 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2646 times"> + </span>]:<span class="lineCov">       2646 :     assert(*pindex-&gt;phashBlock == block.GetHash());</span>
<span class="lineNum">    1799 </span>                :<span class="lineCov">       2646 :     int64_t nTimeStart = GetTimeMicros();</span>
<span class="lineNum">    1800 </span>                :            : 
<span class="lineNum">    1801 </span>                :            :     // Check it again in case a previous version let a bad block in
<span class="lineNum">    1802 </span>                :            :     // NOTE: We don't currently (re-)invoke ContextualCheckBlock() or
<span class="lineNum">    1803 </span>                :            :     // ContextualCheckBlockHeader() here. This means that if we add a new
<span class="lineNum">    1804 </span>                :            :     // consensus rule that is enforced in one of those two functions, then we
<span class="lineNum">    1805 </span>                :            :     // may have let in a block that violates the rule prior to updating the
<span class="lineNum">    1806 </span>                :            :     // software, and we would NOT be enforcing the rule here. Fully solving
<span class="lineNum">    1807 </span>                :            :     // upgrade from one software version to the next after a consensus rule
<span class="lineNum">    1808 </span>                :            :     // change is potentially tricky and issue-specific (see RewindBlockIndex()
<span class="lineNum">    1809 </span>                :            :     // for one general approach that was used for BIP 141 deployment).
<span class="lineNum">    1810 </span>                :            :     // Also, currently the rule against blocks more than 2 hours in the future
<span class="lineNum">    1811 </span>                :            :     // is enforced in ContextualCheckBlockHeader(); we wouldn't want to
<span class="lineNum">    1812 </span>                :            :     // re-enforce that rule here (at least until we make it impossible for
<span class="lineNum">    1813 </span>                :            :     // GetAdjustedTime() to go backward).
<span class="lineNum">    1814 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2646 times"> + </span>]:<span class="lineCov">       2646 :     if (!CheckBlock(block, state, chainparams.GetConsensus(), !fJustCheck, !fJustCheck)) {</span>
<span class="lineNum">    1815 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (state.CorruptionPossible()) {</span>
<span class="lineNum">    1816 </span>                :            :             // We don't write down blocks to disk if they may have been
<span class="lineNum">    1817 </span>                :            :             // corrupted, so this should be impossible unless we're having hardware
<span class="lineNum">    1818 </span>                :            :             // problems.
<span class="lineNum">    1819 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return AbortNode(state, &quot;Corrupt block found indicating potential hardware failure; shutting down&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    1820 </span>                :            :         }
<span class="lineNum">    1821 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: Consensus::CheckBlock: %s&quot;, __func__, FormatStateMessage(state));</span>
<span class="lineNum">    1822 </span>                :            :     }
<span class="lineNum">    1823 </span>                :            : 
<span class="lineNum">    1824 </span>                :            :     // verify that the view's current state corresponds to the previous block
<span class="lineNum">    1825 </span>        [<span class="branchCov" title="Branch 0 was taken 66 times"> + </span><span class="branchCov" title="Branch 1 was taken 2580 times"> + </span>]:<span class="lineCov">       2646 :     uint256 hashPrevBlock = pindex-&gt;pprev == nullptr ? uint256() : pindex-&gt;pprev-&gt;GetBlockHash();</span>
<span class="lineNum">    1826 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2646 times"> + </span>]:<span class="lineCov">       2646 :     assert(hashPrevBlock == view.GetBestBlock());</span>
<span class="lineNum">    1827 </span>                :            : 
<span class="lineNum">    1828 </span>                :            :     // Special case for the genesis block, skipping connection of its transactions
<span class="lineNum">    1829 </span>                :            :     // (its coinbase is unspendable)
<span class="lineNum">    1830 </span>        [<span class="branchCov" title="Branch 1 was taken 66 times"> + </span><span class="branchCov" title="Branch 2 was taken 2580 times"> + </span>]:<span class="lineCov">       2646 :     if (block.GetHash() == chainparams.GetConsensus().hashGenesisBlock) {</span>
<span class="lineNum">    1831 </span>        [<span class="branchCov" title="Branch 0 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         66 :         if (!fJustCheck)</span>
<span class="lineNum">    1832 </span>                :<span class="lineCov">         66 :             view.SetBestBlock(pindex-&gt;GetBlockHash());</span>
<span class="lineNum">    1833 </span>                :            :         return true;
<span class="lineNum">    1834 </span>                :            :     }
<span class="lineNum">    1835 </span>                :            : 
<span class="lineNum">    1836 </span>                :<span class="lineCov">       2580 :     nBlocksTotal++;</span>
<span class="lineNum">    1837 </span>                :            : 
<span class="lineNum">    1838 </span>                :<span class="lineCov">       2580 :     bool fScriptChecks = true;</span>
<span class="lineNum">    1839 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2580 times"> + </span>]:<span class="lineCov">       2580 :     if (!hashAssumeValid.IsNull()) {</span>
<span class="lineNum">    1840 </span>                :            :         // We've been configured with the hash of a block which has been externally verified to have a valid history.
<span class="lineNum">    1841 </span>                :            :         // A suitable default value is included with the software and updated from time to time.  Because validity
<span class="lineNum">    1842 </span>                :            :         //  relative to a piece of software is an objective fact these defaults can be easily reviewed.
<span class="lineNum">    1843 </span>                :            :         // This setting doesn't force the selection of any particular chain but makes validating some faster by
<span class="lineNum">    1844 </span>                :            :         //  effectively caching the result of part of the verification.
<span class="lineNum">    1845 </span>                :<span class="lineNoCov">          0 :         BlockMap::const_iterator  it = mapBlockIndex.find(hashAssumeValid);</span>
<span class="lineNum">    1846 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (it != mapBlockIndex.end()) {</span>
<span class="lineNum">    1847 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (it-&gt;second-&gt;GetAncestor(pindex-&gt;nHeight) == pindex &amp;&amp;</span>
<span class="lineNum">    1848 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 pindexBestHeader-&gt;GetAncestor(pindex-&gt;nHeight) == pindex &amp;&amp;</span>
<span class="lineNum">    1849 </span>                :<span class="lineNoCov">          0 :                 pindexBestHeader-&gt;nChainWork &gt;= nMinimumChainWork) {</span>
<span class="lineNum">    1850 </span>                :            :                 // This block is a member of the assumed verified chain and an ancestor of the best header.
<span class="lineNum">    1851 </span>                :            :                 // The equivalent time check discourages hash power from extorting the network via DOS attack
<span class="lineNum">    1852 </span>                :            :                 //  into accepting an invalid block through telling users they must manually set assumevalid.
<span class="lineNum">    1853 </span>                :            :                 //  Requiring a software change or burying the invalid block, regardless of the setting, makes
<span class="lineNum">    1854 </span>                :            :                 //  it hard to hide the implication of the demand.  This also avoids having release candidates
<span class="lineNum">    1855 </span>                :            :                 //  that are hardly doing any signature verification at all in testing without having to
<span class="lineNum">    1856 </span>                :            :                 //  artificially set the default assumed verified block further back.
<span class="lineNum">    1857 </span>                :            :                 // The test against nMinimumChainWork prevents the skipping when denied access to any chain at
<span class="lineNum">    1858 </span>                :            :                 //  least as good as the expected chain.
<span class="lineNum">    1859 </span>                :<span class="lineNoCov">          0 :                 fScriptChecks = (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, chainparams.GetConsensus()) &lt;= 60 * 60 * 24 * 7 * 2);</span>
<span class="lineNum">    1860 </span>                :            :             }
<span class="lineNum">    1861 </span>                :            :         }
<span class="lineNum">    1862 </span>                :            :     }
<span class="lineNum">    1863 </span>                :            : 
<span class="lineNum">    1864 </span>                :<span class="lineCov">       2580 :     int64_t nTime1 = GetTimeMicros(); nTimeCheck += nTime1 - nTimeStart;</span>
<span class="lineNum">    1865 </span>                :<span class="lineCov">       2580 :     LogPrint(BCLog::BENCH, &quot;    - Sanity checks: %.2fms [%.2fs (%.2fms/blk)]\n&quot;, MILLI * (nTime1 - nTimeStart), nTimeCheck * MICRO, nTimeCheck * MILLI / nBlocksTotal);</span>
<span class="lineNum">    1866 </span>                :            : 
<span class="lineNum">    1867 </span>                :            :     // Do not allow blocks that contain transactions which 'overwrite' older transactions,
<span class="lineNum">    1868 </span>                :            :     // unless those are already completely spent.
<span class="lineNum">    1869 </span>                :            :     // If such overwrites are allowed, coinbases and transactions depending upon those
<span class="lineNum">    1870 </span>                :            :     // can be duplicated to remove the ability to spend the first instance -- even after
<span class="lineNum">    1871 </span>                :            :     // being sent to another address.
<span class="lineNum">    1872 </span>                :            :     // See BIP30 and http://r6.ca/blog/20120206T005236Z.html for more information.
<span class="lineNum">    1873 </span>                :            :     // This logic is not necessary for memory pool transactions, as AcceptToMemoryPool
<span class="lineNum">    1874 </span>                :            :     // already refuses previously-known transaction ids entirely.
<span class="lineNum">    1875 </span>                :            :     // This rule was originally applied to all blocks with a timestamp after March 15, 2012, 0:00 UTC.
<span class="lineNum">    1876 </span>                :            :     // Now that the whole chain is irreversibly beyond that time it is applied to all blocks except the
<span class="lineNum">    1877 </span>                :            :     // two in the chain that violate it. This prevents exploiting the issue against nodes during their
<span class="lineNum">    1878 </span>                :            :     // initial block download.
<span class="lineNum">    1879 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2580 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       2580 :     bool fEnforceBIP30 = !((pindex-&gt;nHeight==91842 &amp;&amp; pindex-&gt;GetBlockHash() == uint256S(&quot;0x00000000000a4d0a398161ffc163c503763b1f4360639393e0e4c8e300e0caec&quot;)) ||</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 2580 times"> + </span>]
<span class="lineNum">    1880 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                            (pindex-&gt;nHeight==91880 &amp;&amp; pindex-&gt;GetBlockHash() == uint256S(&quot;0x00000000000743f190a18c5577a3c2d2a1f610ae9601ac046a38084ccb7cd721&quot;)));</span>
<span class="lineNum">    1881 </span>                :            : 
<span class="lineNum">    1882 </span>                :            :     // Once BIP34 activated it was not possible to create new duplicate coinbases and thus other than starting
<span class="lineNum">    1883 </span>                :            :     // with the 2 existing duplicate coinbase pairs, not possible to create overwriting txs.  But by the
<span class="lineNum">    1884 </span>                :            :     // time BIP34 activated, in each of the existing pairs the duplicate coinbase had overwritten the first
<span class="lineNum">    1885 </span>                :            :     // before the first had been spent.  Since those coinbases are sufficiently buried it's no longer possible to create further
<span class="lineNum">    1886 </span>                :            :     // duplicate transactions descending from the known pairs either.
<span class="lineNum">    1887 </span>                :            :     // If we're on the known chain at height greater than where BIP34 activated, we can save the db accesses needed for the BIP30 check.
<span class="lineNum">    1888 </span>                :            : 
<span class="lineNum">    1889 </span>                :            :     // BIP34 requires that a block at height X (block X) has its coinbase
<span class="lineNum">    1890 </span>                :            :     // scriptSig start with a CScriptNum of X (indicated height X).  The above
<span class="lineNum">    1891 </span>                :            :     // logic of no longer requiring BIP30 once BIP34 activates is flawed in the
<span class="lineNum">    1892 </span>                :            :     // case that there is a block X before the BIP34 height of 227,931 which has
<span class="lineNum">    1893 </span>                :            :     // an indicated height Y where Y is greater than X.  The coinbase for block
<span class="lineNum">    1894 </span>                :            :     // X would also be a valid coinbase for block Y, which could be a BIP30
<span class="lineNum">    1895 </span>                :            :     // violation.  An exhaustive search of all mainnet coinbases before the
<span class="lineNum">    1896 </span>                :            :     // BIP34 height which have an indicated height greater than the block height
<span class="lineNum">    1897 </span>                :            :     // reveals many occurrences. The 3 lowest indicated heights found are
<span class="lineNum">    1898 </span>                :            :     // 209,921, 490,897, and 1,983,702 and thus coinbases for blocks at these 3
<span class="lineNum">    1899 </span>                :            :     // heights would be the first opportunity for BIP30 to be violated.
<span class="lineNum">    1900 </span>                :            : 
<span class="lineNum">    1901 </span>                :            :     // The search reveals a great many blocks which have an indicated height
<span class="lineNum">    1902 </span>                :            :     // greater than 1,983,702, so we simply remove the optimization to skip
<span class="lineNum">    1903 </span>                :            :     // BIP30 checking for blocks at height 1,983,702 or higher.  Before we reach
<span class="lineNum">    1904 </span>                :            :     // that block in another 25 years or so, we should take advantage of a
<span class="lineNum">    1905 </span>                :            :     // future consensus change to do a new and improved version of BIP34 that
<span class="lineNum">    1906 </span>                :            :     // will actually prevent ever creating any duplicate coinbases in the
<span class="lineNum">    1907 </span>                :            :     // future.
<span class="lineNum">    1908 </span>                :            :     static constexpr int BIP34_IMPLIES_BIP30_LIMIT = 1983702;
<span class="lineNum">    1909 </span>                :            : 
<span class="lineNum">    1910 </span>                :            :     // There is no potential to create a duplicate coinbase at block 209,921
<span class="lineNum">    1911 </span>                :            :     // because this is still before the BIP34 height and so explicit BIP30
<span class="lineNum">    1912 </span>                :            :     // checking is still active.
<span class="lineNum">    1913 </span>                :            : 
<span class="lineNum">    1914 </span>                :            :     // The final case is block 176,684 which has an indicated height of
<span class="lineNum">    1915 </span>                :            :     // 490,897. Unfortunately, this issue was not discovered until about 2 weeks
<span class="lineNum">    1916 </span>                :            :     // before block 490,897 so there was not much opportunity to address this
<span class="lineNum">    1917 </span>                :            :     // case other than to carefully analyze it and determine it would not be a
<span class="lineNum">    1918 </span>                :            :     // problem. Block 490,897 was, in fact, mined with a different coinbase than
<span class="lineNum">    1919 </span>                :            :     // block 176,684, but it is important to note that even if it hadn't been or
<span class="lineNum">    1920 </span>                :            :     // is remined on an alternate fork with a duplicate coinbase, we would still
<span class="lineNum">    1921 </span>                :            :     // not run into a BIP30 violation.  This is because the coinbase for 176,684
<span class="lineNum">    1922 </span>                :            :     // is spent in block 185,956 in transaction
<span class="lineNum">    1923 </span>                :            :     // d4f7fbbf92f4a3014a230b2dc70b8058d02eb36ac06b4a0736d9d60eaa9e8781.  This
<span class="lineNum">    1924 </span>                :            :     // spending transaction can't be duplicated because it also spends coinbase
<span class="lineNum">    1925 </span>                :            :     // 0328dd85c331237f18e781d692c92de57649529bd5edf1d01036daea32ffde29.  This
<span class="lineNum">    1926 </span>                :            :     // coinbase has an indicated height of over 4.2 billion, and wouldn't be
<span class="lineNum">    1927 </span>                :            :     // duplicatable until that height, and it's currently impossible to create a
<span class="lineNum">    1928 </span>                :            :     // chain that long. Nevertheless we may wish to consider a future soft fork
<span class="lineNum">    1929 </span>                :            :     // which retroactively prevents block 490,897 from creating a duplicate
<span class="lineNum">    1930 </span>                :            :     // coinbase. The two historical BIP30 violations often provide a confusing
<span class="lineNum">    1931 </span>                :            :     // edge case when manipulating the UTXO and it would be simpler not to have
<span class="lineNum">    1932 </span>                :            :     // another edge case to deal with.
<span class="lineNum">    1933 </span>                :            : 
<span class="lineNum">    1934 </span>                :            :     // testnet3 has no blocks before the BIP34 height with indicated heights
<span class="lineNum">    1935 </span>                :            :     // post BIP34 before approximately height 486,000,000 and presumably will
<span class="lineNum">    1936 </span>                :            :     // be reset before it reaches block 1,983,702 and starts doing unnecessary
<span class="lineNum">    1937 </span>                :            :     // BIP30 checking again.
<span class="lineNum">    1938 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2580 times"> + </span>]:<span class="lineCov">       2580 :     assert(pindex-&gt;pprev);</span>
<span class="lineNum">    1939 </span>                :<span class="lineCov">       2580 :     CBlockIndex *pindexBIP34height = pindex-&gt;pprev-&gt;GetAncestor(chainparams.GetConsensus().BIP34Height);</span>
<span class="lineNum">    1940 </span>                :            :     //Only continue to enforce if we're below BIP34 activation height or the block hash at that height doesn't correspond.
<span class="lineNum">    1941 </span>[<span class="branchCov" title="Branch 0 was taken 2580 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2580 times"> + </span>]:<span class="lineCov">       2580 :     fEnforceBIP30 = fEnforceBIP30 &amp;&amp; (!pindexBIP34height || !(pindexBIP34height-&gt;GetBlockHash() == chainparams.GetConsensus().BIP34Hash));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    1942 </span>                :            : 
<span class="lineNum">    1943 </span>                :            :     // TODO: Remove BIP30 checking from block height 1,983,702 on, once we have a
<span class="lineNum">    1944 </span>                :            :     // consensus change that ensures coinbases at those heights can not
<span class="lineNum">    1945 </span>                :            :     // duplicate earlier coinbases.
<span class="lineNum">    1946 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (fEnforceBIP30 || pindex-&gt;nHeight &gt;= BIP34_IMPLIES_BIP30_LIMIT) {</span>
<span class="lineNum">    1947 </span>        [<span class="branchCov" title="Branch 0 was taken 3727 times"> + </span><span class="branchCov" title="Branch 1 was taken 2580 times"> + </span>]:<span class="lineCov">       6307 :         for (const auto&amp; tx : block.vtx) {</span>
<span class="lineNum">    1948 </span>        [<span class="branchCov" title="Branch 0 was taken 6159 times"> + </span><span class="branchCov" title="Branch 1 was taken 3727 times"> + </span>]:<span class="lineCov">       9886 :             for (size_t o = 0; o &lt; tx-&gt;vout.size(); o++) {</span>
<span class="lineNum">    1949 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 6159 times"> + </span>]:<span class="lineCov">       6159 :                 if (view.HaveCoin(COutPoint(tx-&gt;GetHash(), o))) {</span>
<span class="lineNum">    1950 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     return state.DoS(100, error(&quot;ConnectBlock(): tried to overwrite transaction&quot;),</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    1951 </span>                :<span class="lineNoCov">          0 :                                      REJECT_INVALID, &quot;bad-txns-BIP30&quot;);</span>
<span class="lineNum">    1952 </span>                :            :                 }
<span class="lineNum">    1953 </span>                :            :             }
<span class="lineNum">    1954 </span>                :            :         }
<span class="lineNum">    1955 </span>                :            :     }
<span class="lineNum">    1956 </span>                :            : 
<span class="lineNum">    1957 </span>                :            :     // Start enforcing BIP68 (sequence locks) and BIP112 (CHECKSEQUENCEVERIFY) using versionbits logic.
<span class="lineNum">    1958 </span>                :<span class="lineCov">       2580 :     int nLockTimeFlags = 0;</span>
<span class="lineNum">    1959 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2580 times"> + </span>]:<span class="lineCov">       2580 :     if (VersionBitsState(pindex-&gt;pprev, chainparams.GetConsensus(), Consensus::DEPLOYMENT_CSV, versionbitscache) == ThresholdState::ACTIVE) {</span>
<span class="lineNum">    1960 </span>                :<span class="lineNoCov">          0 :         nLockTimeFlags |= LOCKTIME_VERIFY_SEQUENCE;</span>
<span class="lineNum">    1961 </span>                :            :     }
<span class="lineNum">    1962 </span>                :            : 
<span class="lineNum">    1963 </span>                :            :     // Get the script flags for this block
<span class="lineNum">    1964 </span>                :<span class="lineCov">       2580 :     unsigned int flags = GetBlockScriptFlags(pindex, chainparams.GetConsensus());</span>
<span class="lineNum">    1965 </span>                :            : 
<span class="lineNum">    1966 </span>                :<span class="lineCov">       2580 :     int64_t nTime2 = GetTimeMicros(); nTimeForks += nTime2 - nTime1;</span>
<span class="lineNum">    1967 </span>                :<span class="lineCov">       2580 :     LogPrint(BCLog::BENCH, &quot;    - Fork checks: %.2fms [%.2fs (%.2fms/blk)]\n&quot;, MILLI * (nTime2 - nTime1), nTimeForks * MICRO, nTimeForks * MILLI / nBlocksTotal);</span>
<span class="lineNum">    1968 </span>                :            : 
<span class="lineNum">    1969 </span>                :<span class="lineCov">       2580 :     CBlockUndo blockundo;</span>
<span class="lineNum">    1970 </span>                :            : 
<span class="lineNum">    1971 </span>[<span class="branchCov" title="Branch 0 was taken 2580 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2580 times"> + </span>]:<span class="lineCov">       5160 :     CCheckQueueControl&lt;CScriptCheck&gt; control(fScriptChecks &amp;&amp; nScriptCheckThreads ? &amp;scriptcheckqueue : nullptr);</span>
<span class="lineNum">    1972 </span>                :            : 
<span class="lineNum">    1973 </span>                :<span class="lineNoCov">          0 :     std::vector&lt;int&gt; prevheights;</span>
<span class="lineNum">    1974 </span>                :<span class="lineCov">       2580 :     CAmount nFees = 0;</span>
<span class="lineNum">    1975 </span>                :<span class="lineCov">       2580 :     int nInputs = 0;</span>
<span class="lineNum">    1976 </span>                :<span class="lineCov">       2580 :     int64_t nSigOpsCost = 0;</span>
<span class="lineNum">    1977 </span>        [<span class="branchCov" title="Branch 1 was taken 2580 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       2580 :     blockundo.vtxundo.reserve(block.vtx.size() - 1);</span>
<span class="lineNum">    1978 </span>                :<span class="lineNoCov">          0 :     std::vector&lt;PrecomputedTransactionData&gt; txdata;</span>
<span class="lineNum">    1979 </span>        [<span class="branchCov" title="Branch 1 was taken 2580 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       2580 :     txdata.reserve(block.vtx.size()); // Required so that pointers to individual PrecomputedTransactionData don't get invalidated</span>
<span class="lineNum">    1980 </span>        [<span class="branchCov" title="Branch 0 was taken 3726 times"> + </span><span class="branchCov" title="Branch 1 was taken 2575 times"> + </span>]:<span class="lineCov">       6306 :     for (unsigned int i = 0; i &lt; block.vtx.size(); i++)</span>
<span class="lineNum">    1981 </span>                :            :     {
<span class="lineNum">    1982 </span>                :<span class="lineCov">      11178 :         const CTransaction &amp;tx = *(block.vtx[i]);</span>
<span class="lineNum">    1983 </span>                :            : 
<span class="lineNum">    1984 </span>                :<span class="lineCov">       7452 :         nInputs += tx.vin.size();</span>
<span class="lineNum">    1985 </span>                :            : 
<span class="lineNum">    1986 </span>                :            :         if (!tx.IsCoinBase())
<span class="lineNum">    1987 </span>                :            :         {
<span class="lineNum">    1988 </span>                :<span class="lineCov">       1146 :             CAmount txfee = 0;</span>
<span class="lineNum">    1989 </span>[<span class="branchCov" title="Branch 1 was taken 1146 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 5 times"> + </span><span class="branchCov" title="Branch 4 was taken 1141 times"> + </span>]:<span class="lineCov">       1146 :             if (!Consensus::CheckTxInputs(tx, state, view, pindex-&gt;nHeight, txfee)) {</span>
<span class="lineNum">    1990 </span>[<span class="branchCov" title="Branch 1 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         10 :                 return error(&quot;%s: Consensus::CheckTxInputs: %s, %s&quot;, __func__, tx.GetHash().ToString(), FormatStateMessage(state));</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">    1991 </span>                :            :             }
<span class="lineNum">    1992 </span>                :<span class="lineCov">       1141 :             nFees += txfee;</span>
<span class="lineNum">    1993 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1141 times"> + </span>]:<span class="lineCov">       1141 :             if (!MoneyRange(nFees)) {</span>
<span class="lineNum">    1994 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return state.DoS(100, error(&quot;%s: accumulated fee in the block out of range.&quot;, __func__),</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    1995 </span>                :<span class="lineNoCov">          0 :                                  REJECT_INVALID, &quot;bad-txns-accumulated-fee-outofrange&quot;);</span>
<span class="lineNum">    1996 </span>                :            :             }
<span class="lineNum">    1997 </span>                :            : 
<span class="lineNum">    1998 </span>                :            :             // Check that transaction is BIP68 final
<span class="lineNum">    1999 </span>                :            :             // BIP68 lock checks (as opposed to nLockTime checks) must
<span class="lineNum">    2000 </span>                :            :             // be in ConnectBlock because they require the UTXO set
<span class="lineNum">    2001 </span>        [<span class="branchCov" title="Branch 1 was taken 1141 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1141 :             prevheights.resize(tx.vin.size());</span>
<span class="lineNum">    2002 </span>        [<span class="branchCov" title="Branch 0 was taken 1142 times"> + </span><span class="branchCov" title="Branch 1 was taken 1141 times"> + </span>]:<span class="lineCov">       2283 :             for (size_t j = 0; j &lt; tx.vin.size(); j++) {</span>
<span class="lineNum">    2003 </span>        [<span class="branchCov" title="Branch 1 was taken 1142 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1142 :                 prevheights[j] = view.AccessCoin(tx.vin[j].prevout).nHeight;</span>
<span class="lineNum">    2004 </span>                :            :             }
<span class="lineNum">    2005 </span>                :            : 
<span class="lineNum">    2006 </span>[<span class="branchCov" title="Branch 1 was taken 1141 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 1141 times"> + </span>]:<span class="lineCov">       1141 :             if (!SequenceLocks(tx, nLockTimeFlags, &amp;prevheights, *pindex)) {</span>
<span class="lineNum">    2007 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineCov">       1146 :                 return state.DoS(100, error(&quot;%s: contains a non-BIP68-final transaction&quot;, __func__),</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    2008 </span>                :<span class="lineNoCov">          0 :                                  REJECT_INVALID, &quot;bad-txns-nonfinal&quot;);</span>
<span class="lineNum">    2009 </span>                :            :             }
<span class="lineNum">    2010 </span>                :            :         }
<span class="lineNum">    2011 </span>                :            : 
<span class="lineNum">    2012 </span>                :            :         // GetTransactionSigOpCost counts 3 types of sigops:
<span class="lineNum">    2013 </span>                :            :         // * legacy (always)
<span class="lineNum">    2014 </span>                :            :         // * p2sh (when P2SH enabled in flags and excludes coinbase)
<span class="lineNum">    2015 </span>                :            :         // * witness (when witness enabled in flags and excludes coinbase)
<span class="lineNum">    2016 </span>        [<span class="branchCov" title="Branch 1 was taken 3721 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       3721 :         nSigOpsCost += GetTransactionSigOpCost(tx, view, flags);</span>
<span class="lineNum">    2017 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3721 times"> + </span>]:<span class="lineCov">       3721 :         if (nSigOpsCost &gt; MAX_BLOCK_SIGOPS_COST)</span>
<span class="lineNum">    2018 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.DoS(100, error(&quot;ConnectBlock(): too many sigops&quot;),</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    2019 </span>                :<span class="lineNoCov">          0 :                              REJECT_INVALID, &quot;bad-blk-sigops&quot;);</span>
<span class="lineNum">    2020 </span>                :            : 
<span class="lineNum">    2021 </span>        [<span class="branchCov" title="Branch 1 was taken 3721 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       3721 :         txdata.emplace_back(tx);</span>
<span class="lineNum">    2022 </span>                :            :         if (!tx.IsCoinBase())
<span class="lineNum">    2023 </span>                :            :         {
<span class="lineNum">    2024 </span>                :<span class="lineCov">       1141 :             std::vector&lt;CScriptCheck&gt; vChecks;</span>
<span class="lineNum">    2025 </span>                :<span class="lineCov">       1141 :             bool fCacheResults = fJustCheck; /* Don't cache results if we're actually connecting blocks (still consult the cache, though) */</span>
<span class="lineNum">    2026 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1141 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 1141 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       1141 :             if (!CheckInputs(tx, state, view, fScriptChecks, flags, fCacheResults, fCacheResults, txdata[i], nScriptCheckThreads ? &amp;vChecks : nullptr))</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 1141 times"> + </span>]
<span class="lineNum">    2027 </span>                :            :                 return error(&quot;ConnectBlock(): CheckInputs on %s failed with %s&quot;,
<span class="lineNum">    2028 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     tx.GetHash().ToString(), FormatStateMessage(state));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    2029 </span>                :<span class="lineCov">       1141 :             control.Add(vChecks);</span>
<span class="lineNum">    2030 </span>                :            :         }
<span class="lineNum">    2031 </span>                :            : 
<span class="lineNum">    2032 </span>                :<span class="lineNoCov">          0 :         CTxUndo undoDummy;</span>
<span class="lineNum">    2033 </span>        [<span class="branchCov" title="Branch 0 was taken 1141 times"> + </span><span class="branchCov" title="Branch 1 was taken 2580 times"> + </span>]:<span class="lineCov">       3721 :         if (i &gt; 0) {</span>
<span class="lineNum">    2034 </span>                :<span class="lineCov">       1141 :             blockundo.vtxundo.push_back(CTxUndo());</span>
<span class="lineNum">    2035 </span>                :            :         }
<span class="lineNum">    2036 </span>[<span class="branchCov" title="Branch 0 was taken 1141 times"> + </span><span class="branchCov" title="Branch 1 was taken 2580 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 3721 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       3721 :         UpdateCoins(tx, view, i == 0 ? undoDummy : blockundo.vtxundo.back(), pindex-&gt;nHeight);</span>
<span class="lineNum">    2037 </span>                :            :     }
<span class="lineNum">    2038 </span>        [<span class="branchCov" title="Branch 1 was taken 2575 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       2575 :     int64_t nTime3 = GetTimeMicros(); nTimeConnect += nTime3 - nTime2;</span>
<span class="lineNum">    2039 </span>[<span class="branchCov" title="Branch 0 was taken 17 times"> + </span><span class="branchCov" title="Branch 1 was taken 2558 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 2575 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       2575 :     LogPrint(BCLog::BENCH, &quot;      - Connect %u transactions: %.2fms (%.3fms/tx, %.3fms/txin) [%.2fs (%.2fms/blk)]\n&quot;, (unsigned)block.vtx.size(), MILLI * (nTime3 - nTime2), MILLI * (nTime3 - nTime2) / block.vtx.size(), nInputs &lt;= 1 ? 0 : MILLI * (nTime3 - nTime2) / (nInputs-1), nTimeConnect * MICRO, nTimeConnect * MILLI / nBlocksTotal);</span>
<span class="lineNum">    2040 </span>                :            : 
<span class="lineNum">    2041 </span>                :<span class="lineCov">       2575 :     CAmount blockReward = nFees + GetBlockSubsidy(pindex-&gt;nHeight, chainparams.GetConsensus());</span>
<span class="lineNum">    2042 </span>[<span class="branchCov" title="Branch 1 was taken 2575 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 2575 times"> + </span>]:<span class="lineCov">       2575 :     if (block.vtx[0]-&gt;GetValueOut() &gt; blockReward)</span>
<span class="lineNum">    2043 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return state.DoS(100,</span>
<span class="lineNum">    2044 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                          error(&quot;ConnectBlock(): coinbase pays too much (actual=%d vs limit=%d)&quot;,</span>
<span class="lineNum">    2045 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                block.vtx[0]-&gt;GetValueOut(), blockReward),</span>
<span class="lineNum">    2046 </span>                :<span class="lineNoCov">          0 :                                REJECT_INVALID, &quot;bad-cb-amount&quot;);</span>
<span class="lineNum">    2047 </span>                :            : 
<span class="lineNum">    2048 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 2574 times"> + </span>]:<span class="lineCov">       2575 :     if (!control.Wait())</span>
<span class="lineNum">    2049 </span>[<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          2 :         return state.DoS(100, error(&quot;%s: CheckQueue failed&quot;, __func__), REJECT_INVALID, &quot;block-validation-failed&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">    2050 </span>        [<span class="branchCov" title="Branch 1 was taken 2574 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       2574 :     int64_t nTime4 = GetTimeMicros(); nTimeVerify += nTime4 - nTime2;</span>
<span class="lineNum">    2051 </span>[<span class="branchCov" title="Branch 0 was taken 16 times"> + </span><span class="branchCov" title="Branch 1 was taken 2558 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 2574 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       2574 :     LogPrint(BCLog::BENCH, &quot;    - Verify %u txins: %.2fms (%.3fms/txin) [%.2fs (%.2fms/blk)]\n&quot;, nInputs - 1, MILLI * (nTime4 - nTime2), nInputs &lt;= 1 ? 0 : MILLI * (nTime4 - nTime2) / (nInputs-1), nTimeVerify * MICRO, nTimeVerify * MILLI / nBlocksTotal);</span>
<span class="lineNum">    2052 </span>                :            : 
<span class="lineNum">    2053 </span>        [<span class="branchCov" title="Branch 0 was taken 1271 times"> + </span><span class="branchCov" title="Branch 1 was taken 1303 times"> + </span>]:<span class="lineCov">       2574 :     if (fJustCheck)</span>
<span class="lineNum">    2054 </span>                :            :         return true;
<span class="lineNum">    2055 </span>                :            : 
<span class="lineNum">    2056 </span>[<span class="branchCov" title="Branch 1 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       1271 :     if (!WriteUndoDataForBlock(blockundo, state, pindex, chainparams))</span>
<span class="lineNum">    2057 </span>                :            :         return false;
<span class="lineNum">    2058 </span>                :            : 
<span class="lineNum">    2059 </span>        [<span class="branchCov" title="Branch 0 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1271 :     if (!pindex-&gt;IsValid(BLOCK_VALID_SCRIPTS)) {</span>
<span class="lineNum">    2060 </span>                :<span class="lineCov">       1271 :         pindex-&gt;RaiseValidity(BLOCK_VALID_SCRIPTS);</span>
<span class="lineNum">    2061 </span>                :            :         setDirtyBlockIndex.insert(pindex);
<span class="lineNum">    2062 </span>                :            :     }
<span class="lineNum">    2063 </span>                :            : 
<span class="lineNum">    2064 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1271 times"> + </span>]:<span class="lineCov">       1271 :     assert(pindex-&gt;phashBlock);</span>
<span class="lineNum">    2065 </span>                :            :     // add this block to the view's block chain
<span class="lineNum">    2066 </span>        [<span class="branchCov" title="Branch 1 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1271 :     view.SetBestBlock(pindex-&gt;GetBlockHash());</span>
<span class="lineNum">    2067 </span>                :            : 
<span class="lineNum">    2068 </span>        [<span class="branchCov" title="Branch 1 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1271 :     int64_t nTime5 = GetTimeMicros(); nTimeIndex += nTime5 - nTime4;</span>
<span class="lineNum">    2069 </span>        [<span class="branchCov" title="Branch 1 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1271 :     LogPrint(BCLog::BENCH, &quot;    - Index writing: %.2fms [%.2fs (%.2fms/blk)]\n&quot;, MILLI * (nTime5 - nTime4), nTimeIndex * MICRO, nTimeIndex * MILLI / nBlocksTotal);</span>
<span class="lineNum">    2070 </span>                :            : 
<span class="lineNum">    2071 </span>        [<span class="branchCov" title="Branch 1 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1271 :     int64_t nTime6 = GetTimeMicros(); nTimeCallbacks += nTime6 - nTime5;</span>
<span class="lineNum">    2072 </span>        [<span class="branchCov" title="Branch 1 was taken 1271 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1271 :     LogPrint(BCLog::BENCH, &quot;    - Callbacks: %.2fms [%.2fs (%.2fms/blk)]\n&quot;, MILLI * (nTime6 - nTime5), nTimeCallbacks * MICRO, nTimeCallbacks * MILLI / nBlocksTotal);</span>
<span class="lineNum">    2073 </span>                :            : 
<span class="lineNum">    2074 </span>                :<span class="lineCov">       1271 :     return true;</span>
<span class="lineNum">    2075 </span>                :            : }
<span class="lineNum">    2076 </span>                :            : 
<span class="lineNum">    2077 </span>                :            : /**
<span class="lineNum">    2078 </span>                :            :  * Update the on-disk chain state.
<span class="lineNum">    2079 </span>                :            :  * The caches and indexes are flushed depending on the mode we're called with
<span class="lineNum">    2080 </span>                :            :  * if they're too large, if it's been a while since the last write,
<span class="lineNum">    2081 </span>                :            :  * or always and in all cases if we're in prune mode and are deleting files.
<span class="lineNum">    2082 </span>                :            :  *
<span class="lineNum">    2083 </span>                :            :  * If FlushStateMode::NONE is used, then FlushStateToDisk(...) won't do anything
<span class="lineNum">    2084 </span>                :            :  * besides checking if we need to prune.
<span class="lineNum">    2085 </span>                :            :  */
<span class="lineNum">    2086 </span>                :<span class="lineCov">       3949 : bool static FlushStateToDisk(const CChainParams&amp; chainparams, CValidationState &amp;state, FlushStateMode mode, int nManualPruneHeight) {</span>
<span class="lineNum">    2087 </span>                :<span class="lineCov">       3949 :     int64_t nMempoolUsage = mempool.DynamicMemoryUsage();</span>
<span class="lineNum">    2088 </span>                :<span class="lineCov">       7898 :     LOCK(cs_main);</span>
<span class="lineNum">    2089 </span>                :            :     static int64_t nLastWrite = 0;
<span class="lineNum">    2090 </span>                :            :     static int64_t nLastFlush = 0;
<span class="lineNum">    2091 </span>                :<span class="lineNoCov">          0 :     std::set&lt;int&gt; setFilesToPrune;</span>
<span class="lineNum">    2092 </span>                :<span class="lineCov">       3949 :     bool full_flush_completed = false;</span>
<span class="lineNum">    2093 </span>                :            :     try {
<span class="lineNum">    2094 </span>                :            :     {
<span class="lineNum">    2095 </span>                :<span class="lineCov">       3949 :         bool fFlushForPrune = false;</span>
<span class="lineNum">    2096 </span>                :<span class="lineCov">       3949 :         bool fDoFullFlush = false;</span>
<span class="lineNum">    2097 </span>        [<span class="branchCov" title="Branch 1 was taken 3949 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       3949 :         LOCK(cs_LastBlockFile);</span>
<span class="lineNum">    2098 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3949 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       3949 :         if (fPruneMode &amp;&amp; (fCheckForPruning || nManualPruneHeight &gt; 0) &amp;&amp; !fReindex) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    2099 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (nManualPruneHeight &gt; 0) {</span>
<span class="lineNum">    2100 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 FindFilesToPruneManual(setFilesToPrune, nManualPruneHeight);</span>
<span class="lineNum">    2101 </span>                :            :             } else {
<span class="lineNum">    2102 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight());</span>
<span class="lineNum">    2103 </span>                :<span class="lineNoCov">          0 :                 fCheckForPruning = false;</span>
<span class="lineNum">    2104 </span>                :            :             }
<span class="lineNum">    2105 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!setFilesToPrune.empty()) {</span>
<span class="lineNum">    2106 </span>                :<span class="lineNoCov">          0 :                 fFlushForPrune = true;</span>
<span class="lineNum">    2107 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (!fHavePruned) {</span>
<span class="lineNum">    2108 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     pblocktree-&gt;WriteFlag(&quot;prunedblockfiles&quot;, true);</span>
<span class="lineNum">    2109 </span>                :<span class="lineNoCov">          0 :                     fHavePruned = true;</span>
<span class="lineNum">    2110 </span>                :            :                 }
<span class="lineNum">    2111 </span>                :            :             }
<span class="lineNum">    2112 </span>                :            :         }
<span class="lineNum">    2113 </span>        [<span class="branchCov" title="Branch 1 was taken 3949 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       3949 :         int64_t nNow = GetTimeMicros();</span>
<span class="lineNum">    2114 </span>                :            :         // Avoid writing/flushing immediately after startup.
<span class="lineNum">    2115 </span>        [<span class="branchCov" title="Branch 0 was taken 17 times"> + </span><span class="branchCov" title="Branch 1 was taken 3932 times"> + </span>]:<span class="lineCov">       3949 :         if (nLastWrite == 0) {</span>
<span class="lineNum">    2116 </span>                :<span class="lineCov">         17 :             nLastWrite = nNow;</span>
<span class="lineNum">    2117 </span>                :            :         }
<span class="lineNum">    2118 </span>        [<span class="branchCov" title="Branch 0 was taken 17 times"> + </span><span class="branchCov" title="Branch 1 was taken 3932 times"> + </span>]:<span class="lineCov">       3949 :         if (nLastFlush == 0) {</span>
<span class="lineNum">    2119 </span>                :<span class="lineCov">         17 :             nLastFlush = nNow;</span>
<span class="lineNum">    2120 </span>                :            :         }
<span class="lineNum">    2121 </span>[<span class="branchCov" title="Branch 1 was taken 3949 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 3949 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       3949 :         int64_t nMempoolSizeMax = gArgs.GetArg(&quot;-maxmempool&quot;, DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;</span>
<span class="lineNum">    2122 </span>        [<span class="branchCov" title="Branch 1 was taken 3949 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       3949 :         int64_t cacheSize = pcoinsTip-&gt;DynamicMemoryUsage();</span>
<span class="lineNum">    2123 </span>                :<span class="lineCov">       7898 :         int64_t nTotalSpace = nCoinCacheUsage + std::max&lt;int64_t&gt;(nMempoolSizeMax - nMempoolUsage, 0);</span>
<span class="lineNum">    2124 </span>                :            :         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).
<span class="lineNum">    2125 </span>[<span class="branchCov" title="Branch 0 was taken 1302 times"> + </span><span class="branchCov" title="Branch 1 was taken 2647 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1302 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       5251 :         bool fCacheLarge = mode == FlushStateMode::PERIODIC &amp;&amp; cacheSize &gt; std::max((9 * nTotalSpace) / 10, nTotalSpace - MAX_BLOCK_COINSDB_USAGE * 1024 * 1024);</span>
<span class="lineNum">    2126 </span>                :            :         // The cache is over the limit, we have to write now.
<span class="lineNum">    2127 </span>                :<span class="lineCov">       3949 :         bool fCacheCritical = mode == FlushStateMode::IF_NEEDED &amp;&amp; cacheSize &gt; nTotalSpace;</span>
<span class="lineNum">    2128 </span>                :            :         // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash.
<span class="lineNum">    2129 </span>[<span class="branchCov" title="Branch 0 was taken 1302 times"> + </span><span class="branchCov" title="Branch 1 was taken 2647 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1302 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       3949 :         bool fPeriodicWrite = mode == FlushStateMode::PERIODIC &amp;&amp; nNow &gt; nLastWrite + (int64_t)DATABASE_WRITE_INTERVAL * 1000000;</span>
<span class="lineNum">    2130 </span>                :            :         // It's been very long since we flushed the cache. Do this infrequently, to optimize cache usage.
<span class="lineNum">    2131 </span>[<span class="branchCov" title="Branch 0 was taken 1302 times"> + </span><span class="branchCov" title="Branch 1 was taken 2647 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1302 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       3949 :         bool fPeriodicFlush = mode == FlushStateMode::PERIODIC &amp;&amp; nNow &gt; nLastFlush + (int64_t)DATABASE_FLUSH_INTERVAL * 1000000;</span>
<span class="lineNum">    2132 </span>                :            :         // Combine all conditions that result in a full cache flush.
<span class="lineNum">    2133 </span>[<span class="branchCov" title="Branch 0 was taken 3949 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 3949 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       3949 :         fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicFlush || fFlushForPrune;</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 3949 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<span class="lineNum">    2134 </span>                :            :         // Write blocks and block index to disk.
<span class="lineNum">    2135 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3949 times"> + </span>]:<span class="lineCov">       3949 :         if (fDoFullFlush || fPeriodicWrite) {</span>
<span class="lineNum">    2136 </span>                :            :             // Depend on nMinDiskSpace to ensure we can write block index
<span class="lineNum">    2137 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!CheckDiskSpace(0, true))</span>
<span class="lineNum">    2138 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return state.Error(&quot;out of disk space&quot;);</span>
<span class="lineNum">    2139 </span>                :            :             // First make sure all block and undo data is flushed to disk.
<span class="lineNum">    2140 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             FlushBlockFile();</span>
<span class="lineNum">    2141 </span>                :            :             // Then update all block file information (which may refer to block and undo files).
<span class="lineNum">    2142 </span>                :            :             {
<span class="lineNum">    2143 </span>                :<span class="lineNoCov">          0 :                 std::vector&lt;std::pair&lt;int, const CBlockFileInfo*&gt; &gt; vFiles;</span>
<span class="lineNum">    2144 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 vFiles.reserve(setDirtyFileInfo.size());</span>
<span class="lineNum">    2145 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 for (std::set&lt;int&gt;::iterator it = setDirtyFileInfo.begin(); it != setDirtyFileInfo.end(); ) {</span>
<span class="lineNum">    2146 </span>                :<span class="lineNoCov">          0 :                     vFiles.push_back(std::make_pair(*it, &amp;vinfoBlockFile[*it]));</span>
<span class="lineNum">    2147 </span>                :<span class="lineNoCov">          0 :                     setDirtyFileInfo.erase(it++);</span>
<span class="lineNum">    2148 </span>                :            :                 }
<span class="lineNum">    2149 </span>                :<span class="lineNoCov">          0 :                 std::vector&lt;const CBlockIndex*&gt; vBlocks;</span>
<span class="lineNum">    2150 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 vBlocks.reserve(setDirtyBlockIndex.size());</span>
<span class="lineNum">    2151 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 for (std::set&lt;CBlockIndex*&gt;::iterator it = setDirtyBlockIndex.begin(); it != setDirtyBlockIndex.end(); ) {</span>
<span class="lineNum">    2152 </span>                :<span class="lineNoCov">          0 :                     vBlocks.push_back(*it);</span>
<span class="lineNum">    2153 </span>                :<span class="lineNoCov">          0 :                     setDirtyBlockIndex.erase(it++);</span>
<span class="lineNum">    2154 </span>                :            :                 }
<span class="lineNum">    2155 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (!pblocktree-&gt;WriteBatchSync(vFiles, nLastBlockFile, vBlocks)) {</span>
<span class="lineNum">    2156 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     return AbortNode(state, &quot;Failed to write to block index database&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    2157 </span>                :            :                 }
<span class="lineNum">    2158 </span>                :            :             }
<span class="lineNum">    2159 </span>                :            :             // Finally remove any pruned files
<span class="lineNum">    2160 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (fFlushForPrune)</span>
<span class="lineNum">    2161 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 UnlinkPrunedFiles(setFilesToPrune);</span>
<span class="lineNum">    2162 </span>                :<span class="lineNoCov">          0 :             nLastWrite = nNow;</span>
<span class="lineNum">    2163 </span>                :            :         }
<span class="lineNum">    2164 </span>                :            :         // Flush best chain related state. This can only be done if the blocks / block index write was also done.
<span class="lineNum">    2165 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3949 times"> + </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineCov">       3949 :         if (fDoFullFlush &amp;&amp; !pcoinsTip-&gt;GetBestBlock().IsNull()) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">    2166 </span>                :            :             // Typical Coin structures on disk are around 48 bytes in size.
<span class="lineNum">    2167 </span>                :            :             // Pushing a new one to the database can cause it to be written
<span class="lineNum">    2168 </span>                :            :             // twice (once in the log, and once in the tables). This is already
<span class="lineNum">    2169 </span>                :            :             // an overestimation, as most will delete an existing entry or
<span class="lineNum">    2170 </span>                :            :             // overwrite one. Still, use a conservative safety factor of 2.
<span class="lineNum">    2171 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!CheckDiskSpace(48 * 2 * 2 * pcoinsTip-&gt;GetCacheSize()))</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    2172 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return state.Error(&quot;out of disk space&quot;);</span>
<span class="lineNum">    2173 </span>                :            :             // Flush the chainstate (which may refer to block index entries).
<span class="lineNum">    2174 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!pcoinsTip-&gt;Flush())</span>
<span class="lineNum">    2175 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return AbortNode(state, &quot;Failed to write to coin database&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    2176 </span>                :<span class="lineNoCov">          0 :             nLastFlush = nNow;</span>
<span class="lineNum">    2177 </span>                :<span class="lineNoCov">          0 :             full_flush_completed = true;</span>
<span class="lineNum">    2178 </span>                :            :         }
<span class="lineNum">    2179 </span>                :            :     }
<span class="lineNum">    2180 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3949 times"> + </span>]:<span class="lineCov">       3949 :     if (full_flush_completed) {</span>
<span class="lineNum">    2181 </span>                :            :         // Update best block in wallet (so we can detect restored wallets).
<span class="lineNum">    2182 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         GetMainSignals().ChainStateFlushed(chainActive.GetLocator());</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>][<span class="branchNoExec" title="Branch 9 was not executed"> # </span><span class="branchNoExec" title="Branch 10 was not executed"> # </span>]
<span class="lineNum">    2183 </span>                :            :     }
<span class="lineNum">    2184 </span>                :<span class="lineNoCov">          0 :     } catch (const std::runtime_error&amp; e) {</span>
<span class="lineNum">    2185 </span>  [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span> :<span class="lineNoCov">          0 :         return AbortNode(state, std::string(&quot;System error while flushing: &quot;) + e.what());</span>
<span class="lineNum">         </span>   <span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span><span class="branchNoExec" title="Branch 12 was not executed"> # </span>]
<span class="lineNum">    2186 </span>                :            :     }
<span class="lineNum">    2187 </span>                :            :     return true;
<span class="lineNum">    2188 </span>                :            : }
<span class="lineNum">    2189 </span>                :            : 
<span class="lineNum">    2190 </span>                :<span class="lineNoCov">          0 : void FlushStateToDisk() {</span>
<span class="lineNum">    2191 </span>                :<span class="lineNoCov">          0 :     CValidationState state;</span>
<span class="lineNum">    2192 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     const CChainParams&amp; chainparams = Params();</span>
<span class="lineNum">    2193 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!FlushStateToDisk(chainparams, state, FlushStateMode::ALWAYS)) {</span>
<span class="lineNum">    2194 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LogPrintf(&quot;%s: failed to flush state (%s)\n&quot;, __func__, FormatStateMessage(state));</span>
<span class="lineNum">    2195 </span>                :            :     }
<span class="lineNum">    2196 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2197 </span>                :            : 
<span class="lineNum">    2198 </span>                :<span class="lineNoCov">          0 : void PruneAndFlush() {</span>
<span class="lineNum">    2199 </span>                :<span class="lineNoCov">          0 :     CValidationState state;</span>
<span class="lineNum">    2200 </span>                :<span class="lineNoCov">          0 :     fCheckForPruning = true;</span>
<span class="lineNum">    2201 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     const CChainParams&amp; chainparams = Params();</span>
<span class="lineNum">    2202 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!FlushStateToDisk(chainparams, state, FlushStateMode::NONE)) {</span>
<span class="lineNum">    2203 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LogPrintf(&quot;%s: failed to flush state (%s)\n&quot;, __func__, FormatStateMessage(state));</span>
<span class="lineNum">    2204 </span>                :            :     }
<a name="2205"><span class="lineNum">    2205 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2206 </span>                :            : 
<span class="lineNum">    2207 </span>                :<span class="lineNoCov">          0 : static void DoWarning(const std::string&amp; strWarning)</span>
<span class="lineNum">    2208 </span>                :            : {
<span class="lineNum">    2209 </span>                :            :     static bool fWarned = false;
<span class="lineNum">    2210 </span>                :<span class="lineNoCov">          0 :     SetMiscWarning(strWarning);</span>
<span class="lineNum">    2211 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!fWarned) {</span>
<span class="lineNum">    2212 </span>                :<span class="lineNoCov">          0 :         AlertNotify(strWarning);</span>
<span class="lineNum">    2213 </span>                :<span class="lineNoCov">          0 :         fWarned = true;</span>
<span class="lineNum">    2214 </span>                :            :     }
<span class="lineNum">    2215 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="2216"><span class="lineNum">    2216 </span>                :            : </a>
<span class="lineNum">    2217 </span>                :            : /** Private helper function that concatenates warning messages. */
<span class="lineNum">    2218 </span>                :<span class="lineNoCov">          0 : static void AppendWarning(std::string&amp; res, const std::string&amp; warn)</span>
<span class="lineNum">    2219 </span>                :            : {
<span class="lineNum">    2220 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!res.empty()) res += &quot;, &quot;;</span>
<span class="lineNum">    2221 </span>                :<span class="lineNoCov">          0 :     res += warn;</span>
<span class="lineNum">    2222 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2223 </span>                :            : 
<span class="lineNum">    2224 </span>                :            : /** Check warning conditions and do some notifications on new chain tip set. */
<span class="lineNum">    2225 </span>                :<span class="lineCov">       1344 : void static UpdateTip(const CBlockIndex *pindexNew, const CChainParams&amp; chainParams) {</span>
<span class="lineNum">    2226 </span>                :            :     // New best block
<span class="lineNum">    2227 </span>                :<span class="lineCov">       1344 :     mempool.AddTransactionsUpdated(1);</span>
<span class="lineNum">    2228 </span>                :            : 
<span class="lineNum">    2229 </span>                :            :     {
<span class="lineNum">    2230 </span>                :<span class="lineCov">       1344 :         LOCK(g_best_block_mutex);</span>
<span class="lineNum">    2231 </span>                :<span class="lineCov">       1344 :         g_best_block = pindexNew-&gt;GetBlockHash();</span>
<span class="lineNum">    2232 </span>                :<span class="lineCov">       1344 :         g_best_block_cv.notify_all();</span>
<span class="lineNum">    2233 </span>                :            :     }
<span class="lineNum">    2234 </span>                :            : 
<span class="lineNum">    2235 </span>                :<span class="lineCov">       2688 :     std::string warningMessages;</span>
<span class="lineNum">    2236 </span>[<span class="branchCov" title="Branch 1 was taken 1344 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1128 times"> + </span><span class="branchCov" title="Branch 4 was taken 216 times"> + </span>]:<span class="lineCov">       1344 :     if (!IsInitialBlockDownload())</span>
<span class="lineNum">    2237 </span>                :            :     {
<span class="lineNum">    2238 </span>                :<span class="lineCov">       1128 :         int nUpgraded = 0;</span>
<span class="lineNum">    2239 </span>                :<span class="lineCov">       1128 :         const CBlockIndex* pindex = pindexNew;</span>
<span class="lineNum">    2240 </span>        [<span class="branchCov" title="Branch 0 was taken 32712 times"> + </span><span class="branchCov" title="Branch 1 was taken 1128 times"> + </span>]:<span class="lineCov">      33840 :         for (int bit = 0; bit &lt; VERSIONBITS_NUM_BITS; bit++) {</span>
<span class="lineNum">    2241 </span>                :<span class="lineCov">      65424 :             WarningBitsConditionChecker checker(bit);</span>
<span class="lineNum">    2242 </span>        [<span class="branchCov" title="Branch 1 was taken 32712 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      32712 :             ThresholdState state = checker.GetStateFor(pindex, chainParams.GetConsensus(), warningcache[bit]);</span>
<span class="lineNum">    2243 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 32712 times"> + </span>]:<span class="lineCov">      32712 :             if (state == ThresholdState::ACTIVE || state == ThresholdState::LOCKED_IN) {</span>
<span class="lineNum">    2244 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 const std::string strWarning = strprintf(_(&quot;Warning: unknown new rules activated (versionbit %i)&quot;), bit);</span>
<span class="lineNum">    2245 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (state == ThresholdState::ACTIVE) {</span>
<span class="lineNum">    2246 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     DoWarning(strWarning);</span>
<span class="lineNum">    2247 </span>                :            :                 } else {
<span class="lineNum">    2248 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     AppendWarning(warningMessages, strWarning);</span>
<span class="lineNum">    2249 </span>                :            :                 }
<span class="lineNum">    2250 </span>                :            :             }
<span class="lineNum">    2251 </span>                :            :         }
<span class="lineNum">    2252 </span>                :            :         // Check the version of the last 100 blocks to see if we need to upgrade:
<span class="lineNum">    2253 </span>        [<span class="branchCov" title="Branch 0 was taken 58548 times"> + </span><span class="branchCov" title="Branch 1 was taken 1128 times"> + </span>]:<span class="lineCov">      59676 :         for (int i = 0; i &lt; 100 &amp;&amp; pindex != nullptr; i++)</span>
<span class="lineNum">    2254 </span>                :            :         {
<span class="lineNum">    2255 </span>        [<span class="branchCov" title="Branch 1 was taken 58548 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      58548 :             int32_t nExpectedVersion = ComputeBlockVersion(pindex-&gt;pprev, chainParams.GetConsensus());</span>
<span class="lineNum">    2256 </span>[<span class="branchCov" title="Branch 0 was taken 57450 times"> + </span><span class="branchCov" title="Branch 1 was taken 1098 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 57450 times"> + </span>]:<span class="lineCov">      58548 :             if (pindex-&gt;nVersion &gt; VERSIONBITS_LAST_OLD_BLOCK_VERSION &amp;&amp; (pindex-&gt;nVersion &amp; ~nExpectedVersion) != 0)</span>
<span class="lineNum">    2257 </span>                :<span class="lineNoCov">          0 :                 ++nUpgraded;</span>
<span class="lineNum">    2258 </span>                :<span class="lineCov">      58548 :             pindex = pindex-&gt;pprev;</span>
<span class="lineNum">    2259 </span>                :            :         }
<span class="lineNum">    2260 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1128 times"> + </span>]:<span class="lineCov">       1128 :         if (nUpgraded &gt; 0)</span>
<span class="lineNum">    2261 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineCov">       1128 :             AppendWarning(warningMessages, strprintf(_(&quot;%d of last 100 blocks have unexpected version&quot;), nUpgraded));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    2262 </span>                :            :     }
<span class="lineNum">    2263 </span>        [<span class="branchCov" title="Branch 1 was taken 1344 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1344 :     LogPrintf(&quot;%s: new best=%s height=%d version=0x%08x log2_work=%.8g tx=%lu date='%s' progress=%f cache=%.1fMiB(%utxo)&quot;, __func__, /* Continued */</span>
<span class="lineNum">    2264 </span>        [<span class="branchCov" title="Branch 1 was taken 1344 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1344 :       pindexNew-&gt;GetBlockHash().ToString(), pindexNew-&gt;nHeight, pindexNew-&gt;nVersion,</span>
<span class="lineNum">    2265 </span>        [<span class="branchCov" title="Branch 1 was taken 1344 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1344 :       log(pindexNew-&gt;nChainWork.getdouble())/log(2.0), (unsigned long)pindexNew-&gt;nChainTx,</span>
<span class="lineNum">    2266 </span>        [<span class="branchCov" title="Branch 1 was taken 1344 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1344 :       FormatISO8601DateTime(pindexNew-&gt;GetBlockTime()),</span>
<span class="lineNum">    2267 </span>[<span class="branchCov" title="Branch 1 was taken 1344 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 1344 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       1344 :       GuessVerificationProgress(chainParams.TxData(), pindexNew), pcoinsTip-&gt;DynamicMemoryUsage() * (1.0 / (1&lt;&lt;20)), pcoinsTip-&gt;GetCacheSize());</span>
<span class="lineNum">    2268 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1344 times"> + </span>]:<span class="lineCov">       1344 :     if (!warningMessages.empty())</span>
<span class="lineNum">    2269 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LogPrintf(&quot; warning='%s'&quot;, warningMessages); /* Continued */</span>
<span class="lineNum">    2270 </span>        [<span class="branchCov" title="Branch 1 was taken 1344 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1344 :     LogPrintf(&quot;\n&quot;);</span>
<span class="lineNum">    2271 </span>                :            : 
<span class="lineNum">    2272 </span>                :<span class="lineCov">       1344 : }</span>
<span class="lineNum">    2273 </span>                :            : 
<span class="lineNum">    2274 </span>                :            : /** Disconnect chainActive's tip.
<span class="lineNum">    2275 </span>                :            :   * After calling, the mempool will be in an inconsistent state, with
<span class="lineNum">    2276 </span>                :            :   * transactions from disconnected blocks being added to disconnectpool.  You
<span class="lineNum">    2277 </span>                :            :   * should make the mempool consistent again by calling UpdateMempoolForReorg.
<span class="lineNum">    2278 </span>                :            :   * with cs_main held.
<span class="lineNum">    2279 </span>                :            :   *
<span class="lineNum">    2280 </span>                :            :   * If disconnectpool is nullptr, then no disconnected transactions are added to
<span class="lineNum">    2281 </span>                :            :   * disconnectpool (note that the caller is responsible for mempool consistency
<span class="lineNum">    2282 </span>                :            :   * in any case).
<span class="lineNum">    2283 </span>                :            :   */
<span class="lineNum">    2284 </span>                :<span class="lineCov">          7 : bool CChainState::DisconnectTip(CValidationState&amp; state, const CChainParams&amp; chainparams, DisconnectedBlockTransactions *disconnectpool)</span>
<span class="lineNum">    2285 </span>                :            : {
<span class="lineNum">    2286 </span>                :<span class="lineCov">         14 :     CBlockIndex *pindexDelete = chainActive.Tip();</span>
<span class="lineNum">    2287 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">          7 :     assert(pindexDelete);</span>
<span class="lineNum">    2288 </span>                :            :     // Read block from disk.
<span class="lineNum">    2289 </span>                :<span class="lineCov">          7 :     std::shared_ptr&lt;CBlock&gt; pblock = std::make_shared&lt;CBlock&gt;();</span>
<span class="lineNum">    2290 </span>                :<span class="lineCov">          7 :     CBlock&amp; block = *pblock;</span>
<span class="lineNum">    2291 </span>[<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 7 times"> + </span>]:<span class="lineCov">          7 :     if (!ReadBlockFromDisk(block, pindexDelete, chainparams.GetConsensus()))</span>
<span class="lineNum">    2292 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return AbortNode(state, &quot;Failed to read block&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    2293 </span>                :            :     // Apply the block atomically to the chain state.
<span class="lineNum">    2294 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :     int64_t nStart = GetTimeMicros();</span>
<span class="lineNum">    2295 </span>                :            :     {
<span class="lineNum">    2296 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :         CCoinsViewCache view(pcoinsTip.get());</span>
<span class="lineNum">    2297 </span>[<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 7 times"> + </span>]:<span class="lineCov">          7 :         assert(view.GetBestBlock() == pindexDelete-&gt;GetBlockHash());</span>
<span class="lineNum">    2298 </span>[<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 7 times"> + </span>]:<span class="lineCov">          7 :         if (DisconnectBlock(block, pindexDelete, view) != DISCONNECT_OK)</span>
<span class="lineNum">    2299 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return error(&quot;DisconnectTip(): DisconnectBlock %s failed&quot;, pindexDelete-&gt;GetBlockHash().ToString());</span>
<span class="lineNum">    2300 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :         bool flushed = view.Flush();</span>
<span class="lineNum">    2301 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">          7 :         assert(flushed);</span>
<span class="lineNum">    2302 </span>                :            :     }
<span class="lineNum">    2303 </span>[<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          7 :     LogPrint(BCLog::BENCH, &quot;- Disconnect block: %.2fms\n&quot;, (GetTimeMicros() - nStart) * MILLI);</span>
<span class="lineNum">    2304 </span>                :            :     // Write the chain state to disk, if necessary.
<span class="lineNum">    2305 </span>[<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          7 :     if (!FlushStateToDisk(chainparams, state, FlushStateMode::IF_NEEDED))</span>
<span class="lineNum">    2306 </span>                :            :         return false;
<span class="lineNum">    2307 </span>                :            : 
<span class="lineNum">    2308 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          7 :     if (disconnectpool) {</span>
<span class="lineNum">    2309 </span>                :            :         // Save transactions to re-add to mempool at end of reorg
<span class="lineNum">    2310 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">         14 :         for (auto it = block.vtx.rbegin(); it != block.vtx.rend(); ++it) {</span>
<span class="lineNum">    2311 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :             disconnectpool-&gt;addTransaction(*it);</span>
<span class="lineNum">    2312 </span>                :            :         }
<span class="lineNum">    2313 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">          7 :         while (disconnectpool-&gt;DynamicMemoryUsage() &gt; MAX_DISCONNECTED_TX_POOL_SIZE * 1000) {</span>
<span class="lineNum">    2314 </span>                :            :             // Drop the earliest entry, and remove its children from the mempool.
<span class="lineNum">    2315 </span>                :<span class="lineNoCov">          0 :             auto it = disconnectpool-&gt;queuedTx.get&lt;insertion_order&gt;().begin();</span>
<span class="lineNum">    2316 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             mempool.removeRecursive(**it, MemPoolRemovalReason::REORG);</span>
<span class="lineNum">    2317 </span>                :<span class="lineNoCov">          0 :             disconnectpool-&gt;removeEntry(it);</span>
<span class="lineNum">    2318 </span>                :            :         }
<span class="lineNum">    2319 </span>                :            :     }
<span class="lineNum">    2320 </span>                :            : 
<span class="lineNum">    2321 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :     chainActive.SetTip(pindexDelete-&gt;pprev);</span>
<span class="lineNum">    2322 </span>                :            : 
<span class="lineNum">    2323 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :     UpdateTip(pindexDelete-&gt;pprev, chainparams);</span>
<span class="lineNum">    2324 </span>                :            :     // Let wallets know transactions went from 1-confirmed to
<span class="lineNum">    2325 </span>                :            :     // 0-confirmed or conflicted:
<span class="lineNum">    2326 </span>  [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         14 :     GetMainSignals().BlockDisconnected(pblock);</span>
<span class="lineNum">    2327 </span>                :<span class="lineCov">          7 :     return true;</span>
<span class="lineNum">    2328 </span>                :            : }
<span class="lineNum">    2329 </span>                :            : 
<span class="lineNum">    2330 </span>                :            : static int64_t nTimeReadFromDisk = 0;
<span class="lineNum">    2331 </span>                :            : static int64_t nTimeConnectTotal = 0;
<span class="lineNum">    2332 </span>                :            : static int64_t nTimeFlush = 0;
<span class="lineNum">    2333 </span>                :            : static int64_t nTimeChainState = 0;
<a name="2334"><span class="lineNum">    2334 </span>                :            : static int64_t nTimePostConnect = 0;</a>
<span class="lineNum">    2335 </span>                :            : 
<span class="lineNum">    2336 </span>                :<span class="lineCov">      14543 : struct PerBlockConnectTrace {</span>
<span class="lineNum">    2337 </span>                :            :     CBlockIndex* pindex = nullptr;
<a name="2338"><span class="lineNum">    2338 </span>                :            :     std::shared_ptr&lt;const CBlock&gt; pblock;</a>
<span class="lineNum">    2339 </span>                :            :     std::shared_ptr&lt;std::vector&lt;CTransactionRef&gt;&gt; conflictedTxs;
<span class="lineNum">    2340 </span>                :<span class="lineCov">      13199 :     PerBlockConnectTrace() : conflictedTxs(std::make_shared&lt;std::vector&lt;CTransactionRef&gt;&gt;()) {}</span>
<span class="lineNum">    2341 </span>                :            : };
<span class="lineNum">    2342 </span>                :            : /**
<span class="lineNum">    2343 </span>                :            :  * Used to track blocks whose transactions were applied to the UTXO state as a
<span class="lineNum">    2344 </span>                :            :  * part of a single ActivateBestChainStep call.
<span class="lineNum">    2345 </span>                :            :  *
<span class="lineNum">    2346 </span>                :            :  * This class also tracks transactions that are removed from the mempool as
<span class="lineNum">    2347 </span>                :            :  * conflicts (per block) and can be used to pass all those transactions
<span class="lineNum">    2348 </span>                :            :  * through SyncTransaction.
<span class="lineNum">    2349 </span>                :            :  *
<span class="lineNum">    2350 </span>                :            :  * This class assumes (and asserts) that the conflicted transactions for a given
<span class="lineNum">    2351 </span>                :            :  * block are added via mempool callbacks prior to the BlockConnected() associated
<span class="lineNum">    2352 </span>                :            :  * with those transactions. If any transactions are marked conflicted, it is
<span class="lineNum">    2353 </span>                :            :  * assumed that an associated block will always be added.
<span class="lineNum">    2354 </span>                :            :  *
<span class="lineNum">    2355 </span>                :            :  * This class is single-use, once you call GetBlocksConnected() you have to throw
<span class="lineNum">    2356 </span>                :            :  * it away and make a new one.
<span class="lineNum">    2357 </span>                :            :  */
<span class="lineNum">    2358 </span>                :<span class="lineCov">      11862 : class ConnectTrace {</span>
<span class="lineNum">    2359 </span>                :            : private:
<span class="lineNum">    2360 </span>                :            :     std::vector&lt;PerBlockConnectTrace&gt; blocksConnected;
<span class="lineNum">    2361 </span>                :            :     CTxMemPool &amp;pool;
<span class="lineNum">    2362 </span>                :            :     boost::signals2::scoped_connection m_connNotifyEntryRemoved;
<a name="2363"><span class="lineNum">    2363 </span>                :            : </a>
<span class="lineNum">    2364 </span>                :            : public:
<span class="lineNum">    2365 </span>                :<span class="lineCov">      23724 :     explicit ConnectTrace(CTxMemPool &amp;_pool) : blocksConnected(1), pool(_pool) {</span>
<span class="lineNum">    2366 </span>[<span class="branchCov" title="Branch 1 was taken 11862 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 11862 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">      23724 :         m_connNotifyEntryRemoved = pool.NotifyEntryRemoved.connect(std::bind(&amp;ConnectTrace::NotifyEntryRemoved, this, std::placeholders::_1, std::placeholders::_2));</span>
<a name="2367"><span class="lineNum">    2367 </span>                :<span class="lineCov">      11862 :     }</span></a>
<span class="lineNum">    2368 </span>                :            : 
<span class="lineNum">    2369 </span>                :<span class="lineCov">       1337 :     void BlockConnected(CBlockIndex* pindex, std::shared_ptr&lt;const CBlock&gt; pblock) {</span>
<span class="lineNum">    2370 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1337 times"> + </span>]:<span class="lineCov">       1337 :         assert(!blocksConnected.back().pindex);</span>
<span class="lineNum">    2371 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1337 times"> + </span>]:<span class="lineCov">       1337 :         assert(pindex);</span>
<span class="lineNum">    2372 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1337 times"> + </span>]:<span class="lineCov">       1337 :         assert(pblock);</span>
<span class="lineNum">    2373 </span>                :<span class="lineCov">       2674 :         blocksConnected.back().pindex = pindex;</span>
<span class="lineNum">    2374 </span>                :<span class="lineCov">       4011 :         blocksConnected.back().pblock = std::move(pblock);</span>
<span class="lineNum">    2375 </span>                :<span class="lineCov">       1337 :         blocksConnected.emplace_back();</span>
<span class="lineNum">    2376 </span>                :<span class="lineCov">       1337 :     }</span>
<span class="lineNum">    2377 </span>                :            : 
<span class="lineNum">    2378 </span>                :<span class="lineCov">       1333 :     std::vector&lt;PerBlockConnectTrace&gt;&amp; GetBlocksConnected() {</span>
<span class="lineNum">    2379 </span>                :            :         // We always keep one extra block at the end of our list because
<span class="lineNum">    2380 </span>                :            :         // blocks are added after all the conflicted transactions have
<span class="lineNum">    2381 </span>                :            :         // been filled in. Thus, the last entry should always be an empty
<span class="lineNum">    2382 </span>                :            :         // one waiting for the transactions from the next block. We pop
<span class="lineNum">    2383 </span>                :            :         // the last entry here to make sure the list we return is sane.
<span class="lineNum">    2384 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1333 times"> + </span>]:<span class="lineCov">       1333 :         assert(!blocksConnected.back().pindex);</span>
<span class="lineNum">    2385 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1333 times"> + </span>]:<span class="lineCov">       1333 :         assert(blocksConnected.back().conflictedTxs-&gt;empty());</span>
<span class="lineNum">    2386 </span>                :<span class="lineCov">       2666 :         blocksConnected.pop_back();</span>
<span class="lineNum">    2387 </span>                :<span class="lineCov">       1333 :         return blocksConnected;</span>
<a name="2388"><span class="lineNum">    2388 </span>                :            :     }</a>
<span class="lineNum">    2389 </span>                :            : 
<span class="lineNum">    2390 </span>                :<span class="lineCov">          1 :     void NotifyEntryRemoved(CTransactionRef txRemoved, MemPoolRemovalReason reason) {</span>
<span class="lineNum">    2391 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         assert(!blocksConnected.back().pindex);</span>
<span class="lineNum">    2392 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         if (reason == MemPoolRemovalReason::CONFLICT) {</span>
<span class="lineNum">    2393 </span>                :<span class="lineNoCov">          0 :             blocksConnected.back().conflictedTxs-&gt;emplace_back(std::move(txRemoved));</span>
<span class="lineNum">    2394 </span>                :            :         }
<span class="lineNum">    2395 </span>                :<span class="lineCov">          1 :     }</span>
<span class="lineNum">    2396 </span>                :            : };
<span class="lineNum">    2397 </span>                :            : 
<span class="lineNum">    2398 </span>                :            : /**
<span class="lineNum">    2399 </span>                :            :  * Connect a new block to chainActive. pblock is either nullptr or a pointer to a CBlock
<span class="lineNum">    2400 </span>                :            :  * corresponding to pindexNew, to bypass loading it again from disk.
<span class="lineNum">    2401 </span>                :            :  *
<span class="lineNum">    2402 </span>                :            :  * The block is added to connectTrace if connection succeeds.
<span class="lineNum">    2403 </span>                :            :  */
<span class="lineNum">    2404 </span>                :<span class="lineCov">       1340 : bool CChainState::ConnectTip(CValidationState&amp; state, const CChainParams&amp; chainparams, CBlockIndex* pindexNew, const std::shared_ptr&lt;const CBlock&gt;&amp; pblock, ConnectTrace&amp; connectTrace, DisconnectedBlockTransactions &amp;disconnectpool)</span>
<span class="lineNum">    2405 </span>                :            : {
<span class="lineNum">    2406 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1340 times"> + </span>]:<span class="lineCov">       1340 :     assert(pindexNew-&gt;pprev == chainActive.Tip());</span>
<span class="lineNum">    2407 </span>                :            :     // Read block from disk.
<span class="lineNum">    2408 </span>                :<span class="lineCov">       1340 :     int64_t nTime1 = GetTimeMicros();</span>
<span class="lineNum">    2409 </span>                :<span class="lineCov">       1340 :     std::shared_ptr&lt;const CBlock&gt; pthisBlock;</span>
<span class="lineNum">    2410 </span>        [<span class="branchCov" title="Branch 0 was taken 109 times"> + </span><span class="branchCov" title="Branch 1 was taken 1231 times"> + </span>]:<span class="lineCov">       1340 :     if (!pblock) {</span>
<span class="lineNum">    2411 </span>                :<span class="lineCov">        109 :         std::shared_ptr&lt;CBlock&gt; pblockNew = std::make_shared&lt;CBlock&gt;();</span>
<span class="lineNum">    2412 </span>[<span class="branchCov" title="Branch 1 was taken 109 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 109 times"> + </span>]:<span class="lineCov">        109 :         if (!ReadBlockFromDisk(*pblockNew, pindexNew, chainparams.GetConsensus()))</span>
<span class="lineNum">    2413 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return AbortNode(state, &quot;Failed to read block&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    2414 </span>                :<span class="lineCov">        109 :         pthisBlock = pblockNew;</span>
<span class="lineNum">    2415 </span>                :            :     } else {
<span class="lineNum">    2416 </span>                :            :         pthisBlock = pblock;
<span class="lineNum">    2417 </span>                :            :     }
<span class="lineNum">    2418 </span>                :<span class="lineCov">       1340 :     const CBlock&amp; blockConnecting = *pthisBlock;</span>
<span class="lineNum">    2419 </span>                :            :     // Apply the block atomically to the chain state.
<span class="lineNum">    2420 </span>        [<span class="branchCov" title="Branch 1 was taken 1340 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1340 :     int64_t nTime2 = GetTimeMicros(); nTimeReadFromDisk += nTime2 - nTime1;</span>
<span class="lineNum">    2421 </span>                :            :     int64_t nTime3;
<span class="lineNum">    2422 </span>        [<span class="branchCov" title="Branch 1 was taken 1340 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1340 :     LogPrint(BCLog::BENCH, &quot;  - Load block from disk: %.2fms [%.2fs]\n&quot;, (nTime2 - nTime1) * MILLI, nTimeReadFromDisk * MICRO);</span>
<span class="lineNum">    2423 </span>                :            :     {
<span class="lineNum">    2424 </span>        [<span class="branchCov" title="Branch 1 was taken 1340 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1340 :         CCoinsViewCache view(pcoinsTip.get());</span>
<span class="lineNum">    2425 </span>        [<span class="branchCov" title="Branch 1 was taken 1340 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1340 :         bool rv = ConnectBlock(blockConnecting, state, pindexNew, view, chainparams);</span>
<span class="lineNum">    2426 </span>[<span class="branchCov" title="Branch 1 was taken 1340 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 1340 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       1340 :         GetMainSignals().BlockChecked(blockConnecting, state);</span>
<span class="lineNum">    2427 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 1337 times"> + </span>]:<span class="lineCov">       1340 :         if (!rv) {</span>
<span class="lineNum">    2428 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :             if (state.IsInvalid())</span>
<span class="lineNum">    2429 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :                 InvalidBlockFound(pindexNew, state);</span>
<span class="lineNum">    2430 </span>[<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          3 :             return error(&quot;%s: ConnectBlock %s failed, %s&quot;, __func__, pindexNew-&gt;GetBlockHash().ToString(), FormatStateMessage(state));</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">    2431 </span>                :            :         }
<span class="lineNum">    2432 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :         nTime3 = GetTimeMicros(); nTimeConnectTotal += nTime3 - nTime2;</span>
<span class="lineNum">    2433 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :         LogPrint(BCLog::BENCH, &quot;  - Connect total: %.2fms [%.2fs (%.2fms/blk)]\n&quot;, (nTime3 - nTime2) * MILLI, nTimeConnectTotal * MICRO, nTimeConnectTotal * MILLI / nBlocksTotal);</span>
<span class="lineNum">    2434 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :         bool flushed = view.Flush();</span>
<span class="lineNum">    2435 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1337 times"> + </span>]:<span class="lineCov">       1337 :         assert(flushed);</span>
<span class="lineNum">    2436 </span>                :            :     }
<span class="lineNum">    2437 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :     int64_t nTime4 = GetTimeMicros(); nTimeFlush += nTime4 - nTime3;</span>
<span class="lineNum">    2438 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :     LogPrint(BCLog::BENCH, &quot;  - Flush: %.2fms [%.2fs (%.2fms/blk)]\n&quot;, (nTime4 - nTime3) * MILLI, nTimeFlush * MICRO, nTimeFlush * MILLI / nBlocksTotal);</span>
<span class="lineNum">    2439 </span>                :            :     // Write the chain state to disk, if necessary.
<span class="lineNum">    2440 </span>[<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       1337 :     if (!FlushStateToDisk(chainparams, state, FlushStateMode::IF_NEEDED))</span>
<span class="lineNum">    2441 </span>                :            :         return false;
<span class="lineNum">    2442 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :     int64_t nTime5 = GetTimeMicros(); nTimeChainState += nTime5 - nTime4;</span>
<span class="lineNum">    2443 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :     LogPrint(BCLog::BENCH, &quot;  - Writing chainstate: %.2fms [%.2fs (%.2fms/blk)]\n&quot;, (nTime5 - nTime4) * MILLI, nTimeChainState * MICRO, nTimeChainState * MILLI / nBlocksTotal);</span>
<span class="lineNum">    2444 </span>                :            :     // Remove conflicting transactions from the mempool.;
<span class="lineNum">    2445 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :     mempool.removeForBlock(blockConnecting.vtx, pindexNew-&gt;nHeight);</span>
<span class="lineNum">    2446 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :     disconnectpool.removeForBlock(blockConnecting.vtx);</span>
<span class="lineNum">    2447 </span>                :            :     // Update chainActive &amp; related variables.
<span class="lineNum">    2448 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :     chainActive.SetTip(pindexNew);</span>
<span class="lineNum">    2449 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :     UpdateTip(pindexNew, chainparams);</span>
<span class="lineNum">    2450 </span>                :            : 
<span class="lineNum">    2451 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :     int64_t nTime6 = GetTimeMicros(); nTimePostConnect += nTime6 - nTime5; nTimeTotal += nTime6 - nTime1;</span>
<span class="lineNum">    2452 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :     LogPrint(BCLog::BENCH, &quot;  - Connect postprocess: %.2fms [%.2fs (%.2fms/blk)]\n&quot;, (nTime6 - nTime5) * MILLI, nTimePostConnect * MICRO, nTimePostConnect * MILLI / nBlocksTotal);</span>
<span class="lineNum">    2453 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :     LogPrint(BCLog::BENCH, &quot;- Connect block: %.2fms [%.2fs (%.2fms/blk)]\n&quot;, (nTime6 - nTime1) * MILLI, nTimeTotal * MICRO, nTimeTotal * MILLI / nBlocksTotal);</span>
<span class="lineNum">    2454 </span>                :            : 
<span class="lineNum">    2455 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :     connectTrace.BlockConnected(pindexNew, std::move(pthisBlock));</span>
<span class="lineNum">    2456 </span>                :<span class="lineCov">       1337 :     return true;</span>
<span class="lineNum">    2457 </span>                :            : }
<span class="lineNum">    2458 </span>                :            : 
<span class="lineNum">    2459 </span>                :            : /**
<span class="lineNum">    2460 </span>                :            :  * Return the tip of the chain with the most work in it, that isn't
<a name="2461"><span class="lineNum">    2461 </span>                :            :  * known to be invalid (it's however far from certain to be valid).</a>
<span class="lineNum">    2462 </span>                :            :  */
<span class="lineNum">    2463 </span>                :<span class="lineCov">      23660 : CBlockIndex* CChainState::FindMostWorkChain() {</span>
<span class="lineNum">    2464 </span>                :            :     do {
<span class="lineNum">    2465 </span>                :<span class="lineCov">      11830 :         CBlockIndex *pindexNew = nullptr;</span>
<span class="lineNum">    2466 </span>                :            : 
<span class="lineNum">    2467 </span>                :            :         // Find the best candidate header.
<span class="lineNum">    2468 </span>                :            :         {
<span class="lineNum">    2469 </span>                :<span class="lineCov">      23660 :             std::set&lt;CBlockIndex*, CBlockIndexWorkComparator&gt;::reverse_iterator it = setBlockIndexCandidates.rbegin();</span>
<span class="lineNum">    2470 </span>        [<span class="branchCov" title="Branch 0 was taken 11830 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      11830 :             if (it == setBlockIndexCandidates.rend())</span>
<span class="lineNum">    2471 </span>                :            :                 return nullptr;
<span class="lineNum">    2472 </span>                :<span class="lineCov">      11830 :             pindexNew = *it;</span>
<span class="lineNum">    2473 </span>                :            :         }
<span class="lineNum">    2474 </span>                :            : 
<span class="lineNum">    2475 </span>                :            :         // Check whether all blocks on the path between the currently active chain and the candidate are valid.
<span class="lineNum">    2476 </span>                :            :         // Just going until the active chain is an optimization, as we know all blocks in it are valid already.
<span class="lineNum">    2477 </span>                :<span class="lineCov">      11830 :         CBlockIndex *pindexTest = pindexNew;</span>
<span class="lineNum">    2478 </span>                :<span class="lineCov">      11830 :         bool fInvalidAncestor = false;</span>
<span class="lineNum">    2479 </span>[<span class="branchCov" title="Branch 0 was taken 13104 times"> + </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1340 times"> + </span><span class="branchCov" title="Branch 3 was taken 11764 times"> + </span>]:<span class="lineCov">      26274 :         while (pindexTest &amp;&amp; !chainActive.Contains(pindexTest)) {</span>
<span class="lineNum">    2480 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1340 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       1340 :             assert(pindexTest-&gt;HaveTxsDownloaded() || pindexTest-&gt;nHeight == 0);</span>
<span class="lineNum">    2481 </span>                :            : 
<span class="lineNum">    2482 </span>                :            :             // Pruned nodes may have entries in setBlockIndexCandidates for
<span class="lineNum">    2483 </span>                :            :             // which block files have been deleted.  Remove those as candidates
<span class="lineNum">    2484 </span>                :            :             // for the most work chain if we come across them; we can't switch
<span class="lineNum">    2485 </span>                :            :             // to a chain unless we have all the non-active-chain parent blocks.
<span class="lineNum">    2486 </span>                :<span class="lineCov">       1340 :             bool fFailedChain = pindexTest-&gt;nStatus &amp; BLOCK_FAILED_MASK;</span>
<span class="lineNum">    2487 </span>                :<span class="lineCov">       1340 :             bool fMissingData = !(pindexTest-&gt;nStatus &amp; BLOCK_HAVE_DATA);</span>
<span class="lineNum">    2488 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1340 times"> + </span>]:<span class="lineCov">       1340 :             if (fFailedChain || fMissingData) {</span>
<span class="lineNum">    2489 </span>                :            :                 // Candidate chain is not usable (either invalid or missing data)
<span class="lineNum">    2490 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (fFailedChain &amp;&amp; (pindexBestInvalid == nullptr || pindexNew-&gt;nChainWork &gt; pindexBestInvalid-&gt;nChainWork))</span>
<span class="lineNum">         </span>  [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    2491 </span>                :<span class="lineNoCov">          0 :                     pindexBestInvalid = pindexNew;</span>
<span class="lineNum">    2492 </span>                :<span class="lineNoCov">          0 :                 CBlockIndex *pindexFailed = pindexNew;</span>
<span class="lineNum">    2493 </span>                :            :                 // Remove the entire chain from the set.
<span class="lineNum">    2494 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 while (pindexTest != pindexFailed) {</span>
<span class="lineNum">    2495 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if (fFailedChain) {</span>
<span class="lineNum">    2496 </span>                :<span class="lineNoCov">          0 :                         pindexFailed-&gt;nStatus |= BLOCK_FAILED_CHILD;</span>
<span class="lineNum">    2497 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     } else if (fMissingData) {</span>
<span class="lineNum">    2498 </span>                :            :                         // If we're missing data, then add back to mapBlocksUnlinked,
<span class="lineNum">    2499 </span>                :            :                         // so that if the block arrives in the future we can try adding
<span class="lineNum">    2500 </span>                :            :                         // to setBlockIndexCandidates again.
<span class="lineNum">    2501 </span>                :<span class="lineNoCov">          0 :                         mapBlocksUnlinked.insert(std::make_pair(pindexFailed-&gt;pprev, pindexFailed));</span>
<span class="lineNum">    2502 </span>                :            :                     }
<span class="lineNum">    2503 </span>                :<span class="lineNoCov">          0 :                     setBlockIndexCandidates.erase(pindexFailed);</span>
<span class="lineNum">    2504 </span>                :<span class="lineNoCov">          0 :                     pindexFailed = pindexFailed-&gt;pprev;</span>
<span class="lineNum">    2505 </span>                :            :                 }
<span class="lineNum">    2506 </span>                :<span class="lineNoCov">          0 :                 setBlockIndexCandidates.erase(pindexTest);</span>
<span class="lineNum">    2507 </span>                :<span class="lineNoCov">          0 :                 fInvalidAncestor = true;</span>
<span class="lineNum">    2508 </span>                :            :                 break;
<span class="lineNum">    2509 </span>                :            :             }
<span class="lineNum">    2510 </span>                :<span class="lineCov">       1340 :             pindexTest = pindexTest-&gt;pprev;</span>
<span class="lineNum">    2511 </span>                :            :         }
<span class="lineNum">    2512 </span>                :            :         if (!fInvalidAncestor)
<span class="lineNum">    2513 </span>                :<span class="lineNoCov">          0 :             return pindexNew;</span>
<span class="lineNum">    2514 </span>                :            :     } while(true);
<span class="lineNum">    2515 </span>                :            : }
<a name="2516"><span class="lineNum">    2516 </span>                :            : </a>
<span class="lineNum">    2517 </span>                :            : /** Delete all entries in setBlockIndexCandidates that are worse than the current tip. */
<span class="lineNum">    2518 </span>                :<span class="lineCov">       1337 : void CChainState::PruneBlockIndexCandidates() {</span>
<span class="lineNum">    2519 </span>                :            :     // Note that we can't delete the current block itself, as we may need to return to it later in case a
<span class="lineNum">    2520 </span>                :            :     // reorganization to a better block fails.
<span class="lineNum">    2521 </span>                :<span class="lineCov">       1337 :     std::set&lt;CBlockIndex*, CBlockIndexWorkComparator&gt;::iterator it = setBlockIndexCandidates.begin();</span>
<span class="lineNum">    2522 </span>[<span class="branchCov" title="Branch 0 was taken 2621 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1284 times"> + </span><span class="branchCov" title="Branch 4 was taken 1337 times"> + </span>]:<span class="lineCov">       5242 :     while (it != setBlockIndexCandidates.end() &amp;&amp; setBlockIndexCandidates.value_comp()(*it, chainActive.Tip())) {</span>
<span class="lineNum">    2523 </span>                :<span class="lineCov">       2568 :         setBlockIndexCandidates.erase(it++);</span>
<span class="lineNum">    2524 </span>                :            :     }
<span class="lineNum">    2525 </span>                :            :     // Either the current tip or a successor of it we're working towards is left in setBlockIndexCandidates.
<span class="lineNum">    2526 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1337 times"> + </span>]:<span class="lineCov">       1337 :     assert(!setBlockIndexCandidates.empty());</span>
<span class="lineNum">    2527 </span>                :<span class="lineCov">       1337 : }</span>
<span class="lineNum">    2528 </span>                :            : 
<span class="lineNum">    2529 </span>                :            : /**
<span class="lineNum">    2530 </span>                :            :  * Try to make some progress towards making pindexMostWork the active block.
<span class="lineNum">    2531 </span>                :            :  * pblock is either nullptr or a pointer to a CBlock corresponding to pindexMostWork.
<span class="lineNum">    2532 </span>                :            :  */
<span class="lineNum">    2533 </span>                :<span class="lineCov">       1333 : bool CChainState::ActivateBestChainStep(CValidationState&amp; state, const CChainParams&amp; chainparams, CBlockIndex* pindexMostWork, const std::shared_ptr&lt;const CBlock&gt;&amp; pblock, bool&amp; fInvalidFound, ConnectTrace&amp; connectTrace)</span>
<span class="lineNum">    2534 </span>                :            : {
<span class="lineNum">    2535 </span>                :<span class="lineCov">       1333 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    2536 </span>                :            : 
<span class="lineNum">    2537 </span>                :<span class="lineCov">       2666 :     const CBlockIndex *pindexOldTip = chainActive.Tip();</span>
<span class="lineNum">    2538 </span>                :<span class="lineCov">       1333 :     const CBlockIndex *pindexFork = chainActive.FindFork(pindexMostWork);</span>
<span class="lineNum">    2539 </span>                :            : 
<span class="lineNum">    2540 </span>                :            :     // Disconnect active blocks which are no longer in the best chain.
<span class="lineNum">    2541 </span>                :<span class="lineCov">       1333 :     bool fBlocksDisconnected = false;</span>
<span class="lineNum">    2542 </span>                :<span class="lineCov">       2666 :     DisconnectedBlockTransactions disconnectpool;</span>
<span class="lineNum">    2543 </span>[<span class="branchCov" title="Branch 0 was taken 1274 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1267 times"> + </span><span class="branchCov" title="Branch 3 was taken 7 times"> + </span>]:<span class="lineCov">       1274 :     while (chainActive.Tip() &amp;&amp; chainActive.Tip() != pindexFork) {</span>
<span class="lineNum">    2544 </span>[<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          7 :         if (!DisconnectTip(state, chainparams, &amp;disconnectpool)) {</span>
<span class="lineNum">    2545 </span>                :            :             // This is likely a fatal error, but keep the mempool consistent,
<span class="lineNum">    2546 </span>                :            :             // just in case. Only remove from the mempool in this case.
<span class="lineNum">    2547 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             UpdateMempoolForReorg(disconnectpool, false);</span>
<span class="lineNum">    2548 </span>                :            :             return false;
<span class="lineNum">    2549 </span>                :            :         }
<span class="lineNum">    2550 </span>                :            :         fBlocksDisconnected = true;
<span class="lineNum">    2551 </span>                :            :     }
<span class="lineNum">    2552 </span>                :            : 
<span class="lineNum">    2553 </span>                :            :     // Build list of new blocks to connect.
<span class="lineNum">    2554 </span>                :<span class="lineNoCov">          0 :     std::vector&lt;CBlockIndex*&gt; vpindexToConnect;</span>
<span class="lineNum">    2555 </span>                :<span class="lineCov">       1333 :     bool fContinue = true;</span>
<span class="lineNum">    2556 </span>        [<span class="branchCov" title="Branch 0 was taken 1267 times"> + </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>]:<span class="lineCov">       1333 :     int nHeight = pindexFork ? pindexFork-&gt;nHeight : -1;</span>
<span class="lineNum">    2557 </span>[<span class="branchCov" title="Branch 0 was taken 1333 times"> + </span><span class="branchCov" title="Branch 1 was taken 1333 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1333 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       2666 :     while (fContinue &amp;&amp; nHeight != pindexMostWork-&gt;nHeight) {</span>
<span class="lineNum">    2558 </span>                :            :         // Don't iterate the entire list of potential improvements toward the best tip, as we likely only need
<span class="lineNum">    2559 </span>                :            :         // a few blocks along the way.
<span class="lineNum">    2560 </span>                :<span class="lineCov">       2666 :         int nTargetHeight = std::min(nHeight + 32, pindexMostWork-&gt;nHeight);</span>
<span class="lineNum">    2561 </span>                :<span class="lineCov">       1333 :         vpindexToConnect.clear();</span>
<span class="lineNum">    2562 </span>        [<span class="branchCov" title="Branch 1 was taken 1333 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1333 :         vpindexToConnect.reserve(nTargetHeight - nHeight);</span>
<span class="lineNum">    2563 </span>        [<span class="branchCov" title="Branch 1 was taken 1333 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1333 :         CBlockIndex *pindexIter = pindexMostWork-&gt;GetAncestor(nTargetHeight);</span>
<span class="lineNum">    2564 </span>[<span class="branchCov" title="Branch 0 was taken 2920 times"> + </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1653 times"> + </span><span class="branchCov" title="Branch 3 was taken 1267 times"> + </span>]:<span class="lineCov">       2986 :         while (pindexIter &amp;&amp; pindexIter-&gt;nHeight != nHeight) {</span>
<span class="lineNum">    2565 </span>        [<span class="branchCov" title="Branch 1 was taken 1653 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1653 :             vpindexToConnect.push_back(pindexIter);</span>
<span class="lineNum">    2566 </span>                :<span class="lineCov">       1653 :             pindexIter = pindexIter-&gt;pprev;</span>
<span class="lineNum">    2567 </span>                :            :         }
<span class="lineNum">    2568 </span>                :<span class="lineCov">       1333 :         nHeight = nTargetHeight;</span>
<span class="lineNum">    2569 </span>                :            : 
<span class="lineNum">    2570 </span>                :            :         // Connect new blocks.
<span class="lineNum">    2571 </span>        [<span class="branchCov" title="Branch 1 was taken 1340 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       2673 :         for (CBlockIndex *pindexConnect : reverse_iterate(vpindexToConnect)) {</span>
<span class="lineNum">    2572 </span>[<span class="branchCov" title="Branch 0 was taken 1301 times"> + </span><span class="branchCov" title="Branch 1 was taken 39 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 1340 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       4020 :             if (!ConnectTip(state, chainparams, pindexConnect, pindexConnect == pindexMostWork ? pblock : std::shared_ptr&lt;const CBlock&gt;(), connectTrace, disconnectpool)) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken 3 times"> + </span><span class="branchCov" title="Branch 6 was taken 1337 times"> + </span>]
<span class="lineNum">    2573 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :                 if (state.IsInvalid()) {</span>
<span class="lineNum">    2574 </span>                :            :                     // The block violates a consensus rule.
<span class="lineNum">    2575 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :                     if (!state.CorruptionPossible()) {</span>
<span class="lineNum">    2576 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :                         InvalidChainFound(vpindexToConnect.front());</span>
<span class="lineNum">    2577 </span>                :            :                     }
<span class="lineNum">    2578 </span>                :<span class="lineCov">          3 :                     state = CValidationState();</span>
<span class="lineNum">    2579 </span>                :<span class="lineCov">          3 :                     fInvalidFound = true;</span>
<span class="lineNum">    2580 </span>                :<span class="lineCov">          3 :                     fContinue = false;</span>
<span class="lineNum">    2581 </span>                :<span class="lineCov">          3 :                     break;</span>
<span class="lineNum">    2582 </span>                :            :                 } else {
<span class="lineNum">    2583 </span>                :            :                     // A system error occurred (disk space, database error, ...).
<span class="lineNum">    2584 </span>                :            :                     // Make the mempool consistent with the current tip, just in case
<span class="lineNum">    2585 </span>                :            :                     // any observers try to use it before shutdown.
<span class="lineNum">    2586 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     UpdateMempoolForReorg(disconnectpool, false);</span>
<span class="lineNum">    2587 </span>                :<span class="lineNoCov">          0 :                     return false;</span>
<span class="lineNum">    2588 </span>                :            :                 }
<span class="lineNum">    2589 </span>                :            :             } else {
<span class="lineNum">    2590 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1337 :                 PruneBlockIndexCandidates();</span>
<span class="lineNum">    2591 </span>[<span class="branchCov" title="Branch 0 was taken 1271 times"> + </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchCov" title="Branch 3 was taken 1264 times"> + </span>]:<span class="lineCov">       2608 :                 if (!pindexOldTip || chainActive.Tip()-&gt;nChainWork &gt; pindexOldTip-&gt;nChainWork) {</span>
<span class="lineNum">    2592 </span>                :            :                     // We're in a better position than we were. Return temporarily to release the lock.
<span class="lineNum">    2593 </span>                :            :                     fContinue = false;
<span class="lineNum">    2594 </span>                :            :                     break;
<span class="lineNum">    2595 </span>                :            :                 }
<span class="lineNum">    2596 </span>                :            :             }
<span class="lineNum">    2597 </span>                :            :         }
<span class="lineNum">    2598 </span>                :            :     }
<span class="lineNum">    2599 </span>                :            : 
<span class="lineNum">    2600 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1332 times"> + </span>]:<span class="lineCov">       1333 :     if (fBlocksDisconnected) {</span>
<span class="lineNum">    2601 </span>                :            :         // If any blocks were disconnected, disconnectpool may be non empty.  Add
<span class="lineNum">    2602 </span>                :            :         // any disconnected transactions back to the mempool.
<span class="lineNum">    2603 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :         UpdateMempoolForReorg(disconnectpool, true);</span>
<span class="lineNum">    2604 </span>                :            :     }
<span class="lineNum">    2605 </span>        [<span class="branchCov" title="Branch 1 was taken 1333 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1333 :     mempool.check(pcoinsTip.get());</span>
<span class="lineNum">    2606 </span>                :            : 
<span class="lineNum">    2607 </span>                :            :     // Callbacks/notifications for a new best chain.
<span class="lineNum">    2608 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 1330 times"> + </span>]:<span class="lineCov">       1333 :     if (fInvalidFound)</span>
<span class="lineNum">    2609 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         CheckForkWarningConditionsOnNewFork(vpindexToConnect.back());</span>
<span class="lineNum">    2610 </span>                :            :     else
<span class="lineNum">    2611 </span>        [<span class="branchCov" title="Branch 1 was taken 1330 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1330 :         CheckForkWarningConditions();</span>
<span class="lineNum">    2612 </span>                :            : 
<span class="lineNum">    2613 </span>                :            :     return true;
<a name="2614"><span class="lineNum">    2614 </span>                :            : }</a>
<span class="lineNum">    2615 </span>                :            : 
<span class="lineNum">    2616 </span>                :<span class="lineCov">      11762 : static void NotifyHeaderTip() LOCKS_EXCLUDED(cs_main) {</span>
<span class="lineNum">    2617 </span>                :<span class="lineCov">      11762 :     bool fNotify = false;</span>
<span class="lineNum">    2618 </span>                :<span class="lineCov">      11762 :     bool fInitialBlockDownload = false;</span>
<span class="lineNum">    2619 </span>                :            :     static CBlockIndex* pindexHeaderOld = nullptr;
<span class="lineNum">    2620 </span>                :<span class="lineCov">      11762 :     CBlockIndex* pindexHeader = nullptr;</span>
<span class="lineNum">    2621 </span>                :            :     {
<span class="lineNum">    2622 </span>                :<span class="lineCov">      11762 :         LOCK(cs_main);</span>
<span class="lineNum">    2623 </span>                :<span class="lineCov">      11762 :         pindexHeader = pindexBestHeader;</span>
<span class="lineNum">    2624 </span>                :            : 
<span class="lineNum">    2625 </span>        [<span class="branchCov" title="Branch 0 was taken 1230 times"> + </span><span class="branchCov" title="Branch 1 was taken 10532 times"> + </span>]:<span class="lineCov">      11762 :         if (pindexHeader != pindexHeaderOld) {</span>
<span class="lineNum">    2626 </span>                :<span class="lineCov">       1230 :             fNotify = true;</span>
<span class="lineNum">    2627 </span>        [<span class="branchCov" title="Branch 1 was taken 1230 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1230 :             fInitialBlockDownload = IsInitialBlockDownload();</span>
<span class="lineNum">    2628 </span>                :<span class="lineCov">       1230 :             pindexHeaderOld = pindexHeader;</span>
<span class="lineNum">    2629 </span>                :            :         }
<span class="lineNum">    2630 </span>                :            :     }
<span class="lineNum">    2631 </span>                :            :     // Send block tip changed notifications without cs_main
<span class="lineNum">    2632 </span>        [<span class="branchCov" title="Branch 0 was taken 1230 times"> + </span><span class="branchCov" title="Branch 1 was taken 10532 times"> + </span>]:<span class="lineCov">      11762 :     if (fNotify) {</span>
<span class="lineNum">    2633 </span>                :<span class="lineCov">       1230 :         uiInterface.NotifyHeaderTip(fInitialBlockDownload, pindexHeader);</span>
<span class="lineNum">    2634 </span>                :            :     }
<span class="lineNum">    2635 </span>                :<span class="lineCov">      11762 : }</span>
<span class="lineNum">    2636 </span>                :            : 
<span class="lineNum">    2637 </span>                :            : /**
<span class="lineNum">    2638 </span>                :            :  * Make the best chain active, in multiple steps. The result is either failure
<span class="lineNum">    2639 </span>                :            :  * or an activated best chain. pblock is either nullptr or a pointer to a block
<span class="lineNum">    2640 </span>                :            :  * that is already loaded (to avoid loading it again from disk).
<span class="lineNum">    2641 </span>                :            :  *
<span class="lineNum">    2642 </span>                :            :  * ActivateBestChain is split into steps (see ActivateBestChainStep) so that
<span class="lineNum">    2643 </span>                :            :  * we avoid holding cs_main for an extended period of time; the length of this
<span class="lineNum">    2644 </span>                :            :  * call may be quite long during reindexing or a substantial reorg.
<span class="lineNum">    2645 </span>                :            :  */
<span class="lineNum">    2646 </span>                :<span class="lineCov">      11827 : bool CChainState::ActivateBestChain(CValidationState &amp;state, const CChainParams&amp; chainparams, std::shared_ptr&lt;const CBlock&gt; pblock) {</span>
<span class="lineNum">    2647 </span>                :            :     // Note that while we're often called here from ProcessNewBlock, this is
<span class="lineNum">    2648 </span>                :            :     // far from a guarantee. Things in the P2P/RPC will often end up calling
<span class="lineNum">    2649 </span>                :            :     // us in the middle of ProcessNewBlock - do not assume pblock is set
<span class="lineNum">    2650 </span>                :            :     // sanely for performance or correctness!
<span class="lineNum">    2651 </span>                :<span class="lineCov">      11827 :     AssertLockNotHeld(cs_main);</span>
<span class="lineNum">    2652 </span>                :            : 
<span class="lineNum">    2653 </span>                :            :     // ABC maintains a fair degree of expensive-to-calculate internal state
<span class="lineNum">    2654 </span>                :            :     // because this function periodically releases cs_main so that it does not lock up other threads for too long
<span class="lineNum">    2655 </span>                :            :     // during large connects - and to allow for e.g. the callback queue to drain
<span class="lineNum">    2656 </span>                :            :     // we use m_cs_chainstate to enforce mutual exclusion so that only one caller may execute this function at a time
<span class="lineNum">    2657 </span>                :<span class="lineCov">      23654 :     LOCK(m_cs_chainstate);</span>
<span class="lineNum">    2658 </span>                :            : 
<span class="lineNum">    2659 </span>                :<span class="lineCov">      11827 :     CBlockIndex *pindexMostWork = nullptr;</span>
<span class="lineNum">    2660 </span>                :<span class="lineCov">      11827 :     CBlockIndex *pindexNewTip = nullptr;</span>
<span class="lineNum">    2661 </span>[<span class="branchCov" title="Branch 1 was taken 11827 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 11827 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">      23654 :     int nStopAtHeight = gArgs.GetArg(&quot;-stopatheight&quot;, DEFAULT_STOPATHEIGHT);</span>
<span class="lineNum">    2662 </span>                :            :     do {
<span class="lineNum">    2663 </span>        [<span class="branchCov" title="Branch 1 was taken 11862 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      11862 :         boost::this_thread::interruption_point();</span>
<span class="lineNum">    2664 </span>                :            : 
<span class="lineNum">    2665 </span>[<span class="branchCov" title="Branch 1 was taken 11862 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 11862 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">      11862 :         if (GetMainSignals().CallbacksPending() &gt; 10) {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 11862 times"> + </span>]
<span class="lineNum">    2666 </span>                :            :             // Block until the validation queue drains. This should largely
<span class="lineNum">    2667 </span>                :            :             // never happen in normal operation, however may happen during
<span class="lineNum">    2668 </span>                :            :             // reindex, causing memory blowup if we run too far ahead.
<span class="lineNum">    2669 </span>                :            :             // Note that if a validationinterface callback ends up calling
<span class="lineNum">    2670 </span>                :            :             // ActivateBestChain this may lead to a deadlock! We should
<span class="lineNum">    2671 </span>                :            :             // probably have a DEBUG_LOCKORDER test for this in the future.
<span class="lineNum">    2672 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             SyncWithValidationInterfaceQueue();</span>
<span class="lineNum">    2673 </span>                :            :         }
<span class="lineNum">    2674 </span>                :            : 
<span class="lineNum">    2675 </span>                :            :         {
<span class="lineNum">    2676 </span>        [<span class="branchCov" title="Branch 1 was taken 11862 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      11862 :             LOCK(cs_main);</span>
<span class="lineNum">    2677 </span>                :<span class="lineCov">      23724 :             CBlockIndex* starting_tip = chainActive.Tip();</span>
<span class="lineNum">    2678 </span>                :<span class="lineCov">      11862 :             bool blocks_connected = false;</span>
<span class="lineNum">    2679 </span>                :            :             do {
<span class="lineNum">    2680 </span>                :            :                 // We absolutely may not unlock cs_main until we've made forward progress
<span class="lineNum">    2681 </span>                :            :                 // (with the exception of shutdown due to hardware issues, low disk space, etc).
<span class="lineNum">    2682 </span>        [<span class="branchCov" title="Branch 1 was taken 11862 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      11862 :                 ConnectTrace connectTrace(mempool); // Destructed before cs_main is unlocked</span>
<span class="lineNum">    2683 </span>                :            : 
<span class="lineNum">    2684 </span>        [<span class="branchCov" title="Branch 0 was taken 11830 times"> + </span><span class="branchCov" title="Branch 1 was taken 32 times"> + </span>]:<span class="lineCov">      11862 :                 if (pindexMostWork == nullptr) {</span>
<span class="lineNum">    2685 </span>        [<span class="branchCov" title="Branch 1 was taken 11830 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      11830 :                     pindexMostWork = FindMostWorkChain();</span>
<span class="lineNum">    2686 </span>                :            :                 }
<span class="lineNum">    2687 </span>                :            : 
<span class="lineNum">    2688 </span>                :            :                 // Whether we have anything to do at all.
<span class="lineNum">    2689 </span>[<span class="branchCov" title="Branch 0 was taken 11862 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 10529 times"> + </span><span class="branchCov" title="Branch 3 was taken 1333 times"> + </span>]:<span class="lineCov">      23724 :                 if (pindexMostWork == nullptr || pindexMostWork == chainActive.Tip()) {</span>
<span class="lineNum">    2690 </span>                :            :                     break;
<span class="lineNum">    2691 </span>                :            :                 }
<span class="lineNum">    2692 </span>                :            : 
<span class="lineNum">    2693 </span>                :<span class="lineCov">       1333 :                 bool fInvalidFound = false;</span>
<span class="lineNum">    2694 </span>                :<span class="lineNoCov">          0 :                 std::shared_ptr&lt;const CBlock&gt; nullBlockPtr;</span>
<span class="lineNum">    2695 </span>[<span class="branchCov" title="Branch 0 was taken 1267 times"> + </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 1267 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       1333 :                 if (!ActivateBestChainStep(state, chainparams, pindexMostWork, pblock &amp;&amp; pblock-&gt;GetHash() == pindexMostWork-&gt;GetBlockHash() ? pblock : nullBlockPtr, fInvalidFound, connectTrace))</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 36 times"> + </span><span class="branchCov" title="Branch 6 was taken 1231 times"> + </span>][<span class="branchCov" title="Branch 8 was taken 1333 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 10 was not taken"> - </span><span class="branchCov" title="Branch 11 was taken 1333 times"> + </span>]
<span class="lineNum">    2696 </span>                :<span class="lineNoCov">          0 :                     return false;</span>
<span class="lineNum">    2697 </span>                :<span class="lineCov">       1333 :                 blocks_connected = true;</span>
<span class="lineNum">    2698 </span>                :            : 
<span class="lineNum">    2699 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 1330 times"> + </span>]:<span class="lineCov">       1333 :                 if (fInvalidFound) {</span>
<span class="lineNum">    2700 </span>                :            :                     // Wipe cache, we may need another branch now.
<span class="lineNum">    2701 </span>                :<span class="lineCov">          3 :                     pindexMostWork = nullptr;</span>
<span class="lineNum">    2702 </span>                :            :                 }
<span class="lineNum">    2703 </span>                :<span class="lineCov">       2666 :                 pindexNewTip = chainActive.Tip();</span>
<span class="lineNum">    2704 </span>                :            : 
<span class="lineNum">    2705 </span>        [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchCov" title="Branch 2 was taken 1333 times"> + </span>]:<span class="lineCov">       2670 :                 for (const PerBlockConnectTrace&amp; trace : connectTrace.GetBlocksConnected()) {</span>
<span class="lineNum">    2706 </span>[<span class="branchCov" title="Branch 0 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1337 times"> + </span>]:<span class="lineCov">       1337 :                     assert(trace.pblock &amp;&amp; trace.pindex);</span>
<span class="lineNum">    2707 </span>  [<span class="branchCov" title="Branch 1 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       2674 :                     GetMainSignals().BlockConnected(trace.pblock, trace.pindex, trace.conflictedTxs);</span>
<span class="lineNum">    2708 </span>                :            :                 }
<span class="lineNum">    2709 </span>[<span class="branchCov" title="Branch 0 was taken 1333 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1267 times"> + </span><span class="branchCov" title="Branch 3 was taken 66 times"> + </span>]:<span class="lineCov">       1333 :             } while (!chainActive.Tip() || (starting_tip &amp;&amp; CBlockIndexWorkComparator()(chainActive.Tip(), starting_tip)));</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 1267 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>][<span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchCov" title="Branch 8 was taken 1267 times"> + </span>]
<span class="lineNum">    2710 </span>        [<span class="branchCov" title="Branch 0 was taken 1333 times"> + </span><span class="branchCov" title="Branch 1 was taken 10529 times"> + </span>]:<span class="lineCov">      11862 :             if (!blocks_connected) return true;</span>
<span class="lineNum">    2711 </span>                :            : 
<span class="lineNum">    2712 </span>        [<span class="branchCov" title="Branch 1 was taken 1333 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1333 :             const CBlockIndex* pindexFork = chainActive.FindFork(starting_tip);</span>
<span class="lineNum">    2713 </span>        [<span class="branchCov" title="Branch 1 was taken 1333 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1333 :             bool fInitialDownload = IsInitialBlockDownload();</span>
<span class="lineNum">    2714 </span>                :            : 
<span class="lineNum">    2715 </span>                :            :             // Notify external listeners about the new tip.
<span class="lineNum">    2716 </span>                :            :             // Enqueue while holding cs_main to ensure that UpdatedBlockTip is called in the order in which blocks are connected
<span class="lineNum">    2717 </span>        [<span class="branchCov" title="Branch 0 was taken 1330 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">       1333 :             if (pindexFork != pindexNewTip) {</span>
<span class="lineNum">    2718 </span>                :            :                 // Notify ValidationInterface subscribers
<span class="lineNum">    2719 </span>[<span class="branchCov" title="Branch 1 was taken 1330 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 1330 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       1330 :                 GetMainSignals().UpdatedBlockTip(pindexNewTip, pindexFork, fInitialDownload);</span>
<span class="lineNum">    2720 </span>                :            : 
<span class="lineNum">    2721 </span>                :            :                 // Always notify the UI if a new block tip was connected
<span class="lineNum">    2722 </span>        [<span class="branchCov" title="Branch 1 was taken 1330 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1330 :                 uiInterface.NotifyBlockTip(fInitialDownload, pindexNewTip);</span>
<span class="lineNum">    2723 </span>                :            :             }
<span class="lineNum">    2724 </span>                :            :         }
<span class="lineNum">    2725 </span>                :            :         // When we reach this point, we switched to a new tip (stored in pindexNewTip).
<span class="lineNum">    2726 </span>                :            : 
<span class="lineNum">    2727 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1333 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       1333 :         if (nStopAtHeight &amp;&amp; pindexNewTip &amp;&amp; pindexNewTip-&gt;nHeight &gt;= nStopAtHeight) StartShutdown();</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">    2728 </span>                :            : 
<span class="lineNum">    2729 </span>                :            :         // We check shutdown only after giving ActivateBestChainStep a chance to run once so that we
<span class="lineNum">    2730 </span>                :            :         // never shutdown before connecting the genesis block during LoadChainTip(). Previously this
<span class="lineNum">    2731 </span>                :            :         // caused an assert() failure during shutdown in such cases as the UTXO DB flushing checks
<span class="lineNum">    2732 </span>                :            :         // that the best block hash is non-null.
<span class="lineNum">    2733 </span>[<span class="branchCov" title="Branch 1 was taken 1333 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1333 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       1333 :         if (ShutdownRequested())</span>
<span class="lineNum">    2734 </span>                :            :             break;
<span class="lineNum">    2735 </span>        [<span class="branchCov" title="Branch 0 was taken 35 times"> + </span><span class="branchCov" title="Branch 1 was taken 1298 times"> + </span>]:<span class="lineCov">       1333 :     } while (pindexNewTip != pindexMostWork);</span>
<span class="lineNum">    2736 </span>        [<span class="branchCov" title="Branch 1 was taken 1298 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1298 :     CheckBlockIndex(chainparams.GetConsensus());</span>
<span class="lineNum">    2737 </span>                :            : 
<span class="lineNum">    2738 </span>                :            :     // Write changes periodically to disk, after relay.
<span class="lineNum">    2739 </span>[<span class="branchCov" title="Branch 1 was taken 1298 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1298 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       1298 :     if (!FlushStateToDisk(chainparams, state, FlushStateMode::PERIODIC)) {</span>
<span class="lineNum">    2740 </span>                :            :         return false;
<span class="lineNum">    2741 </span>                :            :     }
<span class="lineNum">    2742 </span>                :            : 
<span class="lineNum">    2743 </span>                :<span class="lineCov">       1298 :     return true;</span>
<a name="2744"><span class="lineNum">    2744 </span>                :            : }</a>
<span class="lineNum">    2745 </span>                :            : 
<span class="lineNum">    2746 </span>                :<span class="lineCov">         66 : bool ActivateBestChain(CValidationState &amp;state, const CChainParams&amp; chainparams, std::shared_ptr&lt;const CBlock&gt; pblock) {</span>
<span class="lineNum">    2747 </span>        [<span class="branchCov" title="Branch 1 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        132 :     return g_chainstate.ActivateBestChain(state, chainparams, std::move(pblock));</span>
<a name="2748"><span class="lineNum">    2748 </span>                :            : }</a>
<span class="lineNum">    2749 </span>                :            : 
<span class="lineNum">    2750 </span>                :<span class="lineNoCov">          0 : bool CChainState::PreciousBlock(CValidationState&amp; state, const CChainParams&amp; params, CBlockIndex *pindex)</span>
<span class="lineNum">    2751 </span>                :            : {
<span class="lineNum">    2752 </span>                :            :     {
<span class="lineNum">    2753 </span>                :<span class="lineNoCov">          0 :         LOCK(cs_main);</span>
<span class="lineNum">    2754 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex-&gt;nChainWork &lt; chainActive.Tip()-&gt;nChainWork) {</span>
<span class="lineNum">    2755 </span>                :            :             // Nothing to do, this block is not at the tip.
<span class="lineNum">    2756 </span>                :<span class="lineNoCov">          0 :             return true;</span>
<span class="lineNum">    2757 </span>                :            :         }
<span class="lineNum">    2758 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (chainActive.Tip()-&gt;nChainWork &gt; nLastPreciousChainwork) {</span>
<span class="lineNum">    2759 </span>                :            :             // The chain has been extended since the last call, reset the counter.
<span class="lineNum">    2760 </span>                :<span class="lineNoCov">          0 :             nBlockReverseSequenceId = -1;</span>
<span class="lineNum">    2761 </span>                :            :         }
<span class="lineNum">    2762 </span>                :<span class="lineNoCov">          0 :         nLastPreciousChainwork = chainActive.Tip()-&gt;nChainWork;</span>
<span class="lineNum">    2763 </span>                :<span class="lineNoCov">          0 :         setBlockIndexCandidates.erase(pindex);</span>
<span class="lineNum">    2764 </span>                :<span class="lineNoCov">          0 :         pindex-&gt;nSequenceId = nBlockReverseSequenceId;</span>
<span class="lineNum">    2765 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (nBlockReverseSequenceId &gt; std::numeric_limits&lt;int32_t&gt;::min()) {</span>
<span class="lineNum">    2766 </span>                :            :             // We can't keep reducing the counter if somebody really wants to
<span class="lineNum">    2767 </span>                :            :             // call preciousblock 2**31-1 times on the same set of tips...
<span class="lineNum">    2768 </span>                :<span class="lineNoCov">          0 :             nBlockReverseSequenceId--;</span>
<span class="lineNum">    2769 </span>                :            :         }
<span class="lineNum">    2770 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex-&gt;IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp; pindex-&gt;HaveTxsDownloaded()) {</span>
<span class="lineNum">    2771 </span>                :<span class="lineNoCov">          0 :             setBlockIndexCandidates.insert(pindex);</span>
<span class="lineNum">    2772 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             PruneBlockIndexCandidates();</span>
<span class="lineNum">    2773 </span>                :            :         }
<span class="lineNum">    2774 </span>                :            :     }
<span class="lineNum">    2775 </span>                :            : 
<a name="2776"><span class="lineNum">    2776 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return ActivateBestChain(state, params, std::shared_ptr&lt;const CBlock&gt;());</span></a>
<span class="lineNum">    2777 </span>                :            : }
<span class="lineNum">    2778 </span>                :<span class="lineNoCov">          0 : bool PreciousBlock(CValidationState&amp; state, const CChainParams&amp; params, CBlockIndex *pindex) {</span>
<span class="lineNum">    2779 </span>                :<span class="lineNoCov">          0 :     return g_chainstate.PreciousBlock(state, params, pindex);</span>
<a name="2780"><span class="lineNum">    2780 </span>                :            : }</a>
<span class="lineNum">    2781 </span>                :            : 
<span class="lineNum">    2782 </span>                :<span class="lineNoCov">          0 : bool CChainState::InvalidateBlock(CValidationState&amp; state, const CChainParams&amp; chainparams, CBlockIndex *pindex)</span>
<span class="lineNum">    2783 </span>                :            : {
<span class="lineNum">    2784 </span>                :<span class="lineNoCov">          0 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    2785 </span>                :            : 
<span class="lineNum">    2786 </span>                :            :     // We first disconnect backwards and then mark the blocks as invalid.
<span class="lineNum">    2787 </span>                :            :     // This prevents a case where pruned nodes may fail to invalidateblock
<span class="lineNum">    2788 </span>                :            :     // and be left unable to start as they have no tip candidates (as there
<span class="lineNum">    2789 </span>                :            :     // are no blocks that meet the &quot;have data and are not invalid per
<span class="lineNum">    2790 </span>                :            :     // nStatus&quot; criteria for inclusion in setBlockIndexCandidates).
<span class="lineNum">    2791 </span>                :            : 
<span class="lineNum">    2792 </span>                :<span class="lineNoCov">          0 :     bool pindex_was_in_chain = false;</span>
<span class="lineNum">    2793 </span>                :<span class="lineNoCov">          0 :     CBlockIndex *invalid_walk_tip = chainActive.Tip();</span>
<span class="lineNum">    2794 </span>                :            : 
<span class="lineNum">    2795 </span>                :<span class="lineNoCov">          0 :     DisconnectedBlockTransactions disconnectpool;</span>
<span class="lineNum">    2796 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while (chainActive.Contains(pindex)) {</span>
<span class="lineNum">    2797 </span>                :<span class="lineNoCov">          0 :         pindex_was_in_chain = true;</span>
<span class="lineNum">    2798 </span>                :            :         // ActivateBestChain considers blocks already in chainActive
<span class="lineNum">    2799 </span>                :            :         // unconditionally valid already, so force disconnect away from it.
<span class="lineNum">    2800 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!DisconnectTip(state, chainparams, &amp;disconnectpool)) {</span>
<span class="lineNum">    2801 </span>                :            :             // It's probably hopeless to try to make the mempool consistent
<span class="lineNum">    2802 </span>                :            :             // here if DisconnectTip failed, but we can try.
<span class="lineNum">    2803 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             UpdateMempoolForReorg(disconnectpool, false);</span>
<span class="lineNum">    2804 </span>                :            :             return false;
<span class="lineNum">    2805 </span>                :            :         }
<span class="lineNum">    2806 </span>                :            :     }
<span class="lineNum">    2807 </span>                :            : 
<span class="lineNum">    2808 </span>                :            :     // Now mark the blocks we just disconnected as descendants invalid
<span class="lineNum">    2809 </span>                :            :     // (note this may not be all descendants).
<span class="lineNum">    2810 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while (pindex_was_in_chain &amp;&amp; invalid_walk_tip != pindex) {</span>
<span class="lineNum">    2811 </span>                :<span class="lineNoCov">          0 :         invalid_walk_tip-&gt;nStatus |= BLOCK_FAILED_CHILD;</span>
<span class="lineNum">    2812 </span>                :<span class="lineNoCov">          0 :         setDirtyBlockIndex.insert(invalid_walk_tip);</span>
<span class="lineNum">    2813 </span>                :<span class="lineNoCov">          0 :         setBlockIndexCandidates.erase(invalid_walk_tip);</span>
<span class="lineNum">    2814 </span>                :<span class="lineNoCov">          0 :         invalid_walk_tip = invalid_walk_tip-&gt;pprev;</span>
<span class="lineNum">    2815 </span>                :            :     }
<span class="lineNum">    2816 </span>                :            : 
<span class="lineNum">    2817 </span>                :            :     // Mark the block itself as invalid.
<span class="lineNum">    2818 </span>                :<span class="lineNoCov">          0 :     pindex-&gt;nStatus |= BLOCK_FAILED_VALID;</span>
<span class="lineNum">    2819 </span>                :<span class="lineNoCov">          0 :     setDirtyBlockIndex.insert(pindex);</span>
<span class="lineNum">    2820 </span>                :<span class="lineNoCov">          0 :     setBlockIndexCandidates.erase(pindex);</span>
<span class="lineNum">    2821 </span>                :<span class="lineNoCov">          0 :     m_failed_blocks.insert(pindex);</span>
<span class="lineNum">    2822 </span>                :            : 
<span class="lineNum">    2823 </span>                :            :     // DisconnectTip will add transactions to disconnectpool; try to add these
<span class="lineNum">    2824 </span>                :            :     // back to the mempool.
<span class="lineNum">    2825 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     UpdateMempoolForReorg(disconnectpool, true);</span>
<span class="lineNum">    2826 </span>                :            : 
<span class="lineNum">    2827 </span>                :            :     // The resulting new best tip may not be in setBlockIndexCandidates anymore, so
<span class="lineNum">    2828 </span>                :            :     // add it again.
<span class="lineNum">    2829 </span>                :<span class="lineNoCov">          0 :     BlockMap::iterator it = mapBlockIndex.begin();</span>
<span class="lineNum">    2830 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while (it != mapBlockIndex.end()) {</span>
<span class="lineNum">    2831 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (it-&gt;second-&gt;IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp; it-&gt;second-&gt;HaveTxsDownloaded() &amp;&amp; !setBlockIndexCandidates.value_comp()(it-&gt;second, chainActive.Tip())) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    2832 </span>                :<span class="lineNoCov">          0 :             setBlockIndexCandidates.insert(it-&gt;second);</span>
<span class="lineNum">    2833 </span>                :            :         }
<span class="lineNum">    2834 </span>                :            :         it++;
<span class="lineNum">    2835 </span>                :            :     }
<span class="lineNum">    2836 </span>                :            : 
<span class="lineNum">    2837 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     InvalidChainFound(pindex);</span>
<span class="lineNum">    2838 </span>                :            : 
<span class="lineNum">    2839 </span>                :            :     // Only notify about a new block tip if the active chain was modified.
<span class="lineNum">    2840 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (pindex_was_in_chain) {</span>
<span class="lineNum">    2841 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         uiInterface.NotifyBlockTip(IsInitialBlockDownload(), pindex-&gt;pprev);</span>
<span class="lineNum">    2842 </span>                :            :     }
<span class="lineNum">    2843 </span>                :            :     return true;
<a name="2844"><span class="lineNum">    2844 </span>                :            : }</a>
<span class="lineNum">    2845 </span>                :            : 
<span class="lineNum">    2846 </span>                :<span class="lineNoCov">          0 : bool InvalidateBlock(CValidationState&amp; state, const CChainParams&amp; chainparams, CBlockIndex *pindex) {</span>
<span class="lineNum">    2847 </span>                :<span class="lineNoCov">          0 :     return g_chainstate.InvalidateBlock(state, chainparams, pindex);</span>
<a name="2848"><span class="lineNum">    2848 </span>                :            : }</a>
<span class="lineNum">    2849 </span>                :            : 
<span class="lineNum">    2850 </span>                :<span class="lineNoCov">          0 : void CChainState::ResetBlockFailureFlags(CBlockIndex *pindex) {</span>
<span class="lineNum">    2851 </span>                :<span class="lineNoCov">          0 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    2852 </span>                :            : 
<span class="lineNum">    2853 </span>                :<span class="lineNoCov">          0 :     int nHeight = pindex-&gt;nHeight;</span>
<span class="lineNum">    2854 </span>                :            : 
<span class="lineNum">    2855 </span>                :            :     // Remove the invalidity flag from this block and all its descendants.
<span class="lineNum">    2856 </span>                :<span class="lineNoCov">          0 :     BlockMap::iterator it = mapBlockIndex.begin();</span>
<span class="lineNum">    2857 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while (it != mapBlockIndex.end()) {</span>
<span class="lineNum">    2858 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!it-&gt;second-&gt;IsValid() &amp;&amp; it-&gt;second-&gt;GetAncestor(nHeight) == pindex) {</span>
<span class="lineNum">    2859 </span>                :<span class="lineNoCov">          0 :             it-&gt;second-&gt;nStatus &amp;= ~BLOCK_FAILED_MASK;</span>
<span class="lineNum">    2860 </span>                :<span class="lineNoCov">          0 :             setDirtyBlockIndex.insert(it-&gt;second);</span>
<span class="lineNum">    2861 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (it-&gt;second-&gt;IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp; it-&gt;second-&gt;HaveTxsDownloaded() &amp;&amp; setBlockIndexCandidates.value_comp()(chainActive.Tip(), it-&gt;second)) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">    2862 </span>                :<span class="lineNoCov">          0 :                 setBlockIndexCandidates.insert(it-&gt;second);</span>
<span class="lineNum">    2863 </span>                :            :             }
<span class="lineNum">    2864 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (it-&gt;second == pindexBestInvalid) {</span>
<span class="lineNum">    2865 </span>                :            :                 // Reset invalid block marker if it was pointing to one of those.
<span class="lineNum">    2866 </span>                :<span class="lineNoCov">          0 :                 pindexBestInvalid = nullptr;</span>
<span class="lineNum">    2867 </span>                :            :             }
<span class="lineNum">    2868 </span>                :<span class="lineNoCov">          0 :             m_failed_blocks.erase(it-&gt;second);</span>
<span class="lineNum">    2869 </span>                :            :         }
<span class="lineNum">    2870 </span>                :            :         it++;
<span class="lineNum">    2871 </span>                :            :     }
<span class="lineNum">    2872 </span>                :            : 
<span class="lineNum">    2873 </span>                :            :     // Remove the invalidity flag from all ancestors too.
<span class="lineNum">    2874 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while (pindex != nullptr) {</span>
<span class="lineNum">    2875 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex-&gt;nStatus &amp; BLOCK_FAILED_MASK) {</span>
<span class="lineNum">    2876 </span>                :<span class="lineNoCov">          0 :             pindex-&gt;nStatus &amp;= ~BLOCK_FAILED_MASK;</span>
<span class="lineNum">    2877 </span>                :<span class="lineNoCov">          0 :             setDirtyBlockIndex.insert(pindex);</span>
<span class="lineNum">    2878 </span>                :<span class="lineNoCov">          0 :             m_failed_blocks.erase(pindex);</span>
<span class="lineNum">    2879 </span>                :            :         }
<span class="lineNum">    2880 </span>                :<span class="lineNoCov">          0 :         pindex = pindex-&gt;pprev;</span>
<span class="lineNum">    2881 </span>                :            :     }
<a name="2882"><span class="lineNum">    2882 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2883 </span>                :            : 
<span class="lineNum">    2884 </span>                :<span class="lineNoCov">          0 : void ResetBlockFailureFlags(CBlockIndex *pindex) {</span>
<span class="lineNum">    2885 </span>                :<span class="lineNoCov">          0 :     return g_chainstate.ResetBlockFailureFlags(pindex);</span>
<a name="2886"><span class="lineNum">    2886 </span>                :            : }</a>
<span class="lineNum">    2887 </span>                :            : 
<span class="lineNum">    2888 </span>                :<span class="lineCov">       1371 : CBlockIndex* CChainState::AddToBlockIndex(const CBlockHeader&amp; block)</span>
<span class="lineNum">    2889 </span>                :            : {
<span class="lineNum">    2890 </span>                :<span class="lineCov">       1371 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    2891 </span>                :            : 
<span class="lineNum">    2892 </span>                :            :     // Check for duplicate
<span class="lineNum">    2893 </span>                :<span class="lineCov">       1371 :     uint256 hash = block.GetHash();</span>
<span class="lineNum">    2894 </span>                :<span class="lineCov">       2742 :     BlockMap::iterator it = mapBlockIndex.find(hash);</span>
<span class="lineNum">    2895 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1370 times"> + </span>]:<span class="lineCov">       1371 :     if (it != mapBlockIndex.end())</span>
<span class="lineNum">    2896 </span>                :<span class="lineCov">          1 :         return it-&gt;second;</span>
<span class="lineNum">    2897 </span>                :            : 
<span class="lineNum">    2898 </span>                :            :     // Construct new block index object
<span class="lineNum">    2899 </span>                :<span class="lineCov">       1370 :     CBlockIndex* pindexNew = new CBlockIndex(block);</span>
<span class="lineNum">    2900 </span>                :            :     // We assign the sequence id to blocks only when the full data is available,
<span class="lineNum">    2901 </span>                :            :     // to avoid miners withholding blocks but broadcasting headers, to get a
<span class="lineNum">    2902 </span>                :            :     // competitive advantage.
<span class="lineNum">    2903 </span>                :<span class="lineCov">       1370 :     pindexNew-&gt;nSequenceId = 0;</span>
<span class="lineNum">    2904 </span>                :<span class="lineCov">       4110 :     BlockMap::iterator mi = mapBlockIndex.insert(std::make_pair(hash, pindexNew)).first;</span>
<span class="lineNum">    2905 </span>                :<span class="lineCov">       1370 :     pindexNew-&gt;phashBlock = &amp;((*mi).first);</span>
<span class="lineNum">    2906 </span>                :<span class="lineCov">       2740 :     BlockMap::iterator miPrev = mapBlockIndex.find(block.hashPrevBlock);</span>
<span class="lineNum">    2907 </span>        [<span class="branchCov" title="Branch 0 was taken 1304 times"> + </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>]:<span class="lineCov">       1370 :     if (miPrev != mapBlockIndex.end())</span>
<span class="lineNum">    2908 </span>                :            :     {
<span class="lineNum">    2909 </span>                :<span class="lineCov">       1304 :         pindexNew-&gt;pprev = (*miPrev).second;</span>
<span class="lineNum">    2910 </span>                :<span class="lineCov">       1304 :         pindexNew-&gt;nHeight = pindexNew-&gt;pprev-&gt;nHeight + 1;</span>
<span class="lineNum">    2911 </span>                :<span class="lineCov">       1304 :         pindexNew-&gt;BuildSkip();</span>
<span class="lineNum">    2912 </span>                :            :     }
<span class="lineNum">    2913 </span>        [<span class="branchCov" title="Branch 0 was taken 1304 times"> + </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>]:<span class="lineCov">       2674 :     pindexNew-&gt;nTimeMax = (pindexNew-&gt;pprev ? std::max(pindexNew-&gt;pprev-&gt;nTimeMax, pindexNew-&gt;nTime) : pindexNew-&gt;nTime);</span>
<span class="lineNum">    2914 </span>        [<span class="branchCov" title="Branch 1 was taken 1304 times"> + </span><span class="branchCov" title="Branch 2 was taken 66 times"> + </span>]:<span class="lineCov">       2740 :     pindexNew-&gt;nChainWork = (pindexNew-&gt;pprev ? pindexNew-&gt;pprev-&gt;nChainWork : 0) + GetBlockProof(*pindexNew);</span>
<span class="lineNum">    2915 </span>                :<span class="lineCov">       1370 :     pindexNew-&gt;RaiseValidity(BLOCK_VALID_TREE);</span>
<span class="lineNum">    2916 </span>  [<span class="branchCov" title="Branch 0 was taken 1304 times"> + </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span><span class="branchCov" title="Branch 2 was taken 1265 times"> + </span><span class="branchCov" title="Branch 3 was taken 39 times"> + </span>]:<span class="lineCov">       2674 :     if (pindexBestHeader == nullptr || pindexBestHeader-&gt;nChainWork &lt; pindexNew-&gt;nChainWork)</span>
<span class="lineNum">    2917 </span>                :<span class="lineCov">       1331 :         pindexBestHeader = pindexNew;</span>
<span class="lineNum">    2918 </span>                :            : 
<span class="lineNum">    2919 </span>                :<span class="lineCov">       1370 :     setDirtyBlockIndex.insert(pindexNew);</span>
<span class="lineNum">    2920 </span>                :            : 
<span class="lineNum">    2921 </span>                :<span class="lineCov">       1370 :     return pindexNew;</span>
<span class="lineNum">    2922 </span>                :            : }
<span class="lineNum">    2923 </span>                :            : 
<span class="lineNum">    2924 </span>                :            : /** Mark a block as having its data received and checked (up to BLOCK_VALID_TRANSACTIONS). */
<span class="lineNum">    2925 </span>                :<span class="lineCov">       1369 : void CChainState::ReceivedBlockTransactions(const CBlock&amp; block, CBlockIndex* pindexNew, const CDiskBlockPos&amp; pos, const Consensus::Params&amp; consensusParams)</span>
<span class="lineNum">    2926 </span>                :            : {
<span class="lineNum">    2927 </span>                :<span class="lineCov">       2738 :     pindexNew-&gt;nTx = block.vtx.size();</span>
<span class="lineNum">    2928 </span>                :<span class="lineCov">       1369 :     pindexNew-&gt;nChainTx = 0;</span>
<span class="lineNum">    2929 </span>                :<span class="lineCov">       1369 :     pindexNew-&gt;nFile = pos.nFile;</span>
<span class="lineNum">    2930 </span>                :<span class="lineCov">       1369 :     pindexNew-&gt;nDataPos = pos.nPos;</span>
<span class="lineNum">    2931 </span>                :<span class="lineCov">       1369 :     pindexNew-&gt;nUndoPos = 0;</span>
<span class="lineNum">    2932 </span>                :<span class="lineCov">       1369 :     pindexNew-&gt;nStatus |= BLOCK_HAVE_DATA;</span>
<span class="lineNum">    2933 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1369 times"> + </span>]:<span class="lineCov">       1369 :     if (IsWitnessEnabled(pindexNew-&gt;pprev, consensusParams)) {</span>
<span class="lineNum">    2934 </span>                :<span class="lineNoCov">          0 :         pindexNew-&gt;nStatus |= BLOCK_OPT_WITNESS;</span>
<span class="lineNum">    2935 </span>                :            :     }
<span class="lineNum">    2936 </span>                :<span class="lineCov">       1369 :     pindexNew-&gt;RaiseValidity(BLOCK_VALID_TRANSACTIONS);</span>
<span class="lineNum">    2937 </span>                :<span class="lineCov">       1369 :     setDirtyBlockIndex.insert(pindexNew);</span>
<span class="lineNum">    2938 </span>                :            : 
<span class="lineNum">    2939 </span>[<span class="branchCov" title="Branch 0 was taken 1303 times"> + </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1237 times"> + </span><span class="branchCov" title="Branch 3 was taken 66 times"> + </span>]:<span class="lineCov">       1369 :     if (pindexNew-&gt;pprev == nullptr || pindexNew-&gt;pprev-&gt;HaveTxsDownloaded()) {</span>
<span class="lineNum">    2940 </span>                :            :         // If pindexNew is the genesis block or all parents are BLOCK_VALID_TRANSACTIONS.
<span class="lineNum">    2941 </span>                :<span class="lineCov">       1303 :         std::deque&lt;CBlockIndex*&gt; queue;</span>
<span class="lineNum">    2942 </span>        [<span class="branchCov" title="Branch 1 was taken 1303 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1303 :         queue.push_back(pindexNew);</span>
<span class="lineNum">    2943 </span>                :            : 
<span class="lineNum">    2944 </span>                :            :         // Recursively process any descendant blocks that now may be eligible to be connected.
<span class="lineNum">    2945 </span>        [<span class="branchCov" title="Branch 0 was taken 1369 times"> + </span><span class="branchCov" title="Branch 1 was taken 1303 times"> + </span>]:<span class="lineCov">       2672 :         while (!queue.empty()) {</span>
<span class="lineNum">    2946 </span>                :<span class="lineCov">       1369 :             CBlockIndex *pindex = queue.front();</span>
<span class="lineNum">    2947 </span>                :<span class="lineCov">       1369 :             queue.pop_front();</span>
<span class="lineNum">    2948 </span>        [<span class="branchCov" title="Branch 0 was taken 1303 times"> + </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>]:<span class="lineCov">       1369 :             pindex-&gt;nChainTx = (pindex-&gt;pprev ? pindex-&gt;pprev-&gt;nChainTx : 0) + pindex-&gt;nTx;</span>
<span class="lineNum">    2949 </span>                :            :             {
<span class="lineNum">    2950 </span>        [<span class="branchCov" title="Branch 1 was taken 1369 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1369 :                 LOCK(cs_nBlockSequenceId);</span>
<span class="lineNum">    2951 </span>                :<span class="lineCov">       1369 :                 pindex-&gt;nSequenceId = nBlockSequenceId++;</span>
<span class="lineNum">    2952 </span>                :            :             }
<span class="lineNum">    2953 </span>[<span class="branchCov" title="Branch 0 was taken 1303 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1303 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       1303 :             if (chainActive.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, chainActive.Tip())) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken 16 times"> + </span><span class="branchCov" title="Branch 6 was taken 1287 times"> + </span>]
<span class="lineNum">    2954 </span>                :<span class="lineCov">       1353 :                 setBlockIndexCandidates.insert(pindex);</span>
<span class="lineNum">    2955 </span>                :            :             }
<span class="lineNum">    2956 </span>                :<span class="lineCov">       1369 :             std::pair&lt;std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;::iterator, std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;::iterator&gt; range = mapBlocksUnlinked.equal_range(pindex);</span>
<span class="lineNum">    2957 </span>        [<span class="branchCov" title="Branch 0 was taken 66 times"> + </span><span class="branchCov" title="Branch 1 was taken 1369 times"> + </span>]:<span class="lineCov">       1435 :             while (range.first != range.second) {</span>
<span class="lineNum">    2958 </span>                :<span class="lineCov">         66 :                 std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;::iterator it = range.first;</span>
<span class="lineNum">    2959 </span>        [<span class="branchCov" title="Branch 1 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         66 :                 queue.push_back(it-&gt;second);</span>
<span class="lineNum">    2960 </span>                :<span class="lineCov">         66 :                 range.first++;</span>
<span class="lineNum">    2961 </span>                :<span class="lineCov">        132 :                 mapBlocksUnlinked.erase(it);</span>
<span class="lineNum">    2962 </span>                :            :             }
<span class="lineNum">    2963 </span>                :            :         }
<span class="lineNum">    2964 </span>                :            :     } else {
<span class="lineNum">    2965 </span>        [<span class="branchCov" title="Branch 0 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         66 :         if (pindexNew-&gt;pprev &amp;&amp; pindexNew-&gt;pprev-&gt;IsValid(BLOCK_VALID_TREE)) {</span>
<span class="lineNum">    2966 </span>                :<span class="lineCov">         66 :             mapBlocksUnlinked.insert(std::make_pair(pindexNew-&gt;pprev, pindexNew));</span>
<span class="lineNum">    2967 </span>                :            :         }
<span class="lineNum">    2968 </span>                :            :     }
<span class="lineNum">    2969 </span>                :<span class="lineCov">       1369 : }</span>
<span class="lineNum">    2970 </span>                :            : 
<span class="lineNum">    2971 </span>                :<span class="lineCov">       1369 : static bool FindBlockPos(CDiskBlockPos &amp;pos, unsigned int nAddSize, unsigned int nHeight, uint64_t nTime, bool fKnown = false)</span>
<span class="lineNum">    2972 </span>                :            : {
<span class="lineNum">    2973 </span>                :<span class="lineCov">       2738 :     LOCK(cs_LastBlockFile);</span>
<span class="lineNum">    2974 </span>                :            : 
<span class="lineNum">    2975 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1369 times"> + </span>]:<span class="lineCov">       1369 :     unsigned int nFile = fKnown ? pos.nFile : nLastBlockFile;</span>
<span class="lineNum">    2976 </span>        [<span class="branchCov" title="Branch 0 was taken 66 times"> + </span><span class="branchCov" title="Branch 1 was taken 1303 times"> + </span>]:<span class="lineCov">       1369 :     if (vinfoBlockFile.size() &lt;= nFile) {</span>
<span class="lineNum">    2977 </span>        [<span class="branchCov" title="Branch 1 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         66 :         vinfoBlockFile.resize(nFile + 1);</span>
<span class="lineNum">    2978 </span>                :            :     }
<span class="lineNum">    2979 </span>                :            : 
<span class="lineNum">    2980 </span>        [<span class="branchCov" title="Branch 0 was taken 1369 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1371 :     if (!fKnown) {</span>
<span class="lineNum">    2981 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 1369 times"> + </span>]:<span class="lineCov">       1371 :         while (vinfoBlockFile[nFile].nSize + nAddSize &gt;= MAX_BLOCKFILE_SIZE) {</span>
<span class="lineNum">    2982 </span>                :<span class="lineCov">          2 :             nFile++;</span>
<span class="lineNum">    2983 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :             if (vinfoBlockFile.size() &lt;= nFile) {</span>
<span class="lineNum">    2984 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :                 vinfoBlockFile.resize(nFile + 1);</span>
<span class="lineNum">    2985 </span>                :            :             }
<span class="lineNum">    2986 </span>                :            :         }
<span class="lineNum">    2987 </span>                :<span class="lineCov">       1369 :         pos.nFile = nFile;</span>
<span class="lineNum">    2988 </span>                :<span class="lineCov">       1369 :         pos.nPos = vinfoBlockFile[nFile].nSize;</span>
<span class="lineNum">    2989 </span>                :            :     }
<span class="lineNum">    2990 </span>                :            : 
<span class="lineNum">    2991 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 1367 times"> + </span>]:<span class="lineCov">       1369 :     if ((int)nFile != nLastBlockFile) {</span>
<span class="lineNum">    2992 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :         if (!fKnown) {</span>
<span class="lineNum">    2993 </span>[<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          4 :             LogPrintf(&quot;Leaving block file %i: %s\n&quot;, nLastBlockFile, vinfoBlockFile[nLastBlockFile].ToString());</span>
<span class="lineNum">    2994 </span>                :            :         }
<span class="lineNum">    2995 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :         FlushBlockFile(!fKnown);</span>
<span class="lineNum">    2996 </span>                :<span class="lineCov">          2 :         nLastBlockFile = nFile;</span>
<span class="lineNum">    2997 </span>                :            :     }
<span class="lineNum">    2998 </span>                :            : 
<span class="lineNum">    2999 </span>                :<span class="lineCov">       4107 :     vinfoBlockFile[nFile].AddBlock(nHeight, nTime);</span>
<span class="lineNum">    3000 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1369 times"> + </span>]:<span class="lineCov">       1369 :     if (fKnown)</span>
<span class="lineNum">    3001 </span>                :<span class="lineNoCov">          0 :         vinfoBlockFile[nFile].nSize = std::max(pos.nPos + nAddSize, vinfoBlockFile[nFile].nSize);</span>
<span class="lineNum">    3002 </span>                :            :     else
<span class="lineNum">    3003 </span>                :<span class="lineCov">       1369 :         vinfoBlockFile[nFile].nSize += nAddSize;</span>
<span class="lineNum">    3004 </span>                :            : 
<span class="lineNum">    3005 </span>        [<span class="branchCov" title="Branch 0 was taken 1369 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1369 :     if (!fKnown) {</span>
<span class="lineNum">    3006 </span>                :<span class="lineCov">       1369 :         unsigned int nOldChunks = (pos.nPos + BLOCKFILE_CHUNK_SIZE - 1) / BLOCKFILE_CHUNK_SIZE;</span>
<span class="lineNum">    3007 </span>                :<span class="lineCov">       2738 :         unsigned int nNewChunks = (vinfoBlockFile[nFile].nSize + BLOCKFILE_CHUNK_SIZE - 1) / BLOCKFILE_CHUNK_SIZE;</span>
<span class="lineNum">    3008 </span>        [<span class="branchCov" title="Branch 0 was taken 68 times"> + </span><span class="branchCov" title="Branch 1 was taken 1301 times"> + </span>]:<span class="lineCov">       1369 :         if (nNewChunks &gt; nOldChunks) {</span>
<span class="lineNum">    3009 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 68 times"> + </span>]:<span class="lineCov">         68 :             if (fPruneMode)</span>
<span class="lineNum">    3010 </span>                :<span class="lineNoCov">          0 :                 fCheckForPruning = true;</span>
<span class="lineNum">    3011 </span>[<span class="branchCov" title="Branch 1 was taken 68 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 68 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         68 :             if (CheckDiskSpace(nNewChunks * BLOCKFILE_CHUNK_SIZE - pos.nPos, true)) {</span>
<span class="lineNum">    3012 </span>        [<span class="branchCov" title="Branch 1 was taken 68 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         68 :                 FILE *file = OpenBlockFile(pos);</span>
<span class="lineNum">    3013 </span>        [<span class="branchCov" title="Branch 0 was taken 68 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         68 :                 if (file) {</span>
<span class="lineNum">    3014 </span>        [<span class="branchCov" title="Branch 1 was taken 68 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         68 :                     LogPrintf(&quot;Pre-allocating up to position 0x%x in blk%05u.dat\n&quot;, nNewChunks * BLOCKFILE_CHUNK_SIZE, pos.nFile);</span>
<span class="lineNum">    3015 </span>        [<span class="branchCov" title="Branch 1 was taken 68 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         68 :                     AllocateFileRange(file, pos.nPos, nNewChunks * BLOCKFILE_CHUNK_SIZE - pos.nPos);</span>
<span class="lineNum">    3016 </span>        [<span class="branchCov" title="Branch 1 was taken 68 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         68 :                     fclose(file);</span>
<span class="lineNum">    3017 </span>                :            :                 }
<span class="lineNum">    3018 </span>                :            :             }
<span class="lineNum">    3019 </span>                :            :             else
<span class="lineNum">    3020 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return error(&quot;out of disk space&quot;);</span>
<span class="lineNum">    3021 </span>                :            :         }
<span class="lineNum">    3022 </span>                :            :     }
<span class="lineNum">    3023 </span>                :            : 
<span class="lineNum">    3024 </span>                :<span class="lineCov">       2738 :     setDirtyFileInfo.insert(nFile);</span>
<span class="lineNum">    3025 </span>                :<span class="lineCov">       1369 :     return true;</span>
<span class="lineNum">    3026 </span>                :            : }
<span class="lineNum">    3027 </span>                :            : 
<span class="lineNum">    3028 </span>                :<span class="lineCov">       1271 : static bool FindUndoPos(CValidationState &amp;state, int nFile, CDiskBlockPos &amp;pos, unsigned int nAddSize)</span>
<span class="lineNum">    3029 </span>                :            : {
<span class="lineNum">    3030 </span>                :<span class="lineCov">       1271 :     pos.nFile = nFile;</span>
<span class="lineNum">    3031 </span>                :            : 
<span class="lineNum">    3032 </span>                :<span class="lineCov">       2542 :     LOCK(cs_LastBlockFile);</span>
<span class="lineNum">    3033 </span>                :            : 
<span class="lineNum">    3034 </span>                :            :     unsigned int nNewSize;
<span class="lineNum">    3035 </span>                :<span class="lineCov">       2542 :     pos.nPos = vinfoBlockFile[nFile].nUndoSize;</span>
<span class="lineNum">    3036 </span>                :<span class="lineCov">       2542 :     nNewSize = vinfoBlockFile[nFile].nUndoSize += nAddSize;</span>
<span class="lineNum">    3037 </span>                :<span class="lineCov">       1271 :     setDirtyFileInfo.insert(nFile);</span>
<span class="lineNum">    3038 </span>                :            : 
<span class="lineNum">    3039 </span>                :<span class="lineCov">       1271 :     unsigned int nOldChunks = (pos.nPos + UNDOFILE_CHUNK_SIZE - 1) / UNDOFILE_CHUNK_SIZE;</span>
<span class="lineNum">    3040 </span>                :<span class="lineCov">       1271 :     unsigned int nNewChunks = (nNewSize + UNDOFILE_CHUNK_SIZE - 1) / UNDOFILE_CHUNK_SIZE;</span>
<span class="lineNum">    3041 </span>        [<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchCov" title="Branch 1 was taken 1256 times"> + </span>]:<span class="lineCov">       1271 :     if (nNewChunks &gt; nOldChunks) {</span>
<span class="lineNum">    3042 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 15 times"> + </span>]:<span class="lineCov">         15 :         if (fPruneMode)</span>
<span class="lineNum">    3043 </span>                :<span class="lineNoCov">          0 :             fCheckForPruning = true;</span>
<span class="lineNum">    3044 </span>[<span class="branchCov" title="Branch 1 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         15 :         if (CheckDiskSpace(nNewChunks * UNDOFILE_CHUNK_SIZE - pos.nPos, true)) {</span>
<span class="lineNum">    3045 </span>        [<span class="branchCov" title="Branch 1 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         15 :             FILE *file = OpenUndoFile(pos);</span>
<span class="lineNum">    3046 </span>        [<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         15 :             if (file) {</span>
<span class="lineNum">    3047 </span>        [<span class="branchCov" title="Branch 1 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         15 :                 LogPrintf(&quot;Pre-allocating up to position 0x%x in rev%05u.dat\n&quot;, nNewChunks * UNDOFILE_CHUNK_SIZE, pos.nFile);</span>
<span class="lineNum">    3048 </span>        [<span class="branchCov" title="Branch 1 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         15 :                 AllocateFileRange(file, pos.nPos, nNewChunks * UNDOFILE_CHUNK_SIZE - pos.nPos);</span>
<span class="lineNum">    3049 </span>        [<span class="branchCov" title="Branch 1 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         15 :                 fclose(file);</span>
<span class="lineNum">    3050 </span>                :            :             }
<span class="lineNum">    3051 </span>                :            :         }
<span class="lineNum">    3052 </span>                :            :         else
<span class="lineNum">    3053 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.Error(&quot;out of disk space&quot;);</span>
<span class="lineNum">    3054 </span>                :            :     }
<span class="lineNum">    3055 </span>                :            : 
<span class="lineNum">    3056 </span>                :            :     return true;
<span class="lineNum">    3057 </span>                :            : }
<span class="lineNum">    3058 </span>                :            : 
<span class="lineNum">    3059 </span>                :<span class="lineCov">       5338 : static bool CheckBlockHeader(const CBlockHeader&amp; block, CValidationState&amp; state, const Consensus::Params&amp; consensusParams, bool fCheckPOW = true)</span>
<span class="lineNum">    3060 </span>                :            : {
<span class="lineNum">    3061 </span>                :            :     // Check proof of work matches claimed amount
<span class="lineNum">    3062 </span>[<span class="branchCov" title="Branch 0 was taken 2724 times"> + </span><span class="branchCov" title="Branch 1 was taken 2614 times"> + </span>][<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 2724 times"> + </span>]:<span class="lineCov">       5338 :     if (fCheckPOW &amp;&amp; !CheckProofOfWork(block.GetHash(), block.nBits, consensusParams))</span>
<span class="lineNum">    3063 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineCov">       5338 :         return state.DoS(50, false, REJECT_INVALID, &quot;high-hash&quot;, false, &quot;proof of work failed&quot;);</span>
<span class="lineNum">    3064 </span>                :            : 
<span class="lineNum">    3065 </span>                :            :     return true;
<span class="lineNum">    3066 </span>                :            : }
<span class="lineNum">    3067 </span>                :            : 
<span class="lineNum">    3068 </span>                :<span class="lineCov">      17146 : bool CheckBlock(const CBlock&amp; block, CValidationState&amp; state, const Consensus::Params&amp; consensusParams, bool fCheckPOW, bool fCheckMerkleRoot)</span>
<span class="lineNum">    3069 </span>                :            : {
<span class="lineNum">    3070 </span>                :            :     // These are checks that are independent of context.
<span class="lineNum">    3071 </span>                :            : 
<span class="lineNum">    3072 </span>        [<span class="branchCov" title="Branch 0 was taken 4034 times"> + </span><span class="branchCov" title="Branch 1 was taken 13112 times"> + </span>]:<span class="lineCov">      17146 :     if (block.fChecked)</span>
<span class="lineNum">    3073 </span>                :            :         return true;
<span class="lineNum">    3074 </span>                :            : 
<span class="lineNum">    3075 </span>                :            :     // Check that the header is valid (particularly PoW).  This is mostly
<span class="lineNum">    3076 </span>                :            :     // redundant with the call in AcceptBlockHeader.
<span class="lineNum">    3077 </span>        [<span class="branchCov" title="Branch 1 was taken 4034 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       4034 :     if (!CheckBlockHeader(block, state, consensusParams, fCheckPOW))</span>
<span class="lineNum">    3078 </span>                :            :         return false;
<span class="lineNum">    3079 </span>                :            : 
<span class="lineNum">    3080 </span>                :            :     // Check the merkle root.
<span class="lineNum">    3081 </span>        [<span class="branchCov" title="Branch 0 was taken 1420 times"> + </span><span class="branchCov" title="Branch 1 was taken 2614 times"> + </span>]:<span class="lineCov">       4034 :     if (fCheckMerkleRoot) {</span>
<span class="lineNum">    3082 </span>                :            :         bool mutated;
<span class="lineNum">    3083 </span>                :<span class="lineCov">       1420 :         uint256 hashMerkleRoot2 = BlockMerkleRoot(block, &amp;mutated);</span>
<span class="lineNum">    3084 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 1418 times"> + </span>]:<span class="lineCov">       1420 :         if (block.hashMerkleRoot != hashMerkleRoot2)</span>
<span class="lineNum">    3085 </span>[<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          4 :             return state.DoS(100, false, REJECT_INVALID, &quot;bad-txnmrklroot&quot;, true, &quot;hashMerkleRoot mismatch&quot;);</span>
<span class="lineNum">    3086 </span>                :            : 
<span class="lineNum">    3087 </span>                :            :         // Check for merkle tree malleability (CVE-2012-2459): repeating sequences
<span class="lineNum">    3088 </span>                :            :         // of transactions in a block without affecting the merkle root of a block,
<span class="lineNum">    3089 </span>                :            :         // while still invalidating it.
<span class="lineNum">    3090 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1418 times"> + </span>]:<span class="lineCov">       1418 :         if (mutated)</span>
<span class="lineNum">    3091 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineCov">       1420 :             return state.DoS(100, false, REJECT_INVALID, &quot;bad-txns-duplicate&quot;, true, &quot;duplicate transaction&quot;);</span>
<span class="lineNum">    3092 </span>                :            :     }
<span class="lineNum">    3093 </span>                :            : 
<span class="lineNum">    3094 </span>                :            :     // All potential-corruption validation must be done before we do any
<span class="lineNum">    3095 </span>                :            :     // transaction validation, as otherwise we may mark the header as invalid
<span class="lineNum">    3096 </span>                :            :     // because we receive the wrong transactions for it.
<span class="lineNum">    3097 </span>                :            :     // Note that witness malleability is checked in ContextualCheckBlock, so no
<span class="lineNum">    3098 </span>                :            :     // checks that use witness data may be performed here.
<span class="lineNum">    3099 </span>                :            : 
<span class="lineNum">    3100 </span>                :            :     // Size limits
<span class="lineNum">    3101 </span>[<span class="branchCov" title="Branch 0 was taken 4032 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 4032 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       4032 :     if (block.vtx.empty() || block.vtx.size() * WITNESS_SCALE_FACTOR &gt; MAX_BLOCK_WEIGHT || ::GetSerializeSize(block, PROTOCOL_VERSION | SERIALIZE_TRANSACTION_NO_WITNESS) * WITNESS_SCALE_FACTOR &gt; MAX_BLOCK_WEIGHT)</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 4032 times"> + </span>]
<span class="lineNum">    3102 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return state.DoS(100, false, REJECT_INVALID, &quot;bad-blk-length&quot;, false, &quot;size limits failed&quot;);</span>
<span class="lineNum">    3103 </span>                :            : 
<span class="lineNum">    3104 </span>                :            :     // First transaction must be coinbase, the rest must not be
<span class="lineNum">    3105 </span>        [<span class="branchCov" title="Branch 0 was taken 4032 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       4032 :     if (block.vtx.empty() || !block.vtx[0]-&gt;IsCoinBase())</span>
<span class="lineNum">    3106 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return state.DoS(100, false, REJECT_INVALID, &quot;bad-cb-missing&quot;, false, &quot;first tx is not coinbase&quot;);</span>
<span class="lineNum">    3107 </span>        [<span class="branchCov" title="Branch 0 was taken 3303 times"> + </span><span class="branchCov" title="Branch 1 was taken 4031 times"> + </span>]:<span class="lineCov">       7334 :     for (unsigned int i = 1; i &lt; block.vtx.size(); i++)</span>
<span class="lineNum">    3108 </span>                :<span class="lineCov">       9910 :         if (block.vtx[i]-&gt;IsCoinBase())</span>
<span class="lineNum">    3109 </span>[<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          2 :             return state.DoS(100, false, REJECT_INVALID, &quot;bad-cb-multiple&quot;, false, &quot;more than one coinbase&quot;);</span>
<span class="lineNum">    3110 </span>                :            : 
<span class="lineNum">    3111 </span>                :            :     // Check transactions
<span class="lineNum">    3112 </span>        [<span class="branchCov" title="Branch 0 was taken 7333 times"> + </span><span class="branchCov" title="Branch 1 was taken 4031 times"> + </span>]:<span class="lineCov">      11364 :     for (const auto&amp; tx : block.vtx)</span>
<span class="lineNum">    3113 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 7333 times"> + </span>]:<span class="lineCov">       7333 :         if (!CheckTransaction(*tx, state, true))</span>
<span class="lineNum">    3114 </span>                :<span class="lineNoCov">          0 :             return state.Invalid(false, state.GetRejectCode(), state.GetRejectReason(),</span>
<span class="lineNum">    3115 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                  strprintf(&quot;Transaction check failed (tx hash %s) %s&quot;, tx-&gt;GetHash().ToString(), state.GetDebugMessage()));</span>
<span class="lineNum">    3116 </span>                :            : 
<span class="lineNum">    3117 </span>                :<span class="lineCov">       4031 :     unsigned int nSigOps = 0;</span>
<span class="lineNum">    3118 </span>        [<span class="branchCov" title="Branch 0 was taken 7333 times"> + </span><span class="branchCov" title="Branch 1 was taken 4031 times"> + </span>]:<span class="lineCov">      11364 :     for (const auto&amp; tx : block.vtx)</span>
<span class="lineNum">    3119 </span>                :            :     {
<span class="lineNum">    3120 </span>                :<span class="lineCov">       7333 :         nSigOps += GetLegacySigOpCount(*tx);</span>
<span class="lineNum">    3121 </span>                :            :     }
<span class="lineNum">    3122 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 4030 times"> + </span>]:<span class="lineCov">       4031 :     if (nSigOps * WITNESS_SCALE_FACTOR &gt; MAX_BLOCK_SIGOPS_COST)</span>
<span class="lineNum">    3123 </span>[<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          2 :         return state.DoS(100, false, REJECT_INVALID, &quot;bad-blk-sigops&quot;, false, &quot;out-of-bounds SigOpCount&quot;);</span>
<span class="lineNum">    3124 </span>                :            : 
<span class="lineNum">    3125 </span>        [<span class="branchCov" title="Branch 0 was taken 1418 times"> + </span><span class="branchCov" title="Branch 1 was taken 2612 times"> + </span>]:<span class="lineCov">       4030 :     if (fCheckPOW &amp;&amp; fCheckMerkleRoot)</span>
<span class="lineNum">    3126 </span>                :<span class="lineCov">      17146 :         block.fChecked = true;</span>
<span class="lineNum">    3127 </span>                :            : 
<span class="lineNum">    3128 </span>                :            :     return true;
<a name="3129"><span class="lineNum">    3129 </span>                :            : }</a>
<span class="lineNum">    3130 </span>                :            : 
<span class="lineNum">    3131 </span>                :<span class="lineCov">       3985 : bool IsWitnessEnabled(const CBlockIndex* pindexPrev, const Consensus::Params&amp; params)</span>
<span class="lineNum">    3132 </span>                :            : {
<span class="lineNum">    3133 </span>                :<span class="lineCov">       3985 :     LOCK(cs_main);</span>
<span class="lineNum">    3134 </span>        [<span class="branchCov" title="Branch 1 was taken 3985 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       7970 :     return (VersionBitsState(pindexPrev, params, Consensus::DEPLOYMENT_SEGWIT, versionbitscache) == ThresholdState::ACTIVE);</span>
<a name="3135"><span class="lineNum">    3135 </span>                :            : }</a>
<span class="lineNum">    3136 </span>                :            : 
<span class="lineNum">    3137 </span>                :<span class="lineCov">       2583 : bool IsNullDummyEnabled(const CBlockIndex* pindexPrev, const Consensus::Params&amp; params)</span>
<span class="lineNum">    3138 </span>                :            : {
<span class="lineNum">    3139 </span>                :<span class="lineCov">       2583 :     LOCK(cs_main);</span>
<span class="lineNum">    3140 </span>        [<span class="branchCov" title="Branch 1 was taken 2583 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       5166 :     return (VersionBitsState(pindexPrev, params, Consensus::DEPLOYMENT_SEGWIT, versionbitscache) == ThresholdState::ACTIVE);</span>
<span class="lineNum">    3141 </span>                :            : }
<span class="lineNum">    3142 </span>                :            : 
<a name="3143"><span class="lineNum">    3143 </span>                :            : // Compute at which vout of the block's coinbase transaction the witness</a>
<span class="lineNum">    3144 </span>                :            : // commitment occurs, or -1 if not found.
<span class="lineNum">    3145 </span>                :<span class="lineCov">       2616 : static int GetWitnessCommitmentIndex(const CBlock&amp; block)</span>
<span class="lineNum">    3146 </span>                :            : {
<span class="lineNum">    3147 </span>                :<span class="lineCov">       2616 :     int commitpos = -1;</span>
<span class="lineNum">    3148 </span>        [<span class="branchCov" title="Branch 0 was taken 2616 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2616 :     if (!block.vtx.empty()) {</span>
<span class="lineNum">    3149 </span>        [<span class="branchCov" title="Branch 0 was taken 3924 times"> + </span><span class="branchCov" title="Branch 1 was taken 2616 times"> + </span>]:<span class="lineCov">       6540 :         for (size_t o = 0; o &lt; block.vtx[0]-&gt;vout.size(); o++) {</span>
<span class="lineNum">    3150 </span>[<span class="branchCov" title="Branch 0 was taken 1346 times"> + </span><span class="branchCov" title="Branch 1 was taken 2578 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1308 times"> + </span><span class="branchCov" title="Branch 3 was taken 38 times"> + </span>]:<span class="lineCov">      11810 :             if (block.vtx[0]-&gt;vout[o].scriptPubKey.size() &gt;= 38 &amp;&amp; block.vtx[0]-&gt;vout[o].scriptPubKey[0] == OP_RETURN &amp;&amp; block.vtx[0]-&gt;vout[o].scriptPubKey[1] == 0x24 &amp;&amp; block.vtx[0]-&gt;vout[o].scriptPubKey[2] == 0xaa &amp;&amp; block.vtx[0]-&gt;vout[o].scriptPubKey[3] == 0x21 &amp;&amp; block.vtx[0]-&gt;vout[o].scriptPubKey[4] == 0xa9 &amp;&amp; block.vtx[0]-&gt;vout[o].scriptPubKey[5] == 0xed) {</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>][<span class="branchCov" title="Branch 10 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 12 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 13 was not taken"> - </span>]
<span class="lineNum">    3151 </span>                :<span class="lineCov">       1308 :                 commitpos = o;</span>
<span class="lineNum">    3152 </span>                :            :             }
<span class="lineNum">    3153 </span>                :            :         }
<span class="lineNum">    3154 </span>                :            :     }
<span class="lineNum">    3155 </span>                :<span class="lineCov">       2616 :     return commitpos;</span>
<a name="3156"><span class="lineNum">    3156 </span>                :            : }</a>
<span class="lineNum">    3157 </span>                :            : 
<span class="lineNum">    3158 </span>                :<span class="lineCov">       1308 : void UpdateUncommittedBlockStructures(CBlock&amp; block, const CBlockIndex* pindexPrev, const Consensus::Params&amp; consensusParams)</span>
<span class="lineNum">    3159 </span>                :            : {
<span class="lineNum">    3160 </span>                :<span class="lineCov">       1308 :     int commitpos = GetWitnessCommitmentIndex(block);</span>
<span class="lineNum">    3161 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchCov" title="Branch 1 was taken 1302 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       1308 :     static const std::vector&lt;unsigned char&gt; nonce(32, 0x00);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">    3162 </span>[<span class="branchCov" title="Branch 0 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 1308 times"> + </span>]:<span class="lineCov">       1308 :     if (commitpos != -1 &amp;&amp; IsWitnessEnabled(pindexPrev, consensusParams) &amp;&amp; !block.vtx[0]-&gt;HasWitness()) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">    3163 </span>                :<span class="lineNoCov">          0 :         CMutableTransaction tx(*block.vtx[0]);</span>
<span class="lineNum">    3164 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         tx.vin[0].scriptWitness.stack.resize(1);</span>
<span class="lineNum">    3165 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         tx.vin[0].scriptWitness.stack[0] = nonce;</span>
<span class="lineNum">    3166 </span>                :<span class="lineNoCov">          0 :         block.vtx[0] = MakeTransactionRef(std::move(tx));</span>
<span class="lineNum">    3167 </span>                :            :     }
<span class="lineNum">    3168 </span>                :<span class="lineCov">       1308 : }</span>
<span class="lineNum">    3169 </span>                :            : 
<span class="lineNum">    3170 </span>                :<span class="lineCov">       1308 : std::vector&lt;unsigned char&gt; GenerateCoinbaseCommitment(CBlock&amp; block, const CBlockIndex* pindexPrev, const Consensus::Params&amp; consensusParams)</span>
<span class="lineNum">    3171 </span>                :            : {
<span class="lineNum">    3172 </span>                :<span class="lineCov">       1308 :     std::vector&lt;unsigned char&gt; commitment;</span>
<span class="lineNum">    3173 </span>                :<span class="lineCov">       1308 :     int commitpos = GetWitnessCommitmentIndex(block);</span>
<span class="lineNum">    3174 </span>        [<span class="branchCov" title="Branch 1 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1308 :     std::vector&lt;unsigned char&gt; ret(32, 0x00);</span>
<span class="lineNum">    3175 </span>        [<span class="branchCov" title="Branch 0 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1308 :     if (consensusParams.vDeployments[Consensus::DEPLOYMENT_SEGWIT].nTimeout != 0) {</span>
<span class="lineNum">    3176 </span>        [<span class="branchCov" title="Branch 0 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1308 :         if (commitpos == -1) {</span>
<span class="lineNum">    3177 </span>        [<span class="branchCov" title="Branch 1 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1308 :             uint256 witnessroot = BlockWitnessMerkleRoot(block, nullptr);</span>
<span class="lineNum">    3178 </span>        [<span class="branchCov" title="Branch 1 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1308 :             CHash256().Write(witnessroot.begin(), 32).Write(ret.data(), 32).Finalize(witnessroot.begin());</span>
<span class="lineNum">    3179 </span>                :<span class="lineCov">       1308 :             CTxOut out;</span>
<span class="lineNum">    3180 </span>                :<span class="lineCov">       1308 :             out.nValue = 0;</span>
<span class="lineNum">    3181 </span>                :<span class="lineCov">       1308 :             out.scriptPubKey.resize(38);</span>
<span class="lineNum">    3182 </span>                :<span class="lineCov">       1308 :             out.scriptPubKey[0] = OP_RETURN;</span>
<span class="lineNum">    3183 </span>                :<span class="lineCov">       1308 :             out.scriptPubKey[1] = 0x24;</span>
<span class="lineNum">    3184 </span>                :<span class="lineCov">       1308 :             out.scriptPubKey[2] = 0xaa;</span>
<span class="lineNum">    3185 </span>                :<span class="lineCov">       1308 :             out.scriptPubKey[3] = 0x21;</span>
<span class="lineNum">    3186 </span>                :<span class="lineCov">       1308 :             out.scriptPubKey[4] = 0xa9;</span>
<span class="lineNum">    3187 </span>                :<span class="lineCov">       1308 :             out.scriptPubKey[5] = 0xed;</span>
<span class="lineNum">    3188 </span>                :<span class="lineCov">       3924 :             memcpy(&amp;out.scriptPubKey[6], witnessroot.begin(), 32);</span>
<span class="lineNum">    3189 </span>        [<span class="branchCov" title="Branch 1 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1308 :             commitment = std::vector&lt;unsigned char&gt;(out.scriptPubKey.begin(), out.scriptPubKey.end());</span>
<span class="lineNum">    3190 </span>        [<span class="branchCov" title="Branch 1 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1308 :             CMutableTransaction tx(*block.vtx[0]);</span>
<span class="lineNum">    3191 </span>        [<span class="branchCov" title="Branch 1 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1308 :             tx.vout.push_back(out);</span>
<span class="lineNum">    3192 </span>                :<span class="lineCov">       6540 :             block.vtx[0] = MakeTransactionRef(std::move(tx));</span>
<span class="lineNum">    3193 </span>                :            :         }
<span class="lineNum">    3194 </span>                :            :     }
<span class="lineNum">    3195 </span>        [<span class="branchCov" title="Branch 1 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1308 :     UpdateUncommittedBlockStructures(block, pindexPrev, consensusParams);</span>
<span class="lineNum">    3196 </span>                :<span class="lineCov">       1308 :     return commitment;</span>
<span class="lineNum">    3197 </span>                :            : }
<span class="lineNum">    3198 </span>                :            : 
<span class="lineNum">    3199 </span>                :            : /** Context-dependent validity checks.
<span class="lineNum">    3200 </span>                :            :  *  By &quot;context&quot;, we mean only the previous block headers, but not the UTXO
<span class="lineNum">    3201 </span>                :            :  *  set; UTXO-related validity checks are done in ConnectBlock().
<span class="lineNum">    3202 </span>                :            :  *  NOTE: This function is not currently invoked by ConnectBlock(), so we
<span class="lineNum">    3203 </span>                :            :  *  should consider upgrade issues if we change which consensus rules are
<span class="lineNum">    3204 </span>                :            :  *  enforced in this function (eg by adding a new consensus rule). See comment
<span class="lineNum">    3205 </span>                :            :  *  in ConnectBlock().
<span class="lineNum">    3206 </span>                :            :  *  Note that -reindex-chainstate skips the validation that happens here!
<span class="lineNum">    3207 </span>                :            :  */
<span class="lineNum">    3208 </span>                :<span class="lineCov">       2612 : static bool ContextualCheckBlockHeader(const CBlockHeader&amp; block, CValidationState&amp; state, const CChainParams&amp; params, const CBlockIndex* pindexPrev, int64_t nAdjustedTime)</span>
<span class="lineNum">    3209 </span>                :            : {
<span class="lineNum">    3210 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2612 times"> + </span>]:<span class="lineCov">       2612 :     assert(pindexPrev != nullptr);</span>
<span class="lineNum">    3211 </span>                :<span class="lineCov">       2612 :     const int nHeight = pindexPrev-&gt;nHeight + 1;</span>
<span class="lineNum">    3212 </span>                :            : 
<span class="lineNum">    3213 </span>                :            :     // Check proof of work
<span class="lineNum">    3214 </span>                :<span class="lineCov">       2612 :     const Consensus::Params&amp; consensusParams = params.GetConsensus();</span>
<span class="lineNum">    3215 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2612 times"> + </span>]:<span class="lineCov">       2612 :     if (block.nBits != GetNextWorkRequired(pindexPrev, &amp;block, consensusParams))</span>
<span class="lineNum">    3216 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return state.DoS(100, false, REJECT_INVALID, &quot;bad-diffbits&quot;, false, &quot;incorrect proof of work&quot;);</span>
<span class="lineNum">    3217 </span>                :            : 
<span class="lineNum">    3218 </span>                :            :     // Check against checkpoints
<span class="lineNum">    3219 </span>        [<span class="branchCov" title="Branch 0 was taken 2483 times"> + </span><span class="branchCov" title="Branch 1 was taken 129 times"> + </span>]:<span class="lineCov">       2612 :     if (fCheckpointsEnabled) {</span>
<span class="lineNum">    3220 </span>                :            :         // Don't accept any forks from the main chain prior to last checkpoint.
<span class="lineNum">    3221 </span>                :            :         // GetLastCheckpoint finds the last checkpoint in MapCheckpoints that's in our
<span class="lineNum">    3222 </span>                :            :         // MapBlockIndex.
<span class="lineNum">    3223 </span>                :<span class="lineCov">       2483 :         CBlockIndex* pcheckpoint = Checkpoints::GetLastCheckpoint(params.Checkpoints());</span>
<span class="lineNum">    3224 </span>[<span class="branchCov" title="Branch 0 was taken 2483 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2483 times"> + </span>]:<span class="lineCov">       2483 :         if (pcheckpoint &amp;&amp; nHeight &lt; pcheckpoint-&gt;nHeight)</span>
<span class="lineNum">    3225 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.DoS(100, error(&quot;%s: forked chain older than last checkpoint (height %d)&quot;, __func__, nHeight), REJECT_CHECKPOINT, &quot;bad-fork-prior-to-checkpoint&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    3226 </span>                :            :     }
<span class="lineNum">    3227 </span>                :            : 
<span class="lineNum">    3228 </span>                :            :     // Check timestamp against prev
<span class="lineNum">    3229 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2612 times"> + </span>]:<span class="lineCov">       2612 :     if (block.GetBlockTime() &lt;= pindexPrev-&gt;GetMedianTimePast())</span>
<span class="lineNum">    3230 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return state.Invalid(false, REJECT_INVALID, &quot;time-too-old&quot;, &quot;block's timestamp is too early&quot;);</span>
<span class="lineNum">    3231 </span>                :            : 
<span class="lineNum">    3232 </span>                :            :     // Check timestamp
<span class="lineNum">    3233 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2612 times"> + </span>]:<span class="lineCov">       2612 :     if (block.GetBlockTime() &gt; nAdjustedTime + MAX_FUTURE_BLOCK_TIME)</span>
<span class="lineNum">    3234 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return state.Invalid(false, REJECT_INVALID, &quot;time-too-new&quot;, &quot;block timestamp too far in the future&quot;);</span>
<span class="lineNum">    3235 </span>                :            : 
<span class="lineNum">    3236 </span>                :            :     // Reject outdated version blocks when 95% (75% on testnet) of the network has upgraded:
<span class="lineNum">    3237 </span>                :            :     // check for version 2, 3 and 4 upgrades
<span class="lineNum">    3238 </span>[<span class="branchCov" title="Branch 0 was taken 110 times"> + </span><span class="branchCov" title="Branch 1 was taken 2502 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 110 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       2612 :     if((block.nVersion &lt; 2 &amp;&amp; nHeight &gt;= consensusParams.BIP34Height) ||</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 110 times"> + </span><span class="branchCov" title="Branch 5 was taken 2502 times"> + </span>]
<span class="lineNum">    3239 </span>[<span class="branchCov" title="Branch 0 was taken 110 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 110 times"> + </span><span class="branchCov" title="Branch 3 was taken 2502 times"> + </span>]:<span class="lineCov">       2612 :        (block.nVersion &lt; 3 &amp;&amp; nHeight &gt;= consensusParams.BIP66Height) ||</span>
<span class="lineNum">    3240 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 110 times"> + </span>]:<span class="lineCov">        110 :        (block.nVersion &lt; 4 &amp;&amp; nHeight &gt;= consensusParams.BIP65Height))</span>
<span class="lineNum">    3241 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.Invalid(false, REJECT_OBSOLETE, strprintf(&quot;bad-version(0x%08x)&quot;, block.nVersion),</span>
<span class="lineNum">    3242 </span>                :<span class="lineCov">       2612 :                                  strprintf(&quot;rejected nVersion=0x%08x block&quot;, block.nVersion));</span>
<span class="lineNum">    3243 </span>                :            : 
<span class="lineNum">    3244 </span>                :            :     return true;
<span class="lineNum">    3245 </span>                :            : }
<span class="lineNum">    3246 </span>                :            : 
<span class="lineNum">    3247 </span>                :            : /** NOTE: This function is not currently invoked by ConnectBlock(), so we
<span class="lineNum">    3248 </span>                :            :  *  should consider upgrade issues if we change which consensus rules are
<span class="lineNum">    3249 </span>                :            :  *  enforced in this function (eg by adding a new consensus rule). See comment
<span class="lineNum">    3250 </span>                :            :  *  in ConnectBlock().
<span class="lineNum">    3251 </span>                :            :  *  Note that -reindex-chainstate skips the validation that happens here!
<span class="lineNum">    3252 </span>                :            :  */
<span class="lineNum">    3253 </span>                :<span class="lineCov">       2609 : static bool ContextualCheckBlock(const CBlock&amp; block, CValidationState&amp; state, const Consensus::Params&amp; consensusParams, const CBlockIndex* pindexPrev)</span>
<span class="lineNum">    3254 </span>                :            : {
<span class="lineNum">    3255 </span>        [<span class="branchCov" title="Branch 0 was taken 2609 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2609 :     const int nHeight = pindexPrev == nullptr ? 0 : pindexPrev-&gt;nHeight + 1;</span>
<span class="lineNum">    3256 </span>                :            : 
<span class="lineNum">    3257 </span>                :            :     // Start enforcing BIP113 (Median Time Past) using versionbits logic.
<span class="lineNum">    3258 </span>                :<span class="lineCov">       2609 :     int nLockTimeFlags = 0;</span>
<span class="lineNum">    3259 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2609 times"> + </span>]:<span class="lineCov">       2609 :     if (VersionBitsState(pindexPrev, consensusParams, Consensus::DEPLOYMENT_CSV, versionbitscache) == ThresholdState::ACTIVE) {</span>
<span class="lineNum">    3260 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         assert(pindexPrev != nullptr);</span>
<span class="lineNum">    3261 </span>                :            :         nLockTimeFlags |= LOCKTIME_MEDIAN_TIME_PAST;
<span class="lineNum">    3262 </span>                :            :     }
<span class="lineNum">    3263 </span>                :            : 
<span class="lineNum">    3264 </span>                :<span class="lineCov">       2609 :     int64_t nLockTimeCutoff = (nLockTimeFlags &amp; LOCKTIME_MEDIAN_TIME_PAST)</span>
<span class="lineNum">    3265 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2609 times"> + </span>]:<span class="lineCov">       2609 :                               ? pindexPrev-&gt;GetMedianTimePast()</span>
<span class="lineNum">    3266 </span>                :<span class="lineCov">       5218 :                               : block.GetBlockTime();</span>
<span class="lineNum">    3267 </span>                :            : 
<span class="lineNum">    3268 </span>                :            :     // Check that all transactions are finalized
<span class="lineNum">    3269 </span>        [<span class="branchCov" title="Branch 0 was taken 3762 times"> + </span><span class="branchCov" title="Branch 1 was taken 2609 times"> + </span>]:<span class="lineCov">       6371 :     for (const auto&amp; tx : block.vtx) {</span>
<span class="lineNum">    3270 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 3762 times"> + </span>]:<span class="lineCov">       3762 :         if (!IsFinalTx(*tx, nHeight, nLockTimeCutoff)) {</span>
<span class="lineNum">    3271 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.DoS(10, false, REJECT_INVALID, &quot;bad-txns-nonfinal&quot;, false, &quot;non-final transaction&quot;);</span>
<span class="lineNum">    3272 </span>                :            :         }
<span class="lineNum">    3273 </span>                :            :     }
<span class="lineNum">    3274 </span>                :            : 
<span class="lineNum">    3275 </span>                :            :     // Enforce rule that the coinbase starts with serialized block height
<span class="lineNum">    3276 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2609 times"> + </span>]:<span class="lineCov">       2609 :     if (nHeight &gt;= consensusParams.BIP34Height)</span>
<span class="lineNum">    3277 </span>                :            :     {
<span class="lineNum">    3278 </span>                :<span class="lineNoCov">          0 :         CScript expect = CScript() &lt;&lt; nHeight;</span>
<span class="lineNum">    3279 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (block.vtx[0]-&gt;vin[0].scriptSig.size() &lt; expect.size() ||</span>
<span class="lineNum">    3280 </span>                :<span class="lineNoCov">          0 :             !std::equal(expect.begin(), expect.end(), block.vtx[0]-&gt;vin[0].scriptSig.begin())) {</span>
<span class="lineNum">    3281 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.DoS(100, false, REJECT_INVALID, &quot;bad-cb-height&quot;, false, &quot;block height mismatch in coinbase&quot;);</span>
<span class="lineNum">    3282 </span>                :            :         }
<span class="lineNum">    3283 </span>                :            :     }
<span class="lineNum">    3284 </span>                :            : 
<span class="lineNum">    3285 </span>                :            :     // Validation for witness commitments.
<span class="lineNum">    3286 </span>                :            :     // * We compute the witness hash (which is the hash including witnesses) of all the block's transactions, except the
<span class="lineNum">    3287 </span>                :            :     //   coinbase (where 0x0000....0000 is used instead).
<span class="lineNum">    3288 </span>                :            :     // * The coinbase scriptWitness is a stack of a single 32-byte vector, containing a witness reserved value (unconstrained).
<span class="lineNum">    3289 </span>                :            :     // * We build a merkle tree with all those witness hashes as leaves (similar to the hashMerkleRoot in the block header).
<span class="lineNum">    3290 </span>                :            :     // * There must be at least one output whose scriptPubKey is a single 36-byte push, the first 4 bytes of which are
<span class="lineNum">    3291 </span>                :            :     //   {0xaa, 0x21, 0xa9, 0xed}, and the following 32 bytes are SHA256^2(witness root, witness reserved value). In case there are
<span class="lineNum">    3292 </span>                :            :     //   multiple, the last one is used.
<span class="lineNum">    3293 </span>                :<span class="lineCov">       2609 :     bool fHaveWitness = false;</span>
<span class="lineNum">    3294 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2609 times"> + </span>]:<span class="lineCov">       2609 :     if (VersionBitsState(pindexPrev, consensusParams, Consensus::DEPLOYMENT_SEGWIT, versionbitscache) == ThresholdState::ACTIVE) {</span>
<span class="lineNum">    3295 </span>                :<span class="lineNoCov">          0 :         int commitpos = GetWitnessCommitmentIndex(block);</span>
<span class="lineNum">    3296 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (commitpos != -1) {</span>
<span class="lineNum">    3297 </span>                :<span class="lineNoCov">          0 :             bool malleated = false;</span>
<span class="lineNum">    3298 </span>                :<span class="lineNoCov">          0 :             uint256 hashWitness = BlockWitnessMerkleRoot(block, &amp;malleated);</span>
<span class="lineNum">    3299 </span>                :            :             // The malleation check is ignored; as the transaction tree itself
<span class="lineNum">    3300 </span>                :            :             // already does not permit it, it is impossible to trigger in the
<span class="lineNum">    3301 </span>                :            :             // witness tree.
<span class="lineNum">    3302 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (block.vtx[0]-&gt;vin[0].scriptWitness.stack.size() != 1 || block.vtx[0]-&gt;vin[0].scriptWitness.stack[0].size() != 32) {</span>
<span class="lineNum">    3303 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return state.DoS(100, false, REJECT_INVALID, &quot;bad-witness-nonce-size&quot;, true, strprintf(&quot;%s : invalid witness reserved value size&quot;, __func__));</span>
<span class="lineNum">    3304 </span>                :            :             }
<span class="lineNum">    3305 </span>                :<span class="lineNoCov">          0 :             CHash256().Write(hashWitness.begin(), 32).Write(&amp;block.vtx[0]-&gt;vin[0].scriptWitness.stack[0][0], 32).Finalize(hashWitness.begin());</span>
<span class="lineNum">    3306 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (memcmp(hashWitness.begin(), &amp;block.vtx[0]-&gt;vout[commitpos].scriptPubKey[6], 32)) {</span>
<span class="lineNum">    3307 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return state.DoS(100, false, REJECT_INVALID, &quot;bad-witness-merkle-match&quot;, true, strprintf(&quot;%s : witness merkle commitment mismatch&quot;, __func__));</span>
<span class="lineNum">    3308 </span>                :            :             }
<span class="lineNum">    3309 </span>                :<span class="lineNoCov">          0 :             fHaveWitness = true;</span>
<span class="lineNum">    3310 </span>                :            :         }
<span class="lineNum">    3311 </span>                :            :     }
<span class="lineNum">    3312 </span>                :            : 
<span class="lineNum">    3313 </span>                :            :     // No witness data is allowed in blocks that don't commit to witness data, as this would otherwise leave room for spam
<span class="lineNum">    3314 </span>                :            :     if (!fHaveWitness) {
<span class="lineNum">    3315 </span>        [<span class="branchCov" title="Branch 0 was taken 3762 times"> + </span><span class="branchCov" title="Branch 1 was taken 2609 times"> + </span>]:<span class="lineCov">       6371 :       for (const auto&amp; tx : block.vtx) {</span>
<span class="lineNum">    3316 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3762 times"> + </span>]:<span class="lineCov">       7524 :             if (tx-&gt;HasWitness()) {</span>
<span class="lineNum">    3317 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return state.DoS(100, false, REJECT_INVALID, &quot;unexpected-witness&quot;, true, strprintf(&quot;%s : unexpected witness data found&quot;, __func__));</span>
<span class="lineNum">    3318 </span>                :            :             }
<span class="lineNum">    3319 </span>                :            :         }
<span class="lineNum">    3320 </span>                :            :     }
<span class="lineNum">    3321 </span>                :            : 
<span class="lineNum">    3322 </span>                :            :     // After the coinbase witness reserved value and commitment are verified,
<span class="lineNum">    3323 </span>                :            :     // we can check if the block weight passes (before we've checked the
<span class="lineNum">    3324 </span>                :            :     // coinbase witness, it would be possible for the weight to be too
<span class="lineNum">    3325 </span>                :            :     // large by filling up the coinbase witness, which doesn't change
<span class="lineNum">    3326 </span>                :            :     // the block hash, so we couldn't mark the block as permanently
<span class="lineNum">    3327 </span>                :            :     // failed).
<span class="lineNum">    3328 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2609 times"> + </span>]:<span class="lineCov">       2609 :     if (GetBlockWeight(block) &gt; MAX_BLOCK_WEIGHT) {</span>
<span class="lineNum">    3329 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       2609 :         return state.DoS(100, false, REJECT_INVALID, &quot;bad-blk-weight&quot;, false, strprintf(&quot;%s : weight limit failed&quot;, __func__));</span>
<span class="lineNum">    3330 </span>                :            :     }
<span class="lineNum">    3331 </span>                :            : 
<span class="lineNum">    3332 </span>                :            :     return true;
<span class="lineNum">    3333 </span>                :            : }
<span class="lineNum">    3334 </span>                :            : 
<span class="lineNum">    3335 </span>                :<span class="lineCov">      11956 : bool CChainState::AcceptBlockHeader(const CBlockHeader&amp; block, CValidationState&amp; state, const CChainParams&amp; chainparams, CBlockIndex** ppindex)</span>
<span class="lineNum">    3336 </span>                :            : {
<span class="lineNum">    3337 </span>                :<span class="lineCov">      11956 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    3338 </span>                :            :     // Check for duplicate
<span class="lineNum">    3339 </span>                :<span class="lineCov">      11956 :     uint256 hash = block.GetHash();</span>
<span class="lineNum">    3340 </span>                :<span class="lineCov">      23912 :     BlockMap::iterator miSelf = mapBlockIndex.find(hash);</span>
<span class="lineNum">    3341 </span>                :<span class="lineCov">      11956 :     CBlockIndex *pindex = nullptr;</span>
<span class="lineNum">    3342 </span>        [<span class="branchCov" title="Branch 0 was taken 11955 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">      11956 :     if (hash != chainparams.GetConsensus().hashGenesisBlock) {</span>
<span class="lineNum">    3343 </span>        [<span class="branchCov" title="Branch 0 was taken 10651 times"> + </span><span class="branchCov" title="Branch 1 was taken 1304 times"> + </span>]:<span class="lineCov">      11955 :         if (miSelf != mapBlockIndex.end()) {</span>
<span class="lineNum">    3344 </span>                :            :             // Block header is already known.
<span class="lineNum">    3345 </span>                :<span class="lineCov">      10651 :             pindex = miSelf-&gt;second;</span>
<span class="lineNum">    3346 </span>        [<span class="branchCov" title="Branch 0 was taken 10651 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      10651 :             if (ppindex)</span>
<span class="lineNum">    3347 </span>                :<span class="lineCov">      10651 :                 *ppindex = pindex;</span>
<span class="lineNum">    3348 </span>        [<span class="branchCov" title="Branch 0 was taken 122 times"> + </span><span class="branchCov" title="Branch 1 was taken 10529 times"> + </span>]:<span class="lineCov">      10651 :             if (pindex-&gt;nStatus &amp; BLOCK_FAILED_MASK)</span>
<span class="lineNum">    3349 </span>[<span class="branchCov" title="Branch 1 was taken 122 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 122 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        244 :                 return state.Invalid(error(&quot;%s: block %s is marked invalid&quot;, __func__, hash.ToString()), 0, &quot;duplicate&quot;);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 122 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchCov" title="Branch 10 was taken 122 times"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span>]
<span class="lineNum">    3350 </span>                :            :             return true;
<span class="lineNum">    3351 </span>                :            :         }
<span class="lineNum">    3352 </span>                :            : 
<span class="lineNum">    3353 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1304 times"> + </span>]:<span class="lineCov">       1304 :         if (!CheckBlockHeader(block, state, chainparams.GetConsensus()))</span>
<span class="lineNum">    3354 </span>[<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>][<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return error(&quot;%s: Consensus::CheckBlockHeader: %s, %s&quot;, __func__, hash.ToString(), FormatStateMessage(state));</span>
<span class="lineNum">    3355 </span>                :            : 
<span class="lineNum">    3356 </span>                :            :         // Get prev block index
<span class="lineNum">    3357 </span>                :<span class="lineCov">       1304 :         CBlockIndex* pindexPrev = nullptr;</span>
<span class="lineNum">    3358 </span>                :<span class="lineCov">       2608 :         BlockMap::iterator mi = mapBlockIndex.find(block.hashPrevBlock);</span>
<span class="lineNum">    3359 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1304 times"> + </span>]:<span class="lineCov">       1304 :         if (mi == mapBlockIndex.end())</span>
<span class="lineNum">    3360 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.DoS(10, error(&quot;%s: prev block not found&quot;, __func__), 0, &quot;prev-blk-not-found&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    3361 </span>                :<span class="lineCov">       1304 :         pindexPrev = (*mi).second;</span>
<span class="lineNum">    3362 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1304 times"> + </span>]:<span class="lineCov">       1304 :         if (pindexPrev-&gt;nStatus &amp; BLOCK_FAILED_MASK)</span>
<span class="lineNum">    3363 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return state.DoS(100, error(&quot;%s: prev block invalid&quot;, __func__), REJECT_INVALID, &quot;bad-prevblk&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    3364 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1304 times"> + </span>]:<span class="lineCov">       1304 :         if (!ContextualCheckBlockHeader(block, state, chainparams, pindexPrev, GetAdjustedTime()))</span>
<span class="lineNum">    3365 </span>[<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>][<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return error(&quot;%s: Consensus::ContextualCheckBlockHeader: %s, %s&quot;, __func__, hash.ToString(), FormatStateMessage(state));</span>
<span class="lineNum">    3366 </span>                :            : 
<span class="lineNum">    3367 </span>                :            :         /* Determine if this block descends from any block which has been found
<span class="lineNum">    3368 </span>                :            :          * invalid (m_failed_blocks), then mark pindexPrev and any blocks between
<span class="lineNum">    3369 </span>                :            :          * them as failed. For example:
<span class="lineNum">    3370 </span>                :            :          *
<span class="lineNum">    3371 </span>                :            :          *                D3
<span class="lineNum">    3372 </span>                :            :          *              /
<span class="lineNum">    3373 </span>                :            :          *      B2 - C2
<span class="lineNum">    3374 </span>                :            :          *    /         \
<span class="lineNum">    3375 </span>                :            :          *  A             D2 - E2 - F2
<span class="lineNum">    3376 </span>                :            :          *    \
<span class="lineNum">    3377 </span>                :            :          *      B1 - C1 - D1 - E1
<span class="lineNum">    3378 </span>                :            :          *
<span class="lineNum">    3379 </span>                :            :          * In the case that we attempted to reorg from E1 to F2, only to find
<span class="lineNum">    3380 </span>                :            :          * C2 to be invalid, we would mark D2, E2, and F2 as BLOCK_FAILED_CHILD
<span class="lineNum">    3381 </span>                :            :          * but NOT D3 (it was not in any of our candidate sets at the time).
<span class="lineNum">    3382 </span>                :            :          *
<span class="lineNum">    3383 </span>                :            :          * In any case D3 will also be marked as BLOCK_FAILED_CHILD at restart
<span class="lineNum">    3384 </span>                :            :          * in LoadBlockIndex.
<span class="lineNum">    3385 </span>                :            :          */
<span class="lineNum">    3386 </span>        [<span class="branchCov" title="Branch 0 was taken 85 times"> + </span><span class="branchCov" title="Branch 1 was taken 1219 times"> + </span>]:<span class="lineCov">       1304 :         if (!pindexPrev-&gt;IsValid(BLOCK_VALID_SCRIPTS)) {</span>
<span class="lineNum">    3387 </span>                :            :             // The above does not mean &quot;invalid&quot;: it checks if the previous block
<span class="lineNum">    3388 </span>                :            :             // hasn't been validated up to BLOCK_VALID_SCRIPTS. This is a performance
<span class="lineNum">    3389 </span>                :            :             // optimization, in the common case of adding a new block to the tip,
<span class="lineNum">    3390 </span>                :            :             // we don't need to iterate over the failed blocks list.
<span class="lineNum">    3391 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 85 times"> + </span>]:<span class="lineCov">         85 :             for (const CBlockIndex* failedit : m_failed_blocks) {</span>
<span class="lineNum">    3392 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (pindexPrev-&gt;GetAncestor(failedit-&gt;nHeight) == failedit) {</span>
<span class="lineNum">    3393 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     assert(failedit-&gt;nStatus &amp; BLOCK_FAILED_VALID);</span>
<span class="lineNum">    3394 </span>                :<span class="lineNoCov">          0 :                     CBlockIndex* invalid_walk = pindexPrev;</span>
<span class="lineNum">    3395 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     while (invalid_walk != failedit) {</span>
<span class="lineNum">    3396 </span>                :<span class="lineNoCov">          0 :                         invalid_walk-&gt;nStatus |= BLOCK_FAILED_CHILD;</span>
<span class="lineNum">    3397 </span>                :<span class="lineNoCov">          0 :                         setDirtyBlockIndex.insert(invalid_walk);</span>
<span class="lineNum">    3398 </span>                :<span class="lineNoCov">          0 :                         invalid_walk = invalid_walk-&gt;pprev;</span>
<span class="lineNum">    3399 </span>                :            :                     }
<span class="lineNum">    3400 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     return state.DoS(100, error(&quot;%s: prev block invalid&quot;, __func__), REJECT_INVALID, &quot;bad-prevblk&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    3401 </span>                :            :                 }
<span class="lineNum">    3402 </span>                :            :             }
<span class="lineNum">    3403 </span>                :            :         }
<span class="lineNum">    3404 </span>                :            :     }
<span class="lineNum">    3405 </span>                :            :     if (pindex == nullptr)
<span class="lineNum">    3406 </span>                :<span class="lineCov">       1305 :         pindex = AddToBlockIndex(block);</span>
<span class="lineNum">    3407 </span>                :            : 
<span class="lineNum">    3408 </span>        [<span class="branchCov" title="Branch 0 was taken 1305 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1305 :     if (ppindex)</span>
<span class="lineNum">    3409 </span>                :<span class="lineCov">       1305 :         *ppindex = pindex;</span>
<span class="lineNum">    3410 </span>                :            : 
<span class="lineNum">    3411 </span>                :<span class="lineCov">      11956 :     CheckBlockIndex(chainparams.GetConsensus());</span>
<span class="lineNum">    3412 </span>                :            : 
<span class="lineNum">    3413 </span>                :            :     return true;
<span class="lineNum">    3414 </span>                :            : }
<a name="3415"><span class="lineNum">    3415 </span>                :            : </a>
<span class="lineNum">    3416 </span>                :            : // Exposed wrapper for AcceptBlockHeader
<span class="lineNum">    3417 </span>                :<span class="lineCov">          1 : bool ProcessNewBlockHeaders(const std::vector&lt;CBlockHeader&gt;&amp; headers, CValidationState&amp; state, const CChainParams&amp; chainparams, const CBlockIndex** ppindex, CBlockHeader *first_invalid)</span>
<span class="lineNum">    3418 </span>                :            : {
<span class="lineNum">    3419 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :     if (first_invalid != nullptr) first_invalid-&gt;SetNull();</span>
<span class="lineNum">    3420 </span>                :            :     {
<span class="lineNum">    3421 </span>                :<span class="lineCov">          1 :         LOCK(cs_main);</span>
<span class="lineNum">    3422 </span>        [<span class="branchCov" title="Branch 0 was taken 73 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         74 :         for (const CBlockHeader&amp; header : headers) {</span>
<span class="lineNum">    3423 </span>                :<span class="lineCov">         73 :             CBlockIndex *pindex = nullptr; // Use a temp pindex instead of ppindex to avoid a const_cast</span>
<span class="lineNum">    3424 </span>[<span class="branchCov" title="Branch 1 was taken 73 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 73 times"> + </span>]:<span class="lineCov">         73 :             if (!g_chainstate.AcceptBlockHeader(header, state, chainparams, &amp;pindex)) {</span>
<span class="lineNum">    3425 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (first_invalid) *first_invalid = header;</span>
<span class="lineNum">    3426 </span>                :<span class="lineNoCov">          0 :                 return false;</span>
<span class="lineNum">    3427 </span>                :            :             }
<span class="lineNum">    3428 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 73 times"> + </span>]:<span class="lineCov">         73 :             if (ppindex) {</span>
<span class="lineNum">    3429 </span>                :<span class="lineNoCov">          0 :                 *ppindex = pindex;</span>
<span class="lineNum">    3430 </span>                :            :             }
<span class="lineNum">    3431 </span>                :            :         }
<span class="lineNum">    3432 </span>                :            :     }
<span class="lineNum">    3433 </span>                :<span class="lineCov">          1 :     NotifyHeaderTip();</span>
<span class="lineNum">    3434 </span>                :<span class="lineCov">          1 :     return true;</span>
<span class="lineNum">    3435 </span>                :            : }
<span class="lineNum">    3436 </span>                :            : 
<span class="lineNum">    3437 </span>                :            : /** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */
<span class="lineNum">    3438 </span>                :<span class="lineCov">       1369 : static CDiskBlockPos SaveBlockToDisk(const CBlock&amp; block, int nHeight, const CChainParams&amp; chainparams, const CDiskBlockPos* dbp) {</span>
<span class="lineNum">    3439 </span>                :<span class="lineCov">       1369 :     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);</span>
<span class="lineNum">    3440 </span>                :<span class="lineCov">       1369 :     CDiskBlockPos blockPos;</span>
<span class="lineNum">    3441 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1369 times"> + </span>]:<span class="lineCov">       1369 :     if (dbp != nullptr)</span>
<span class="lineNum">    3442 </span>                :<span class="lineNoCov">          0 :         blockPos = *dbp;</span>
<span class="lineNum">    3443 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1369 times"> + </span>]:<span class="lineCov">       1369 :     if (!FindBlockPos(blockPos, nBlockSize+8, nHeight, block.GetBlockTime(), dbp != nullptr)) {</span>
<span class="lineNum">    3444 </span>                :<span class="lineNoCov">          0 :         error(&quot;%s: FindBlockPos failed&quot;, __func__);</span>
<span class="lineNum">    3445 </span>                :<span class="lineNoCov">          0 :         return CDiskBlockPos();</span>
<span class="lineNum">    3446 </span>                :            :     }
<span class="lineNum">    3447 </span>        [<span class="branchCov" title="Branch 0 was taken 1369 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1369 :     if (dbp == nullptr) {</span>
<span class="lineNum">    3448 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1369 times"> + </span>]:<span class="lineCov">       1369 :         if (!WriteBlockToDisk(block, blockPos, chainparams.MessageStart())) {</span>
<span class="lineNum">    3449 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             AbortNode(&quot;Failed to write block&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    3450 </span>                :<span class="lineNoCov">          0 :             return CDiskBlockPos();</span>
<span class="lineNum">    3451 </span>                :            :         }
<span class="lineNum">    3452 </span>                :            :     }
<span class="lineNum">    3453 </span>                :<span class="lineCov">       1369 :     return blockPos;</span>
<span class="lineNum">    3454 </span>                :            : }
<span class="lineNum">    3455 </span>                :            : 
<span class="lineNum">    3456 </span>                :            : /** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */
<span class="lineNum">    3457 </span>                :<span class="lineCov">      11883 : bool CChainState::AcceptBlock(const std::shared_ptr&lt;const CBlock&gt;&amp; pblock, CValidationState&amp; state, const CChainParams&amp; chainparams, CBlockIndex** ppindex, bool fRequested, const CDiskBlockPos* dbp, bool* fNewBlock)</span>
<span class="lineNum">    3458 </span>                :            : {
<span class="lineNum">    3459 </span>                :<span class="lineCov">      11883 :     const CBlock&amp; block = *pblock;</span>
<span class="lineNum">    3460 </span>                :            : 
<span class="lineNum">    3461 </span>        [<span class="branchCov" title="Branch 0 was taken 10651 times"> + </span><span class="branchCov" title="Branch 1 was taken 1232 times"> + </span>]:<span class="lineCov">      11883 :     if (fNewBlock) *fNewBlock = false;</span>
<span class="lineNum">    3462 </span>                :<span class="lineCov">      11883 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    3463 </span>                :            : 
<span class="lineNum">    3464 </span>                :<span class="lineCov">      11883 :     CBlockIndex *pindexDummy = nullptr;</span>
<span class="lineNum">    3465 </span>        [<span class="branchCov" title="Branch 0 was taken 11883 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      11883 :     CBlockIndex *&amp;pindex = ppindex ? *ppindex : pindexDummy;</span>
<span class="lineNum">    3466 </span>                :            : 
<span class="lineNum">    3467 </span>        [<span class="branchCov" title="Branch 1 was taken 11761 times"> + </span><span class="branchCov" title="Branch 2 was taken 122 times"> + </span>]:<span class="lineCov">      11883 :     if (!AcceptBlockHeader(block, state, chainparams, &amp;pindex))</span>
<span class="lineNum">    3468 </span>                :            :         return false;
<span class="lineNum">    3469 </span>                :            : 
<span class="lineNum">    3470 </span>                :            :     // Try to process all requested blocks that we don't have, but only
<span class="lineNum">    3471 </span>                :            :     // process an unrequested block if it's new and has enough work to
<span class="lineNum">    3472 </span>                :            :     // advance our tip, and isn't too many blocks ahead.
<span class="lineNum">    3473 </span>                :<span class="lineCov">      11761 :     bool fAlreadyHave = pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA;</span>
<span class="lineNum">    3474 </span>  [<span class="branchCov" title="Branch 0 was taken 11761 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1560 times"> + </span><span class="branchCov" title="Branch 3 was taken 10201 times"> + </span>]:<span class="lineCov">      23522 :     bool fHasMoreOrSameWork = (chainActive.Tip() ? pindex-&gt;nChainWork &gt;= chainActive.Tip()-&gt;nChainWork : true);</span>
<span class="lineNum">    3475 </span>                :            :     // Blocks that are too out-of-order needlessly limit the effectiveness of
<span class="lineNum">    3476 </span>                :            :     // pruning, because pruning will not delete block files that contain any
<span class="lineNum">    3477 </span>                :            :     // blocks which are too close in height to the tip.  Apply this test
<span class="lineNum">    3478 </span>                :            :     // regardless of whether pruning is enabled; it should generally be safe to
<span class="lineNum">    3479 </span>                :            :     // not process unrequested blocks.
<span class="lineNum">    3480 </span>                :<span class="lineCov">      23522 :     bool fTooFarAhead = (pindex-&gt;nHeight &gt; int(chainActive.Height() + MIN_BLOCKS_TO_KEEP));</span>
<span class="lineNum">    3481 </span>                :            : 
<span class="lineNum">    3482 </span>                :            :     // TODO: Decouple this function from the block download logic by removing fRequested
<span class="lineNum">    3483 </span>                :            :     // This requires some new chain data structure to efficiently look up if a
<span class="lineNum">    3484 </span>                :            :     // block is in a chain leading to a candidate for best tip, despite not
<span class="lineNum">    3485 </span>                :            :     // being such a candidate itself.
<span class="lineNum">    3486 </span>                :            : 
<span class="lineNum">    3487 </span>                :            :     // TODO: deal better with return value and error conditions for duplicate
<span class="lineNum">    3488 </span>                :            :     // and unrequested blocks.
<span class="lineNum">    3489 </span>        [<span class="branchCov" title="Branch 0 was taken 1303 times"> + </span><span class="branchCov" title="Branch 1 was taken 10458 times"> + </span>]:<span class="lineCov">      11761 :     if (fAlreadyHave) return true;</span>
<span class="lineNum">    3490 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1303 times"> + </span>]:<span class="lineCov">       1303 :     if (!fRequested) {  // If we didn't ask for it:</span>
<span class="lineNum">    3491 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex-&gt;nTx != 0) return true;    // This is a previously-processed block that was pruned</span>
<span class="lineNum">    3492 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!fHasMoreOrSameWork) return true; // Don't process less-work chains</span>
<span class="lineNum">    3493 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (fTooFarAhead) return true;        // Block height is too high</span>
<span class="lineNum">    3494 </span>                :            : 
<span class="lineNum">    3495 </span>                :            :         // Protect against DoS attacks from low-work chains.
<span class="lineNum">    3496 </span>                :            :         // If our tip is behind, a peer could try to send us
<span class="lineNum">    3497 </span>                :            :         // low-work blocks on a fake chain that we would never
<span class="lineNum">    3498 </span>                :            :         // request; don't process these.
<span class="lineNum">    3499 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex-&gt;nChainWork &lt; nMinimumChainWork) return true;</span>
<span class="lineNum">    3500 </span>                :            :     }
<span class="lineNum">    3501 </span>                :            : 
<span class="lineNum">    3502 </span>  [<span class="branchCov" title="Branch 1 was taken 1303 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1303 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       2606 :     if (!CheckBlock(block, state, chainparams.GetConsensus()) ||</span>
<span class="lineNum">    3503 </span>                :<span class="lineCov">       1303 :         !ContextualCheckBlock(block, state, chainparams.GetConsensus(), pindex-&gt;pprev)) {</span>
<span class="lineNum">    3504 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (state.IsInvalid() &amp;&amp; !state.CorruptionPossible()) {</span>
<span class="lineNum">    3505 </span>                :<span class="lineNoCov">          0 :             pindex-&gt;nStatus |= BLOCK_FAILED_VALID;</span>
<span class="lineNum">    3506 </span>                :            :             setDirtyBlockIndex.insert(pindex);
<span class="lineNum">    3507 </span>                :            :         }
<span class="lineNum">    3508 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: %s&quot;, __func__, FormatStateMessage(state));</span>
<span class="lineNum">    3509 </span>                :            :     }
<span class="lineNum">    3510 </span>                :            : 
<span class="lineNum">    3511 </span>                :            :     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW
<span class="lineNum">    3512 </span>                :            :     // (but if it does not build on our best tip, let the SendMessages loop relay it)
<span class="lineNum">    3513 </span>[<span class="branchCov" title="Branch 1 was taken 1117 times"> + </span><span class="branchCov" title="Branch 2 was taken 186 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 1117 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       2420 :     if (!IsInitialBlockDownload() &amp;&amp; chainActive.Tip() == pindex-&gt;pprev)</span>
<span class="lineNum">    3514 </span>                :<span class="lineCov">       1117 :         GetMainSignals().NewPoWValidBlock(pindex, pblock);</span>
<span class="lineNum">    3515 </span>                :            : 
<span class="lineNum">    3516 </span>                :            :     // Write block to history file
<span class="lineNum">    3517 </span>        [<span class="branchCov" title="Branch 0 was taken 72 times"> + </span><span class="branchCov" title="Branch 1 was taken 1231 times"> + </span>]:<span class="lineCov">       1303 :     if (fNewBlock) *fNewBlock = true;</span>
<span class="lineNum">    3518 </span>                :            :     try {
<span class="lineNum">    3519 </span>        [<span class="branchCov" title="Branch 1 was taken 1303 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1303 :         CDiskBlockPos blockPos = SaveBlockToDisk(block, pindex-&gt;nHeight, chainparams, dbp);</span>
<span class="lineNum">    3520 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1303 times"> + </span>]:<span class="lineCov">       1303 :         if (blockPos.IsNull()) {</span>
<span class="lineNum">    3521 </span>  [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             state.Error(strprintf(&quot;%s: Failed to find position to write new block to disk&quot;, __func__));</span>
<span class="lineNum">    3522 </span>                :<span class="lineNoCov">          0 :             return false;</span>
<span class="lineNum">    3523 </span>                :            :         }
<span class="lineNum">    3524 </span>        [<span class="branchCov" title="Branch 1 was taken 1303 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1303 :         ReceivedBlockTransactions(block, pindex, blockPos, chainparams.GetConsensus());</span>
<span class="lineNum">    3525 </span>                :<span class="lineNoCov">          0 :     } catch (const std::runtime_error&amp; e) {</span>
<span class="lineNum">    3526 </span>  [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span> :<span class="lineNoCov">          0 :         return AbortNode(state, std::string(&quot;System error: &quot;) + e.what());</span>
<span class="lineNum">         </span>   <span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span><span class="branchNoExec" title="Branch 12 was not executed"> # </span>]
<span class="lineNum">    3527 </span>                :            :     }
<span class="lineNum">    3528 </span>                :            : 
<span class="lineNum">    3529 </span>                :<span class="lineCov">       1303 :     FlushStateToDisk(chainparams, state, FlushStateMode::NONE);</span>
<span class="lineNum">    3530 </span>                :            : 
<span class="lineNum">    3531 </span>                :<span class="lineCov">      11883 :     CheckBlockIndex(chainparams.GetConsensus());</span>
<span class="lineNum">    3532 </span>                :            : 
<span class="lineNum">    3533 </span>                :            :     return true;
<span class="lineNum">    3534 </span>                :            : }
<span class="lineNum">    3535 </span>                :            : 
<span class="lineNum">    3536 </span>                :<span class="lineCov">      11883 : bool ProcessNewBlock(const CChainParams&amp; chainparams, const std::shared_ptr&lt;const CBlock&gt; pblock, bool fForceProcessing, bool *fNewBlock)</span>
<span class="lineNum">    3537 </span>                :            : {
<span class="lineNum">    3538 </span>                :<span class="lineCov">      11883 :     AssertLockNotHeld(cs_main);</span>
<span class="lineNum">    3539 </span>                :            : 
<span class="lineNum">    3540 </span>                :            :     {
<span class="lineNum">    3541 </span>                :<span class="lineCov">      11883 :         CBlockIndex *pindex = nullptr;</span>
<span class="lineNum">    3542 </span>        [<span class="branchCov" title="Branch 0 was taken 10651 times"> + </span><span class="branchCov" title="Branch 1 was taken 1232 times"> + </span>]:<span class="lineCov">      11883 :         if (fNewBlock) *fNewBlock = false;</span>
<span class="lineNum">    3543 </span>                :<span class="lineCov">      11761 :         CValidationState state;</span>
<span class="lineNum">    3544 </span>                :            : 
<span class="lineNum">    3545 </span>                :            :         // CheckBlock() does not support multi-threaded block validation because CBlock::fChecked can cause data race.
<span class="lineNum">    3546 </span>                :            :         // Therefore, the following critical section must include the CheckBlock() call as well.
<span class="lineNum">    3547 </span>        [<span class="branchCov" title="Branch 1 was taken 11883 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      11883 :         LOCK(cs_main);</span>
<span class="lineNum">    3548 </span>                :            : 
<span class="lineNum">    3549 </span>                :            :         // Ensure that CheckBlock() passes before calling AcceptBlock, as
<span class="lineNum">    3550 </span>                :            :         // belt-and-suspenders.
<span class="lineNum">    3551 </span>        [<span class="branchCov" title="Branch 1 was taken 11883 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      11883 :         bool ret = CheckBlock(*pblock, state, chainparams.GetConsensus());</span>
<span class="lineNum">    3552 </span>        [<span class="branchCov" title="Branch 0 was taken 11883 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      11883 :         if (ret) {</span>
<span class="lineNum">    3553 </span>                :            :             // Store to disk
<span class="lineNum">    3554 </span>        [<span class="branchCov" title="Branch 1 was taken 11883 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      11883 :             ret = g_chainstate.AcceptBlock(pblock, state, chainparams, &amp;pindex, fForceProcessing, nullptr, fNewBlock);</span>
<span class="lineNum">    3555 </span>                :            :         }
<span class="lineNum">    3556 </span>        [<span class="branchCov" title="Branch 0 was taken 122 times"> + </span><span class="branchCov" title="Branch 1 was taken 11761 times"> + </span>]:<span class="lineCov">      11883 :         if (!ret) {</span>
<span class="lineNum">    3557 </span>[<span class="branchCov" title="Branch 1 was taken 122 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 122 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        122 :             GetMainSignals().BlockChecked(*pblock, state);</span>
<span class="lineNum">    3558 </span>[<span class="branchCov" title="Branch 1 was taken 122 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 122 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        122 :             return error(&quot;%s: AcceptBlock FAILED (%s)&quot;, __func__, FormatStateMessage(state));</span>
<span class="lineNum">    3559 </span>                :            :         }
<span class="lineNum">    3560 </span>                :            :     }
<span class="lineNum">    3561 </span>                :            : 
<span class="lineNum">    3562 </span>                :<span class="lineCov">      11761 :     NotifyHeaderTip();</span>
<span class="lineNum">    3563 </span>                :            : 
<span class="lineNum">    3564 </span>                :<span class="lineCov">      11883 :     CValidationState state; // Only used to report errors, not invalidity - ignore it</span>
<span class="lineNum">    3565 </span>[<span class="branchCov" title="Branch 1 was taken 11761 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 11761 times"> + </span>]:<span class="lineCov">      23522 :     if (!g_chainstate.ActivateBestChain(state, chainparams, pblock))</span>
<span class="lineNum">    3566 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: ActivateBestChain failed (%s)&quot;, __func__, FormatStateMessage(state));</span>
<span class="lineNum">    3567 </span>                :            : 
<span class="lineNum">    3568 </span>                :            :     return true;
<span class="lineNum">    3569 </span>                :            : }
<span class="lineNum">    3570 </span>                :            : 
<span class="lineNum">    3571 </span>                :<span class="lineCov">       1308 : bool TestBlockValidity(CValidationState&amp; state, const CChainParams&amp; chainparams, const CBlock&amp; block, CBlockIndex* pindexPrev, bool fCheckPOW, bool fCheckMerkleRoot)</span>
<span class="lineNum">    3572 </span>                :            : {
<span class="lineNum">    3573 </span>                :<span class="lineCov">       1308 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    3574 </span>[<span class="branchCov" title="Branch 0 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1308 times"> + </span>]:<span class="lineCov">       2616 :     assert(pindexPrev &amp;&amp; pindexPrev == chainActive.Tip());</span>
<span class="lineNum">    3575 </span>                :<span class="lineCov">       2616 :     CCoinsViewCache viewNew(pcoinsTip.get());</span>
<span class="lineNum">    3576 </span>        [<span class="branchCov" title="Branch 1 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1308 :     uint256 block_hash(block.GetHash());</span>
<span class="lineNum">    3577 </span>                :<span class="lineCov">       1308 :     CBlockIndex indexDummy(block);</span>
<span class="lineNum">    3578 </span>                :<span class="lineCov">       1308 :     indexDummy.pprev = pindexPrev;</span>
<span class="lineNum">    3579 </span>                :<span class="lineCov">       1308 :     indexDummy.nHeight = pindexPrev-&gt;nHeight + 1;</span>
<span class="lineNum">    3580 </span>                :<span class="lineCov">       1308 :     indexDummy.phashBlock = &amp;block_hash;</span>
<span class="lineNum">    3581 </span>                :            : 
<span class="lineNum">    3582 </span>                :            :     // NOTE: CheckBlockHeader is called by CheckBlock
<span class="lineNum">    3583 </span>[<span class="branchCov" title="Branch 1 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       1308 :     if (!ContextualCheckBlockHeader(block, state, chainparams, pindexPrev, GetAdjustedTime()))</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 1308 times"> + </span>]
<span class="lineNum">    3584 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: Consensus::ContextualCheckBlockHeader: %s&quot;, __func__, FormatStateMessage(state));</span>
<span class="lineNum">    3585 </span>[<span class="branchCov" title="Branch 1 was taken 1308 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 2 times"> + </span><span class="branchCov" title="Branch 4 was taken 1306 times"> + </span>]:<span class="lineCov">       1308 :     if (!CheckBlock(block, state, chainparams.GetConsensus(), fCheckPOW, fCheckMerkleRoot))</span>
<span class="lineNum">    3586 </span>[<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          4 :         return error(&quot;%s: Consensus::CheckBlock: %s&quot;, __func__, FormatStateMessage(state));</span>
<span class="lineNum">    3587 </span>[<span class="branchCov" title="Branch 1 was taken 1306 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 1306 times"> + </span>]:<span class="lineCov">       1306 :     if (!ContextualCheckBlock(block, state, chainparams.GetConsensus(), pindexPrev))</span>
<span class="lineNum">    3588 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: Consensus::ContextualCheckBlock: %s&quot;, __func__, FormatStateMessage(state));</span>
<span class="lineNum">    3589 </span>[<span class="branchCov" title="Branch 1 was taken 1306 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1303 times"> + </span><span class="branchCov" title="Branch 4 was taken 3 times"> + </span>]:<span class="lineCov">       1306 :     if (!g_chainstate.ConnectBlock(block, state, &amp;indexDummy, viewNew, chainparams, true))</span>
<span class="lineNum">    3590 </span>                :            :         return false;
<span class="lineNum">    3591 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1303 times"> + </span>]:<span class="lineCov">       1303 :     assert(state.IsValid());</span>
<span class="lineNum">    3592 </span>                :            : 
<span class="lineNum">    3593 </span>                :            :     return true;
<span class="lineNum">    3594 </span>                :            : }
<span class="lineNum">    3595 </span>                :            : 
<span class="lineNum">    3596 </span>                :            : /**
<span class="lineNum">    3597 </span>                :            :  * BLOCK PRUNING CODE
<span class="lineNum">    3598 </span>                :            :  */
<a name="3599"><span class="lineNum">    3599 </span>                :            : </a>
<span class="lineNum">    3600 </span>                :            : /* Calculate the amount of disk space the block &amp; undo files currently use */
<span class="lineNum">    3601 </span>                :<span class="lineNoCov">          0 : uint64_t CalculateCurrentUsage()</span>
<span class="lineNum">    3602 </span>                :            : {
<span class="lineNum">    3603 </span>                :<span class="lineNoCov">          0 :     LOCK(cs_LastBlockFile);</span>
<span class="lineNum">    3604 </span>                :            : 
<span class="lineNum">    3605 </span>                :<span class="lineNoCov">          0 :     uint64_t retval = 0;</span>
<span class="lineNum">    3606 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (const CBlockFileInfo &amp;file : vinfoBlockFile) {</span>
<span class="lineNum">    3607 </span>                :<span class="lineNoCov">          0 :         retval += file.nSize + file.nUndoSize;</span>
<span class="lineNum">    3608 </span>                :            :     }
<span class="lineNum">    3609 </span>                :<span class="lineNoCov">          0 :     return retval;</span>
<span class="lineNum">    3610 </span>                :            : }
<a name="3611"><span class="lineNum">    3611 </span>                :            : </a>
<span class="lineNum">    3612 </span>                :            : /* Prune a block file (modify associated database entries)*/
<span class="lineNum">    3613 </span>                :<span class="lineCov">          3 : void PruneOneBlockFile(const int fileNumber)</span>
<span class="lineNum">    3614 </span>                :            : {
<span class="lineNum">    3615 </span>                :<span class="lineCov">          3 :     LOCK(cs_LastBlockFile);</span>
<span class="lineNum">    3616 </span>                :            : 
<span class="lineNum">    3617 </span>        [<span class="branchCov" title="Branch 0 was taken 306 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">        309 :     for (const auto&amp; entry : mapBlockIndex) {</span>
<span class="lineNum">    3618 </span>                :<span class="lineCov">        306 :         CBlockIndex* pindex = entry.second;</span>
<span class="lineNum">    3619 </span>        [<span class="branchCov" title="Branch 0 was taken 203 times"> + </span><span class="branchCov" title="Branch 1 was taken 103 times"> + </span>]:<span class="lineCov">        306 :         if (pindex-&gt;nFile == fileNumber) {</span>
<span class="lineNum">    3620 </span>                :<span class="lineCov">        203 :             pindex-&gt;nStatus &amp;= ~BLOCK_HAVE_DATA;</span>
<span class="lineNum">    3621 </span>                :<span class="lineCov">        203 :             pindex-&gt;nStatus &amp;= ~BLOCK_HAVE_UNDO;</span>
<span class="lineNum">    3622 </span>                :<span class="lineCov">        203 :             pindex-&gt;nFile = 0;</span>
<span class="lineNum">    3623 </span>                :<span class="lineCov">        203 :             pindex-&gt;nDataPos = 0;</span>
<span class="lineNum">    3624 </span>                :<span class="lineCov">        203 :             pindex-&gt;nUndoPos = 0;</span>
<span class="lineNum">    3625 </span>                :<span class="lineCov">        203 :             setDirtyBlockIndex.insert(pindex);</span>
<span class="lineNum">    3626 </span>                :            : 
<span class="lineNum">    3627 </span>                :            :             // Prune from mapBlocksUnlinked -- any block we prune would have
<span class="lineNum">    3628 </span>                :            :             // to be downloaded again in order to consider its chain, at which
<span class="lineNum">    3629 </span>                :            :             // point it would be considered as a candidate for
<span class="lineNum">    3630 </span>                :            :             // mapBlocksUnlinked or setBlockIndexCandidates.
<span class="lineNum">    3631 </span>                :<span class="lineCov">        203 :             std::pair&lt;std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;::iterator, std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;::iterator&gt; range = mapBlocksUnlinked.equal_range(pindex-&gt;pprev);</span>
<span class="lineNum">    3632 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 203 times"> + </span>]:<span class="lineCov">        203 :             while (range.first != range.second) {</span>
<span class="lineNum">    3633 </span>                :<span class="lineNoCov">          0 :                 std::multimap&lt;CBlockIndex *, CBlockIndex *&gt;::iterator _it = range.first;</span>
<span class="lineNum">    3634 </span>                :<span class="lineNoCov">          0 :                 range.first++;</span>
<span class="lineNum">    3635 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (_it-&gt;second == pindex) {</span>
<span class="lineNum">    3636 </span>                :<span class="lineNoCov">          0 :                     mapBlocksUnlinked.erase(_it);</span>
<span class="lineNum">    3637 </span>                :            :                 }
<span class="lineNum">    3638 </span>                :            :             }
<span class="lineNum">    3639 </span>                :            :         }
<span class="lineNum">    3640 </span>                :            :     }
<span class="lineNum">    3641 </span>                :            : 
<span class="lineNum">    3642 </span>                :<span class="lineCov">          9 :     vinfoBlockFile[fileNumber].SetNull();</span>
<span class="lineNum">    3643 </span>                :<span class="lineCov">          3 :     setDirtyFileInfo.insert(fileNumber);</span>
<span class="lineNum">    3644 </span>                :<span class="lineCov">          3 : }</span>
<span class="lineNum">    3645 </span>                :            : 
<span class="lineNum">    3646 </span>                :            : 
<span class="lineNum">    3647 </span>                :<span class="lineCov">          3 : void UnlinkPrunedFiles(const std::set&lt;int&gt;&amp; setFilesToPrune)</span>
<span class="lineNum">    3648 </span>                :            : {
<span class="lineNum">    3649 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          6 :     for (std::set&lt;int&gt;::iterator it = setFilesToPrune.begin(); it != setFilesToPrune.end(); ++it) {</span>
<span class="lineNum">    3650 </span>                :<span class="lineCov">          6 :         CDiskBlockPos pos(*it, 0);</span>
<span class="lineNum">    3651 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         fs::remove(GetBlockPosFilename(pos, &quot;blk&quot;));</span>
<span class="lineNum">    3652 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         fs::remove(GetBlockPosFilename(pos, &quot;rev&quot;));</span>
<span class="lineNum">    3653 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :         LogPrintf(&quot;Prune: %s deleted blk/rev (%05u)\n&quot;, __func__, *it);</span>
<span class="lineNum">    3654 </span>                :            :     }
<span class="lineNum">    3655 </span>                :<span class="lineCov">          3 : }</span>
<a name="3656"><span class="lineNum">    3656 </span>                :            : </a>
<span class="lineNum">    3657 </span>                :            : /* Calculate the block/rev files to delete based on height specified by user with RPC command pruneblockchain */
<span class="lineNum">    3658 </span>                :<span class="lineNoCov">          0 : static void FindFilesToPruneManual(std::set&lt;int&gt;&amp; setFilesToPrune, int nManualPruneHeight)</span>
<span class="lineNum">    3659 </span>                :            : {
<span class="lineNum">    3660 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     assert(fPruneMode &amp;&amp; nManualPruneHeight &gt; 0);</span>
<span class="lineNum">    3661 </span>                :            : 
<span class="lineNum">    3662 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LOCK2(cs_main, cs_LastBlockFile);</span>
<span class="lineNum">    3663 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (chainActive.Tip() == nullptr)</span>
<span class="lineNum">    3664 </span>                :<span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    3665 </span>                :            : 
<span class="lineNum">    3666 </span>                :            :     // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)
<span class="lineNum">    3667 </span>                :<span class="lineNoCov">          0 :     unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chainActive.Tip()-&gt;nHeight - MIN_BLOCKS_TO_KEEP);</span>
<span class="lineNum">    3668 </span>                :<span class="lineNoCov">          0 :     int count=0;</span>
<span class="lineNum">    3669 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (int fileNumber = 0; fileNumber &lt; nLastBlockFile; fileNumber++) {</span>
<span class="lineNum">    3670 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (vinfoBlockFile[fileNumber].nSize == 0 || vinfoBlockFile[fileNumber].nHeightLast &gt; nLastBlockWeCanPrune)</span>
<span class="lineNum">    3671 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    3672 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         PruneOneBlockFile(fileNumber);</span>
<span class="lineNum">    3673 </span>                :<span class="lineNoCov">          0 :         setFilesToPrune.insert(fileNumber);</span>
<span class="lineNum">    3674 </span>                :<span class="lineNoCov">          0 :         count++;</span>
<span class="lineNum">    3675 </span>                :            :     }
<span class="lineNum">    3676 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LogPrintf(&quot;Prune (Manual): prune_height=%d removed %d blk/rev pairs\n&quot;, nLastBlockWeCanPrune, count);</span>
<span class="lineNum">    3677 </span>                :            : }
<span class="lineNum">    3678 </span>                :            : 
<span class="lineNum">    3679 </span>                :            : /* This function is called from the RPC code for pruneblockchain */
<span class="lineNum">    3680 </span>                :<span class="lineNoCov">          0 : void PruneBlockFilesManual(int nManualPruneHeight)</span>
<span class="lineNum">    3681 </span>                :            : {
<span class="lineNum">    3682 </span>                :<span class="lineNoCov">          0 :     CValidationState state;</span>
<span class="lineNum">    3683 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     const CChainParams&amp; chainparams = Params();</span>
<span class="lineNum">    3684 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!FlushStateToDisk(chainparams, state, FlushStateMode::NONE, nManualPruneHeight)) {</span>
<span class="lineNum">    3685 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LogPrintf(&quot;%s: failed to flush state (%s)\n&quot;, __func__, FormatStateMessage(state));</span>
<span class="lineNum">    3686 </span>                :            :     }
<span class="lineNum">    3687 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3688 </span>                :            : 
<span class="lineNum">    3689 </span>                :            : /**
<span class="lineNum">    3690 </span>                :            :  * Prune block and undo files (blk???.dat and undo???.dat) so that the disk space used is less than a user-defined target.
<span class="lineNum">    3691 </span>                :            :  * The user sets the target (in MB) on the command line or in config file.  This will be run on startup and whenever new
<span class="lineNum">    3692 </span>                :            :  * space is allocated in a block or undo file, staying below the target. Changing back to unpruned requires a reindex
<span class="lineNum">    3693 </span>                :            :  * (which in this case means the blockchain must be re-downloaded.)
<span class="lineNum">    3694 </span>                :            :  *
<span class="lineNum">    3695 </span>                :            :  * Pruning functions are called from FlushStateToDisk when the global fCheckForPruning flag has been set.
<span class="lineNum">    3696 </span>                :            :  * Block and undo files are deleted in lock-step (when blk00003.dat is deleted, so is rev00003.dat.)
<span class="lineNum">    3697 </span>                :            :  * Pruning cannot take place until the longest chain is at least a certain length (100000 on mainnet, 1000 on testnet, 1000 on regtest).
<span class="lineNum">    3698 </span>                :            :  * Pruning will never delete a block within a defined distance (currently 288) from the active chain's tip.
<span class="lineNum">    3699 </span>                :            :  * The block index is updated by unsetting HAVE_DATA and HAVE_UNDO for any blocks that were stored in the deleted files.
<span class="lineNum">    3700 </span>                :            :  * A db flag records the fact that at least some block files have been pruned.
<span class="lineNum">    3701 </span>                :            :  *
<a name="3702"><span class="lineNum">    3702 </span>                :            :  * @param[out]   setFilesToPrune   The set of file indices that can be unlinked will be returned</a>
<span class="lineNum">    3703 </span>                :            :  */
<span class="lineNum">    3704 </span>                :<span class="lineNoCov">          0 : static void FindFilesToPrune(std::set&lt;int&gt;&amp; setFilesToPrune, uint64_t nPruneAfterHeight)</span>
<span class="lineNum">    3705 </span>                :            : {
<span class="lineNum">    3706 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LOCK2(cs_main, cs_LastBlockFile);</span>
<span class="lineNum">    3707 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (chainActive.Tip() == nullptr || nPruneTarget == 0) {</span>
<span class="lineNum">    3708 </span>                :<span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    3709 </span>                :            :     }
<span class="lineNum">    3710 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if ((uint64_t)chainActive.Tip()-&gt;nHeight &lt;= nPruneAfterHeight) {</span>
<span class="lineNum">    3711 </span>                :            :         return;
<span class="lineNum">    3712 </span>                :            :     }
<span class="lineNum">    3713 </span>                :            : 
<span class="lineNum">    3714 </span>                :<span class="lineNoCov">          0 :     unsigned int nLastBlockWeCanPrune = chainActive.Tip()-&gt;nHeight - MIN_BLOCKS_TO_KEEP;</span>
<span class="lineNum">    3715 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     uint64_t nCurrentUsage = CalculateCurrentUsage();</span>
<span class="lineNum">    3716 </span>                :            :     // We don't check to prune until after we've allocated new space for files
<span class="lineNum">    3717 </span>                :            :     // So we should leave a buffer under our target to account for another allocation
<span class="lineNum">    3718 </span>                :            :     // before the next pruning.
<span class="lineNum">    3719 </span>                :<span class="lineNoCov">          0 :     uint64_t nBuffer = BLOCKFILE_CHUNK_SIZE + UNDOFILE_CHUNK_SIZE;</span>
<span class="lineNum">    3720 </span>                :            :     uint64_t nBytesToPrune;
<span class="lineNum">    3721 </span>                :<span class="lineNoCov">          0 :     int count=0;</span>
<span class="lineNum">    3722 </span>                :            : 
<span class="lineNum">    3723 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (nCurrentUsage + nBuffer &gt;= nPruneTarget) {</span>
<span class="lineNum">    3724 </span>                :            :         // On a prune event, the chainstate DB is flushed.
<span class="lineNum">    3725 </span>                :            :         // To avoid excessive prune events negating the benefit of high dbcache
<span class="lineNum">    3726 </span>                :            :         // values, we should not prune too rapidly.
<span class="lineNum">    3727 </span>                :            :         // So when pruning in IBD, increase the buffer a bit to avoid a re-prune too soon.
<span class="lineNum">    3728 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (IsInitialBlockDownload()) {</span>
<span class="lineNum">    3729 </span>                :            :             // Since this is only relevant during IBD, we use a fixed 10%
<span class="lineNum">    3730 </span>                :<span class="lineNoCov">          0 :             nBuffer += nPruneTarget / 10;</span>
<span class="lineNum">    3731 </span>                :            :         }
<span class="lineNum">    3732 </span>                :            : 
<span class="lineNum">    3733 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (int fileNumber = 0; fileNumber &lt; nLastBlockFile; fileNumber++) {</span>
<span class="lineNum">    3734 </span>                :<span class="lineNoCov">          0 :             nBytesToPrune = vinfoBlockFile[fileNumber].nSize + vinfoBlockFile[fileNumber].nUndoSize;</span>
<span class="lineNum">    3735 </span>                :            : 
<span class="lineNum">    3736 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (vinfoBlockFile[fileNumber].nSize == 0)</span>
<span class="lineNum">    3737 </span>                :<span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">    3738 </span>                :            : 
<span class="lineNum">    3739 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (nCurrentUsage + nBuffer &lt; nPruneTarget)  // are we below our target?</span>
<span class="lineNum">    3740 </span>                :            :                 break;
<span class="lineNum">    3741 </span>                :            : 
<span class="lineNum">    3742 </span>                :            :             // don't prune files that could have a block within MIN_BLOCKS_TO_KEEP of the main chain's tip but keep scanning
<span class="lineNum">    3743 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (vinfoBlockFile[fileNumber].nHeightLast &gt; nLastBlockWeCanPrune)</span>
<span class="lineNum">    3744 </span>                :<span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">    3745 </span>                :            : 
<span class="lineNum">    3746 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             PruneOneBlockFile(fileNumber);</span>
<span class="lineNum">    3747 </span>                :            :             // Queue up the files for removal
<span class="lineNum">    3748 </span>                :<span class="lineNoCov">          0 :             setFilesToPrune.insert(fileNumber);</span>
<span class="lineNum">    3749 </span>                :<span class="lineNoCov">          0 :             nCurrentUsage -= nBytesToPrune;</span>
<span class="lineNum">    3750 </span>                :<span class="lineNoCov">          0 :             count++;</span>
<span class="lineNum">    3751 </span>                :            :         }
<span class="lineNum">    3752 </span>                :            :     }
<span class="lineNum">    3753 </span>                :            : 
<span class="lineNum">    3754 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LogPrint(BCLog::PRUNE, &quot;Prune: target=%dMiB actual=%dMiB diff=%dMiB max_prune_height=%d removed %d blk/rev pairs\n&quot;,</span>
<span class="lineNum">    3755 </span>                :<span class="lineNoCov">          0 :            nPruneTarget/1024/1024, nCurrentUsage/1024/1024,</span>
<span class="lineNum">    3756 </span>                :<span class="lineNoCov">          0 :            ((int64_t)nPruneTarget - (int64_t)nCurrentUsage)/1024/1024,</span>
<span class="lineNum">    3757 </span>                :            :            nLastBlockWeCanPrune, count);
<span class="lineNum">    3758 </span>                :            : }
<span class="lineNum">    3759 </span>                :            : 
<span class="lineNum">    3760 </span>                :<span class="lineCov">         83 : bool CheckDiskSpace(uint64_t nAdditionalBytes, bool blocks_dir)</span>
<span class="lineNum">    3761 </span>                :            : {
<span class="lineNum">    3762 </span>        [<span class="branchCov" title="Branch 0 was taken 83 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         83 :     uint64_t nFreeBytesAvailable = fs::space(blocks_dir ? GetBlocksDir() : GetDataDir()).available;</span>
<span class="lineNum">    3763 </span>                :            : 
<span class="lineNum">    3764 </span>                :            :     // Check for nMinDiskSpace bytes (currently 50MB)
<span class="lineNum">    3765 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 83 times"> + </span>]:<span class="lineCov">         83 :     if (nFreeBytesAvailable &lt; nMinDiskSpace + nAdditionalBytes)</span>
<span class="lineNum">    3766 </span>[<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>][<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]:<span class="lineCov">         83 :         return AbortNode(&quot;Disk space is low!&quot;, _(&quot;Error: Disk space is low!&quot;));</span>
<span class="lineNum">    3767 </span>                :            : 
<span class="lineNum">    3768 </span>                :            :     return true;
<span class="lineNum">    3769 </span>                :            : }
<span class="lineNum">    3770 </span>                :            : 
<span class="lineNum">    3771 </span>                :<span class="lineCov">       3274 : static FILE* OpenDiskFile(const CDiskBlockPos &amp;pos, const char *prefix, bool fReadOnly)</span>
<span class="lineNum">    3772 </span>                :            : {
<span class="lineNum">    3773 </span>        [<span class="branchCov" title="Branch 0 was taken 3170 times"> + </span><span class="branchCov" title="Branch 1 was taken 104 times"> + </span>]:<span class="lineCov">       3274 :     if (pos.IsNull())</span>
<span class="lineNum">    3774 </span>                :            :         return nullptr;
<span class="lineNum">    3775 </span>                :<span class="lineCov">       3170 :     fs::path path = GetBlockPosFilename(pos, prefix);</span>
<span class="lineNum">    3776 </span>        [<span class="branchCov" title="Branch 1 was taken 3170 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       3170 :     fs::create_directories(path.parent_path());</span>
<span class="lineNum">    3777 </span>[<span class="branchCov" title="Branch 0 was taken 2727 times"> + </span><span class="branchCov" title="Branch 1 was taken 443 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 3170 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       3170 :     FILE* file = fsbridge::fopen(path, fReadOnly ? &quot;rb&quot;: &quot;rb+&quot;);</span>
<span class="lineNum">    3778 </span>        [<span class="branchCov" title="Branch 0 was taken 83 times"> + </span><span class="branchCov" title="Branch 1 was taken 3087 times"> + </span>]:<span class="lineCov">       3170 :     if (!file &amp;&amp; !fReadOnly)</span>
<span class="lineNum">    3779 </span>        [<span class="branchCov" title="Branch 1 was taken 83 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         83 :         file = fsbridge::fopen(path, &quot;wb+&quot;);</span>
<span class="lineNum">    3780 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3170 times"> + </span>]:<span class="lineCov">       3170 :     if (!file) {</span>
<span class="lineNum">    3781 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LogPrintf(&quot;Unable to open file %s\n&quot;, path.string());</span>
<span class="lineNum">    3782 </span>                :            :         return nullptr;
<span class="lineNum">    3783 </span>                :            :     }
<span class="lineNum">    3784 </span>        [<span class="branchCov" title="Branch 0 was taken 3000 times"> + </span><span class="branchCov" title="Branch 1 was taken 170 times"> + </span>]:<span class="lineCov">       3170 :     if (pos.nPos) {</span>
<span class="lineNum">    3785 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 3000 times"> + </span>]:<span class="lineCov">       3000 :         if (fseek(file, pos.nPos, SEEK_SET)) {</span>
<span class="lineNum">    3786 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             LogPrintf(&quot;Unable to seek to position %u of %s\n&quot;, pos.nPos, path.string());</span>
<span class="lineNum">    3787 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             fclose(file);</span>
<span class="lineNum">    3788 </span>                :            :             return nullptr;
<span class="lineNum">    3789 </span>                :            :         }
<span class="lineNum">    3790 </span>                :            :     }
<span class="lineNum">    3791 </span>                :            :     return file;
<a name="3792"><span class="lineNum">    3792 </span>                :            : }</a>
<span class="lineNum">    3793 </span>                :            : 
<span class="lineNum">    3794 </span>                :<span class="lineCov">       1979 : FILE* OpenBlockFile(const CDiskBlockPos &amp;pos, bool fReadOnly) {</span>
<span class="lineNum">    3795 </span>                :<span class="lineCov">       1979 :     return OpenDiskFile(pos, &quot;blk&quot;, fReadOnly);</span>
<span class="lineNum">    3796 </span>                :            : }
<a name="3797"><span class="lineNum">    3797 </span>                :            : </a>
<span class="lineNum">    3798 </span>                :            : /** Open an undo file (rev?????.dat) */
<span class="lineNum">    3799 </span>                :<span class="lineCov">       1295 : static FILE* OpenUndoFile(const CDiskBlockPos &amp;pos, bool fReadOnly) {</span>
<span class="lineNum">    3800 </span>                :<span class="lineCov">       1295 :     return OpenDiskFile(pos, &quot;rev&quot;, fReadOnly);</span>
<span class="lineNum">    3801 </span>                :            : }
<span class="lineNum">    3802 </span>                :            : 
<span class="lineNum">    3803 </span>                :<span class="lineCov">       3176 : fs::path GetBlockPosFilename(const CDiskBlockPos &amp;pos, const char *prefix)</span>
<span class="lineNum">    3804 </span>                :            : {
<span class="lineNum">    3805 </span>[<span class="branchCov" title="Branch 2 was taken 3176 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>][<span class="branchCov" title="Branch 5 was taken 3176 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]:<span class="lineCov">       9528 :     return GetBlocksDir() / strprintf(&quot;%s%05u.dat&quot;, prefix, pos.nFile);</span>
<a name="3806"><span class="lineNum">    3806 </span>                :            : }</a>
<span class="lineNum">    3807 </span>                :            : 
<span class="lineNum">    3808 </span>                :<span class="lineNoCov">          0 : CBlockIndex * CChainState::InsertBlockIndex(const uint256&amp; hash)</span>
<span class="lineNum">    3809 </span>                :            : {
<span class="lineNum">    3810 </span>                :<span class="lineNoCov">          0 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    3811 </span>                :            : 
<span class="lineNum">    3812 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (hash.IsNull())</span>
<span class="lineNum">    3813 </span>                :            :         return nullptr;
<span class="lineNum">    3814 </span>                :            : 
<span class="lineNum">    3815 </span>                :            :     // Return existing
<span class="lineNum">    3816 </span>                :<span class="lineNoCov">          0 :     BlockMap::iterator mi = mapBlockIndex.find(hash);</span>
<span class="lineNum">    3817 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (mi != mapBlockIndex.end())</span>
<span class="lineNum">    3818 </span>                :<span class="lineNoCov">          0 :         return (*mi).second;</span>
<span class="lineNum">    3819 </span>                :            : 
<span class="lineNum">    3820 </span>                :            :     // Create new
<span class="lineNum">    3821 </span>                :<span class="lineNoCov">          0 :     CBlockIndex* pindexNew = new CBlockIndex();</span>
<span class="lineNum">    3822 </span>                :<span class="lineNoCov">          0 :     mi = mapBlockIndex.insert(std::make_pair(hash, pindexNew)).first;</span>
<span class="lineNum">    3823 </span>                :<span class="lineNoCov">          0 :     pindexNew-&gt;phashBlock = &amp;((*mi).first);</span>
<span class="lineNum">    3824 </span>                :            : 
<span class="lineNum">    3825 </span>                :<span class="lineNoCov">          0 :     return pindexNew;</span>
<span class="lineNum">    3826 </span>                :            : }
<span class="lineNum">    3827 </span>                :            : 
<span class="lineNum">    3828 </span>                :<span class="lineNoCov">          0 : bool CChainState::LoadBlockIndex(const Consensus::Params&amp; consensus_params, CBlockTreeDB&amp; blocktree)</span>
<span class="lineNum">    3829 </span>                :            : {
<span class="lineNum">    3830 </span>[<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>][<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!blocktree.LoadBlockIndexGuts(consensus_params, [this](const uint256&amp; hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return this-&gt;InsertBlockIndex(hash); }))</span>
<span class="lineNum">    3831 </span>                :            :         return false;
<span class="lineNum">    3832 </span>                :            : 
<span class="lineNum">    3833 </span>                :            :     // Calculate nChainWork
<span class="lineNum">    3834 </span>                :<span class="lineNoCov">          0 :     std::vector&lt;std::pair&lt;int, CBlockIndex*&gt; &gt; vSortedByHeight;</span>
<span class="lineNum">    3835 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     vSortedByHeight.reserve(mapBlockIndex.size());</span>
<span class="lineNum">    3836 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (const std::pair&lt;const uint256, CBlockIndex*&gt;&amp; item : mapBlockIndex)</span>
<span class="lineNum">    3837 </span>                :            :     {
<span class="lineNum">    3838 </span>                :<span class="lineNoCov">          0 :         CBlockIndex* pindex = item.second;</span>
<span class="lineNum">    3839 </span>                :<span class="lineNoCov">          0 :         vSortedByHeight.push_back(std::make_pair(pindex-&gt;nHeight, pindex));</span>
<span class="lineNum">    3840 </span>                :            :     }
<span class="lineNum">    3841 </span>                :<span class="lineNoCov">          0 :     sort(vSortedByHeight.begin(), vSortedByHeight.end());</span>
<span class="lineNum">    3842 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (const std::pair&lt;int, CBlockIndex*&gt;&amp; item : vSortedByHeight)</span>
<span class="lineNum">    3843 </span>                :            :     {
<span class="lineNum">    3844 </span>                :<span class="lineNoCov">          0 :         CBlockIndex* pindex = item.second;</span>
<span class="lineNum">    3845 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         pindex-&gt;nChainWork = (pindex-&gt;pprev ? pindex-&gt;pprev-&gt;nChainWork : 0) + GetBlockProof(*pindex);</span>
<span class="lineNum">    3846 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         pindex-&gt;nTimeMax = (pindex-&gt;pprev ? std::max(pindex-&gt;pprev-&gt;nTimeMax, pindex-&gt;nTime) : pindex-&gt;nTime);</span>
<span class="lineNum">    3847 </span>                :            :         // We can link the chain of blocks for which we've received transactions at some point.
<span class="lineNum">    3848 </span>                :            :         // Pruned nodes may have deleted the block.
<span class="lineNum">    3849 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex-&gt;nTx &gt; 0) {</span>
<span class="lineNum">    3850 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (pindex-&gt;pprev) {</span>
<span class="lineNum">    3851 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (pindex-&gt;pprev-&gt;HaveTxsDownloaded()) {</span>
<span class="lineNum">    3852 </span>                :<span class="lineNoCov">          0 :                     pindex-&gt;nChainTx = pindex-&gt;pprev-&gt;nChainTx + pindex-&gt;nTx;</span>
<span class="lineNum">    3853 </span>                :            :                 } else {
<span class="lineNum">    3854 </span>                :<span class="lineNoCov">          0 :                     pindex-&gt;nChainTx = 0;</span>
<span class="lineNum">    3855 </span>                :<span class="lineNoCov">          0 :                     mapBlocksUnlinked.insert(std::make_pair(pindex-&gt;pprev, pindex));</span>
<span class="lineNum">    3856 </span>                :            :                 }
<span class="lineNum">    3857 </span>                :            :             } else {
<span class="lineNum">    3858 </span>                :<span class="lineNoCov">          0 :                 pindex-&gt;nChainTx = pindex-&gt;nTx;</span>
<span class="lineNum">    3859 </span>                :            :             }
<span class="lineNum">    3860 </span>                :            :         }
<span class="lineNum">    3861 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!(pindex-&gt;nStatus &amp; BLOCK_FAILED_MASK) &amp;&amp; pindex-&gt;pprev &amp;&amp; (pindex-&gt;pprev-&gt;nStatus &amp; BLOCK_FAILED_MASK)) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    3862 </span>                :<span class="lineNoCov">          0 :             pindex-&gt;nStatus |= BLOCK_FAILED_CHILD;</span>
<span class="lineNum">    3863 </span>                :            :             setDirtyBlockIndex.insert(pindex);
<span class="lineNum">    3864 </span>                :            :         }
<span class="lineNum">    3865 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex-&gt;IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp; (pindex-&gt;HaveTxsDownloaded() || pindex-&gt;pprev == nullptr))</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    3866 </span>                :<span class="lineNoCov">          0 :             setBlockIndexCandidates.insert(pindex);</span>
<span class="lineNum">    3867 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex-&gt;nStatus &amp; BLOCK_FAILED_MASK &amp;&amp; (!pindexBestInvalid || pindex-&gt;nChainWork &gt; pindexBestInvalid-&gt;nChainWork))</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    3868 </span>                :<span class="lineNoCov">          0 :             pindexBestInvalid = pindex;</span>
<span class="lineNum">    3869 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex-&gt;pprev)</span>
<span class="lineNum">    3870 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             pindex-&gt;BuildSkip();</span>
<span class="lineNum">    3871 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex-&gt;IsValid(BLOCK_VALID_TREE) &amp;&amp; (pindexBestHeader == nullptr || CBlockIndexWorkComparator()(pindexBestHeader, pindex)))</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    3872 </span>                :<span class="lineNoCov">          0 :             pindexBestHeader = pindex;</span>
<span class="lineNum">    3873 </span>                :            :     }
<span class="lineNum">    3874 </span>                :            : 
<span class="lineNum">    3875 </span>                :<span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">    3876 </span>                :            : }
<span class="lineNum">    3877 </span>                :            : 
<span class="lineNum">    3878 </span>                :<span class="lineNoCov">          0 : bool static LoadBlockIndexDB(const CChainParams&amp; chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</span>
<span class="lineNum">    3879 </span>                :            : {
<span class="lineNum">    3880 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!g_chainstate.LoadBlockIndex(chainparams.GetConsensus(), *pblocktree))</span>
<span class="lineNum">    3881 </span>                :            :         return false;
<span class="lineNum">    3882 </span>                :            : 
<span class="lineNum">    3883 </span>                :            :     // Load block file info
<span class="lineNum">    3884 </span>                :<span class="lineNoCov">          0 :     pblocktree-&gt;ReadLastBlockFile(nLastBlockFile);</span>
<span class="lineNum">    3885 </span>                :<span class="lineNoCov">          0 :     vinfoBlockFile.resize(nLastBlockFile + 1);</span>
<span class="lineNum">    3886 </span>                :<span class="lineNoCov">          0 :     LogPrintf(&quot;%s: last block file = %i\n&quot;, __func__, nLastBlockFile);</span>
<span class="lineNum">    3887 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (int nFile = 0; nFile &lt;= nLastBlockFile; nFile++) {</span>
<span class="lineNum">    3888 </span>                :<span class="lineNoCov">          0 :         pblocktree-&gt;ReadBlockFileInfo(nFile, vinfoBlockFile[nFile]);</span>
<span class="lineNum">    3889 </span>                :            :     }
<span class="lineNum">    3890 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LogPrintf(&quot;%s: last block file info: %s\n&quot;, __func__, vinfoBlockFile[nLastBlockFile].ToString());</span>
<span class="lineNum">    3891 </span>                :<span class="lineNoCov">          0 :     for (int nFile = nLastBlockFile + 1; true; nFile++) {</span>
<span class="lineNum">    3892 </span>                :<span class="lineNoCov">          0 :         CBlockFileInfo info;</span>
<span class="lineNum">    3893 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pblocktree-&gt;ReadBlockFileInfo(nFile, info)) {</span>
<span class="lineNum">    3894 </span>                :<span class="lineNoCov">          0 :             vinfoBlockFile.push_back(info);</span>
<span class="lineNum">    3895 </span>                :            :         } else {
<span class="lineNum">    3896 </span>                :            :             break;
<span class="lineNum">    3897 </span>                :            :         }
<span class="lineNum">    3898 </span>                :<span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    3899 </span>                :            : 
<span class="lineNum">    3900 </span>                :            :     // Check presence of blk files
<span class="lineNum">    3901 </span>                :<span class="lineNoCov">          0 :     LogPrintf(&quot;Checking all blk files are present...\n&quot;);</span>
<span class="lineNum">    3902 </span>                :<span class="lineNoCov">          0 :     std::set&lt;int&gt; setBlkDataFiles;</span>
<span class="lineNum">    3903 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (const std::pair&lt;const uint256, CBlockIndex*&gt;&amp; item : mapBlockIndex)</span>
<span class="lineNum">    3904 </span>                :            :     {
<span class="lineNum">    3905 </span>                :<span class="lineNoCov">          0 :         CBlockIndex* pindex = item.second;</span>
<span class="lineNum">    3906 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA) {</span>
<span class="lineNum">    3907 </span>                :<span class="lineNoCov">          0 :             setBlkDataFiles.insert(pindex-&gt;nFile);</span>
<span class="lineNum">    3908 </span>                :            :         }
<span class="lineNum">    3909 </span>                :            :     }
<span class="lineNum">    3910 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (std::set&lt;int&gt;::iterator it = setBlkDataFiles.begin(); it != setBlkDataFiles.end(); it++)</span>
<span class="lineNum">    3911 </span>                :            :     {
<span class="lineNum">    3912 </span>                :<span class="lineNoCov">          0 :         CDiskBlockPos pos(*it, 0);</span>
<span class="lineNum">    3913 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (CAutoFile(OpenBlockFile(pos, true), SER_DISK, CLIENT_VERSION).IsNull()) {</span>
<span class="lineNum">    3914 </span>                :<span class="lineNoCov">          0 :             return false;</span>
<span class="lineNum">    3915 </span>                :            :         }
<span class="lineNum">    3916 </span>                :            :     }
<span class="lineNum">    3917 </span>                :            : 
<span class="lineNum">    3918 </span>                :            :     // Check whether we have ever pruned block &amp; undo files
<span class="lineNum">    3919 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :     pblocktree-&gt;ReadFlag(&quot;prunedblockfiles&quot;, fHavePruned);</span>
<span class="lineNum">    3920 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (fHavePruned)</span>
<span class="lineNum">    3921 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LogPrintf(&quot;LoadBlockIndexDB(): Block files have previously been pruned\n&quot;);</span>
<span class="lineNum">    3922 </span>                :            : 
<span class="lineNum">    3923 </span>                :            :     // Check whether we need to continue reindexing
<span class="lineNum">    3924 </span>                :<span class="lineNoCov">          0 :     bool fReindexing = false;</span>
<span class="lineNum">    3925 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     pblocktree-&gt;ReadReindexing(fReindexing);</span>
<span class="lineNum">    3926 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(fReindexing) fReindex = true;</span>
<span class="lineNum">    3927 </span>                :            : 
<span class="lineNum">    3928 </span>                :            :     return true;
<span class="lineNum">    3929 </span>                :            : }
<span class="lineNum">    3930 </span>                :            : 
<span class="lineNum">    3931 </span>                :<span class="lineNoCov">          0 : bool LoadChainTip(const CChainParams&amp; chainparams)</span>
<span class="lineNum">    3932 </span>                :            : {
<span class="lineNum">    3933 </span>                :<span class="lineNoCov">          0 :     AssertLockHeld(cs_main);</span>
<span class="lineNum">    3934 </span>                :            : 
<span class="lineNum">    3935 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (chainActive.Tip() &amp;&amp; chainActive.Tip()-&gt;GetBlockHash() == pcoinsTip-&gt;GetBestBlock()) return true;</span>
<span class="lineNum">    3936 </span>                :            : 
<span class="lineNum">    3937 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (pcoinsTip-&gt;GetBestBlock().IsNull() &amp;&amp; mapBlockIndex.size() == 1) {</span>
<span class="lineNum">    3938 </span>                :            :         // In case we just added the genesis block, connect it now, so
<span class="lineNum">    3939 </span>                :            :         // that we always have a chainActive.Tip() when we return.
<span class="lineNum">    3940 </span>                :<span class="lineNoCov">          0 :         LogPrintf(&quot;%s: Connecting genesis block...\n&quot;, __func__);</span>
<span class="lineNum">    3941 </span>                :<span class="lineNoCov">          0 :         CValidationState state;</span>
<span class="lineNum">    3942 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!ActivateBestChain(state, chainparams)) {</span>
<span class="lineNum">    3943 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             LogPrintf(&quot;%s: failed to activate chain (%s)\n&quot;, __func__, FormatStateMessage(state));</span>
<span class="lineNum">    3944 </span>                :<span class="lineNoCov">          0 :             return false;</span>
<span class="lineNum">    3945 </span>                :            :         }
<span class="lineNum">    3946 </span>                :            :     }
<span class="lineNum">    3947 </span>                :            : 
<span class="lineNum">    3948 </span>                :            :     // Load pointer to end of best chain
<span class="lineNum">    3949 </span>                :<span class="lineNoCov">          0 :     CBlockIndex* pindex = LookupBlockIndex(pcoinsTip-&gt;GetBestBlock());</span>
<span class="lineNum">    3950 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!pindex) {</span>
<span class="lineNum">    3951 </span>                :            :         return false;
<span class="lineNum">    3952 </span>                :            :     }
<span class="lineNum">    3953 </span>                :<span class="lineNoCov">          0 :     chainActive.SetTip(pindex);</span>
<span class="lineNum">    3954 </span>                :            : 
<span class="lineNum">    3955 </span>                :<span class="lineNoCov">          0 :     g_chainstate.PruneBlockIndexCandidates();</span>
<span class="lineNum">    3956 </span>                :            : 
<span class="lineNum">    3957 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LogPrintf(&quot;Loaded best chain: hashBestChain=%s height=%d date=%s progress=%f\n&quot;,</span>
<span class="lineNum">    3958 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         chainActive.Tip()-&gt;GetBlockHash().ToString(), chainActive.Height(),</span>
<span class="lineNum">    3959 </span>                :<span class="lineNoCov">          0 :         FormatISO8601DateTime(chainActive.Tip()-&gt;GetBlockTime()),</span>
<span class="lineNum">    3960 </span>                :<span class="lineNoCov">          0 :         GuessVerificationProgress(chainparams.TxData(), chainActive.Tip()));</span>
<span class="lineNum">    3961 </span>                :<span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">    3962 </span>                :            : }
<span class="lineNum">    3963 </span>                :            : 
<span class="lineNum">    3964 </span>                :<span class="lineNoCov">          0 : CVerifyDB::CVerifyDB()</span>
<span class="lineNum">    3965 </span>                :            : {
<span class="lineNum">    3966 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     uiInterface.ShowProgress(_(&quot;Verifying blocks...&quot;), 0, false);</span>
<span class="lineNum">    3967 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3968 </span>                :            : 
<span class="lineNum">    3969 </span>                :<span class="lineNoCov">          0 : CVerifyDB::~CVerifyDB()</span>
<span class="lineNum">    3970 </span>                :            : {
<span class="lineNum">    3971 </span>                :<span class="lineNoCov">          0 :     uiInterface.ShowProgress(&quot;&quot;, 100, false);</span>
<span class="lineNum">    3972 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3973 </span>                :            : 
<span class="lineNum">    3974 </span>                :<span class="lineNoCov">          0 : bool CVerifyDB::VerifyDB(const CChainParams&amp; chainparams, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)</span>
<span class="lineNum">    3975 </span>                :            : {
<span class="lineNum">    3976 </span>                :<span class="lineNoCov">          0 :     LOCK(cs_main);</span>
<span class="lineNum">    3977 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (chainActive.Tip() == nullptr || chainActive.Tip()-&gt;pprev == nullptr)</span>
<span class="lineNum">    3978 </span>                :            :         return true;
<span class="lineNum">    3979 </span>                :            : 
<span class="lineNum">    3980 </span>                :            :     // Verify blocks in the best chain
<span class="lineNum">    3981 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (nCheckDepth &lt;= 0 || nCheckDepth &gt; chainActive.Height())</span>
<span class="lineNum">    3982 </span>                :<span class="lineNoCov">          0 :         nCheckDepth = chainActive.Height();</span>
<span class="lineNum">    3983 </span>                :<span class="lineNoCov">          0 :     nCheckLevel = std::max(0, std::min(4, nCheckLevel));</span>
<span class="lineNum">    3984 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LogPrintf(&quot;Verifying last %i blocks at level %i\n&quot;, nCheckDepth, nCheckLevel);</span>
<span class="lineNum">    3985 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     CCoinsViewCache coins(coinsview);</span>
<span class="lineNum">    3986 </span>                :            :     CBlockIndex* pindex;
<span class="lineNum">    3987 </span>                :<span class="lineNoCov">          0 :     CBlockIndex* pindexFailure = nullptr;</span>
<span class="lineNum">    3988 </span>                :<span class="lineNoCov">          0 :     int nGoodTransactions = 0;</span>
<span class="lineNum">    3989 </span>                :<span class="lineNoCov">          0 :     CValidationState state;</span>
<span class="lineNum">    3990 </span>                :<span class="lineNoCov">          0 :     int reportDone = 0;</span>
<span class="lineNum">    3991 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LogPrintf(&quot;[0%%]...&quot;); /* Continued */</span>
<span class="lineNum">    3992 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (pindex = chainActive.Tip(); pindex &amp;&amp; pindex-&gt;pprev; pindex = pindex-&gt;pprev) {</span>
<span class="lineNum">    3993 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         boost::this_thread::interruption_point();</span>
<span class="lineNum">    3994 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         const int percentageDone = std::max(1, std::min(99, (int)(((double)(chainActive.Height() - pindex-&gt;nHeight)) / (double)nCheckDepth * (nCheckLevel &gt;= 4 ? 50 : 100))));</span>
<span class="lineNum">    3995 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (reportDone &lt; percentageDone/10) {</span>
<span class="lineNum">    3996 </span>                :            :             // report every 10% step
<span class="lineNum">    3997 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             LogPrintf(&quot;[%d%%]...&quot;, percentageDone); /* Continued */</span>
<span class="lineNum">    3998 </span>                :<span class="lineNoCov">          0 :             reportDone = percentageDone/10;</span>
<span class="lineNum">    3999 </span>                :            :         }
<span class="lineNum">    4000 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         uiInterface.ShowProgress(_(&quot;Verifying blocks...&quot;), percentageDone, false);</span>
<span class="lineNum">    4001 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindex-&gt;nHeight &lt;= chainActive.Height()-nCheckDepth)</span>
<span class="lineNum">    4002 </span>                :            :             break;
<span class="lineNum">    4003 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (fPruneMode &amp;&amp; !(pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA)) {</span>
<span class="lineNum">    4004 </span>                :            :             // If pruning, only go back as far as we have data.
<span class="lineNum">    4005 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             LogPrintf(&quot;VerifyDB(): block verification stopping at height %d (pruning, no data)\n&quot;, pindex-&gt;nHeight);</span>
<span class="lineNum">    4006 </span>                :            :             break;
<span class="lineNum">    4007 </span>                :            :         }
<span class="lineNum">    4008 </span>                :<span class="lineNoCov">          0 :         CBlock block;</span>
<span class="lineNum">    4009 </span>                :            :         // check level 0: read from disk
<span class="lineNum">    4010 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!ReadBlockFromDisk(block, pindex, chainparams.GetConsensus()))</span>
<span class="lineNum">    4011 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return error(&quot;VerifyDB(): *** ReadBlockFromDisk failed at %d, hash=%s&quot;, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString());</span>
<span class="lineNum">    4012 </span>                :            :         // check level 1: verify block validity
<span class="lineNum">    4013 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (nCheckLevel &gt;= 1 &amp;&amp; !CheckBlock(block, state, chainparams.GetConsensus()))</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">    4014 </span>                :<span class="lineNoCov">          0 :             return error(&quot;%s: *** found bad block at %d, hash=%s (%s)\n&quot;, __func__,</span>
<span class="lineNum">    4015 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                          pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString(), FormatStateMessage(state));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    4016 </span>                :            :         // check level 2: verify undo validity
<span class="lineNum">    4017 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (nCheckLevel &gt;= 2 &amp;&amp; pindex) {</span>
<span class="lineNum">    4018 </span>                :<span class="lineNoCov">          0 :             CBlockUndo undo;</span>
<span class="lineNum">    4019 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!pindex-&gt;GetUndoPos().IsNull()) {</span>
<span class="lineNum">    4020 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (!UndoReadFromDisk(undo, pindex)) {</span>
<span class="lineNum">    4021 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     return error(&quot;VerifyDB(): *** found bad undo data at %d, hash=%s\n&quot;, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString());</span>
<span class="lineNum">    4022 </span>                :            :                 }
<span class="lineNum">    4023 </span>                :            :             }
<span class="lineNum">    4024 </span>                :            :         }
<span class="lineNum">    4025 </span>                :            :         // check level 3: check for inconsistencies during memory-only disconnect of tip blocks
<span class="lineNum">    4026 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (nCheckLevel &gt;= 3 &amp;&amp; (coins.DynamicMemoryUsage() + pcoinsTip-&gt;DynamicMemoryUsage()) &lt;= nCoinCacheUsage) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">    4027 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             assert(coins.GetBestBlock() == pindex-&gt;GetBlockHash());</span>
<span class="lineNum">    4028 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             DisconnectResult res = g_chainstate.DisconnectBlock(block, pindex, coins);</span>
<span class="lineNum">    4029 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (res == DISCONNECT_FAILED) {</span>
<span class="lineNum">    4030 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return error(&quot;VerifyDB(): *** irrecoverable inconsistency in block data at %d, hash=%s&quot;, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString());</span>
<span class="lineNum">    4031 </span>                :            :             }
<span class="lineNum">    4032 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (res == DISCONNECT_UNCLEAN) {</span>
<span class="lineNum">    4033 </span>                :<span class="lineNoCov">          0 :                 nGoodTransactions = 0;</span>
<span class="lineNum">    4034 </span>                :<span class="lineNoCov">          0 :                 pindexFailure = pindex;</span>
<span class="lineNum">    4035 </span>                :            :             } else {
<span class="lineNum">    4036 </span>                :<span class="lineNoCov">          0 :                 nGoodTransactions += block.vtx.size();</span>
<span class="lineNum">    4037 </span>                :            :             }
<span class="lineNum">    4038 </span>                :            :         }
<span class="lineNum">    4039 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ShutdownRequested())</span>
<span class="lineNum">    4040 </span>                :            :             return true;
<span class="lineNum">    4041 </span>                :            :     }
<span class="lineNum">    4042 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (pindexFailure)</span>
<span class="lineNum">    4043 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;VerifyDB(): *** coin database inconsistencies found (last %i blocks, %i good transactions before that)\n&quot;, chainActive.Height() - pindexFailure-&gt;nHeight + 1, nGoodTransactions);</span>
<span class="lineNum">    4044 </span>                :            : 
<span class="lineNum">    4045 </span>                :            :     // store block count as we move pindex at check level &gt;= 4
<span class="lineNum">    4046 </span>                :<span class="lineNoCov">          0 :     int block_count = chainActive.Height() - pindex-&gt;nHeight;</span>
<span class="lineNum">    4047 </span>                :            : 
<span class="lineNum">    4048 </span>                :            :     // check level 4: try reconnecting blocks
<span class="lineNum">    4049 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (nCheckLevel &gt;= 4) {</span>
<span class="lineNum">    4050 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while (pindex != chainActive.Tip()) {</span>
<span class="lineNum">    4051 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             boost::this_thread::interruption_point();</span>
<span class="lineNum">    4052 </span>                :<span class="lineNoCov">          0 :             const int percentageDone = std::max(1, std::min(99, 100 - (int)(((double)(chainActive.Height() - pindex-&gt;nHeight)) / (double)nCheckDepth * 50)));</span>
<span class="lineNum">    4053 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (reportDone &lt; percentageDone/10) {</span>
<span class="lineNum">    4054 </span>                :            :                 // report every 10% step
<span class="lineNum">    4055 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 LogPrintf(&quot;[%d%%]...&quot;, percentageDone); /* Continued */</span>
<span class="lineNum">    4056 </span>                :<span class="lineNoCov">          0 :                 reportDone = percentageDone/10;</span>
<span class="lineNum">    4057 </span>                :            :             }
<span class="lineNum">    4058 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             uiInterface.ShowProgress(_(&quot;Verifying blocks...&quot;), percentageDone, false);</span>
<span class="lineNum">    4059 </span>                :<span class="lineNoCov">          0 :             pindex = chainActive.Next(pindex);</span>
<span class="lineNum">    4060 </span>                :<span class="lineNoCov">          0 :             CBlock block;</span>
<span class="lineNum">    4061 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!ReadBlockFromDisk(block, pindex, chainparams.GetConsensus()))</span>
<span class="lineNum">    4062 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return error(&quot;VerifyDB(): *** ReadBlockFromDisk failed at %d, hash=%s&quot;, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString());</span>
<span class="lineNum">    4063 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!g_chainstate.ConnectBlock(block, state, pindex, coins, chainparams))</span>
<span class="lineNum">    4064 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return error(&quot;VerifyDB(): *** found unconnectable block at %d, hash=%s (%s)&quot;, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString(), FormatStateMessage(state));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    4065 </span>                :            :         }
<span class="lineNum">    4066 </span>                :            :     }
<span class="lineNum">    4067 </span>                :            : 
<span class="lineNum">    4068 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LogPrintf(&quot;[DONE].\n&quot;);</span>
<span class="lineNum">    4069 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LogPrintf(&quot;No coin database inconsistencies in last %i blocks (%i transactions)\n&quot;, block_count, nGoodTransactions);</span>
<span class="lineNum">    4070 </span>                :            : 
<span class="lineNum">    4071 </span>                :            :     return true;
<span class="lineNum">    4072 </span>                :            : }
<span class="lineNum">    4073 </span>                :            : 
<span class="lineNum">    4074 </span>                :            : /** Apply the effects of a block on the utxo cache, ignoring that it may already have been applied. */
<span class="lineNum">    4075 </span>                :<span class="lineNoCov">          0 : bool CChainState::RollforwardBlock(const CBlockIndex* pindex, CCoinsViewCache&amp; inputs, const CChainParams&amp; params)</span>
<span class="lineNum">    4076 </span>                :            : {
<span class="lineNum">    4077 </span>                :            :     // TODO: merge with ConnectBlock
<span class="lineNum">    4078 </span>                :<span class="lineNoCov">          0 :     CBlock block;</span>
<span class="lineNum">    4079 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!ReadBlockFromDisk(block, pindex, params.GetConsensus())) {</span>
<span class="lineNum">    4080 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;ReplayBlock(): ReadBlockFromDisk failed at %d, hash=%s&quot;, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString());</span>
<span class="lineNum">    4081 </span>                :            :     }
<span class="lineNum">    4082 </span>                :            : 
<span class="lineNum">    4083 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (const CTransactionRef&amp; tx : block.vtx) {</span>
<span class="lineNum">    4084 </span>                :<span class="lineNoCov">          0 :         if (!tx-&gt;IsCoinBase()) {</span>
<span class="lineNum">    4085 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             for (const CTxIn &amp;txin : tx-&gt;vin) {</span>
<span class="lineNum">    4086 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 inputs.SpendCoin(txin.prevout);</span>
<span class="lineNum">    4087 </span>                :            :             }
<span class="lineNum">    4088 </span>                :            :         }
<span class="lineNum">    4089 </span>                :            :         // Pass check = true as every addition may be an overwrite.
<span class="lineNum">    4090 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         AddCoins(inputs, *tx, pindex-&gt;nHeight, true);</span>
<span class="lineNum">    4091 </span>                :            :     }
<span class="lineNum">    4092 </span>                :<span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">    4093 </span>                :            : }
<span class="lineNum">    4094 </span>                :            : 
<span class="lineNum">    4095 </span>                :<span class="lineNoCov">          0 : bool CChainState::ReplayBlocks(const CChainParams&amp; params, CCoinsView* view)</span>
<span class="lineNum">    4096 </span>                :            : {
<span class="lineNum">    4097 </span>                :<span class="lineNoCov">          0 :     LOCK(cs_main);</span>
<span class="lineNum">    4098 </span>                :            : 
<span class="lineNum">    4099 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     CCoinsViewCache cache(view);</span>
<span class="lineNum">    4100 </span>                :            : 
<span class="lineNum">    4101 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     std::vector&lt;uint256&gt; hashHeads = view-&gt;GetHeadBlocks();</span>
<span class="lineNum">    4102 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (hashHeads.empty()) return true; // We're already in a consistent state.</span>
<span class="lineNum">    4103 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (hashHeads.size() != 2) return error(&quot;ReplayBlocks(): unknown inconsistent state&quot;);</span>
<span class="lineNum">    4104 </span>                :            : 
<span class="lineNum">    4105 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :     uiInterface.ShowProgress(_(&quot;Replaying blocks...&quot;), 0, false);</span>
<span class="lineNum">    4106 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LogPrintf(&quot;Replaying blocks\n&quot;);</span>
<span class="lineNum">    4107 </span>                :            : 
<span class="lineNum">    4108 </span>                :<span class="lineNoCov">          0 :     const CBlockIndex* pindexOld = nullptr;  // Old tip during the interrupted flush.</span>
<span class="lineNum">    4109 </span>                :            :     const CBlockIndex* pindexNew;            // New tip during the interrupted flush.
<span class="lineNum">    4110 </span>                :<span class="lineNoCov">          0 :     const CBlockIndex* pindexFork = nullptr; // Latest block common to both the old and the new tip.</span>
<span class="lineNum">    4111 </span>                :            : 
<span class="lineNum">    4112 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (mapBlockIndex.count(hashHeads[0]) == 0) {</span>
<span class="lineNum">    4113 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;ReplayBlocks(): reorganization to unknown block requested&quot;);</span>
<span class="lineNum">    4114 </span>                :            :     }
<span class="lineNum">    4115 </span>                :<span class="lineNoCov">          0 :     pindexNew = mapBlockIndex[hashHeads[0]];</span>
<span class="lineNum">    4116 </span>                :            : 
<span class="lineNum">    4117 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!hashHeads[1].IsNull()) { // The old tip is allowed to be 0, indicating it's the first flush.</span>
<span class="lineNum">    4118 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (mapBlockIndex.count(hashHeads[1]) == 0) {</span>
<span class="lineNum">    4119 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return error(&quot;ReplayBlocks(): reorganization from unknown block requested&quot;);</span>
<span class="lineNum">    4120 </span>                :            :         }
<span class="lineNum">    4121 </span>                :<span class="lineNoCov">          0 :         pindexOld = mapBlockIndex[hashHeads[1]];</span>
<span class="lineNum">    4122 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         pindexFork = LastCommonAncestor(pindexOld, pindexNew);</span>
<span class="lineNum">    4123 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         assert(pindexFork != nullptr);</span>
<span class="lineNum">    4124 </span>                :            :     }
<span class="lineNum">    4125 </span>                :            : 
<span class="lineNum">    4126 </span>                :            :     // Rollback along the old branch.
<span class="lineNum">    4127 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while (pindexOld != pindexFork) {</span>
<span class="lineNum">    4128 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pindexOld-&gt;nHeight &gt; 0) { // Never disconnect the genesis block.</span>
<span class="lineNum">    4129 </span>                :<span class="lineNoCov">          0 :             CBlock block;</span>
<span class="lineNum">    4130 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!ReadBlockFromDisk(block, pindexOld, params.GetConsensus())) {</span>
<span class="lineNum">    4131 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return error(&quot;RollbackBlock(): ReadBlockFromDisk() failed at %d, hash=%s&quot;, pindexOld-&gt;nHeight, pindexOld-&gt;GetBlockHash().ToString());</span>
<span class="lineNum">    4132 </span>                :            :             }
<span class="lineNum">    4133 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             LogPrintf(&quot;Rolling back %s (%i)\n&quot;, pindexOld-&gt;GetBlockHash().ToString(), pindexOld-&gt;nHeight);</span>
<span class="lineNum">    4134 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             DisconnectResult res = DisconnectBlock(block, pindexOld, cache);</span>
<span class="lineNum">    4135 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (res == DISCONNECT_FAILED) {</span>
<span class="lineNum">    4136 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return error(&quot;RollbackBlock(): DisconnectBlock failed at %d, hash=%s&quot;, pindexOld-&gt;nHeight, pindexOld-&gt;GetBlockHash().ToString());</span>
<span class="lineNum">    4137 </span>                :            :             }
<span class="lineNum">    4138 </span>                :            :             // If DISCONNECT_UNCLEAN is returned, it means a non-existing UTXO was deleted, or an existing UTXO was
<span class="lineNum">    4139 </span>                :            :             // overwritten. It corresponds to cases where the block-to-be-disconnect never had all its operations
<span class="lineNum">    4140 </span>                :            :             // applied to the UTXO set. However, as both writing a UTXO and deleting a UTXO are idempotent operations,
<span class="lineNum">    4141 </span>                :            :             // the result is still a version of the UTXO set with the effects of that block undone.
<span class="lineNum">    4142 </span>                :            :         }
<span class="lineNum">    4143 </span>                :<span class="lineNoCov">          0 :         pindexOld = pindexOld-&gt;pprev;</span>
<span class="lineNum">    4144 </span>                :            :     }
<span class="lineNum">    4145 </span>                :            : 
<span class="lineNum">    4146 </span>                :            :     // Roll forward from the forking point to the new tip.
<span class="lineNum">    4147 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     int nForkHeight = pindexFork ? pindexFork-&gt;nHeight : 0;</span>
<span class="lineNum">    4148 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (int nHeight = nForkHeight + 1; nHeight &lt;= pindexNew-&gt;nHeight; ++nHeight) {</span>
<span class="lineNum">    4149 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         const CBlockIndex* pindex = pindexNew-&gt;GetAncestor(nHeight);</span>
<span class="lineNum">    4150 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LogPrintf(&quot;Rolling forward %s (%i)\n&quot;, pindex-&gt;GetBlockHash().ToString(), nHeight);</span>
<span class="lineNum">    4151 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         uiInterface.ShowProgress(_(&quot;Replaying blocks...&quot;), (int) ((nHeight - nForkHeight) * 100.0 / (pindexNew-&gt;nHeight - nForkHeight)) , false);</span>
<span class="lineNum">    4152 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!RollforwardBlock(pindex, cache, params)) return false;</span>
<span class="lineNum">    4153 </span>                :            :     }
<span class="lineNum">    4154 </span>                :            : 
<span class="lineNum">    4155 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     cache.SetBestBlock(pindexNew-&gt;GetBlockHash());</span>
<span class="lineNum">    4156 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     cache.Flush();</span>
<span class="lineNum">    4157 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :     uiInterface.ShowProgress(&quot;&quot;, 100, false);</span>
<span class="lineNum">    4158 </span>                :<span class="lineNoCov">          0 :     return true;</span>
<a name="4159"><span class="lineNum">    4159 </span>                :            : }</a>
<span class="lineNum">    4160 </span>                :            : 
<span class="lineNum">    4161 </span>                :<span class="lineNoCov">          0 : bool ReplayBlocks(const CChainParams&amp; params, CCoinsView* view) {</span>
<span class="lineNum">    4162 </span>                :<span class="lineNoCov">          0 :     return g_chainstate.ReplayBlocks(params, view);</span>
<span class="lineNum">    4163 </span>                :            : }
<span class="lineNum">    4164 </span>                :            : 
<span class="lineNum">    4165 </span>                :<span class="lineNoCov">          0 : bool CChainState::RewindBlockIndex(const CChainParams&amp; params)</span>
<span class="lineNum">    4166 </span>                :            : {
<span class="lineNum">    4167 </span>                :<span class="lineNoCov">          0 :     LOCK(cs_main);</span>
<span class="lineNum">    4168 </span>                :            : 
<span class="lineNum">    4169 </span>                :            :     // Note that during -reindex-chainstate we are called with an empty chainActive!
<span class="lineNum">    4170 </span>                :            : 
<span class="lineNum">    4171 </span>                :            :     int nHeight = 1;
<span class="lineNum">    4172 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while (nHeight &lt;= chainActive.Height()) {</span>
<span class="lineNum">    4173 </span>                :            :         // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all
<span class="lineNum">    4174 </span>                :            :         // blocks in ConnectBlock, we don't need to go back and
<span class="lineNum">    4175 </span>                :            :         // re-download/re-verify blocks from before segwit actually activated.
<span class="lineNum">    4176 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (IsWitnessEnabled(chainActive[nHeight - 1], params.GetConsensus()) &amp;&amp; !(chainActive[nHeight]-&gt;nStatus &amp; BLOCK_OPT_WITNESS)) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">    4177 </span>                :            :             break;
<span class="lineNum">    4178 </span>                :            :         }
<span class="lineNum">    4179 </span>                :<span class="lineNoCov">          0 :         nHeight++;</span>
<span class="lineNum">    4180 </span>                :            :     }
<span class="lineNum">    4181 </span>                :            : 
<span class="lineNum">    4182 </span>                :            :     // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1
<span class="lineNum">    4183 </span>                :<span class="lineNoCov">          0 :     CValidationState state;</span>
<span class="lineNum">    4184 </span>                :<span class="lineNoCov">          0 :     CBlockIndex* pindex = chainActive.Tip();</span>
<span class="lineNum">    4185 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while (chainActive.Height() &gt;= nHeight) {</span>
<span class="lineNum">    4186 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (fPruneMode &amp;&amp; !(chainActive.Tip()-&gt;nStatus &amp; BLOCK_HAVE_DATA)) {</span>
<span class="lineNum">    4187 </span>                :            :             // If pruning, don't try rewinding past the HAVE_DATA point;
<span class="lineNum">    4188 </span>                :            :             // since older blocks can't be served anyway, there's
<span class="lineNum">    4189 </span>                :            :             // no need to walk further, and trying to DisconnectTip()
<span class="lineNum">    4190 </span>                :            :             // will fail (and require a needless reindex/redownload
<span class="lineNum">    4191 </span>                :            :             // of the blockchain).
<span class="lineNum">    4192 </span>                :            :             break;
<span class="lineNum">    4193 </span>                :            :         }
<span class="lineNum">    4194 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!DisconnectTip(state, params, nullptr)) {</span>
<span class="lineNum">    4195 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return error(&quot;RewindBlockIndex: unable to disconnect block at height %i (%s)&quot;, pindex-&gt;nHeight, FormatStateMessage(state));</span>
<span class="lineNum">    4196 </span>                :            :         }
<span class="lineNum">    4197 </span>                :            :         // Occasionally flush state to disk.
<span class="lineNum">    4198 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {</span>
<span class="lineNum">    4199 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             LogPrintf(&quot;RewindBlockIndex: unable to flush state to disk (%s)\n&quot;, FormatStateMessage(state));</span>
<span class="lineNum">    4200 </span>                :<span class="lineNoCov">          0 :             return false;</span>
<span class="lineNum">    4201 </span>                :            :         }
<span class="lineNum">    4202 </span>                :            :     }
<span class="lineNum">    4203 </span>                :            : 
<span class="lineNum">    4204 </span>                :            :     // Reduce validity flag and have-data flags.
<span class="lineNum">    4205 </span>                :            :     // We do this after actual disconnecting, otherwise we'll end up writing the lack of data
<span class="lineNum">    4206 </span>                :            :     // to disk before writing the chainstate, resulting in a failure to continue if interrupted.
<span class="lineNum">    4207 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (const auto&amp; entry : mapBlockIndex) {</span>
<span class="lineNum">    4208 </span>                :<span class="lineNoCov">          0 :         CBlockIndex* pindexIter = entry.second;</span>
<span class="lineNum">    4209 </span>                :            : 
<span class="lineNum">    4210 </span>                :            :         // Note: If we encounter an insufficiently validated block that
<span class="lineNum">    4211 </span>                :            :         // is on chainActive, it must be because we are a pruning node, and
<span class="lineNum">    4212 </span>                :            :         // this block or some successor doesn't HAVE_DATA, so we were unable to
<span class="lineNum">    4213 </span>                :            :         // rewind all the way.  Blocks remaining on chainActive at this point
<span class="lineNum">    4214 </span>                :            :         // must not have their validity reduced.
<span class="lineNum">    4215 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (IsWitnessEnabled(pindexIter-&gt;pprev, params.GetConsensus()) &amp;&amp; !(pindexIter-&gt;nStatus &amp; BLOCK_OPT_WITNESS) &amp;&amp; !chainActive.Contains(pindexIter)) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    4216 </span>                :            :             // Reduce validity
<span class="lineNum">    4217 </span>                :<span class="lineNoCov">          0 :             pindexIter-&gt;nStatus = std::min&lt;unsigned int&gt;(pindexIter-&gt;nStatus &amp; BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (pindexIter-&gt;nStatus &amp; ~BLOCK_VALID_MASK);</span>
<span class="lineNum">    4218 </span>                :            :             // Remove have-data flags.
<span class="lineNum">    4219 </span>                :<span class="lineNoCov">          0 :             pindexIter-&gt;nStatus &amp;= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);</span>
<span class="lineNum">    4220 </span>                :            :             // Remove storage location.
<span class="lineNum">    4221 </span>                :<span class="lineNoCov">          0 :             pindexIter-&gt;nFile = 0;</span>
<span class="lineNum">    4222 </span>                :<span class="lineNoCov">          0 :             pindexIter-&gt;nDataPos = 0;</span>
<span class="lineNum">    4223 </span>                :<span class="lineNoCov">          0 :             pindexIter-&gt;nUndoPos = 0;</span>
<span class="lineNum">    4224 </span>                :            :             // Remove various other things
<span class="lineNum">    4225 </span>                :<span class="lineNoCov">          0 :             pindexIter-&gt;nTx = 0;</span>
<span class="lineNum">    4226 </span>                :<span class="lineNoCov">          0 :             pindexIter-&gt;nChainTx = 0;</span>
<span class="lineNum">    4227 </span>                :<span class="lineNoCov">          0 :             pindexIter-&gt;nSequenceId = 0;</span>
<span class="lineNum">    4228 </span>                :            :             // Make sure it gets written.
<span class="lineNum">    4229 </span>                :<span class="lineNoCov">          0 :             setDirtyBlockIndex.insert(pindexIter);</span>
<span class="lineNum">    4230 </span>                :            :             // Update indexes
<span class="lineNum">    4231 </span>                :<span class="lineNoCov">          0 :             setBlockIndexCandidates.erase(pindexIter);</span>
<span class="lineNum">    4232 </span>                :<span class="lineNoCov">          0 :             std::pair&lt;std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;::iterator, std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;::iterator&gt; ret = mapBlocksUnlinked.equal_range(pindexIter-&gt;pprev);</span>
<span class="lineNum">    4233 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             while (ret.first != ret.second) {</span>
<span class="lineNum">    4234 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (ret.first-&gt;second == pindexIter) {</span>
<span class="lineNum">    4235 </span>                :<span class="lineNoCov">          0 :                     mapBlocksUnlinked.erase(ret.first++);</span>
<span class="lineNum">    4236 </span>                :            :                 } else {
<span class="lineNum">    4237 </span>                :            :                     ++ret.first;
<span class="lineNum">    4238 </span>                :            :                 }
<span class="lineNum">    4239 </span>                :            :             }
<span class="lineNum">    4240 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if (pindexIter-&gt;IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp; pindexIter-&gt;HaveTxsDownloaded()) {</span>
<span class="lineNum">    4241 </span>                :<span class="lineNoCov">          0 :             setBlockIndexCandidates.insert(pindexIter);</span>
<span class="lineNum">    4242 </span>                :            :         }
<span class="lineNum">    4243 </span>                :            :     }
<span class="lineNum">    4244 </span>                :            : 
<span class="lineNum">    4245 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (chainActive.Tip() != nullptr) {</span>
<span class="lineNum">    4246 </span>                :            :         // We can't prune block index candidates based on our tip if we have
<span class="lineNum">    4247 </span>                :            :         // no tip due to chainActive being empty!
<span class="lineNum">    4248 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         PruneBlockIndexCandidates();</span>
<span class="lineNum">    4249 </span>                :            : 
<span class="lineNum">    4250 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         CheckBlockIndex(params.GetConsensus());</span>
<span class="lineNum">    4251 </span>                :            :     }
<span class="lineNum">    4252 </span>                :            : 
<span class="lineNum">    4253 </span>                :            :     return true;
<span class="lineNum">    4254 </span>                :            : }
<span class="lineNum">    4255 </span>                :            : 
<span class="lineNum">    4256 </span>                :<span class="lineNoCov">          0 : bool RewindBlockIndex(const CChainParams&amp; params) {</span>
<span class="lineNum">    4257 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!g_chainstate.RewindBlockIndex(params)) {</span>
<span class="lineNum">    4258 </span>                :            :         return false;
<span class="lineNum">    4259 </span>                :            :     }
<span class="lineNum">    4260 </span>                :            : 
<span class="lineNum">    4261 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (chainActive.Tip() != nullptr) {</span>
<span class="lineNum">    4262 </span>                :            :         // FlushStateToDisk can possibly read chainActive. Be conservative
<span class="lineNum">    4263 </span>                :            :         // and skip it here, we're about to -reindex-chainstate anyway, so
<span class="lineNum">    4264 </span>                :            :         // it'll get called a bunch real soon.
<span class="lineNum">    4265 </span>                :<span class="lineNoCov">          0 :         CValidationState state;</span>
<span class="lineNum">    4266 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {</span>
<span class="lineNum">    4267 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             LogPrintf(&quot;RewindBlockIndex: unable to flush state to disk (%s)\n&quot;, FormatStateMessage(state));</span>
<span class="lineNum">    4268 </span>                :<span class="lineNoCov">          0 :             return false;</span>
<span class="lineNum">    4269 </span>                :            :         }
<span class="lineNum">    4270 </span>                :            :     }
<span class="lineNum">    4271 </span>                :            : 
<span class="lineNum">    4272 </span>                :            :     return true;
<a name="4273"><span class="lineNum">    4273 </span>                :            : }</a>
<span class="lineNum">    4274 </span>                :            : 
<span class="lineNum">    4275 </span>                :<span class="lineCov">         66 : void CChainState::UnloadBlockIndex() {</span>
<span class="lineNum">    4276 </span>                :<span class="lineCov">         66 :     nBlockSequenceId = 1;</span>
<span class="lineNum">    4277 </span>                :<span class="lineCov">        132 :     m_failed_blocks.clear();</span>
<span class="lineNum">    4278 </span>                :<span class="lineCov">        132 :     setBlockIndexCandidates.clear();</span>
<span class="lineNum">    4279 </span>                :<span class="lineCov">         66 : }</span>
<span class="lineNum">    4280 </span>                :            : 
<span class="lineNum">    4281 </span>                :            : // May NOT be used after any connections are up as much
<a name="4282"><span class="lineNum">    4282 </span>                :            : // of the peer-processing logic assumes a consistent</a>
<span class="lineNum">    4283 </span>                :            : // block index state
<span class="lineNum">    4284 </span>                :<span class="lineCov">         66 : void UnloadBlockIndex()</span>
<span class="lineNum">    4285 </span>                :            : {
<span class="lineNum">    4286 </span>                :<span class="lineCov">         66 :     LOCK(cs_main);</span>
<span class="lineNum">    4287 </span>        [<span class="branchCov" title="Branch 1 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         66 :     chainActive.SetTip(nullptr);</span>
<span class="lineNum">    4288 </span>                :<span class="lineCov">         66 :     pindexBestInvalid = nullptr;</span>
<span class="lineNum">    4289 </span>                :<span class="lineCov">         66 :     pindexBestHeader = nullptr;</span>
<span class="lineNum">    4290 </span>        [<span class="branchCov" title="Branch 1 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         66 :     mempool.clear();</span>
<span class="lineNum">    4291 </span>                :<span class="lineCov">        132 :     mapBlocksUnlinked.clear();</span>
<span class="lineNum">    4292 </span>                :<span class="lineCov">         66 :     vinfoBlockFile.clear();</span>
<span class="lineNum">    4293 </span>                :<span class="lineCov">         66 :     nLastBlockFile = 0;</span>
<span class="lineNum">    4294 </span>                :<span class="lineCov">         66 :     setDirtyBlockIndex.clear();</span>
<span class="lineNum">    4295 </span>                :<span class="lineCov">         66 :     setDirtyFileInfo.clear();</span>
<span class="lineNum">    4296 </span>        [<span class="branchCov" title="Branch 1 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         66 :     versionbitscache.Clear();</span>
<span class="lineNum">    4297 </span>        [<span class="branchCov" title="Branch 0 was taken 1914 times"> + </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>]:<span class="lineCov">       1980 :     for (int b = 0; b &lt; VERSIONBITS_NUM_BITS; b++) {</span>
<span class="lineNum">    4298 </span>                :<span class="lineCov">       3828 :         warningcache[b].clear();</span>
<span class="lineNum">    4299 </span>                :            :     }
<span class="lineNum">    4300 </span>                :            : 
<span class="lineNum">    4301 </span>        [<span class="branchCov" title="Branch 0 was taken 1375 times"> + </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>]:<span class="lineCov">       1441 :     for (const BlockMap::value_type&amp; entry : mapBlockIndex) {</span>
<span class="lineNum">    4302 </span>                :<span class="lineCov">       1375 :         delete entry.second;</span>
<span class="lineNum">    4303 </span>                :            :     }
<span class="lineNum">    4304 </span>                :<span class="lineCov">        132 :     mapBlockIndex.clear();</span>
<span class="lineNum">    4305 </span>                :<span class="lineCov">         66 :     fHavePruned = false;</span>
<span class="lineNum">    4306 </span>                :            : 
<span class="lineNum">    4307 </span>                :<span class="lineCov">         66 :     g_chainstate.UnloadBlockIndex();</span>
<a name="4308"><span class="lineNum">    4308 </span>                :<span class="lineCov">         66 : }</span></a>
<span class="lineNum">    4309 </span>                :            : 
<span class="lineNum">    4310 </span>                :<span class="lineNoCov">          0 : bool LoadBlockIndex(const CChainParams&amp; chainparams)</span>
<span class="lineNum">    4311 </span>                :            : {
<span class="lineNum">    4312 </span>                :            :     // Load block index from databases
<span class="lineNum">    4313 </span>                :<span class="lineNoCov">          0 :     bool needs_init = fReindex;</span>
<span class="lineNum">    4314 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!fReindex) {</span>
<span class="lineNum">    4315 </span>                :<span class="lineNoCov">          0 :         bool ret = LoadBlockIndexDB(chainparams);</span>
<span class="lineNum">    4316 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!ret) return false;</span>
<span class="lineNum">    4317 </span>                :<span class="lineNoCov">          0 :         needs_init = mapBlockIndex.empty();</span>
<span class="lineNum">    4318 </span>                :            :     }
<span class="lineNum">    4319 </span>                :            : 
<span class="lineNum">    4320 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (needs_init) {</span>
<span class="lineNum">    4321 </span>                :            :         // Everything here is for *new* reindex/DBs. Thus, though
<span class="lineNum">    4322 </span>                :            :         // LoadBlockIndexDB may have set fReindex if we shut down
<span class="lineNum">    4323 </span>                :            :         // mid-reindex previously, we don't check fReindex and
<span class="lineNum">    4324 </span>                :            :         // instead only check it prior to LoadBlockIndexDB to set
<span class="lineNum">    4325 </span>                :            :         // needs_init.
<span class="lineNum">    4326 </span>                :            : 
<span class="lineNum">    4327 </span>                :<span class="lineNoCov">          0 :         LogPrintf(&quot;Initializing databases...\n&quot;);</span>
<span class="lineNum">    4328 </span>                :            :     }
<span class="lineNum">    4329 </span>                :            :     return true;
<a name="4330"><span class="lineNum">    4330 </span>                :            : }</a>
<span class="lineNum">    4331 </span>                :            : 
<span class="lineNum">    4332 </span>                :<span class="lineCov">         66 : bool CChainState::LoadGenesisBlock(const CChainParams&amp; chainparams)</span>
<span class="lineNum">    4333 </span>                :            : {
<span class="lineNum">    4334 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineCov">        132 :     LOCK(cs_main);</span>
<span class="lineNum">    4335 </span>                :            : 
<span class="lineNum">    4336 </span>                :            :     // Check whether we're already initialized by checking for genesis in
<span class="lineNum">    4337 </span>                :            :     // mapBlockIndex. Note that we can't use chainActive here, since it is
<span class="lineNum">    4338 </span>                :            :     // set based on the coins db, not the block index db, which is the only
<span class="lineNum">    4339 </span>                :            :     // thing loaded at this point.
<span class="lineNum">    4340 </span>  [<span class="branchCov" title="Branch 1 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        132 :     if (mapBlockIndex.count(chainparams.GenesisBlock().GetHash()))</span>
<span class="lineNum">    4341 </span>                :            :         return true;
<span class="lineNum">    4342 </span>                :            : 
<span class="lineNum">    4343 </span>                :            :     try {
<span class="lineNum">    4344 </span>                :<span class="lineCov">         66 :         const CBlock&amp; block = chainparams.GenesisBlock();</span>
<span class="lineNum">    4345 </span>        [<span class="branchCov" title="Branch 1 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         66 :         CDiskBlockPos blockPos = SaveBlockToDisk(block, 0, chainparams, nullptr);</span>
<span class="lineNum">    4346 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>]:<span class="lineCov">         66 :         if (blockPos.IsNull())</span>
<span class="lineNum">    4347 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             return error(&quot;%s: writing genesis block to disk failed&quot;, __func__);</span>
<span class="lineNum">    4348 </span>        [<span class="branchCov" title="Branch 1 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         66 :         CBlockIndex *pindex = AddToBlockIndex(block);</span>
<span class="lineNum">    4349 </span>        [<span class="branchCov" title="Branch 1 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         66 :         ReceivedBlockTransactions(block, pindex, blockPos, chainparams.GetConsensus());</span>
<span class="lineNum">    4350 </span>                :<span class="lineNoCov">          0 :     } catch (const std::runtime_error&amp; e) {</span>
<span class="lineNum">    4351 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return error(&quot;%s: failed to write genesis block: %s&quot;, __func__, e.what());</span>
<span class="lineNum">    4352 </span>                :            :     }
<span class="lineNum">    4353 </span>                :            : 
<span class="lineNum">    4354 </span>                :<span class="lineCov">         66 :     return true;</span>
<a name="4355"><span class="lineNum">    4355 </span>                :            : }</a>
<span class="lineNum">    4356 </span>                :            : 
<span class="lineNum">    4357 </span>                :<span class="lineCov">         66 : bool LoadGenesisBlock(const CChainParams&amp; chainparams)</span>
<span class="lineNum">    4358 </span>                :            : {
<span class="lineNum">    4359 </span>                :<span class="lineCov">         66 :     return g_chainstate.LoadGenesisBlock(chainparams);</span>
<span class="lineNum">    4360 </span>                :            : }
<span class="lineNum">    4361 </span>                :            : 
<span class="lineNum">    4362 </span>                :<span class="lineNoCov">          0 : bool LoadExternalBlockFile(const CChainParams&amp; chainparams, FILE* fileIn, CDiskBlockPos *dbp)</span>
<span class="lineNum">    4363 </span>                :            : {
<span class="lineNum">    4364 </span>                :            :     // Map of disk positions for blocks with unknown parent (only used for reindex)
<span class="lineNum">    4365 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     static std::multimap&lt;uint256, CDiskBlockPos&gt; mapBlocksUnknownParent;</span>
<span class="lineNum">    4366 </span>                :<span class="lineNoCov">          0 :     int64_t nStart = GetTimeMillis();</span>
<span class="lineNum">    4367 </span>                :            : 
<span class="lineNum">    4368 </span>                :<span class="lineNoCov">          0 :     int nLoaded = 0;</span>
<span class="lineNum">    4369 </span>                :            :     try {
<span class="lineNum">    4370 </span>                :            :         // This takes over fileIn and calls fclose() on it in the CBufferedFile destructor
<span class="lineNum">    4371 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         CBufferedFile blkdat(fileIn, 2*MAX_BLOCK_SERIALIZED_SIZE, MAX_BLOCK_SERIALIZED_SIZE+8, SER_DISK, CLIENT_VERSION);</span>
<span class="lineNum">    4372 </span>                :<span class="lineNoCov">          0 :         uint64_t nRewind = blkdat.GetPos();</span>
<span class="lineNum">    4373 </span>                :            :         while (!blkdat.eof()) {
<span class="lineNum">    4374 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             boost::this_thread::interruption_point();</span>
<span class="lineNum">    4375 </span>                :            : 
<span class="lineNum">    4376 </span>                :<span class="lineNoCov">          0 :             blkdat.SetPos(nRewind);</span>
<span class="lineNum">    4377 </span>                :<span class="lineNoCov">          0 :             nRewind++; // start one byte further next time, in case of failure</span>
<span class="lineNum">    4378 </span>                :<span class="lineNoCov">          0 :             blkdat.SetLimit(); // remove former limit</span>
<span class="lineNum">    4379 </span>                :<span class="lineNoCov">          0 :             unsigned int nSize = 0;</span>
<span class="lineNum">    4380 </span>                :            :             try {
<span class="lineNum">    4381 </span>                :            :                 // locate a header
<span class="lineNum">    4382 </span>                :            :                 unsigned char buf[CMessageHeader::MESSAGE_START_SIZE];
<span class="lineNum">    4383 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 blkdat.FindByte(chainparams.MessageStart()[0]);</span>
<span class="lineNum">    4384 </span>                :<span class="lineNoCov">          0 :                 nRewind = blkdat.GetPos()+1;</span>
<span class="lineNum">    4385 </span>                :<span class="lineNoCov">          0 :                 blkdat &gt;&gt; buf;</span>
<span class="lineNum">    4386 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (memcmp(buf, chainparams.MessageStart(), CMessageHeader::MESSAGE_START_SIZE))</span>
<span class="lineNum">    4387 </span>                :<span class="lineNoCov">          0 :                     continue;</span>
<span class="lineNum">    4388 </span>                :            :                 // read size
<span class="lineNum">    4389 </span>                :<span class="lineNoCov">          0 :                 blkdat &gt;&gt; nSize;</span>
<span class="lineNum">    4390 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (nSize &lt; 80 || nSize &gt; MAX_BLOCK_SERIALIZED_SIZE)</span>
<span class="lineNum">    4391 </span>                :<span class="lineNoCov">          0 :                     continue;</span>
<span class="lineNum">    4392 </span>                :<span class="lineNoCov">          0 :             } catch (const std::exception&amp;) {</span>
<span class="lineNum">    4393 </span>                :            :                 // no valid block header found; don't complain
<span class="lineNum">    4394 </span>                :            :                 break;
<span class="lineNum">    4395 </span>                :            :             }
<span class="lineNum">    4396 </span>                :            :             try {
<span class="lineNum">    4397 </span>                :            :                 // read block
<span class="lineNum">    4398 </span>                :<span class="lineNoCov">          0 :                 uint64_t nBlockPos = blkdat.GetPos();</span>
<span class="lineNum">    4399 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (dbp)</span>
<span class="lineNum">    4400 </span>                :<span class="lineNoCov">          0 :                     dbp-&gt;nPos = nBlockPos;</span>
<span class="lineNum">    4401 </span>                :<span class="lineNoCov">          0 :                 blkdat.SetLimit(nBlockPos + nSize);</span>
<span class="lineNum">    4402 </span>                :<span class="lineNoCov">          0 :                 blkdat.SetPos(nBlockPos);</span>
<span class="lineNum">    4403 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 std::shared_ptr&lt;CBlock&gt; pblock = std::make_shared&lt;CBlock&gt;();</span>
<span class="lineNum">    4404 </span>                :<span class="lineNoCov">          0 :                 CBlock&amp; block = *pblock;</span>
<span class="lineNum">    4405 </span>                :<span class="lineNoCov">          0 :                 blkdat &gt;&gt; block;</span>
<span class="lineNum">    4406 </span>                :<span class="lineNoCov">          0 :                 nRewind = blkdat.GetPos();</span>
<span class="lineNum">    4407 </span>                :            : 
<span class="lineNum">    4408 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 uint256 hash = block.GetHash();</span>
<span class="lineNum">    4409 </span>                :            :                 {
<span class="lineNum">    4410 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     LOCK(cs_main);</span>
<span class="lineNum">    4411 </span>                :            :                     // detect out of order blocks, and store them for later
<span class="lineNum">    4412 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if (hash != chainparams.GetConsensus().hashGenesisBlock &amp;&amp; !LookupBlockIndex(block.hashPrevBlock)) {</span>
<span class="lineNum">    4413 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         LogPrint(BCLog::REINDEX, &quot;%s: Out of order block %s, parent %s not known\n&quot;, __func__, hash.ToString(),</span>
<span class="lineNum">    4414 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 block.hashPrevBlock.ToString());</span>
<span class="lineNum">    4415 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (dbp)</span>
<span class="lineNum">    4416 </span>                :<span class="lineNoCov">          0 :                             mapBlocksUnknownParent.insert(std::make_pair(block.hashPrevBlock, *dbp));</span>
<span class="lineNum">    4417 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    4418 </span>                :            :                     }
<span class="lineNum">    4419 </span>                :            : 
<span class="lineNum">    4420 </span>                :            :                     // process in case the block isn't known yet
<span class="lineNum">    4421 </span>                :<span class="lineNoCov">          0 :                     CBlockIndex* pindex = LookupBlockIndex(hash);</span>
<span class="lineNum">    4422 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if (!pindex || (pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA) == 0) {</span>
<span class="lineNum">    4423 </span>                :<span class="lineNoCov">          0 :                       CValidationState state;</span>
<span class="lineNum">    4424 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                       if (g_chainstate.AcceptBlock(pblock, state, chainparams, nullptr, true, dbp, nullptr)) {</span>
<span class="lineNum">    4425 </span>                :<span class="lineNoCov">          0 :                           nLoaded++;</span>
<span class="lineNum">    4426 </span>                :            :                       }
<span class="lineNum">    4427 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                       if (state.IsError()) {</span>
<span class="lineNum">    4428 </span>                :            :                           break;
<span class="lineNum">    4429 </span>                :            :                       }
<span class="lineNum">    4430 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     } else if (hash != chainparams.GetConsensus().hashGenesisBlock &amp;&amp; pindex-&gt;nHeight % 1000 == 0) {</span>
<span class="lineNum">    4431 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                       LogPrint(BCLog::REINDEX, &quot;Block Import: already had block %s at height %d\n&quot;, hash.ToString(), pindex-&gt;nHeight);</span>
<span class="lineNum">    4432 </span>                :            :                     }
<span class="lineNum">    4433 </span>                :            :                 }
<span class="lineNum">    4434 </span>                :            : 
<span class="lineNum">    4435 </span>                :            :                 // Activate the genesis block so normal node progress can continue
<span class="lineNum">    4436 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (hash == chainparams.GetConsensus().hashGenesisBlock) {</span>
<span class="lineNum">    4437 </span>                :<span class="lineNoCov">          0 :                     CValidationState state;</span>
<span class="lineNum">    4438 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if (!ActivateBestChain(state, chainparams)) {</span>
<span class="lineNum">    4439 </span>                :            :                         break;
<span class="lineNum">    4440 </span>                :            :                     }
<span class="lineNum">    4441 </span>                :            :                 }
<span class="lineNum">    4442 </span>                :            : 
<span class="lineNum">    4443 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 NotifyHeaderTip();</span>
<span class="lineNum">    4444 </span>                :            : 
<span class="lineNum">    4445 </span>                :            :                 // Recursively process earlier encountered successors of this block
<span class="lineNum">    4446 </span>                :<span class="lineNoCov">          0 :                 std::deque&lt;uint256&gt; queue;</span>
<span class="lineNum">    4447 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 queue.push_back(hash);</span>
<span class="lineNum">    4448 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 while (!queue.empty()) {</span>
<span class="lineNum">    4449 </span>                :<span class="lineNoCov">          0 :                     uint256 head = queue.front();</span>
<span class="lineNum">    4450 </span>                :<span class="lineNoCov">          0 :                     queue.pop_front();</span>
<span class="lineNum">    4451 </span>                :<span class="lineNoCov">          0 :                     std::pair&lt;std::multimap&lt;uint256, CDiskBlockPos&gt;::iterator, std::multimap&lt;uint256, CDiskBlockPos&gt;::iterator&gt; range = mapBlocksUnknownParent.equal_range(head);</span>
<span class="lineNum">    4452 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     while (range.first != range.second) {</span>
<span class="lineNum">    4453 </span>                :<span class="lineNoCov">          0 :                         std::multimap&lt;uint256, CDiskBlockPos&gt;::iterator it = range.first;</span>
<span class="lineNum">    4454 </span>                :<span class="lineNoCov">          0 :                         std::shared_ptr&lt;CBlock&gt; pblockrecursive = std::make_shared&lt;CBlock&gt;();</span>
<span class="lineNum">    4455 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (ReadBlockFromDisk(*pblockrecursive, it-&gt;second, chainparams.GetConsensus()))</span>
<span class="lineNum">    4456 </span>                :            :                         {
<span class="lineNum">    4457 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                             LogPrint(BCLog::REINDEX, &quot;%s: Processing out of order child %s of %s\n&quot;, __func__, pblockrecursive-&gt;GetHash().ToString(),</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    4458 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                     head.ToString());</span>
<span class="lineNum">    4459 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                             LOCK(cs_main);</span>
<span class="lineNum">    4460 </span>                :<span class="lineNoCov">          0 :                             CValidationState dummy;</span>
<span class="lineNum">    4461 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                             if (g_chainstate.AcceptBlock(pblockrecursive, dummy, chainparams, nullptr, true, &amp;it-&gt;second, nullptr))</span>
<span class="lineNum">    4462 </span>                :            :                             {
<span class="lineNum">    4463 </span>                :<span class="lineNoCov">          0 :                                 nLoaded++;</span>
<span class="lineNum">    4464 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 queue.push_back(pblockrecursive-&gt;GetHash());</span>
<span class="lineNum">    4465 </span>                :            :                             }
<span class="lineNum">    4466 </span>                :            :                         }
<span class="lineNum">    4467 </span>                :<span class="lineNoCov">          0 :                         range.first++;</span>
<span class="lineNum">    4468 </span>                :<span class="lineNoCov">          0 :                         mapBlocksUnknownParent.erase(it);</span>
<span class="lineNum">    4469 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         NotifyHeaderTip();</span>
<span class="lineNum">    4470 </span>                :            :                     }
<span class="lineNum">    4471 </span>                :            :                 }
<span class="lineNum">    4472 </span>                :<span class="lineNoCov">          0 :             } catch (const std::exception&amp; e) {</span>
<span class="lineNum">    4473 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 LogPrintf(&quot;%s: Deserialize or I/O error - %s\n&quot;, __func__, e.what());</span>
<span class="lineNum">    4474 </span>                :            :             }
<span class="lineNum">    4475 </span>                :            :         }
<span class="lineNum">    4476 </span>                :<span class="lineNoCov">          0 :     } catch (const std::runtime_error&amp; e) {</span>
<span class="lineNum">    4477 </span>  [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span> :<span class="lineNoCov">          0 :         AbortNode(std::string(&quot;System error: &quot;) + e.what());</span>
<span class="lineNum">         </span>   <span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span><span class="branchNoExec" title="Branch 12 was not executed"> # </span>]
<span class="lineNum">    4478 </span>                :            :     }
<span class="lineNum">    4479 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (nLoaded &gt; 0)</span>
<span class="lineNum">    4480 </span>                :<span class="lineNoCov">          0 :         LogPrintf(&quot;Loaded %i blocks from external file in %dms\n&quot;, nLoaded, GetTimeMillis() - nStart);</span>
<span class="lineNum">    4481 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return nLoaded &gt; 0;</span>
<a name="4482"><span class="lineNum">    4482 </span>                :            : }</a>
<span class="lineNum">    4483 </span>                :            : 
<span class="lineNum">    4484 </span>                :<span class="lineCov">       3906 : void CChainState::CheckBlockIndex(const Consensus::Params&amp; consensusParams)</span>
<span class="lineNum">    4485 </span>                :            : {
<span class="lineNum">    4486 </span>        [<span class="branchCov" title="Branch 0 was taken 3906 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       3906 :     if (!fCheckBlockIndex) {</span>
<span class="lineNum">    4487 </span>                :<span class="lineCov">       3906 :         return;</span>
<span class="lineNum">    4488 </span>                :            :     }
<span class="lineNum">    4489 </span>                :            : 
<span class="lineNum">    4490 </span>                :<span class="lineCov">       7812 :     LOCK(cs_main);</span>
<span class="lineNum">    4491 </span>                :            : 
<span class="lineNum">    4492 </span>                :            :     // During a reindex, we read the genesis block and call CheckBlockIndex before ActivateBestChain,
<span class="lineNum">    4493 </span>                :            :     // so we have the genesis block in mapBlockIndex but no active chain.  (A few of the tests when
<span class="lineNum">    4494 </span>                :            :     // iterating the block tree require that chainActive has been initialized.)
<span class="lineNum">    4495 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>]:<span class="lineCov">       3906 :     if (chainActive.Height() &lt; 0) {</span>
<span class="lineNum">    4496 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         assert(mapBlockIndex.size() &lt;= 1);</span>
<span class="lineNum">    4497 </span>                :            :         return;
<span class="lineNum">    4498 </span>                :            :     }
<span class="lineNum">    4499 </span>                :            : 
<span class="lineNum">    4500 </span>                :            :     // Build forward-pointing map of the entire block tree.
<span class="lineNum">    4501 </span>                :<span class="lineNoCov">          0 :     std::multimap&lt;CBlockIndex*,CBlockIndex*&gt; forward;</span>
<span class="lineNum">    4502 </span>        [<span class="branchCov" title="Branch 0 was taken 203436 times"> + </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>]:<span class="lineCov">     207342 :     for (const std::pair&lt;const uint256, CBlockIndex*&gt;&amp; entry : mapBlockIndex) {</span>
<span class="lineNum">    4503 </span>                :<span class="lineCov">     610308 :         forward.insert(std::make_pair(entry.second-&gt;pprev, entry.second));</span>
<span class="lineNum">    4504 </span>                :            :     }
<span class="lineNum">    4505 </span>                :            : 
<span class="lineNum">    4506 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>]:<span class="lineCov">       3906 :     assert(forward.size() == mapBlockIndex.size());</span>
<span class="lineNum">    4507 </span>                :            : 
<span class="lineNum">    4508 </span>                :<span class="lineCov">       7812 :     std::pair&lt;std::multimap&lt;CBlockIndex*,CBlockIndex*&gt;::iterator,std::multimap&lt;CBlockIndex*,CBlockIndex*&gt;::iterator&gt; rangeGenesis = forward.equal_range(nullptr);</span>
<span class="lineNum">    4509 </span>                :<span class="lineCov">       3906 :     CBlockIndex *pindex = rangeGenesis.first-&gt;second;</span>
<span class="lineNum">    4510 </span>                :<span class="lineCov">       3906 :     rangeGenesis.first++;</span>
<span class="lineNum">    4511 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>]:<span class="lineCov">     207342 :     assert(rangeGenesis.first == rangeGenesis.second); // There is only one index entry with parent nullptr.</span>
<span class="lineNum">    4512 </span>                :            : 
<span class="lineNum">    4513 </span>                :            :     // Iterate over the entire block tree, using depth-first search.
<span class="lineNum">    4514 </span>                :            :     // Along the way, remember whether there are blocks on the path from genesis
<span class="lineNum">    4515 </span>                :            :     // block being explored which are the first to have certain properties.
<span class="lineNum">    4516 </span>                :            :     size_t nNodes = 0;
<span class="lineNum">    4517 </span>                :            :     int nHeight = 0;
<span class="lineNum">    4518 </span>                :            :     CBlockIndex* pindexFirstInvalid = nullptr; // Oldest ancestor of pindex which is invalid.
<span class="lineNum">    4519 </span>                :            :     CBlockIndex* pindexFirstMissing = nullptr; // Oldest ancestor of pindex which does not have BLOCK_HAVE_DATA.
<span class="lineNum">    4520 </span>                :            :     CBlockIndex* pindexFirstNeverProcessed = nullptr; // Oldest ancestor of pindex for which nTx == 0.
<span class="lineNum">    4521 </span>                :            :     CBlockIndex* pindexFirstNotTreeValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TREE (regardless of being valid or not).
<span class="lineNum">    4522 </span>                :            :     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).
<span class="lineNum">    4523 </span>                :            :     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).
<span class="lineNum">    4524 </span>                :            :     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).
<span class="lineNum">    4525 </span>        [<span class="branchCov" title="Branch 0 was taken 203436 times"> + </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>]:<span class="lineCov">     207342 :     while (pindex != nullptr) {</span>
<span class="lineNum">    4526 </span>                :<span class="lineCov">     203436 :         nNodes++;</span>
<span class="lineNum">    4527 </span>[<span class="branchCov" title="Branch 0 was taken 203436 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 8 times"> + </span><span class="branchCov" title="Branch 3 was taken 203428 times"> + </span>]:<span class="lineCov">     203436 :         if (pindexFirstInvalid == nullptr &amp;&amp; pindex-&gt;nStatus &amp; BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;</span>
<span class="lineNum">    4528 </span>[<span class="branchCov" title="Branch 0 was taken 195815 times"> + </span><span class="branchCov" title="Branch 1 was taken 7621 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1397 times"> + </span><span class="branchCov" title="Branch 3 was taken 194418 times"> + </span>]:<span class="lineCov">     203436 :         if (pindexFirstMissing == nullptr &amp;&amp; !(pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;</span>
<span class="lineNum">    4529 </span>[<span class="branchCov" title="Branch 0 was taken 195815 times"> + </span><span class="branchCov" title="Branch 1 was taken 7621 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1397 times"> + </span><span class="branchCov" title="Branch 3 was taken 194418 times"> + </span>]:<span class="lineCov">     203436 :         if (pindexFirstNeverProcessed == nullptr &amp;&amp; pindex-&gt;nTx == 0) pindexFirstNeverProcessed = pindex;</span>
<span class="lineNum">    4530 </span>[<span class="branchCov" title="Branch 0 was taken 199530 times"> + </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 199530 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">     203436 :         if (pindex-&gt;pprev != nullptr &amp;&amp; pindexFirstNotTreeValid == nullptr &amp;&amp; (pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &lt; BLOCK_VALID_TREE) pindexFirstNotTreeValid = pindex;</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 199530 times"> + </span>]
<span class="lineNum">    4531 </span>[<span class="branchCov" title="Branch 0 was taken 199530 times"> + </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 191909 times"> + </span><span class="branchCov" title="Branch 3 was taken 7621 times"> + </span>]:<span class="lineCov">     203436 :         if (pindex-&gt;pprev != nullptr &amp;&amp; pindexFirstNotTransactionsValid == nullptr &amp;&amp; (pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &lt; BLOCK_VALID_TRANSACTIONS) pindexFirstNotTransactionsValid = pindex;</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 1397 times"> + </span><span class="branchCov" title="Branch 5 was taken 190512 times"> + </span>]
<span class="lineNum">    4532 </span>[<span class="branchCov" title="Branch 0 was taken 199530 times"> + </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 191754 times"> + </span><span class="branchCov" title="Branch 3 was taken 7776 times"> + </span>]:<span class="lineCov">     203436 :         if (pindex-&gt;pprev != nullptr &amp;&amp; pindexFirstNotChainValid == nullptr &amp;&amp; (pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &lt; BLOCK_VALID_CHAIN) pindexFirstNotChainValid = pindex;</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 2654 times"> + </span><span class="branchCov" title="Branch 5 was taken 189100 times"> + </span>]
<span class="lineNum">    4533 </span>[<span class="branchCov" title="Branch 0 was taken 199530 times"> + </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 191754 times"> + </span><span class="branchCov" title="Branch 3 was taken 7776 times"> + </span>]:<span class="lineCov">     203436 :         if (pindex-&gt;pprev != nullptr &amp;&amp; pindexFirstNotScriptsValid == nullptr &amp;&amp; (pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &lt; BLOCK_VALID_SCRIPTS) pindexFirstNotScriptsValid = pindex;</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 2654 times"> + </span><span class="branchCov" title="Branch 5 was taken 189100 times"> + </span>]
<span class="lineNum">    4534 </span>                :            : 
<span class="lineNum">    4535 </span>                :            :         // Begin: actual consistency checks.
<span class="lineNum">    4536 </span>        [<span class="branchCov" title="Branch 0 was taken 3906 times"> + </span><span class="branchCov" title="Branch 1 was taken 199530 times"> + </span>]:<span class="lineCov">     203436 :         if (pindex-&gt;pprev == nullptr) {</span>
<span class="lineNum">    4537 </span>                :            :             // Genesis block checks.
<span class="lineNum">    4538 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>]:<span class="lineCov">       3906 :             assert(pindex-&gt;GetBlockHash() == consensusParams.hashGenesisBlock); // Genesis block's hash must match.</span>
<span class="lineNum">    4539 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>]:<span class="lineCov">       3906 :             assert(pindex == chainActive.Genesis()); // The current active chain's genesis block must be this block.</span>
<span class="lineNum">    4540 </span>                :            :         }
<span class="lineNum">    4541 </span>[<span class="branchCov" title="Branch 0 was taken 9018 times"> + </span><span class="branchCov" title="Branch 1 was taken 194418 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 9018 times"> + </span>]:<span class="lineCov">     203436 :         if (!pindex-&gt;HaveTxsDownloaded()) assert(pindex-&gt;nSequenceId &lt;= 0); // nSequenceId can't be set positive for blocks that aren't linked (negative is used for preciousblock)</span>
<span class="lineNum">    4542 </span>                :            :         // VALID_TRANSACTIONS is equivalent to nTx &gt; 0 for all nodes (whether or not pruning has occurred).
<span class="lineNum">    4543 </span>                :            :         // HAVE_DATA is only equivalent to nTx &gt; 0 (or VALID_TRANSACTIONS) if no pruning has occurred.
<span class="lineNum">    4544 </span>        [<span class="branchCov" title="Branch 0 was taken 203436 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     203436 :         if (!fHavePruned) {</span>
<span class="lineNum">    4545 </span>                :            :             // If we've never pruned, then HAVE_DATA should be equivalent to nTx &gt; 0
<span class="lineNum">    4546 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 203436 times"> + </span>]:<span class="lineCov">     203436 :             assert(!(pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA) == (pindex-&gt;nTx == 0));</span>
<span class="lineNum">    4547 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 203436 times"> + </span>]:<span class="lineCov">     203436 :             assert(pindexFirstMissing == pindexFirstNeverProcessed);</span>
<span class="lineNum">    4548 </span>                :            :         } else {
<span class="lineNum">    4549 </span>                :            :             // If we have pruned, then we can only say that HAVE_DATA implies nTx &gt; 0
<span class="lineNum">    4550 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA) assert(pindex-&gt;nTx &gt; 0);</span>
<span class="lineNum">    4551 </span>                :            :         }
<span class="lineNum">    4552 </span>[<span class="branchCov" title="Branch 0 was taken 189100 times"> + </span><span class="branchCov" title="Branch 1 was taken 14336 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 189100 times"> + </span>]:<span class="lineCov">     203436 :         if (pindex-&gt;nStatus &amp; BLOCK_HAVE_UNDO) assert(pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA);</span>
<span class="lineNum">    4553 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 203436 times"> + </span>]:<span class="lineCov">     203436 :         assert(((pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &gt;= BLOCK_VALID_TRANSACTIONS) == (pindex-&gt;nTx &gt; 0)); // This is pruning-independent.</span>
<span class="lineNum">    4554 </span>                :            :         // All parents having had data (at some point) is equivalent to all parents being VALID_TRANSACTIONS, which is equivalent to HaveTxsDownloaded().
<span class="lineNum">    4555 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 203436 times"> + </span>]:<span class="lineCov">     203436 :         assert((pindexFirstNeverProcessed == nullptr) == pindex-&gt;HaveTxsDownloaded());</span>
<span class="lineNum">    4556 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 203436 times"> + </span>]:<span class="lineCov">     203436 :         assert((pindexFirstNotTransactionsValid == nullptr) == pindex-&gt;HaveTxsDownloaded());</span>
<span class="lineNum">    4557 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 203436 times"> + </span>]:<span class="lineCov">     203436 :         assert(pindex-&gt;nHeight == nHeight); // nHeight must be consistent.</span>
<span class="lineNum">    4558 </span>[<span class="branchCov" title="Branch 0 was taken 199530 times"> + </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 199530 times"> + </span>]:<span class="lineCov">     402966 :         assert(pindex-&gt;pprev == nullptr || pindex-&gt;nChainWork &gt;= pindex-&gt;pprev-&gt;nChainWork); // For every block except the genesis block, the chainwork must be larger than the parent's.</span>
<span class="lineNum">    4559 </span>[<span class="branchCov" title="Branch 0 was taken 195690 times"> + </span><span class="branchCov" title="Branch 1 was taken 7746 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 195690 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">     203436 :         assert(nHeight &lt; 2 || (pindex-&gt;pskip &amp;&amp; (pindex-&gt;pskip-&gt;nHeight &lt; nHeight))); // The pskip pointer must point back for all but the first 2 blocks.</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 195690 times"> + </span>]
<span class="lineNum">    4560 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 203436 times"> + </span>]:<span class="lineCov">     203436 :         assert(pindexFirstNotTreeValid == nullptr); // All mapBlockIndex entries must at least be TREE valid</span>
<span class="lineNum">    4561 </span>                :<span class="lineCov">     203436 :         if ((pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &gt;= BLOCK_VALID_TREE) assert(pindexFirstNotTreeValid == nullptr); // TREE valid implies all parents are TREE valid</span>
<span class="lineNum">    4562 </span>[<span class="branchCov" title="Branch 0 was taken 189100 times"> + </span><span class="branchCov" title="Branch 1 was taken 14336 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 189100 times"> + </span>]:<span class="lineCov">     203436 :         if ((pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &gt;= BLOCK_VALID_CHAIN) assert(pindexFirstNotChainValid == nullptr); // CHAIN valid implies all parents are CHAIN valid</span>
<span class="lineNum">    4563 </span>[<span class="branchCov" title="Branch 0 was taken 189100 times"> + </span><span class="branchCov" title="Branch 1 was taken 14336 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 189100 times"> + </span>]:<span class="lineCov">     203436 :         if ((pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &gt;= BLOCK_VALID_SCRIPTS) assert(pindexFirstNotScriptsValid == nullptr); // SCRIPTS valid implies all parents are SCRIPTS valid</span>
<span class="lineNum">    4564 </span>        [<span class="branchCov" title="Branch 0 was taken 203428 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">     203436 :         if (pindexFirstInvalid == nullptr) {</span>
<span class="lineNum">    4565 </span>                :            :             // Checks for not-invalid blocks.
<span class="lineNum">    4566 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 203428 times"> + </span>]:<span class="lineCov">     203428 :             assert((pindex-&gt;nStatus &amp; BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.</span>
<span class="lineNum">    4567 </span>                :            :         }
<span class="lineNum">    4568 </span>[<span class="branchCov" title="Branch 1 was taken 203436 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 14149 times"> + </span><span class="branchCov" title="Branch 4 was taken 189287 times"> + </span>]:<span class="lineCov">     203436 :         if (!CBlockIndexWorkComparator()(pindex, chainActive.Tip()) &amp;&amp; pindexFirstNeverProcessed == nullptr) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken 5201 times"> + </span><span class="branchCov" title="Branch 6 was taken 8948 times"> + </span>]
<span class="lineNum">    4569 </span>        [<span class="branchCov" title="Branch 0 was taken 5193 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">       5201 :             if (pindexFirstInvalid == nullptr) {</span>
<span class="lineNum">    4570 </span>                :            :                 // If this block sorts at least as good as the current tip and
<span class="lineNum">    4571 </span>                :            :                 // is valid and we have all data for its parents, it must be in
<span class="lineNum">    4572 </span>                :            :                 // setBlockIndexCandidates.  chainActive.Tip() must also be there
<span class="lineNum">    4573 </span>                :            :                 // even if some data has been pruned.
<span class="lineNum">    4574 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5193 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       5193 :                 if (pindexFirstMissing == nullptr || pindex == chainActive.Tip()) {</span>
<span class="lineNum">    4575 </span>                :<span class="lineCov">       5193 :                     assert(setBlockIndexCandidates.count(pindex));</span>
<span class="lineNum">    4576 </span>                :            :                 }
<span class="lineNum">    4577 </span>                :            :                 // If some parent is missing, then it could be that this block was in
<span class="lineNum">    4578 </span>                :            :                 // setBlockIndexCandidates but had to be removed because of the missing data.
<span class="lineNum">    4579 </span>                :            :                 // In this case it must be in mapBlocksUnlinked -- see test below.
<span class="lineNum">    4580 </span>                :            :             }
<span class="lineNum">    4581 </span>                :            :         } else { // If this block sorts worse than the current tip or some ancestor's block has never been seen, it cannot be in setBlockIndexCandidates.
<span class="lineNum">    4582 </span>                :<span class="lineCov">     198235 :             assert(setBlockIndexCandidates.count(pindex) == 0);</span>
<span class="lineNum">    4583 </span>                :            :         }
<span class="lineNum">    4584 </span>                :            :         // Check whether this block is in mapBlocksUnlinked.
<span class="lineNum">    4585 </span>                :<span class="lineCov">     406872 :         std::pair&lt;std::multimap&lt;CBlockIndex*,CBlockIndex*&gt;::iterator,std::multimap&lt;CBlockIndex*,CBlockIndex*&gt;::iterator&gt; rangeUnlinked = mapBlocksUnlinked.equal_range(pindex-&gt;pprev);</span>
<span class="lineNum">    4586 </span>                :<span class="lineCov">     203436 :         bool foundInUnlinked = false;</span>
<span class="lineNum">    4587 </span>        [<span class="branchCov" title="Branch 0 was taken 2641 times"> + </span><span class="branchCov" title="Branch 1 was taken 201097 times"> + </span>]:<span class="lineCov">     203738 :         while (rangeUnlinked.first != rangeUnlinked.second) {</span>
<span class="lineNum">    4588 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2641 times"> + </span>]:<span class="lineCov">       2641 :             assert(rangeUnlinked.first-&gt;first == pindex-&gt;pprev);</span>
<span class="lineNum">    4589 </span>        [<span class="branchCov" title="Branch 0 was taken 302 times"> + </span><span class="branchCov" title="Branch 1 was taken 2339 times"> + </span>]:<span class="lineCov">       2641 :             if (rangeUnlinked.first-&gt;second == pindex) {</span>
<span class="lineNum">    4590 </span>                :            :                 foundInUnlinked = true;
<span class="lineNum">    4591 </span>                :            :                 break;
<span class="lineNum">    4592 </span>                :            :             }
<span class="lineNum">    4593 </span>                :            :             rangeUnlinked.first++;
<span class="lineNum">    4594 </span>                :            :         }
<span class="lineNum">    4595 </span>[<span class="branchCov" title="Branch 0 was taken 199530 times"> + </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 192851 times"> + </span><span class="branchCov" title="Branch 3 was taken 6679 times"> + </span>]:<span class="lineCov">     203436 :         if (pindex-&gt;pprev &amp;&amp; (pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA) &amp;&amp; pindexFirstNeverProcessed != nullptr &amp;&amp; pindexFirstInvalid == nullptr) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 2339 times"> + </span><span class="branchCov" title="Branch 5 was taken 190512 times"> + </span>]
<span class="lineNum">    4596 </span>                :            :             // If this block has block data available, some parent was never received, and has no invalid parents, it must be in mapBlocksUnlinked.
<span class="lineNum">    4597 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2339 times"> + </span>]:<span class="lineCov">       2339 :             assert(foundInUnlinked);</span>
<span class="lineNum">    4598 </span>                :            :         }
<span class="lineNum">    4599 </span>[<span class="branchCov" title="Branch 0 was taken 6679 times"> + </span><span class="branchCov" title="Branch 1 was taken 196757 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 6679 times"> + </span>]:<span class="lineCov">     203436 :         if (!(pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA)) assert(!foundInUnlinked); // Can't be in mapBlocksUnlinked if we don't HAVE_DATA</span>
<span class="lineNum">    4600 </span>[<span class="branchCov" title="Branch 0 was taken 194418 times"> + </span><span class="branchCov" title="Branch 1 was taken 9018 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 194418 times"> + </span>]:<span class="lineCov">     203436 :         if (pindexFirstMissing == nullptr) assert(!foundInUnlinked); // We aren't missing data for any parent -- cannot be in mapBlocksUnlinked.</span>
<span class="lineNum">    4601 </span>[<span class="branchCov" title="Branch 0 was taken 199530 times"> + </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 192851 times"> + </span><span class="branchCov" title="Branch 3 was taken 6679 times"> + </span>]:<span class="lineCov">     203436 :         if (pindex-&gt;pprev &amp;&amp; (pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA) &amp;&amp; pindexFirstNeverProcessed == nullptr &amp;&amp; pindexFirstMissing != nullptr) {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 192851 times"> + </span>]
<span class="lineNum">    4602 </span>                :            :             // We HAVE_DATA for this block, have received data for all parents at some point, but we're currently missing data for some parent.
<span class="lineNum">    4603 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             assert(fHavePruned); // We must have pruned.</span>
<span class="lineNum">    4604 </span>                :            :             // This block may have entered mapBlocksUnlinked if:
<span class="lineNum">    4605 </span>                :            :             //  - it has a descendant that at some point had more work than the
<span class="lineNum">    4606 </span>                :            :             //    tip, and
<span class="lineNum">    4607 </span>                :            :             //  - we tried switching to that descendant but were missing
<span class="lineNum">    4608 </span>                :            :             //    data for some intermediate block between chainActive and the
<span class="lineNum">    4609 </span>                :            :             //    tip.
<span class="lineNum">    4610 </span>                :            :             // So if this block is itself better than chainActive.Tip() and it wasn't in
<span class="lineNum">    4611 </span>                :            :             // setBlockIndexCandidates, then it must be in mapBlocksUnlinked.
<span class="lineNum">    4612 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!CBlockIndexWorkComparator()(pindex, chainActive.Tip()) &amp;&amp; setBlockIndexCandidates.count(pindex) == 0) {</span>
<span class="lineNum">    4613 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (pindexFirstInvalid == nullptr) {</span>
<span class="lineNum">    4614 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     assert(foundInUnlinked);</span>
<span class="lineNum">    4615 </span>                :            :                 }
<span class="lineNum">    4616 </span>                :            :             }
<span class="lineNum">    4617 </span>                :            :         }
<span class="lineNum">    4618 </span>                :            :         // assert(pindex-&gt;GetBlockHash() == pindex-&gt;GetBlockHeader().GetHash()); // Perhaps too slow
<span class="lineNum">    4619 </span>                :            :         // End: actual consistency checks.
<span class="lineNum">    4620 </span>                :            : 
<span class="lineNum">    4621 </span>                :            :         // Try descending into the first subnode.
<span class="lineNum">    4622 </span>                :<span class="lineCov">     203436 :         std::pair&lt;std::multimap&lt;CBlockIndex*,CBlockIndex*&gt;::iterator,std::multimap&lt;CBlockIndex*,CBlockIndex*&gt;::iterator&gt; range = forward.equal_range(pindex);</span>
<span class="lineNum">    4623 </span>        [<span class="branchCov" title="Branch 0 was taken 198792 times"> + </span><span class="branchCov" title="Branch 1 was taken 4644 times"> + </span>]:<span class="lineCov">     203436 :         if (range.first != range.second) {</span>
<span class="lineNum">    4624 </span>                :            :             // A subnode was found.
<span class="lineNum">    4625 </span>                :<span class="lineCov">     198792 :             pindex = range.first-&gt;second;</span>
<span class="lineNum">    4626 </span>                :<span class="lineCov">     198792 :             nHeight++;</span>
<span class="lineNum">    4627 </span>                :<span class="lineCov">     198792 :             continue;</span>
<span class="lineNum">    4628 </span>                :            :         }
<span class="lineNum">    4629 </span>                :            :         // This is a leaf node.
<span class="lineNum">    4630 </span>                :            :         // Move upwards until we reach a node of which we have not yet visited the last child.
<span class="lineNum">    4631 </span>        [<span class="branchCov" title="Branch 0 was taken 203436 times"> + </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>]:<span class="lineCov">     207342 :         while (pindex) {</span>
<span class="lineNum">    4632 </span>                :            :             // We are going to either move to a parent or a sibling of pindex.
<span class="lineNum">    4633 </span>                :            :             // If pindex was the first with a certain property, unset the corresponding variable.
<span class="lineNum">    4634 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 203428 times"> + </span>]:<span class="lineCov">     203436 :             if (pindex == pindexFirstInvalid) pindexFirstInvalid = nullptr;</span>
<span class="lineNum">    4635 </span>        [<span class="branchCov" title="Branch 0 was taken 1397 times"> + </span><span class="branchCov" title="Branch 1 was taken 202039 times"> + </span>]:<span class="lineCov">     203436 :             if (pindex == pindexFirstMissing) pindexFirstMissing = nullptr;</span>
<span class="lineNum">    4636 </span>        [<span class="branchCov" title="Branch 0 was taken 1397 times"> + </span><span class="branchCov" title="Branch 1 was taken 202039 times"> + </span>]:<span class="lineCov">     203436 :             if (pindex == pindexFirstNeverProcessed) pindexFirstNeverProcessed = nullptr;</span>
<span class="lineNum">    4637 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 203436 times"> + </span>]:<span class="lineCov">     203436 :             if (pindex == pindexFirstNotTreeValid) pindexFirstNotTreeValid = nullptr;</span>
<span class="lineNum">    4638 </span>        [<span class="branchCov" title="Branch 0 was taken 1397 times"> + </span><span class="branchCov" title="Branch 1 was taken 202039 times"> + </span>]:<span class="lineCov">     203436 :             if (pindex == pindexFirstNotTransactionsValid) pindexFirstNotTransactionsValid = nullptr;</span>
<span class="lineNum">    4639 </span>        [<span class="branchCov" title="Branch 0 was taken 2654 times"> + </span><span class="branchCov" title="Branch 1 was taken 200782 times"> + </span>]:<span class="lineCov">     203436 :             if (pindex == pindexFirstNotChainValid) pindexFirstNotChainValid = nullptr;</span>
<span class="lineNum">    4640 </span>        [<span class="branchCov" title="Branch 0 was taken 2654 times"> + </span><span class="branchCov" title="Branch 1 was taken 200782 times"> + </span>]:<span class="lineCov">     203436 :             if (pindex == pindexFirstNotScriptsValid) pindexFirstNotScriptsValid = nullptr;</span>
<span class="lineNum">    4641 </span>                :            :             // Find our parent.
<span class="lineNum">    4642 </span>                :<span class="lineCov">     203436 :             CBlockIndex* pindexPar = pindex-&gt;pprev;</span>
<span class="lineNum">    4643 </span>                :            :             // Find which child we just visited.
<span class="lineNum">    4644 </span>                :<span class="lineCov">     203436 :             std::pair&lt;std::multimap&lt;CBlockIndex*,CBlockIndex*&gt;::iterator,std::multimap&lt;CBlockIndex*,CBlockIndex*&gt;::iterator&gt; rangePar = forward.equal_range(pindexPar);</span>
<span class="lineNum">    4645 </span>        [<span class="branchCov" title="Branch 0 was taken 741 times"> + </span><span class="branchCov" title="Branch 1 was taken 203436 times"> + </span>]:<span class="lineCov">     204177 :             while (rangePar.first-&gt;second != pindex) {</span>
<span class="lineNum">    4646 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 741 times"> + </span>]:<span class="lineCov">        741 :                 assert(rangePar.first != rangePar.second); // Our parent must have at least the node we're coming from as child.</span>
<span class="lineNum">    4647 </span>                :            :                 rangePar.first++;
<span class="lineNum">    4648 </span>                :            :             }
<span class="lineNum">    4649 </span>                :            :             // Proceed to the next one.
<span class="lineNum">    4650 </span>                :<span class="lineCov">     203436 :             rangePar.first++;</span>
<span class="lineNum">    4651 </span>        [<span class="branchCov" title="Branch 0 was taken 738 times"> + </span><span class="branchCov" title="Branch 1 was taken 202698 times"> + </span>]:<span class="lineCov">     203436 :             if (rangePar.first != rangePar.second) {</span>
<span class="lineNum">    4652 </span>                :            :                 // Move to the sibling.
<span class="lineNum">    4653 </span>                :<span class="lineCov">        738 :                 pindex = rangePar.first-&gt;second;</span>
<span class="lineNum">    4654 </span>                :<span class="lineCov">        738 :                 break;</span>
<span class="lineNum">    4655 </span>                :            :             } else {
<span class="lineNum">    4656 </span>                :            :                 // Move up further.
<span class="lineNum">    4657 </span>                :<span class="lineCov">     202698 :                 pindex = pindexPar;</span>
<span class="lineNum">    4658 </span>                :<span class="lineCov">     202698 :                 nHeight--;</span>
<span class="lineNum">    4659 </span>                :<span class="lineCov">     207342 :                 continue;</span>
<span class="lineNum">    4660 </span>                :            :             }
<span class="lineNum">    4661 </span>                :            :         }
<span class="lineNum">    4662 </span>                :            :     }
<span class="lineNum">    4663 </span>                :            : 
<span class="lineNum">    4664 </span>                :            :     // Check that we actually traversed the entire map.
<span class="lineNum">    4665 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3906 times"> + </span>]:<span class="lineCov">       3906 :     assert(nNodes == forward.size());</span>
<span class="lineNum">    4666 </span>                :            : }
<span class="lineNum">    4667 </span>                :            : 
<span class="lineNum">    4668 </span>                :<span class="lineCov">          2 : std::string CBlockFileInfo::ToString() const</span>
<span class="lineNum">    4669 </span>                :            : {
<span class="lineNum">    4670 </span>[<span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>][<span class="branchCov" title="Branch 5 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]:<span class="lineCov">          4 :     return strprintf(&quot;CBlockFileInfo(blocks=%u, size=%u, heights=%u...%u, time=%s...%s)&quot;, nBlocks, nSize, nHeightFirst, nHeightLast, FormatISO8601Date(nTimeFirst), FormatISO8601Date(nTimeLast));</span>
<a name="4671"><span class="lineNum">    4671 </span>                :            : }</a>
<span class="lineNum">    4672 </span>                :            : 
<span class="lineNum">    4673 </span>                :<span class="lineCov">          2 : CBlockFileInfo* GetBlockFileInfo(size_t n)</span>
<span class="lineNum">    4674 </span>                :            : {
<span class="lineNum">    4675 </span>                :<span class="lineCov">          2 :     LOCK(cs_LastBlockFile);</span>
<span class="lineNum">    4676 </span>                :            : 
<span class="lineNum">    4677 </span>                :<span class="lineCov">          2 :     return &amp;vinfoBlockFile.at(n);</span>
<a name="4678"><span class="lineNum">    4678 </span>                :            : }</a>
<span class="lineNum">    4679 </span>                :            : 
<span class="lineNum">    4680 </span>                :<span class="lineNoCov">          0 : ThresholdState VersionBitsTipState(const Consensus::Params&amp; params, Consensus::DeploymentPos pos)</span>
<span class="lineNum">    4681 </span>                :            : {
<span class="lineNum">    4682 </span>                :<span class="lineNoCov">          0 :     LOCK(cs_main);</span>
<span class="lineNum">    4683 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return VersionBitsState(chainActive.Tip(), params, pos, versionbitscache);</span>
<a name="4684"><span class="lineNum">    4684 </span>                :            : }</a>
<span class="lineNum">    4685 </span>                :            : 
<span class="lineNum">    4686 </span>                :<span class="lineNoCov">          0 : BIP9Stats VersionBitsTipStatistics(const Consensus::Params&amp; params, Consensus::DeploymentPos pos)</span>
<span class="lineNum">    4687 </span>                :            : {
<span class="lineNum">    4688 </span>                :<span class="lineNoCov">          0 :     LOCK(cs_main);</span>
<span class="lineNum">    4689 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return VersionBitsStatistics(chainActive.Tip(), params, pos);</span>
<a name="4690"><span class="lineNum">    4690 </span>                :            : }</a>
<span class="lineNum">    4691 </span>                :            : 
<span class="lineNum">    4692 </span>                :<span class="lineNoCov">          0 : int VersionBitsTipStateSinceHeight(const Consensus::Params&amp; params, Consensus::DeploymentPos pos)</span>
<span class="lineNum">    4693 </span>                :            : {
<span class="lineNum">    4694 </span>                :<span class="lineNoCov">          0 :     LOCK(cs_main);</span>
<span class="lineNum">    4695 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return VersionBitsStateSinceHeight(chainActive.Tip(), params, pos, versionbitscache);</span>
<span class="lineNum">    4696 </span>                :            : }
<span class="lineNum">    4697 </span>                :            : 
<span class="lineNum">    4698 </span>                :            : static const uint64_t MEMPOOL_DUMP_VERSION = 1;
<span class="lineNum">    4699 </span>                :            : 
<span class="lineNum">    4700 </span>                :<span class="lineNoCov">          0 : bool LoadMempool()</span>
<span class="lineNum">    4701 </span>                :            : {
<span class="lineNum">    4702 </span>                :<span class="lineNoCov">          0 :     const CChainParams&amp; chainparams = Params();</span>
<span class="lineNum">    4703 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :     int64_t nExpiryTimeout = gArgs.GetArg(&quot;-mempoolexpiry&quot;, DEFAULT_MEMPOOL_EXPIRY) * 60 * 60;</span>
<span class="lineNum">    4704 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :     FILE* filestr = fsbridge::fopen(GetDataDir() / &quot;mempool.dat&quot;, &quot;rb&quot;);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">    4705 </span>                :<span class="lineNoCov">          0 :     CAutoFile file(filestr, SER_DISK, CLIENT_VERSION);</span>
<span class="lineNum">    4706 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (file.IsNull()) {</span>
<span class="lineNum">    4707 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LogPrintf(&quot;Failed to open mempool file from disk. Continuing anyway.\n&quot;);</span>
<span class="lineNum">    4708 </span>                :            :         return false;
<span class="lineNum">    4709 </span>                :            :     }
<span class="lineNum">    4710 </span>                :            : 
<span class="lineNum">    4711 </span>                :<span class="lineNoCov">          0 :     int64_t count = 0;</span>
<span class="lineNum">    4712 </span>                :<span class="lineNoCov">          0 :     int64_t expired = 0;</span>
<span class="lineNum">    4713 </span>                :<span class="lineNoCov">          0 :     int64_t failed = 0;</span>
<span class="lineNum">    4714 </span>                :<span class="lineNoCov">          0 :     int64_t already_there = 0;</span>
<span class="lineNum">    4715 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     int64_t nNow = GetTime();</span>
<span class="lineNum">    4716 </span>                :            : 
<span class="lineNum">    4717 </span>                :            :     try {
<span class="lineNum">    4718 </span>                :            :         uint64_t version;
<span class="lineNum">    4719 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         file &gt;&gt; version;</span>
<span class="lineNum">    4720 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (version != MEMPOOL_DUMP_VERSION) {</span>
<span class="lineNum">    4721 </span>                :<span class="lineNoCov">          0 :             return false;</span>
<span class="lineNum">    4722 </span>                :            :         }
<span class="lineNum">    4723 </span>                :            :         uint64_t num;
<span class="lineNum">    4724 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         file &gt;&gt; num;</span>
<span class="lineNum">    4725 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while (num--) {</span>
<span class="lineNum">    4726 </span>                :<span class="lineNoCov">          0 :             CTransactionRef tx;</span>
<span class="lineNum">    4727 </span>                :            :             int64_t nTime;
<span class="lineNum">    4728 </span>                :            :             int64_t nFeeDelta;
<span class="lineNum">    4729 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             file &gt;&gt; tx;</span>
<span class="lineNum">    4730 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             file &gt;&gt; nTime;</span>
<span class="lineNum">    4731 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             file &gt;&gt; nFeeDelta;</span>
<span class="lineNum">    4732 </span>                :            : 
<span class="lineNum">    4733 </span>                :<span class="lineNoCov">          0 :             CAmount amountdelta = nFeeDelta;</span>
<span class="lineNum">    4734 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (amountdelta) {</span>
<span class="lineNum">    4735 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 mempool.PrioritiseTransaction(tx-&gt;GetHash(), amountdelta);</span>
<span class="lineNum">    4736 </span>                :            :             }
<span class="lineNum">    4737 </span>                :<span class="lineNoCov">          0 :             CValidationState state;</span>
<span class="lineNum">    4738 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (nTime + nExpiryTimeout &gt; nNow) {</span>
<span class="lineNum">    4739 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 LOCK(cs_main);</span>
<span class="lineNum">    4740 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 AcceptToMemoryPoolWithTime(chainparams, mempool, state, tx, nullptr /* pfMissingInputs */, nTime,</span>
<span class="lineNum">    4741 </span>                :            :                                            nullptr /* plTxnReplaced */, false /* bypass_limits */, 0 /* nAbsurdFee */,
<span class="lineNum">    4742 </span>                :            :                                            false /* test_accept */);
<span class="lineNum">    4743 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (state.IsValid()) {</span>
<span class="lineNum">    4744 </span>                :<span class="lineNoCov">          0 :                     ++count;</span>
<span class="lineNum">    4745 </span>                :            :                 } else {
<span class="lineNum">    4746 </span>                :            :                     // mempool may contain the transaction already, e.g. from
<span class="lineNum">    4747 </span>                :            :                     // wallet(s) having loaded it while we were processing
<span class="lineNum">    4748 </span>                :            :                     // mempool transactions; consider these as valid, instead of
<span class="lineNum">    4749 </span>                :            :                     // failed, but mark them as 'already there'
<span class="lineNum">    4750 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if (mempool.exists(tx-&gt;GetHash())) {</span>
<span class="lineNum">    4751 </span>                :<span class="lineNoCov">          0 :                         ++already_there;</span>
<span class="lineNum">    4752 </span>                :            :                     } else {
<span class="lineNum">    4753 </span>                :<span class="lineNoCov">          0 :                         ++failed;</span>
<span class="lineNum">    4754 </span>                :            :                     }
<span class="lineNum">    4755 </span>                :            :                 }
<span class="lineNum">    4756 </span>                :            :             } else {
<span class="lineNum">    4757 </span>                :<span class="lineNoCov">          0 :                 ++expired;</span>
<span class="lineNum">    4758 </span>                :            :             }
<span class="lineNum">    4759 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (ShutdownRequested())</span>
<span class="lineNum">    4760 </span>                :<span class="lineNoCov">          0 :                 return false;</span>
<span class="lineNum">    4761 </span>                :            :         }
<span class="lineNum">    4762 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         std::map&lt;uint256, CAmount&gt; mapDeltas;</span>
<span class="lineNum">    4763 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         file &gt;&gt; mapDeltas;</span>
<span class="lineNum">    4764 </span>                :            : 
<span class="lineNum">    4765 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (const auto&amp; i : mapDeltas) {</span>
<span class="lineNum">    4766 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             mempool.PrioritiseTransaction(i.first, i.second);</span>
<span class="lineNum">    4767 </span>                :            :         }
<span class="lineNum">    4768 </span>                :<span class="lineNoCov">          0 :     } catch (const std::exception&amp; e) {</span>
<span class="lineNum">    4769 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LogPrintf(&quot;Failed to deserialize mempool data on disk: %s. Continuing anyway.\n&quot;, e.what());</span>
<span class="lineNum">    4770 </span>                :            :         return false;
<span class="lineNum">    4771 </span>                :            :     }
<span class="lineNum">    4772 </span>                :            : 
<span class="lineNum">    4773 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LogPrintf(&quot;Imported mempool transactions from disk: %i succeeded, %i failed, %i expired, %i already there\n&quot;, count, failed, expired, already_there);</span>
<span class="lineNum">    4774 </span>                :            :     return true;
<span class="lineNum">    4775 </span>                :            : }
<span class="lineNum">    4776 </span>                :            : 
<span class="lineNum">    4777 </span>                :<span class="lineNoCov">          0 : bool DumpMempool()</span>
<span class="lineNum">    4778 </span>                :            : {
<span class="lineNum">    4779 </span>                :<span class="lineNoCov">          0 :     int64_t start = GetTimeMicros();</span>
<span class="lineNum">    4780 </span>                :            : 
<span class="lineNum">    4781 </span>                :<span class="lineNoCov">          0 :     std::map&lt;uint256, CAmount&gt; mapDeltas;</span>
<span class="lineNum">    4782 </span>                :<span class="lineNoCov">          0 :     std::vector&lt;TxMempoolInfo&gt; vinfo;</span>
<span class="lineNum">    4783 </span>                :            : 
<span class="lineNum">    4784 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     static Mutex dump_mutex;</span>
<span class="lineNum">    4785 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LOCK(dump_mutex);</span>
<span class="lineNum">    4786 </span>                :            : 
<span class="lineNum">    4787 </span>                :            :     {
<span class="lineNum">    4788 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LOCK(mempool.cs);</span>
<span class="lineNum">    4789 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (const auto &amp;i : mempool.mapDeltas) {</span>
<span class="lineNum">    4790 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             mapDeltas[i.first] = i.second;</span>
<span class="lineNum">    4791 </span>                :            :         }
<span class="lineNum">    4792 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         vinfo = mempool.infoAll();</span>
<span class="lineNum">    4793 </span>                :            :     }
<span class="lineNum">    4794 </span>                :            : 
<span class="lineNum">    4795 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     int64_t mid = GetTimeMicros();</span>
<span class="lineNum">    4796 </span>                :            : 
<span class="lineNum">    4797 </span>                :            :     try {
<span class="lineNum">    4798 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         FILE* filestr = fsbridge::fopen(GetDataDir() / &quot;mempool.dat.new&quot;, &quot;wb&quot;);</span>
<span class="lineNum">         </span>  [<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span><span class="branchNoExec" title="Branch 10 was not executed"> # </span>]
<span class="lineNum">    4799 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!filestr) {</span>
<span class="lineNum">    4800 </span>                :<span class="lineNoCov">          0 :             return false;</span>
<span class="lineNum">    4801 </span>                :            :         }
<span class="lineNum">    4802 </span>                :            : 
<span class="lineNum">    4803 </span>                :<span class="lineNoCov">          0 :         CAutoFile file(filestr, SER_DISK, CLIENT_VERSION);</span>
<span class="lineNum">    4804 </span>                :            : 
<span class="lineNum">    4805 </span>                :<span class="lineNoCov">          0 :         uint64_t version = MEMPOOL_DUMP_VERSION;</span>
<span class="lineNum">    4806 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         file &lt;&lt; version;</span>
<span class="lineNum">    4807 </span>                :            : 
<span class="lineNum">    4808 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         file &lt;&lt; (uint64_t)vinfo.size();</span>
<span class="lineNum">    4809 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (const auto&amp; i : vinfo) {</span>
<span class="lineNum">    4810 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             file &lt;&lt; *(i.tx);</span>
<span class="lineNum">    4811 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             file &lt;&lt; (int64_t)i.nTime;</span>
<span class="lineNum">    4812 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             file &lt;&lt; (int64_t)i.nFeeDelta;</span>
<span class="lineNum">    4813 </span>                :<span class="lineNoCov">          0 :             mapDeltas.erase(i.tx-&gt;GetHash());</span>
<span class="lineNum">    4814 </span>                :            :         }
<span class="lineNum">    4815 </span>                :            : 
<span class="lineNum">    4816 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         file &lt;&lt; mapDeltas;</span>
<span class="lineNum">    4817 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!FileCommit(file.Get()))</span>
<span class="lineNum">    4818 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             throw std::runtime_error(&quot;FileCommit failed&quot;);</span>
<span class="lineNum">    4819 </span>                :<span class="lineNoCov">          0 :         file.fclose();</span>
<span class="lineNum">    4820 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         RenameOver(GetDataDir() / &quot;mempool.dat.new&quot;, GetDataDir() / &quot;mempool.dat&quot;);</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>][<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>]
<span class="lineNum">    4821 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         int64_t last = GetTimeMicros();</span>
<span class="lineNum">    4822 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LogPrintf(&quot;Dumped mempool: %gs to copy, %gs to dump\n&quot;, (mid-start)*MICRO, (last-mid)*MICRO);</span>
<span class="lineNum">    4823 </span>                :<span class="lineNoCov">          0 :     } catch (const std::exception&amp; e) {</span>
<span class="lineNum">    4824 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LogPrintf(&quot;Failed to dump mempool: %s. Continuing anyway.\n&quot;, e.what());</span>
<span class="lineNum">    4825 </span>                :            :         return false;
<span class="lineNum">    4826 </span>                :            :     }
<span class="lineNum">    4827 </span>                :<span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">    4828 </span>                :            : }
<span class="lineNum">    4829 </span>                :            : 
<a name="4830"><span class="lineNum">    4830 </span>                :            : //! Guess how far we are in the verification process at the given block index</a>
<span class="lineNum">    4831 </span>                :            : //! require cs_main if pindex has not been validated yet (because nChainTx might be unset)
<span class="lineNum">    4832 </span>                :<span class="lineCov">       1565 : double GuessVerificationProgress(const ChainTxData&amp; data, const CBlockIndex *pindex) {</span>
<span class="lineNum">    4833 </span>        [<span class="branchCov" title="Branch 0 was taken 1564 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">       1565 :     if (pindex == nullptr)</span>
<span class="lineNum">    4834 </span>                :            :         return 0.0;
<span class="lineNum">    4835 </span>                :            : 
<span class="lineNum">    4836 </span>                :<span class="lineCov">       1564 :     int64_t nNow = time(nullptr);</span>
<span class="lineNum">    4837 </span>                :            : 
<span class="lineNum">    4838 </span>                :            :     double fTxTotal;
<span class="lineNum">    4839 </span>                :            : 
<span class="lineNum">    4840 </span>        [<span class="branchCov" title="Branch 0 was taken 157 times"> + </span><span class="branchCov" title="Branch 1 was taken 1407 times"> + </span>]:<span class="lineCov">       1564 :     if (pindex-&gt;nChainTx &lt;= data.nTxCount) {</span>
<span class="lineNum">    4841 </span>                :<span class="lineCov">        157 :         fTxTotal = data.nTxCount + (nNow - data.nTime) * data.dTxRate;</span>
<span class="lineNum">    4842 </span>                :            :     } else {
<span class="lineNum">    4843 </span>                :<span class="lineCov">       1407 :         fTxTotal = pindex-&gt;nChainTx + (nNow - pindex-&gt;GetBlockTime()) * data.dTxRate;</span>
<span class="lineNum">    4844 </span>                :            :     }
<span class="lineNum">    4845 </span>                :            : 
<span class="lineNum">    4846 </span>                :<span class="lineCov">       1564 :     return pindex-&gt;nChainTx / fTxTotal;</span>
<span class="lineNum">    4847 </span>                :            : }
<span class="lineNum">    4848 </span>                :            : 
<span class="lineNum">    4849 </span>                :            : class CMainCleanup
<span class="lineNum">    4850 </span>                :            : {
<a name="4851"><span class="lineNum">    4851 </span>                :            : public:</a>
<span class="lineNum">    4852 </span>                :            :     CMainCleanup() {}
<span class="lineNum">    4853 </span>                :<span class="lineCov">         73 :     ~CMainCleanup() {</span>
<span class="lineNum">    4854 </span>                :            :         // block headers
<span class="lineNum">    4855 </span>                :<span class="lineCov">         73 :         BlockMap::iterator it1 = mapBlockIndex.begin();</span>
<span class="lineNum">    4856 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 73 times"> + </span>]:<span class="lineCov">         73 :         for (; it1 != mapBlockIndex.end(); it1++)</span>
<span class="lineNum">    4857 </span>                :<span class="lineNoCov">          0 :             delete (*it1).second;</span>
<a name="4858"><span class="lineNum">    4858 </span>                :<span class="lineCov">        146 :         mapBlockIndex.clear();</span></a>
<span class="lineNum">    4859 </span>                :<span class="lineCov">         73 :     }</span>
<span class="lineNum">    4860 </span>[<span class="branchCov" title="Branch 1 was taken 73 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 73 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        365 : } instance_of_cmaincleanup;</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
