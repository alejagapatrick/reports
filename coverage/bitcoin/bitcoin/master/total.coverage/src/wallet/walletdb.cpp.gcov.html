<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - total_coverage.info - src/wallet/walletdb.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">src/wallet</a> - walletdb.cpp<span style="font-size: 80%;"> (source / <a href="walletdb.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">total_coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">253</td>
            <td class="headerCovTableEntry">357</td>
            <td class="headerCovTableEntryLo">70.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2000-01-01 12:00:00</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">33</td>
            <td class="headerCovTableEntry">43</td>
            <td class="headerCovTableEntryMed">76.7 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">230</td>
            <td class="headerCovTableEntry">498</td>
            <td class="headerCovTableEntryLo">46.2 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : // Copyright (c) 2009-2010 Satoshi Nakamoto</a>
<span class="lineNum">       2 </span>                :            : // Copyright (c) 2009-2018 The Bitcoin Core developers
<span class="lineNum">       3 </span>                :            : // Distributed under the MIT software license, see the accompanying
<span class="lineNum">       4 </span>                :            : // file COPYING or http://www.opensource.org/licenses/mit-license.php.
<span class="lineNum">       5 </span>                :            : 
<span class="lineNum">       6 </span>                :            : #include &lt;wallet/walletdb.h&gt;
<span class="lineNum">       7 </span>                :            : 
<span class="lineNum">       8 </span>                :            : #include &lt;consensus/tx_verify.h&gt;
<span class="lineNum">       9 </span>                :            : #include &lt;consensus/validation.h&gt;
<span class="lineNum">      10 </span>                :            : #include &lt;fs.h&gt;
<span class="lineNum">      11 </span>                :            : #include &lt;key_io.h&gt;
<span class="lineNum">      12 </span>                :            : #include &lt;protocol.h&gt;
<span class="lineNum">      13 </span>                :            : #include &lt;serialize.h&gt;
<span class="lineNum">      14 </span>                :            : #include &lt;sync.h&gt;
<span class="lineNum">      15 </span>                :            : #include &lt;util/system.h&gt;
<span class="lineNum">      16 </span>                :            : #include &lt;util/time.h&gt;
<span class="lineNum">      17 </span>                :            : #include &lt;wallet/wallet.h&gt;
<span class="lineNum">      18 </span>                :            : 
<span class="lineNum">      19 </span>                :            : #include &lt;atomic&gt;
<span class="lineNum">      20 </span>                :            : #include &lt;string&gt;
<span class="lineNum">      21 </span>                :            : 
<span class="lineNum">      22 </span>                :            : #include &lt;boost/thread.hpp&gt;
<span class="lineNum">      23 </span>                :            : 
<span class="lineNum">      24 </span>                :            : //
<span class="lineNum">      25 </span>                :            : // WalletBatch
<a name="26"><span class="lineNum">      26 </span>                :            : //</a>
<span class="lineNum">      27 </span>                :            : 
<span class="lineNum">      28 </span>                :<span class="lineCov">       2690 : bool WalletBatch::WriteName(const std::string&amp; strAddress, const std::string&amp; strName)</span>
<span class="lineNum">      29 </span>                :            : {
<span class="lineNum">      30 </span>[<span class="branchCov" title="Branch 1 was taken 2690 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 2690 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       8070 :     return WriteIC(std::make_pair(std::string(&quot;name&quot;), strAddress), strName);</span>
<a name="31"><span class="lineNum">      31 </span>                :            : }</a>
<span class="lineNum">      32 </span>                :            : 
<span class="lineNum">      33 </span>                :<span class="lineNoCov">          0 : bool WalletBatch::EraseName(const std::string&amp; strAddress)</span>
<span class="lineNum">      34 </span>                :            : {
<span class="lineNum">      35 </span>                :            :     // This should only be used for sending addresses, never for receiving addresses,
<span class="lineNum">      36 </span>                :            :     // receiving addresses must always have an address book entry if they're not change return.
<span class="lineNum">      37 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return EraseIC(std::make_pair(std::string(&quot;name&quot;), strAddress));</span>
<a name="38"><span class="lineNum">      38 </span>                :            : }</a>
<span class="lineNum">      39 </span>                :            : 
<span class="lineNum">      40 </span>                :<span class="lineCov">       2690 : bool WalletBatch::WritePurpose(const std::string&amp; strAddress, const std::string&amp; strPurpose)</span>
<span class="lineNum">      41 </span>                :            : {
<span class="lineNum">      42 </span>[<span class="branchCov" title="Branch 1 was taken 2690 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 2690 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       8070 :     return WriteIC(std::make_pair(std::string(&quot;purpose&quot;), strAddress), strPurpose);</span>
<a name="43"><span class="lineNum">      43 </span>                :            : }</a>
<span class="lineNum">      44 </span>                :            : 
<span class="lineNum">      45 </span>                :<span class="lineNoCov">          0 : bool WalletBatch::ErasePurpose(const std::string&amp; strAddress)</span>
<span class="lineNum">      46 </span>                :            : {
<span class="lineNum">      47 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return EraseIC(std::make_pair(std::string(&quot;purpose&quot;), strAddress));</span>
<a name="48"><span class="lineNum">      48 </span>                :            : }</a>
<span class="lineNum">      49 </span>                :            : 
<span class="lineNum">      50 </span>                :<span class="lineCov">     129997 : bool WalletBatch::WriteTx(const CWalletTx&amp; wtx)</span>
<span class="lineNum">      51 </span>                :            : {
<span class="lineNum">      52 </span>[<span class="branchCov" title="Branch 1 was taken 129997 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 129997 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">     389991 :     return WriteIC(std::make_pair(std::string(&quot;tx&quot;), wtx.GetHash()), wtx);</span>
<a name="53"><span class="lineNum">      53 </span>                :            : }</a>
<span class="lineNum">      54 </span>                :            : 
<span class="lineNum">      55 </span>                :<span class="lineCov">        514 : bool WalletBatch::EraseTx(uint256 hash)</span>
<span class="lineNum">      56 </span>                :            : {
<span class="lineNum">      57 </span>[<span class="branchCov" title="Branch 1 was taken 514 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 514 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       1542 :     return EraseIC(std::make_pair(std::string(&quot;tx&quot;), hash));</span>
<a name="58"><span class="lineNum">      58 </span>                :            : }</a>
<span class="lineNum">      59 </span>                :            : 
<span class="lineNum">      60 </span>                :<span class="lineCov">      10847 : bool WalletBatch::WriteKeyMetadata(const CKeyMetadata&amp; meta, const CPubKey&amp; pubkey, const bool overwrite)</span>
<span class="lineNum">      61 </span>                :            : {
<span class="lineNum">      62 </span>[<span class="branchCov" title="Branch 1 was taken 10847 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 10847 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">      32541 :     return WriteIC(std::make_pair(std::string(&quot;keymeta&quot;), pubkey), meta, overwrite);</span>
<span class="lineNum">      63 </span>                :            : }
<span class="lineNum">      64 </span>                :            : 
<span class="lineNum">      65 </span>                :<span class="lineCov">      10091 : bool WalletBatch::WriteKey(const CPubKey&amp; vchPubKey, const CPrivKey&amp; vchPrivKey, const CKeyMetadata&amp; keyMeta)</span>
<span class="lineNum">      66 </span>                :            : {
<span class="lineNum">      67 </span>        [<span class="branchCov" title="Branch 1 was taken 10091 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      10091 :     if (!WriteKeyMetadata(keyMeta, vchPubKey, false)) {</span>
<span class="lineNum">      68 </span>                :            :         return false;
<span class="lineNum">      69 </span>                :            :     }
<span class="lineNum">      70 </span>                :            : 
<span class="lineNum">      71 </span>                :            :     // hash pubkey/privkey to accelerate wallet load
<span class="lineNum">      72 </span>                :<span class="lineCov">      10091 :     std::vector&lt;unsigned char&gt; vchKey;</span>
<span class="lineNum">      73 </span>        [<span class="branchCov" title="Branch 1 was taken 10091 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      10091 :     vchKey.reserve(vchPubKey.size() + vchPrivKey.size());</span>
<span class="lineNum">      74 </span>        [<span class="branchCov" title="Branch 1 was taken 10091 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      10091 :     vchKey.insert(vchKey.end(), vchPubKey.begin(), vchPubKey.end());</span>
<span class="lineNum">      75 </span>        [<span class="branchCov" title="Branch 1 was taken 10091 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      10091 :     vchKey.insert(vchKey.end(), vchPrivKey.begin(), vchPrivKey.end());</span>
<span class="lineNum">      76 </span>                :            : 
<span class="lineNum">      77 </span>[<span class="branchCov" title="Branch 1 was taken 10091 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 10091 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">      30273 :     return WriteIC(std::make_pair(std::string(&quot;key&quot;), vchPubKey), std::make_pair(vchPrivKey, Hash(vchKey.begin(), vchKey.end())), false);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 10091 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<a name="78"><span class="lineNum">      78 </span>                :            : }</a>
<span class="lineNum">      79 </span>                :            : 
<span class="lineNum">      80 </span>                :<span class="lineCov">        741 : bool WalletBatch::WriteCryptedKey(const CPubKey&amp; vchPubKey,</span>
<span class="lineNum">      81 </span>                :            :                                 const std::vector&lt;unsigned char&gt;&amp; vchCryptedSecret,
<span class="lineNum">      82 </span>                :            :                                 const CKeyMetadata &amp;keyMeta)
<span class="lineNum">      83 </span>                :            : {
<span class="lineNum">      84 </span>        [<span class="branchCov" title="Branch 1 was taken 741 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        741 :     if (!WriteKeyMetadata(keyMeta, vchPubKey, true)) {</span>
<span class="lineNum">      85 </span>                :            :         return false;
<span class="lineNum">      86 </span>                :            :     }
<span class="lineNum">      87 </span>                :            : 
<span class="lineNum">      88 </span>[<span class="branchCov" title="Branch 1 was taken 741 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 741 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       2223 :     if (!WriteIC(std::make_pair(std::string(&quot;ckey&quot;), vchPubKey), vchCryptedSecret, false)) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 741 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">      89 </span>                :            :         return false;
<span class="lineNum">      90 </span>                :            :     }
<span class="lineNum">      91 </span>[<span class="branchCov" title="Branch 1 was taken 741 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 741 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       1482 :     EraseIC(std::make_pair(std::string(&quot;key&quot;), vchPubKey));</span>
<span class="lineNum">      92 </span>[<span class="branchCov" title="Branch 1 was taken 741 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 741 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       1482 :     EraseIC(std::make_pair(std::string(&quot;wkey&quot;), vchPubKey));</span>
<span class="lineNum">      93 </span>                :<span class="lineCov">        741 :     return true;</span>
<a name="94"><span class="lineNum">      94 </span>                :            : }</a>
<span class="lineNum">      95 </span>                :            : 
<span class="lineNum">      96 </span>                :<span class="lineCov">         13 : bool WalletBatch::WriteMasterKey(unsigned int nID, const CMasterKey&amp; kMasterKey)</span>
<span class="lineNum">      97 </span>                :            : {
<span class="lineNum">      98 </span>[<span class="branchCov" title="Branch 1 was taken 13 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 13 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         39 :     return WriteIC(std::make_pair(std::string(&quot;mkey&quot;), nID), kMasterKey, true);</span>
<a name="99"><span class="lineNum">      99 </span>                :            : }</a>
<span class="lineNum">     100 </span>                :            : 
<span class="lineNum">     101 </span>                :<span class="lineCov">       2439 : bool WalletBatch::WriteCScript(const uint160&amp; hash, const CScript&amp; redeemScript)</span>
<span class="lineNum">     102 </span>                :            : {
<span class="lineNum">     103 </span>[<span class="branchCov" title="Branch 1 was taken 2439 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 2439 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       7317 :     return WriteIC(std::make_pair(std::string(&quot;cscript&quot;), hash), redeemScript, false);</span>
<a name="104"><span class="lineNum">     104 </span>                :            : }</a>
<span class="lineNum">     105 </span>                :            : 
<span class="lineNum">     106 </span>                :<span class="lineCov">        227 : bool WalletBatch::WriteWatchOnly(const CScript &amp;dest, const CKeyMetadata&amp; keyMeta)</span>
<span class="lineNum">     107 </span>                :            : {
<span class="lineNum">     108 </span>  [<span class="branchCov" title="Branch 1 was taken 227 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 227 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        681 :     if (!WriteIC(std::make_pair(std::string(&quot;watchmeta&quot;), dest), keyMeta)) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 227 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">     109 </span>                :            :         return false;
<span class="lineNum">     110 </span>                :            :     }
<span class="lineNum">     111 </span>  [<span class="branchCov" title="Branch 1 was taken 227 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 227 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        681 :     return WriteIC(std::make_pair(std::string(&quot;watchs&quot;), dest), '1');</span>
<a name="112"><span class="lineNum">     112 </span>                :            : }</a>
<span class="lineNum">     113 </span>                :            : 
<span class="lineNum">     114 </span>                :<span class="lineCov">          8 : bool WalletBatch::EraseWatchOnly(const CScript &amp;dest)</span>
<span class="lineNum">     115 </span>                :            : {
<span class="lineNum">     116 </span>  [<span class="branchCov" title="Branch 1 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         24 :     if (!EraseIC(std::make_pair(std::string(&quot;watchmeta&quot;), dest))) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">     117 </span>                :            :         return false;
<span class="lineNum">     118 </span>                :            :     }
<span class="lineNum">     119 </span>  [<span class="branchCov" title="Branch 1 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         24 :     return EraseIC(std::make_pair(std::string(&quot;watchs&quot;), dest));</span>
<span class="lineNum">     120 </span>                :            : }
<span class="lineNum">     121 </span>                :            : 
<span class="lineNum">     122 </span>                :<span class="lineCov">        739 : bool WalletBatch::WriteBestBlock(const CBlockLocator&amp; locator)</span>
<span class="lineNum">     123 </span>                :            : {
<span class="lineNum">     124 </span>[<span class="branchCov" title="Branch 1 was taken 739 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 739 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        739 :     WriteIC(std::string(&quot;bestblock&quot;), CBlockLocator()); // Write empty block locator so versions that require a merkle branch automatically rescan</span>
<span class="lineNum">     125 </span>[<span class="branchCov" title="Branch 1 was taken 739 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 739 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       1478 :     return WriteIC(std::string(&quot;bestblock_nomerkle&quot;), locator);</span>
<span class="lineNum">     126 </span>                :            : }
<span class="lineNum">     127 </span>                :            : 
<span class="lineNum">     128 </span>                :<span class="lineCov">        458 : bool WalletBatch::ReadBestBlock(CBlockLocator&amp; locator)</span>
<span class="lineNum">     129 </span>                :            : {
<span class="lineNum">     130 </span>[<span class="branchCov" title="Branch 2 was taken 458 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 457 times"> + </span><span class="branchCov" title="Branch 5 was taken 1 time"> + </span>]:<span class="lineCov">        916 :     if (m_batch.Read(std::string(&quot;bestblock&quot;), locator) &amp;&amp; !locator.vHave.empty()) return true;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 6 was taken 457 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>][<span class="branchCov" title="Branch 8 was taken 458 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>]
<span class="lineNum">     131 </span>[<span class="branchCov" title="Branch 1 was taken 458 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 458 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        916 :     return m_batch.Read(std::string(&quot;bestblock_nomerkle&quot;), locator);</span>
<a name="132"><span class="lineNum">     132 </span>                :            : }</a>
<span class="lineNum">     133 </span>                :            : 
<span class="lineNum">     134 </span>                :<span class="lineCov">     128070 : bool WalletBatch::WriteOrderPosNext(int64_t nOrderPosNext)</span>
<span class="lineNum">     135 </span>                :            : {
<span class="lineNum">     136 </span>[<span class="branchCov" title="Branch 1 was taken 128070 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 128070 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">     256140 :     return WriteIC(std::string(&quot;orderposnext&quot;), nOrderPosNext);</span>
<a name="137"><span class="lineNum">     137 </span>                :            : }</a>
<span class="lineNum">     138 </span>                :            : 
<span class="lineNum">     139 </span>                :<span class="lineCov">       2936 : bool WalletBatch::ReadPool(int64_t nPool, CKeyPool&amp; keypool)</span>
<span class="lineNum">     140 </span>                :            : {
<span class="lineNum">     141 </span>[<span class="branchCov" title="Branch 1 was taken 2936 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 2936 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       8808 :     return m_batch.Read(std::make_pair(std::string(&quot;pool&quot;), nPool), keypool);</span>
<a name="142"><span class="lineNum">     142 </span>                :            : }</a>
<span class="lineNum">     143 </span>                :            : 
<span class="lineNum">     144 </span>                :<span class="lineCov">       9180 : bool WalletBatch::WritePool(int64_t nPool, const CKeyPool&amp; keypool)</span>
<span class="lineNum">     145 </span>                :            : {
<span class="lineNum">     146 </span>[<span class="branchCov" title="Branch 1 was taken 9180 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 9180 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">      27540 :     return WriteIC(std::make_pair(std::string(&quot;pool&quot;), nPool), keypool);</span>
<a name="147"><span class="lineNum">     147 </span>                :            : }</a>
<span class="lineNum">     148 </span>                :            : 
<span class="lineNum">     149 </span>                :<span class="lineCov">       2589 : bool WalletBatch::ErasePool(int64_t nPool)</span>
<span class="lineNum">     150 </span>                :            : {
<span class="lineNum">     151 </span>[<span class="branchCov" title="Branch 1 was taken 2589 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 2589 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       7767 :     return EraseIC(std::make_pair(std::string(&quot;pool&quot;), nPool));</span>
<a name="152"><span class="lineNum">     152 </span>                :            : }</a>
<span class="lineNum">     153 </span>                :            : 
<span class="lineNum">     154 </span>                :<span class="lineCov">        281 : bool WalletBatch::WriteMinVersion(int nVersion)</span>
<span class="lineNum">     155 </span>                :            : {
<span class="lineNum">     156 </span>[<span class="branchCov" title="Branch 1 was taken 281 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 281 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        562 :     return WriteIC(std::string(&quot;minversion&quot;), nVersion);</span>
<span class="lineNum">     157 </span>                :            : }
<span class="lineNum">     158 </span>                :            : 
<span class="lineNum">     159 </span>                :<span class="lineCov">        968 : class CWalletScanState {</span>
<span class="lineNum">     160 </span>                :            : public:
<span class="lineNum">     161 </span>                :            :     unsigned int nKeys{0};
<span class="lineNum">     162 </span>                :            :     unsigned int nCKeys{0};
<span class="lineNum">     163 </span>                :            :     unsigned int nWatchKeys{0};
<span class="lineNum">     164 </span>                :            :     unsigned int nKeyMeta{0};
<span class="lineNum">     165 </span>                :            :     unsigned int m_unknown_records{0};
<span class="lineNum">     166 </span>                :            :     bool fIsEncrypted{false};
<span class="lineNum">     167 </span>                :            :     bool fAnyUnordered{false};
<span class="lineNum">     168 </span>                :            :     int nFileVersion{0};
<span class="lineNum">     169 </span>                :            :     std::vector&lt;uint256&gt; vWalletUpgrade;
<span class="lineNum">     170 </span>                :            : 
<span class="lineNum">     171 </span>                :<span class="lineCov">        968 :     CWalletScanState() {</span>
<span class="lineNum">     172 </span>                :            :     }
<span class="lineNum">     173 </span>                :            : };
<span class="lineNum">     174 </span>                :            : 
<span class="lineNum">     175 </span>                :            : static bool
<span class="lineNum">     176 </span>                :<span class="lineCov">      23477 : ReadKeyValue(CWallet* pwallet, CDataStream&amp; ssKey, CDataStream&amp; ssValue,</span>
<span class="lineNum">     177 </span>                :            :              CWalletScanState &amp;wss, std::string&amp; strType, std::string&amp; strErr) EXCLUSIVE_LOCKS_REQUIRED(pwallet-&gt;cs_wallet)
<span class="lineNum">     178 </span>                :            : {
<span class="lineNum">     179 </span>                :            :     try {
<span class="lineNum">     180 </span>                :            :         // Unserialize
<span class="lineNum">     181 </span>                :            :         // Taking advantage of the fact that pair serialization
<span class="lineNum">     182 </span>                :            :         // is just the two items serialized one after the other
<span class="lineNum">     183 </span>                :<span class="lineCov">      23477 :         ssKey &gt;&gt; strType;</span>
<span class="lineNum">     184 </span>        [<span class="branchCov" title="Branch 0 was taken 970 times"> + </span><span class="branchCov" title="Branch 1 was taken 22507 times"> + </span>]:<span class="lineCov">      23477 :         if (strType == &quot;name&quot;)</span>
<span class="lineNum">     185 </span>                :            :         {
<span class="lineNum">     186 </span>                :<span class="lineCov">        970 :             std::string strAddress;</span>
<span class="lineNum">     187 </span>                :<span class="lineCov">        970 :             ssKey &gt;&gt; strAddress;</span>
<span class="lineNum">     188 </span>[<span class="branchCov" title="Branch 1 was taken 970 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 970 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        970 :             ssValue &gt;&gt; pwallet-&gt;mapAddressBook[DecodeDestination(strAddress)].name;</span>
<span class="lineNum">     189 </span>                :            :         }
<span class="lineNum">     190 </span>        [<span class="branchCov" title="Branch 0 was taken 970 times"> + </span><span class="branchCov" title="Branch 1 was taken 21537 times"> + </span>]:<span class="lineCov">      22507 :         else if (strType == &quot;purpose&quot;)</span>
<span class="lineNum">     191 </span>                :            :         {
<span class="lineNum">     192 </span>                :<span class="lineCov">        970 :             std::string strAddress;</span>
<span class="lineNum">     193 </span>                :<span class="lineCov">        970 :             ssKey &gt;&gt; strAddress;</span>
<span class="lineNum">     194 </span>[<span class="branchCov" title="Branch 1 was taken 970 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 970 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        970 :             ssValue &gt;&gt; pwallet-&gt;mapAddressBook[DecodeDestination(strAddress)].purpose;</span>
<span class="lineNum">     195 </span>                :            :         }
<span class="lineNum">     196 </span>        [<span class="branchCov" title="Branch 0 was taken 5644 times"> + </span><span class="branchCov" title="Branch 1 was taken 15893 times"> + </span>]:<span class="lineCov">      21537 :         else if (strType == &quot;tx&quot;)</span>
<span class="lineNum">     197 </span>                :            :         {
<span class="lineNum">     198 </span>                :<span class="lineCov">       5644 :             uint256 hash;</span>
<span class="lineNum">     199 </span>                :<span class="lineCov">       5644 :             ssKey &gt;&gt; hash;</span>
<span class="lineNum">     200 </span>                :<span class="lineCov">      11288 :             CWalletTx wtx(nullptr /* pwallet */, MakeTransactionRef());</span>
<span class="lineNum">     201 </span>                :<span class="lineCov">       5644 :             ssValue &gt;&gt; wtx;</span>
<span class="lineNum">     202 </span>                :<span class="lineCov">       5644 :             CValidationState state;</span>
<span class="lineNum">     203 </span>[<span class="branchCov" title="Branch 1 was taken 5644 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 5644 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       5644 :             if (!(CheckTransaction(*wtx.tx, state) &amp;&amp; (wtx.GetHash() == hash) &amp;&amp; state.IsValid()))</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 5644 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>][<span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchCov" title="Branch 8 was taken 5644 times"> + </span>]
<span class="lineNum">     204 </span>                :<span class="lineNoCov">          0 :                 return false;</span>
<span class="lineNum">     205 </span>                :            : 
<span class="lineNum">     206 </span>                :            :             // Undo serialize changes in 31600
<span class="lineNum">     207 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5644 times"> + </span>]:<span class="lineCov">       5644 :             if (31404 &lt;= wtx.fTimeReceivedIsTxTime &amp;&amp; wtx.fTimeReceivedIsTxTime &lt;= 31703)</span>
<span class="lineNum">     208 </span>                :            :             {
<span class="lineNum">     209 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (!ssValue.empty())</span>
<span class="lineNum">     210 </span>                :            :                 {
<span class="lineNum">     211 </span>                :            :                     char fTmp;
<span class="lineNum">     212 </span>                :            :                     char fUnused;
<span class="lineNum">     213 </span>                :<span class="lineNoCov">          0 :                     std::string unused_string;</span>
<span class="lineNum">     214 </span>                :<span class="lineNoCov">          0 :                     ssValue &gt;&gt; fTmp &gt;&gt; fUnused &gt;&gt; unused_string;</span>
<span class="lineNum">     215 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     strErr = strprintf(&quot;LoadWallet() upgrading tx ver=%d %d %s&quot;,</span>
<span class="lineNum">     216 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                        wtx.fTimeReceivedIsTxTime, fTmp, hash.ToString());</span>
<span class="lineNum">     217 </span>                :<span class="lineNoCov">          0 :                     wtx.fTimeReceivedIsTxTime = fTmp;</span>
<span class="lineNum">     218 </span>                :            :                 }
<span class="lineNum">     219 </span>                :            :                 else
<span class="lineNum">     220 </span>                :            :                 {
<span class="lineNum">     221 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     strErr = strprintf(&quot;LoadWallet() repairing tx ver=%d %s&quot;, wtx.fTimeReceivedIsTxTime, hash.ToString());</span>
<span class="lineNum">     222 </span>                :<span class="lineNoCov">          0 :                     wtx.fTimeReceivedIsTxTime = 0;</span>
<span class="lineNum">     223 </span>                :            :                 }
<span class="lineNum">     224 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 wss.vWalletUpgrade.push_back(hash);</span>
<span class="lineNum">     225 </span>                :            :             }
<span class="lineNum">     226 </span>                :            : 
<span class="lineNum">     227 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5644 times"> + </span>]:<span class="lineCov">       5644 :             if (wtx.nOrderPos == -1)</span>
<span class="lineNum">     228 </span>                :<span class="lineNoCov">          0 :                 wss.fAnyUnordered = true;</span>
<span class="lineNum">     229 </span>                :            : 
<span class="lineNum">     230 </span>        [<span class="branchCov" title="Branch 1 was taken 5644 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       5644 :             pwallet-&gt;LoadToWallet(wtx);</span>
<span class="lineNum">     231 </span>                :            :         }
<span class="lineNum">     232 </span>        [<span class="branchCov" title="Branch 0 was taken 57 times"> + </span><span class="branchCov" title="Branch 1 was taken 15836 times"> + </span>]:<span class="lineCov">      15893 :         else if (strType == &quot;watchs&quot;)</span>
<span class="lineNum">     233 </span>                :            :         {
<span class="lineNum">     234 </span>                :<span class="lineCov">         57 :             wss.nWatchKeys++;</span>
<span class="lineNum">     235 </span>                :<span class="lineCov">         57 :             CScript script;</span>
<span class="lineNum">     236 </span>                :<span class="lineCov">         57 :             ssKey &gt;&gt; script;</span>
<span class="lineNum">     237 </span>                :            :             char fYes;
<span class="lineNum">     238 </span>                :<span class="lineCov">         57 :             ssValue &gt;&gt; fYes;</span>
<span class="lineNum">     239 </span>        [<span class="branchCov" title="Branch 0 was taken 57 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         57 :             if (fYes == '1')</span>
<span class="lineNum">     240 </span>        [<span class="branchCov" title="Branch 1 was taken 57 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         57 :                 pwallet-&gt;LoadWatchOnly(script);</span>
<span class="lineNum">     241 </span>                :            :         }
<span class="lineNum">     242 </span>  [<span class="branchCov" title="Branch 0 was taken 11050 times"> + </span><span class="branchCov" title="Branch 1 was taken 4786 times"> + </span><span class="branchCov" title="Branch 2 was taken 11050 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      26886 :         else if (strType == &quot;key&quot; || strType == &quot;wkey&quot;)</span>
<span class="lineNum">     243 </span>                :            :         {
<span class="lineNum">     244 </span>                :<span class="lineCov">       4786 :             CPubKey vchPubKey;</span>
<span class="lineNum">     245 </span>                :<span class="lineCov">       4786 :             ssKey &gt;&gt; vchPubKey;</span>
<span class="lineNum">     246 </span>                :<span class="lineNoCov">          0 :             if (!vchPubKey.IsValid())</span>
<span class="lineNum">     247 </span>                :            :             {
<span class="lineNum">     248 </span>                :            :                 strErr = &quot;Error reading wallet database: CPubKey corrupt&quot;;
<span class="lineNum">     249 </span>                :<span class="lineNoCov">          0 :                 return false;</span>
<span class="lineNum">     250 </span>                :            :             }
<span class="lineNum">     251 </span>        [<span class="branchCov" title="Branch 1 was taken 4786 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       9572 :             CKey key;</span>
<span class="lineNum">     252 </span>                :<span class="lineNoCov">          0 :             CPrivKey pkey;</span>
<span class="lineNum">     253 </span>                :<span class="lineCov">       4786 :             uint256 hash;</span>
<span class="lineNum">     254 </span>                :            : 
<span class="lineNum">     255 </span>        [<span class="branchCov" title="Branch 0 was taken 4786 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       4786 :             if (strType == &quot;key&quot;)</span>
<span class="lineNum">     256 </span>                :            :             {
<span class="lineNum">     257 </span>                :<span class="lineCov">       4786 :                 wss.nKeys++;</span>
<span class="lineNum">     258 </span>                :            :                 ssValue &gt;&gt; pkey;
<span class="lineNum">     259 </span>                :            :             } else {
<span class="lineNum">     260 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 CWalletKey wkey;</span>
<span class="lineNum">     261 </span>                :<span class="lineNoCov">          0 :                 ssValue &gt;&gt; wkey;</span>
<span class="lineNum">     262 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 pkey = wkey.vchPrivKey;</span>
<span class="lineNum">     263 </span>                :            :             }
<span class="lineNum">     264 </span>                :            : 
<span class="lineNum">     265 </span>                :            :             // Old wallets store keys as &quot;key&quot; [pubkey] =&gt; [privkey]
<span class="lineNum">     266 </span>                :            :             // ... which was slow for wallets with lots of keys, because the public key is re-derived from the private key
<span class="lineNum">     267 </span>                :            :             // using EC operations as a checksum.
<span class="lineNum">     268 </span>                :            :             // Newer wallets store keys as &quot;key&quot;[pubkey] =&gt; [privkey][hash(pubkey,privkey)], which is much faster while
<span class="lineNum">     269 </span>                :            :             // remaining backwards-compatible.
<span class="lineNum">     270 </span>                :            :             try
<span class="lineNum">     271 </span>                :            :             {
<span class="lineNum">     272 </span>                :            :                 ssValue &gt;&gt; hash;
<span class="lineNum">     273 </span>                :            :             }
<span class="lineNum">     274 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             catch (...) {}</span>
<span class="lineNum">     275 </span>                :            : 
<span class="lineNum">     276 </span>                :<span class="lineCov">       4786 :             bool fSkipCheck = false;</span>
<span class="lineNum">     277 </span>                :            : 
<span class="lineNum">     278 </span>        [<span class="branchCov" title="Branch 0 was taken 4786 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       4786 :             if (!hash.IsNull())</span>
<span class="lineNum">     279 </span>                :            :             {
<span class="lineNum">     280 </span>                :            :                 // hash pubkey/privkey to accelerate wallet load
<span class="lineNum">     281 </span>                :<span class="lineCov">       4786 :                 std::vector&lt;unsigned char&gt; vchKey;</span>
<span class="lineNum">     282 </span>        [<span class="branchCov" title="Branch 1 was taken 4786 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       4786 :                 vchKey.reserve(vchPubKey.size() + pkey.size());</span>
<span class="lineNum">     283 </span>        [<span class="branchCov" title="Branch 1 was taken 4786 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       4786 :                 vchKey.insert(vchKey.end(), vchPubKey.begin(), vchPubKey.end());</span>
<span class="lineNum">     284 </span>        [<span class="branchCov" title="Branch 1 was taken 4786 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       4786 :                 vchKey.insert(vchKey.end(), pkey.begin(), pkey.end());</span>
<span class="lineNum">     285 </span>                :            : 
<span class="lineNum">     286 </span>[<span class="branchCov" title="Branch 1 was taken 4786 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 4786 times"> + </span>]:<span class="lineCov">       4786 :                 if (Hash(vchKey.begin(), vchKey.end()) != hash)</span>
<span class="lineNum">     287 </span>                :            :                 {
<span class="lineNum">     288 </span>                :<span class="lineNoCov">          0 :                     strErr = &quot;Error reading wallet database: CPubKey/CPrivKey corrupt&quot;;</span>
<span class="lineNum">     289 </span>                :<span class="lineNoCov">          0 :                     return false;</span>
<span class="lineNum">     290 </span>                :            :                 }
<span class="lineNum">     291 </span>                :            : 
<span class="lineNum">     292 </span>                :<span class="lineCov">       4786 :                 fSkipCheck = true;</span>
<span class="lineNum">     293 </span>                :            :             }
<span class="lineNum">     294 </span>                :            : 
<span class="lineNum">     295 </span>[<span class="branchCov" title="Branch 1 was taken 4786 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 4786 times"> + </span>]:<span class="lineCov">       4786 :             if (!key.Load(pkey, vchPubKey, fSkipCheck))</span>
<span class="lineNum">     296 </span>                :            :             {
<span class="lineNum">     297 </span>                :            :                 strErr = &quot;Error reading wallet database: CPrivKey corrupt&quot;;
<span class="lineNum">     298 </span>                :            :                 return false;
<span class="lineNum">     299 </span>                :            :             }
<span class="lineNum">     300 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4786 times"> + </span>]:<span class="lineCov">       4786 :             if (!pwallet-&gt;LoadKey(key, vchPubKey))</span>
<span class="lineNum">     301 </span>                :            :             {
<span class="lineNum">     302 </span>                :            :                 strErr = &quot;Error reading wallet database: LoadKey failed&quot;;
<span class="lineNum">     303 </span>                :            :                 return false;
<span class="lineNum">     304 </span>                :            :             }
<span class="lineNum">     305 </span>                :            :         }
<span class="lineNum">     306 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 11045 times"> + </span>]:<span class="lineCov">      11050 :         else if (strType == &quot;mkey&quot;)</span>
<span class="lineNum">     307 </span>                :            :         {
<span class="lineNum">     308 </span>                :            :             unsigned int nID;
<span class="lineNum">     309 </span>                :<span class="lineCov">          5 :             ssKey &gt;&gt; nID;</span>
<span class="lineNum">     310 </span>                :<span class="lineCov">         10 :             CMasterKey kMasterKey;</span>
<span class="lineNum">     311 </span>                :<span class="lineCov">          5 :             ssValue &gt;&gt; kMasterKey;</span>
<span class="lineNum">     312 </span>                :<span class="lineCov">         10 :             if(pwallet-&gt;mapMasterKeys.count(nID) != 0)</span>
<span class="lineNum">     313 </span>                :            :             {
<span class="lineNum">     314 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 strErr = strprintf(&quot;Error reading wallet database: duplicate CMasterKey id %u&quot;, nID);</span>
<span class="lineNum">     315 </span>                :<span class="lineNoCov">          0 :                 return false;</span>
<span class="lineNum">     316 </span>                :            :             }
<span class="lineNum">     317 </span>[<span class="branchCov" title="Branch 1 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          5 :             pwallet-&gt;mapMasterKeys[nID] = kMasterKey;</span>
<span class="lineNum">     318 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          5 :             if (pwallet-&gt;nMasterKeyMaxID &lt; nID)</span>
<span class="lineNum">     319 </span>                :<span class="lineCov">          5 :                 pwallet-&gt;nMasterKeyMaxID = nID;</span>
<span class="lineNum">     320 </span>                :            :         }
<span class="lineNum">     321 </span>        [<span class="branchCov" title="Branch 0 was taken 51 times"> + </span><span class="branchCov" title="Branch 1 was taken 10994 times"> + </span>]:<span class="lineCov">      11045 :         else if (strType == &quot;ckey&quot;)</span>
<span class="lineNum">     322 </span>                :            :         {
<span class="lineNum">     323 </span>                :<span class="lineCov">         51 :             CPubKey vchPubKey;</span>
<span class="lineNum">     324 </span>                :<span class="lineCov">         51 :             ssKey &gt;&gt; vchPubKey;</span>
<span class="lineNum">     325 </span>                :<span class="lineNoCov">          0 :             if (!vchPubKey.IsValid())</span>
<span class="lineNum">     326 </span>                :            :             {
<span class="lineNum">     327 </span>                :            :                 strErr = &quot;Error reading wallet database: CPubKey corrupt&quot;;
<span class="lineNum">     328 </span>                :<span class="lineNoCov">          0 :                 return false;</span>
<span class="lineNum">     329 </span>                :            :             }
<span class="lineNum">     330 </span>                :<span class="lineCov">         51 :             std::vector&lt;unsigned char&gt; vchPrivKey;</span>
<span class="lineNum">     331 </span>                :<span class="lineCov">         51 :             ssValue &gt;&gt; vchPrivKey;</span>
<span class="lineNum">     332 </span>                :<span class="lineCov">         51 :             wss.nCKeys++;</span>
<span class="lineNum">     333 </span>                :            : 
<span class="lineNum">     334 </span>[<span class="branchCov" title="Branch 1 was taken 51 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 51 times"> + </span>]:<span class="lineCov">         51 :             if (!pwallet-&gt;LoadCryptedKey(vchPubKey, vchPrivKey))</span>
<span class="lineNum">     335 </span>                :            :             {
<span class="lineNum">     336 </span>                :<span class="lineNoCov">          0 :                 strErr = &quot;Error reading wallet database: LoadCryptedKey failed&quot;;</span>
<span class="lineNum">     337 </span>                :<span class="lineNoCov">          0 :                 return false;</span>
<span class="lineNum">     338 </span>                :            :             }
<span class="lineNum">     339 </span>                :<span class="lineCov">         51 :             wss.fIsEncrypted = true;</span>
<span class="lineNum">     340 </span>                :            :         }
<span class="lineNum">     341 </span>        [<span class="branchCov" title="Branch 0 was taken 4842 times"> + </span><span class="branchCov" title="Branch 1 was taken 6152 times"> + </span>]:<span class="lineCov">      10994 :         else if (strType == &quot;keymeta&quot;)</span>
<span class="lineNum">     342 </span>                :            :         {
<span class="lineNum">     343 </span>                :<span class="lineCov">       4842 :             CPubKey vchPubKey;</span>
<span class="lineNum">     344 </span>                :<span class="lineCov">       4842 :             ssKey &gt;&gt; vchPubKey;</span>
<span class="lineNum">     345 </span>                :<span class="lineCov">       9684 :             CKeyMetadata keyMeta;</span>
<span class="lineNum">     346 </span>                :<span class="lineCov">       4842 :             ssValue &gt;&gt; keyMeta;</span>
<span class="lineNum">     347 </span>                :<span class="lineCov">       4842 :             wss.nKeyMeta++;</span>
<span class="lineNum">     348 </span>[<span class="branchCov" title="Branch 1 was taken 4842 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 4842 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       4842 :             pwallet-&gt;LoadKeyMetadata(vchPubKey.GetID(), keyMeta);</span>
<span class="lineNum">     349 </span>                :            :         }
<span class="lineNum">     350 </span>        [<span class="branchCov" title="Branch 0 was taken 57 times"> + </span><span class="branchCov" title="Branch 1 was taken 6095 times"> + </span>]:<span class="lineCov">       6152 :         else if (strType == &quot;watchmeta&quot;)</span>
<span class="lineNum">     351 </span>                :            :         {
<span class="lineNum">     352 </span>                :<span class="lineCov">         57 :             CScript script;</span>
<span class="lineNum">     353 </span>                :<span class="lineCov">         57 :             ssKey &gt;&gt; script;</span>
<span class="lineNum">     354 </span>                :<span class="lineCov">        114 :             CKeyMetadata keyMeta;</span>
<span class="lineNum">     355 </span>                :<span class="lineCov">         57 :             ssValue &gt;&gt; keyMeta;</span>
<span class="lineNum">     356 </span>                :<span class="lineCov">         57 :             wss.nKeyMeta++;</span>
<span class="lineNum">     357 </span>[<span class="branchCov" title="Branch 1 was taken 57 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 57 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         57 :             pwallet-&gt;LoadScriptMetadata(CScriptID(script), keyMeta);</span>
<span class="lineNum">     358 </span>                :            :         }
<span class="lineNum">     359 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6095 times"> + </span>]:<span class="lineCov">       6095 :         else if (strType == &quot;defaultkey&quot;)</span>
<span class="lineNum">     360 </span>                :            :         {
<span class="lineNum">     361 </span>                :            :             // We don't want or need the default key, but if there is one set,
<span class="lineNum">     362 </span>                :            :             // we want to make sure that it is valid so that we can detect corruption
<span class="lineNum">     363 </span>                :<span class="lineNoCov">          0 :             CPubKey vchPubKey;</span>
<span class="lineNum">     364 </span>                :<span class="lineNoCov">          0 :             ssValue &gt;&gt; vchPubKey;</span>
<span class="lineNum">     365 </span>                :<span class="lineNoCov">          0 :             if (!vchPubKey.IsValid()) {</span>
<span class="lineNum">     366 </span>                :<span class="lineNoCov">          0 :                 strErr = &quot;Error reading wallet database: Default Key corrupt&quot;;</span>
<span class="lineNum">     367 </span>                :<span class="lineNoCov">          0 :                 return false;</span>
<span class="lineNum">     368 </span>                :            :             }
<span class="lineNum">     369 </span>                :            :         }
<span class="lineNum">     370 </span>        [<span class="branchCov" title="Branch 0 was taken 3714 times"> + </span><span class="branchCov" title="Branch 1 was taken 2381 times"> + </span>]:<span class="lineCov">       6095 :         else if (strType == &quot;pool&quot;)</span>
<span class="lineNum">     371 </span>                :            :         {
<span class="lineNum">     372 </span>                :            :             int64_t nIndex;
<span class="lineNum">     373 </span>                :<span class="lineCov">       3714 :             ssKey &gt;&gt; nIndex;</span>
<span class="lineNum">     374 </span>        [<span class="branchCov" title="Branch 1 was taken 3714 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       3714 :             CKeyPool keypool;</span>
<span class="lineNum">     375 </span>                :<span class="lineCov">       3714 :             ssValue &gt;&gt; keypool;</span>
<span class="lineNum">     376 </span>                :            : 
<span class="lineNum">     377 </span>        [<span class="branchCov" title="Branch 1 was taken 3714 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       3714 :             pwallet-&gt;LoadKeyPool(nIndex, keypool);</span>
<span class="lineNum">     378 </span>                :            :         }
<span class="lineNum">     379 </span>        [<span class="branchCov" title="Branch 0 was taken 484 times"> + </span><span class="branchCov" title="Branch 1 was taken 1897 times"> + </span>]:<span class="lineCov">       2381 :         else if (strType == &quot;version&quot;)</span>
<span class="lineNum">     380 </span>                :            :         {
<span class="lineNum">     381 </span>                :<span class="lineCov">        968 :             ssValue &gt;&gt; wss.nFileVersion;</span>
<span class="lineNum">     382 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 484 times"> + </span>]:<span class="lineCov">        484 :             if (wss.nFileVersion == 10300)</span>
<span class="lineNum">     383 </span>                :<span class="lineNoCov">          0 :                 wss.nFileVersion = 300;</span>
<span class="lineNum">     384 </span>                :            :         }
<span class="lineNum">     385 </span>        [<span class="branchCov" title="Branch 0 was taken 824 times"> + </span><span class="branchCov" title="Branch 1 was taken 1073 times"> + </span>]:<span class="lineCov">       1897 :         else if (strType == &quot;cscript&quot;)</span>
<span class="lineNum">     386 </span>                :            :         {
<span class="lineNum">     387 </span>                :<span class="lineCov">        824 :             uint160 hash;</span>
<span class="lineNum">     388 </span>                :<span class="lineCov">        824 :             ssKey &gt;&gt; hash;</span>
<span class="lineNum">     389 </span>                :<span class="lineCov">        824 :             CScript script;</span>
<span class="lineNum">     390 </span>                :<span class="lineCov">        824 :             ssValue &gt;&gt; script;</span>
<span class="lineNum">     391 </span>[<span class="branchCov" title="Branch 1 was taken 824 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 824 times"> + </span>]:<span class="lineCov">        824 :             if (!pwallet-&gt;LoadCScript(script))</span>
<span class="lineNum">     392 </span>                :            :             {
<span class="lineNum">     393 </span>                :<span class="lineNoCov">          0 :                 strErr = &quot;Error reading wallet database: LoadCScript failed&quot;;</span>
<span class="lineNum">     394 </span>                :<span class="lineNoCov">          0 :                 return false;</span>
<span class="lineNum">     395 </span>                :            :             }
<span class="lineNum">     396 </span>                :            :         }
<span class="lineNum">     397 </span>        [<span class="branchCov" title="Branch 0 was taken 100 times"> + </span><span class="branchCov" title="Branch 1 was taken 973 times"> + </span>]:<span class="lineCov">       1073 :         else if (strType == &quot;orderposnext&quot;)</span>
<span class="lineNum">     398 </span>                :            :         {
<span class="lineNum">     399 </span>                :<span class="lineCov">        100 :             ssValue &gt;&gt; pwallet-&gt;nOrderPosNext;</span>
<span class="lineNum">     400 </span>                :            :         }
<span class="lineNum">     401 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 973 times"> + </span>]:<span class="lineCov">        973 :         else if (strType == &quot;destdata&quot;)</span>
<span class="lineNum">     402 </span>                :            :         {
<span class="lineNum">     403 </span>                :<span class="lineNoCov">          0 :             std::string strAddress, strKey, strValue;</span>
<span class="lineNum">     404 </span>                :<span class="lineNoCov">          0 :             ssKey &gt;&gt; strAddress;</span>
<span class="lineNum">     405 </span>                :<span class="lineNoCov">          0 :             ssKey &gt;&gt; strKey;</span>
<span class="lineNum">     406 </span>                :<span class="lineNoCov">          0 :             ssValue &gt;&gt; strValue;</span>
<span class="lineNum">     407 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             pwallet-&gt;LoadDestData(DecodeDestination(strAddress), strKey, strValue);</span>
<span class="lineNum">     408 </span>                :            :         }
<span class="lineNum">     409 </span>        [<span class="branchCov" title="Branch 0 was taken 195 times"> + </span><span class="branchCov" title="Branch 1 was taken 778 times"> + </span>]:<span class="lineCov">        973 :         else if (strType == &quot;hdchain&quot;)</span>
<span class="lineNum">     410 </span>                :            :         {
<span class="lineNum">     411 </span>                :<span class="lineCov">        195 :             CHDChain chain;</span>
<span class="lineNum">     412 </span>                :<span class="lineCov">        195 :             ssValue &gt;&gt; chain;</span>
<span class="lineNum">     413 </span>        [<span class="branchCov" title="Branch 1 was taken 195 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        195 :             pwallet-&gt;SetHDChain(chain, true);</span>
<span class="lineNum">     414 </span>        [<span class="branchCov" title="Branch 0 was taken 195 times"> + </span><span class="branchCov" title="Branch 1 was taken 583 times"> + </span>]:<span class="lineCov">        778 :         } else if (strType == &quot;flags&quot;) {</span>
<span class="lineNum">     415 </span>                :            :             uint64_t flags;
<span class="lineNum">     416 </span>                :<span class="lineCov">        195 :             ssValue &gt;&gt; flags;</span>
<span class="lineNum">     417 </span>[<span class="branchCov" title="Branch 1 was taken 195 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 195 times"> + </span>]:<span class="lineCov">        195 :             if (!pwallet-&gt;SetWalletFlags(flags, true)) {</span>
<span class="lineNum">     418 </span>                :            :                 strErr = &quot;Error reading wallet database: Unknown non-tolerable wallet flags found&quot;;
<span class="lineNum">     419 </span>                :            :                 return false;
<span class="lineNum">     420 </span>                :            :             }
<span class="lineNum">     421 </span>  [<span class="branchCov" title="Branch 0 was taken 195 times"> + </span><span class="branchCov" title="Branch 1 was taken 194 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 195 times"> + </span>]:<span class="lineCov">        584 :         } else if (strType != &quot;bestblock&quot; &amp;&amp; strType != &quot;bestblock_nomerkle&quot; &amp;&amp;</span>
<span class="lineNum">     422 </span>  [<span class="branchCov" title="Branch 0 was taken 389 times"> + </span><span class="branchCov" title="Branch 1 was taken 194 times"> + </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">        583 :                 strType != &quot;minversion&quot; &amp;&amp; strType != &quot;acentry&quot;) {</span>
<span class="lineNum">     423 </span>                :<span class="lineCov">      23477 :             wss.m_unknown_records++;</span>
<span class="lineNum">     424 </span>                :            :         }
<span class="lineNum">     425 </span>                :<span class="lineNoCov">          0 :     } catch (...)</span>
<span class="lineNum">     426 </span>                :            :     {
<span class="lineNum">     427 </span>                :            :         return false;
<span class="lineNum">     428 </span>                :            :     }
<span class="lineNum">     429 </span>                :            :     return true;
<a name="430"><span class="lineNum">     430 </span>                :            : }</a>
<span class="lineNum">     431 </span>                :            : 
<span class="lineNum">     432 </span>                :<span class="lineNoCov">          0 : bool WalletBatch::IsKeyType(const std::string&amp; strType)</span>
<span class="lineNum">     433 </span>                :            : {
<span class="lineNum">     434 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return (strType== &quot;key&quot; || strType == &quot;wkey&quot; ||</span>
<span class="lineNum">     435 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             strType == &quot;mkey&quot; || strType == &quot;ckey&quot;);</span>
<span class="lineNum">     436 </span>                :            : }
<span class="lineNum">     437 </span>                :            : 
<span class="lineNum">     438 </span>                :<span class="lineCov">        484 : DBErrors WalletBatch::LoadWallet(CWallet* pwallet)</span>
<span class="lineNum">     439 </span>                :            : {
<span class="lineNum">     440 </span>                :<span class="lineCov">        484 :     CWalletScanState wss;</span>
<span class="lineNum">     441 </span>                :<span class="lineCov">        484 :     bool fNoncriticalErrors = false;</span>
<span class="lineNum">     442 </span>                :<span class="lineCov">        484 :     DBErrors result = DBErrors::LOAD_OK;</span>
<span class="lineNum">     443 </span>                :            : 
<span class="lineNum">     444 </span>        [<span class="branchCov" title="Branch 1 was taken 484 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        484 :     LOCK(pwallet-&gt;cs_wallet);</span>
<span class="lineNum">     445 </span>                :            :     try {
<span class="lineNum">     446 </span>                :<span class="lineCov">        484 :         int nMinVersion = 0;</span>
<span class="lineNum">     447 </span>[<span class="branchCov" title="Branch 1 was taken 484 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 484 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        968 :         if (m_batch.Read((std::string)&quot;minversion&quot;, nMinVersion))</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 195 times"> + </span><span class="branchCov" title="Branch 7 was taken 289 times"> + </span>]
<span class="lineNum">     448 </span>                :            :         {
<span class="lineNum">     449 </span>        [<span class="branchCov" title="Branch 0 was taken 195 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        195 :             if (nMinVersion &gt; FEATURE_LATEST)</span>
<span class="lineNum">     450 </span>                :<span class="lineNoCov">          0 :                 return DBErrors::TOO_NEW;</span>
<span class="lineNum">     451 </span>                :<span class="lineCov">        195 :             pwallet-&gt;LoadMinVersion(nMinVersion);</span>
<span class="lineNum">     452 </span>                :            :         }
<span class="lineNum">     453 </span>                :            : 
<span class="lineNum">     454 </span>                :            :         // Get cursor
<span class="lineNum">     455 </span>                :<span class="lineNoCov">          0 :         Dbc* pcursor = m_batch.GetCursor();</span>
<span class="lineNum">     456 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 484 times"> + </span>]:<span class="lineCov">        484 :         if (!pcursor)</span>
<span class="lineNum">     457 </span>                :            :         {
<span class="lineNum">     458 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :             pwallet-&gt;WalletLogPrintf(&quot;Error getting wallet database cursor\n&quot;);</span>
<span class="lineNum">     459 </span>                :<span class="lineNoCov">          0 :             return DBErrors::CORRUPT;</span>
<span class="lineNum">     460 </span>                :            :         }
<span class="lineNum">     461 </span>                :            : 
<span class="lineNum">     462 </span>                :            :         while (true)
<span class="lineNum">     463 </span>                :            :         {
<span class="lineNum">     464 </span>                :            :             // Read next record
<span class="lineNum">     465 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineCov">      23477 :             CDataStream ssKey(SER_DISK, CLIENT_VERSION);</span>
<span class="lineNum">     466 </span>                :<span class="lineNoCov">          0 :             CDataStream ssValue(SER_DISK, CLIENT_VERSION);</span>
<span class="lineNum">     467 </span>        [<span class="branchCov" title="Branch 1 was taken 23961 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      23961 :             int ret = m_batch.ReadAtCursor(pcursor, ssKey, ssValue);</span>
<span class="lineNum">     468 </span>        [<span class="branchCov" title="Branch 0 was taken 23477 times"> + </span><span class="branchCov" title="Branch 1 was taken 484 times"> + </span>]:<span class="lineCov">      23961 :             if (ret == DB_NOTFOUND)</span>
<span class="lineNum">     469 </span>                :            :                 break;
<span class="lineNum">     470 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 23477 times"> + </span>]:<span class="lineCov">      23477 :             else if (ret != 0)</span>
<span class="lineNum">     471 </span>                :            :             {
<span class="lineNum">     472 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 pwallet-&gt;WalletLogPrintf(&quot;Error reading next record from wallet database\n&quot;);</span>
<span class="lineNum">     473 </span>                :<span class="lineNoCov">          0 :                 return DBErrors::CORRUPT;</span>
<span class="lineNum">     474 </span>                :            :             }
<span class="lineNum">     475 </span>                :            : 
<span class="lineNum">     476 </span>                :            :             // Try to be tolerant of single corrupt records:
<span class="lineNum">     477 </span>                :<span class="lineNoCov">          0 :             std::string strType, strErr;</span>
<span class="lineNum">     478 </span>[<span class="branchCov" title="Branch 1 was taken 23477 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 23477 times"> + </span>]:<span class="lineCov">      23477 :             if (!ReadKeyValue(pwallet, ssKey, ssValue, wss, strType, strErr))</span>
<span class="lineNum">     479 </span>                :            :             {
<span class="lineNum">     480 </span>                :            :                 // losing keys is considered a catastrophic error, anything else
<span class="lineNum">     481 </span>                :            :                 // we assume the user can live with:
<span class="lineNum">     482 </span>  [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (IsKeyType(strType) || strType == &quot;defaultkey&quot;) {</span>
<span class="lineNum">     483 </span>                :            :                     result = DBErrors::CORRUPT;
<span class="lineNum">     484 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 } else if(strType == &quot;flags&quot;) {</span>
<span class="lineNum">     485 </span>                :            :                     // reading the wallet flags can only fail if unknown flags are present
<span class="lineNum">     486 </span>                :            :                     result = DBErrors::TOO_NEW;
<span class="lineNum">     487 </span>                :            :                 } else {
<span class="lineNum">     488 </span>                :            :                     // Leave other errors alone, if we try to fix them we might make things worse.
<span class="lineNum">     489 </span>                :<span class="lineNoCov">          0 :                     fNoncriticalErrors = true; // ... but do warn the user there is something wrong.</span>
<span class="lineNum">     490 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if (strType == &quot;tx&quot;)</span>
<span class="lineNum">     491 </span>                :            :                         // Rescan if there is a bad transaction record:
<span class="lineNum">     492 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         gArgs.SoftSetBoolArg(&quot;-rescan&quot;, true);</span>
<span class="lineNum">     493 </span>                :            :                 }
<span class="lineNum">     494 </span>                :            :             }
<span class="lineNum">     495 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 23477 times"> + </span>]:<span class="lineCov">      23477 :             if (!strErr.empty())</span>
<span class="lineNum">     496 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 pwallet-&gt;WalletLogPrintf(&quot;%s\n&quot;, strErr);</span>
<span class="lineNum">     497 </span>                :            :         }
<span class="lineNum">     498 </span>        [<span class="branchCov" title="Branch 1 was taken 484 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        484 :         pcursor-&gt;close();</span>
<span class="lineNum">     499 </span>                :            :     }
<span class="lineNum">     500 </span>                :<span class="lineNoCov">          0 :     catch (const boost::thread_interrupted&amp;) {</span>
<span class="lineNum">     501 </span>                :<span class="lineNoCov">          0 :         throw;</span>
<span class="lineNum">     502 </span>                :            :     }
<span class="lineNum">     503 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     catch (...) {</span>
<span class="lineNum">     504 </span>                :<span class="lineNoCov">          0 :         result = DBErrors::CORRUPT;</span>
<span class="lineNum">     505 </span>                :            :     }
<span class="lineNum">     506 </span>                :            : 
<span class="lineNum">     507 </span>        [<span class="branchCov" title="Branch 0 was taken 484 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        484 :     if (fNoncriticalErrors &amp;&amp; result == DBErrors::LOAD_OK)</span>
<span class="lineNum">     508 </span>                :            :         result = DBErrors::NONCRITICAL_ERROR;
<span class="lineNum">     509 </span>                :            : 
<span class="lineNum">     510 </span>                :            :     // Any wallet corruption at all: skip any rewriting or
<span class="lineNum">     511 </span>                :            :     // upgrading, we don't want to make it worse.
<span class="lineNum">     512 </span>        [<span class="branchCov" title="Branch 0 was taken 484 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        484 :     if (result != DBErrors::LOAD_OK)</span>
<span class="lineNum">     513 </span>                :            :         return result;
<span class="lineNum">     514 </span>                :            : 
<span class="lineNum">     515 </span>[<span class="branchCov" title="Branch 1 was taken 484 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 484 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        484 :     pwallet-&gt;WalletLogPrintf(&quot;nFileVersion = %d\n&quot;, wss.nFileVersion);</span>
<span class="lineNum">     516 </span>                :            : 
<span class="lineNum">     517 </span>[<span class="branchCov" title="Branch 1 was taken 484 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 484 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">        484 :     pwallet-&gt;WalletLogPrintf(&quot;Keys: %u plaintext, %u encrypted, %u w/ metadata, %u total. Unknown wallet records: %u\n&quot;,</span>
<span class="lineNum">     518 </span>                :<span class="lineCov">        484 :            wss.nKeys, wss.nCKeys, wss.nKeyMeta, wss.nKeys + wss.nCKeys, wss.m_unknown_records);</span>
<span class="lineNum">     519 </span>                :            : 
<span class="lineNum">     520 </span>                :            :     // nTimeFirstKey is only reliable if all keys have metadata
<span class="lineNum">     521 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 482 times"> + </span>]:<span class="lineCov">        484 :     if ((wss.nKeys + wss.nCKeys + wss.nWatchKeys) != wss.nKeyMeta)</span>
<span class="lineNum">     522 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :         pwallet-&gt;UpdateTimeFirstKey(1);</span>
<span class="lineNum">     523 </span>                :            : 
<span class="lineNum">     524 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 484 times"> + </span>]:<span class="lineCov">        484 :     for (const uint256&amp; hash : wss.vWalletUpgrade)</span>
<span class="lineNum">     525 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         WriteTx(pwallet-&gt;mapWallet.at(hash));</span>
<span class="lineNum">     526 </span>                :            : 
<span class="lineNum">     527 </span>                :            :     // Rewrite encrypted wallets of versions 0.4.0 and 0.5.0rc:
<span class="lineNum">     528 </span>[<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 479 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        484 :     if (wss.fIsEncrypted &amp;&amp; (wss.nFileVersion == 40000 || wss.nFileVersion == 50000))</span>
<span class="lineNum">     529 </span>                :            :         return DBErrors::NEED_REWRITE;
<span class="lineNum">     530 </span>                :            : 
<span class="lineNum">     531 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 484 times"> + </span>]:<span class="lineCov">        484 :     if (wss.nFileVersion &lt; CLIENT_VERSION) // Update</span>
<span class="lineNum">     532 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         WriteVersion(CLIENT_VERSION);</span>
<span class="lineNum">     533 </span>                :            : 
<span class="lineNum">     534 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 484 times"> + </span>]:<span class="lineCov">        484 :     if (wss.fAnyUnordered)</span>
<span class="lineNum">     535 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         result = pwallet-&gt;ReorderTransactions();</span>
<span class="lineNum">     536 </span>                :            : 
<span class="lineNum">     537 </span>                :            :     // Upgrade all of the wallet keymetadata to have the hd master key id
<span class="lineNum">     538 </span>                :            :     // This operation is not atomic, but if it fails, updated entries are still backwards compatible with older software
<span class="lineNum">     539 </span>                :            :     try {
<span class="lineNum">     540 </span>        [<span class="branchCov" title="Branch 1 was taken 484 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        484 :         pwallet-&gt;UpgradeKeyMetadata();</span>
<span class="lineNum">     541 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } catch (...) {</span>
<span class="lineNum">     542 </span>                :<span class="lineNoCov">          0 :         result = DBErrors::CORRUPT;</span>
<span class="lineNum">     543 </span>                :            :     }
<span class="lineNum">     544 </span>                :            : 
<span class="lineNum">     545 </span>                :            :     return result;
<span class="lineNum">     546 </span>                :            : }
<span class="lineNum">     547 </span>                :            : 
<span class="lineNum">     548 </span>                :<span class="lineCov">         11 : DBErrors WalletBatch::FindWalletTx(std::vector&lt;uint256&gt;&amp; vTxHash, std::vector&lt;CWalletTx&gt;&amp; vWtx)</span>
<span class="lineNum">     549 </span>                :            : {
<span class="lineNum">     550 </span>                :<span class="lineCov">         11 :     DBErrors result = DBErrors::LOAD_OK;</span>
<span class="lineNum">     551 </span>                :            : 
<span class="lineNum">     552 </span>                :            :     try {
<span class="lineNum">     553 </span>                :<span class="lineCov">         11 :         int nMinVersion = 0;</span>
<span class="lineNum">     554 </span>[<span class="branchCov" title="Branch 1 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         22 :         if (m_batch.Read((std::string)&quot;minversion&quot;, nMinVersion))</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">     555 </span>                :            :         {
<span class="lineNum">     556 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         11 :             if (nMinVersion &gt; FEATURE_LATEST)</span>
<span class="lineNum">     557 </span>                :<span class="lineCov">         11 :                 return DBErrors::TOO_NEW;</span>
<span class="lineNum">     558 </span>                :            :         }
<span class="lineNum">     559 </span>                :            : 
<span class="lineNum">     560 </span>                :            :         // Get cursor
<span class="lineNum">     561 </span>                :<span class="lineNoCov">          0 :         Dbc* pcursor = m_batch.GetCursor();</span>
<span class="lineNum">     562 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>]:<span class="lineCov">         11 :         if (!pcursor)</span>
<span class="lineNum">     563 </span>                :            :         {
<span class="lineNum">     564 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             LogPrintf(&quot;Error getting wallet database cursor\n&quot;);</span>
<span class="lineNum">     565 </span>                :            :             return DBErrors::CORRUPT;
<span class="lineNum">     566 </span>                :            :         }
<span class="lineNum">     567 </span>                :            : 
<span class="lineNum">     568 </span>                :            :         while (true)
<span class="lineNum">     569 </span>                :            :         {
<span class="lineNum">     570 </span>                :            :             // Read next record
<span class="lineNum">     571 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineCov">       1178 :             CDataStream ssKey(SER_DISK, CLIENT_VERSION);</span>
<span class="lineNum">     572 </span>                :<span class="lineNoCov">          0 :             CDataStream ssValue(SER_DISK, CLIENT_VERSION);</span>
<span class="lineNum">     573 </span>        [<span class="branchCov" title="Branch 1 was taken 1189 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1189 :             int ret = m_batch.ReadAtCursor(pcursor, ssKey, ssValue);</span>
<span class="lineNum">     574 </span>        [<span class="branchCov" title="Branch 0 was taken 1178 times"> + </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>]:<span class="lineCov">       1189 :             if (ret == DB_NOTFOUND)</span>
<span class="lineNum">     575 </span>                :            :                 break;
<span class="lineNum">     576 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1178 times"> + </span>]:<span class="lineCov">       1178 :             else if (ret != 0)</span>
<span class="lineNum">     577 </span>                :            :             {
<span class="lineNum">     578 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 LogPrintf(&quot;Error reading next record from wallet database\n&quot;);</span>
<span class="lineNum">     579 </span>                :<span class="lineNoCov">          0 :                 return DBErrors::CORRUPT;</span>
<span class="lineNum">     580 </span>                :            :             }
<span class="lineNum">     581 </span>                :            : 
<span class="lineNum">     582 </span>                :<span class="lineNoCov">          0 :             std::string strType;</span>
<span class="lineNum">     583 </span>                :<span class="lineCov">       1178 :             ssKey &gt;&gt; strType;</span>
<span class="lineNum">     584 </span>        [<span class="branchCov" title="Branch 0 was taken 517 times"> + </span><span class="branchCov" title="Branch 1 was taken 661 times"> + </span>]:<span class="lineCov">       1178 :             if (strType == &quot;tx&quot;) {</span>
<span class="lineNum">     585 </span>                :<span class="lineCov">        517 :                 uint256 hash;</span>
<span class="lineNum">     586 </span>                :<span class="lineCov">        517 :                 ssKey &gt;&gt; hash;</span>
<span class="lineNum">     587 </span>                :            : 
<span class="lineNum">     588 </span>                :<span class="lineCov">       1034 :                 CWalletTx wtx(nullptr /* pwallet */, MakeTransactionRef());</span>
<span class="lineNum">     589 </span>                :<span class="lineCov">        517 :                 ssValue &gt;&gt; wtx;</span>
<span class="lineNum">     590 </span>                :            : 
<span class="lineNum">     591 </span>        [<span class="branchCov" title="Branch 1 was taken 517 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        517 :                 vTxHash.push_back(hash);</span>
<span class="lineNum">     592 </span>        [<span class="branchCov" title="Branch 1 was taken 517 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        517 :                 vWtx.push_back(wtx);</span>
<span class="lineNum">     593 </span>                :            :             }
<span class="lineNum">     594 </span>                :            :         }
<span class="lineNum">     595 </span>        [<span class="branchCov" title="Branch 1 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         11 :         pcursor-&gt;close();</span>
<span class="lineNum">     596 </span>                :            :     }
<span class="lineNum">     597 </span>                :<span class="lineNoCov">          0 :     catch (const boost::thread_interrupted&amp;) {</span>
<span class="lineNum">     598 </span>                :<span class="lineNoCov">          0 :         throw;</span>
<span class="lineNum">     599 </span>                :            :     }
<span class="lineNum">     600 </span>                :<span class="lineNoCov">          0 :     catch (...) {</span>
<span class="lineNum">     601 </span>                :<span class="lineNoCov">          0 :         result = DBErrors::CORRUPT;</span>
<span class="lineNum">     602 </span>                :            :     }
<span class="lineNum">     603 </span>                :            : 
<span class="lineNum">     604 </span>                :            :     return result;
<span class="lineNum">     605 </span>                :            : }
<span class="lineNum">     606 </span>                :            : 
<span class="lineNum">     607 </span>                :<span class="lineCov">          3 : DBErrors WalletBatch::ZapSelectTx(std::vector&lt;uint256&gt;&amp; vTxHashIn, std::vector&lt;uint256&gt;&amp; vTxHashOut)</span>
<span class="lineNum">     608 </span>                :            : {
<span class="lineNum">     609 </span>                :            :     // build list of wallet TXs and hashes
<span class="lineNum">     610 </span>                :<span class="lineCov">          3 :     std::vector&lt;uint256&gt; vTxHash;</span>
<span class="lineNum">     611 </span>                :<span class="lineCov">          3 :     std::vector&lt;CWalletTx&gt; vWtx;</span>
<span class="lineNum">     612 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :     DBErrors err = FindWalletTx(vTxHash, vWtx);</span>
<span class="lineNum">     613 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :     if (err != DBErrors::LOAD_OK) {</span>
<span class="lineNum">     614 </span>                :            :         return err;
<span class="lineNum">     615 </span>                :            :     }
<span class="lineNum">     616 </span>                :            : 
<span class="lineNum">     617 </span>                :<span class="lineCov">          9 :     std::sort(vTxHash.begin(), vTxHash.end());</span>
<span class="lineNum">     618 </span>                :<span class="lineCov">          6 :     std::sort(vTxHashIn.begin(), vTxHashIn.end());</span>
<span class="lineNum">     619 </span>                :            : 
<span class="lineNum">     620 </span>                :            :     // erase each matching wallet TX
<span class="lineNum">     621 </span>                :<span class="lineCov">          3 :     bool delerror = false;</span>
<span class="lineNum">     622 </span>                :<span class="lineCov">          3 :     std::vector&lt;uint256&gt;::iterator it = vTxHashIn.begin();</span>
<span class="lineNum">     623 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          7 :     for (const uint256&amp; hash : vTxHash) {</span>
<span class="lineNum">     624 </span>[<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 4 times"> + </span>]:<span class="lineCov">          6 :         while (it &lt; vTxHashIn.end() &amp;&amp; (*it) &lt; hash) {</span>
<span class="lineNum">     625 </span>                :            :             it++;
<span class="lineNum">     626 </span>                :            :         }
<span class="lineNum">     627 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          5 :         if (it == vTxHashIn.end()) {</span>
<span class="lineNum">     628 </span>                :            :             break;
<span class="lineNum">     629 </span>                :            :         }
<span class="lineNum">     630 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          4 :         else if ((*it) == hash) {</span>
<span class="lineNum">     631 </span>[<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 2 times"> + </span>]:<span class="lineCov">          2 :             if(!EraseTx(hash)) {</span>
<span class="lineNum">     632 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 LogPrint(BCLog::DB, &quot;Transaction was found for deletion but returned database error: %s\n&quot;, hash.GetHex());</span>
<span class="lineNum">     633 </span>                :<span class="lineNoCov">          0 :                 delerror = true;</span>
<span class="lineNum">     634 </span>                :            :             }
<span class="lineNum">     635 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :             vTxHashOut.push_back(hash);</span>
<span class="lineNum">     636 </span>                :            :         }
<span class="lineNum">     637 </span>                :            :     }
<span class="lineNum">     638 </span>                :            : 
<span class="lineNum">     639 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :     if (delerror) {</span>
<span class="lineNum">     640 </span>                :            :         return DBErrors::CORRUPT;
<span class="lineNum">     641 </span>                :            :     }
<span class="lineNum">     642 </span>                :<span class="lineCov">          3 :     return DBErrors::LOAD_OK;</span>
<span class="lineNum">     643 </span>                :            : }
<span class="lineNum">     644 </span>                :            : 
<span class="lineNum">     645 </span>                :<span class="lineCov">          8 : DBErrors WalletBatch::ZapWalletTx(std::vector&lt;CWalletTx&gt;&amp; vWtx)</span>
<span class="lineNum">     646 </span>                :            : {
<span class="lineNum">     647 </span>                :            :     // build list of wallet TXs
<span class="lineNum">     648 </span>                :<span class="lineCov">          8 :     std::vector&lt;uint256&gt; vTxHash;</span>
<span class="lineNum">     649 </span>        [<span class="branchCov" title="Branch 1 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          8 :     DBErrors err = FindWalletTx(vTxHash, vWtx);</span>
<span class="lineNum">     650 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          8 :     if (err != DBErrors::LOAD_OK)</span>
<span class="lineNum">     651 </span>                :            :         return err;
<span class="lineNum">     652 </span>                :            : 
<span class="lineNum">     653 </span>                :            :     // erase each wallet TX
<span class="lineNum">     654 </span>        [<span class="branchCov" title="Branch 0 was taken 512 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">        520 :     for (const uint256&amp; hash : vTxHash) {</span>
<span class="lineNum">     655 </span>[<span class="branchCov" title="Branch 1 was taken 512 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 512 times"> + </span>]:<span class="lineCov">        512 :         if (!EraseTx(hash))</span>
<span class="lineNum">     656 </span>                :<span class="lineNoCov">          0 :             return DBErrors::CORRUPT;</span>
<span class="lineNum">     657 </span>                :            :     }
<span class="lineNum">     658 </span>                :            : 
<span class="lineNum">     659 </span>                :<span class="lineCov">          8 :     return DBErrors::LOAD_OK;</span>
<span class="lineNum">     660 </span>                :            : }
<span class="lineNum">     661 </span>                :            : 
<span class="lineNum">     662 </span>                :<span class="lineCov">       7898 : void MaybeCompactWalletDB()</span>
<span class="lineNum">     663 </span>                :            : {
<span class="lineNum">     664 </span>                :            :     static std::atomic&lt;bool&gt; fOneThread(false);
<span class="lineNum">     665 </span>        [<span class="branchCov" title="Branch 0 was taken 7898 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       7898 :     if (fOneThread.exchange(true)) {</span>
<span class="lineNum">     666 </span>                :            :         return;
<span class="lineNum">     667 </span>                :            :     }
<span class="lineNum">     668 </span>[<span class="branchCov" title="Branch 1 was taken 7898 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 7898 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">      15796 :     if (!gArgs.GetBoolArg(&quot;-flushwallet&quot;, DEFAULT_FLUSHWALLET)) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 7898 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">     669 </span>                :            :         return;
<span class="lineNum">     670 </span>                :            :     }
<span class="lineNum">     671 </span>                :            : 
<span class="lineNum">     672 </span>        [<span class="branchCov" title="Branch 1 was taken 8073 times"> + </span><span class="branchCov" title="Branch 2 was taken 7898 times"> + </span>]:<span class="lineCov">      15971 :     for (const std::shared_ptr&lt;CWallet&gt;&amp; pwallet : GetWallets()) {</span>
<span class="lineNum">     673 </span>                :<span class="lineCov">      16146 :         WalletDatabase&amp; dbh = pwallet-&gt;GetDBHandle();</span>
<span class="lineNum">     674 </span>                :            : 
<span class="lineNum">     675 </span>                :<span class="lineCov">      16146 :         unsigned int nUpdateCounter = dbh.nUpdateCounter;</span>
<span class="lineNum">     676 </span>                :            : 
<span class="lineNum">     677 </span>        [<span class="branchCov" title="Branch 0 was taken 1397 times"> + </span><span class="branchCov" title="Branch 1 was taken 6676 times"> + </span>]:<span class="lineCov">       8073 :         if (dbh.nLastSeen != nUpdateCounter) {</span>
<span class="lineNum">     678 </span>                :<span class="lineCov">       1397 :             dbh.nLastSeen = nUpdateCounter;</span>
<span class="lineNum">     679 </span>        [<span class="branchCov" title="Branch 1 was taken 1397 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1397 :             dbh.nLastWalletUpdate = GetTime();</span>
<span class="lineNum">     680 </span>                :            :         }
<span class="lineNum">     681 </span>                :            : 
<span class="lineNum">     682 </span>[<span class="branchCov" title="Branch 0 was taken 3142 times"> + </span><span class="branchCov" title="Branch 1 was taken 4931 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 3142 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       8073 :         if (dbh.nLastFlushed != nUpdateCounter &amp;&amp; GetTime() - dbh.nLastWalletUpdate &gt;= 2) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken 350 times"> + </span><span class="branchCov" title="Branch 6 was taken 2792 times"> + </span>]
<span class="lineNum">     683 </span>[<span class="branchCov" title="Branch 1 was taken 350 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 350 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        350 :             if (BerkeleyBatch::PeriodicFlush(dbh)) {</span>
<span class="lineNum">     684 </span>                :<span class="lineCov">        350 :                 dbh.nLastFlushed = nUpdateCounter;</span>
<span class="lineNum">     685 </span>                :            :             }
<span class="lineNum">     686 </span>                :            :         }
<span class="lineNum">     687 </span>                :            :     }
<span class="lineNum">     688 </span>                :            : 
<span class="lineNum">     689 </span>                :            :     fOneThread = false;
<span class="lineNum">     690 </span>                :            : }
<span class="lineNum">     691 </span>                :            : 
<span class="lineNum">     692 </span>                :            : //
<a name="693"><span class="lineNum">     693 </span>                :            : // Try to (very carefully!) recover wallet file if there is a problem.</a>
<span class="lineNum">     694 </span>                :            : //
<span class="lineNum">     695 </span>                :<span class="lineNoCov">          0 : bool WalletBatch::Recover(const fs::path&amp; wallet_path, void *callbackDataIn, bool (*recoverKVcallback)(void* callbackData, CDataStream ssKey, CDataStream ssValue), std::string&amp; out_backup_filename)</span>
<span class="lineNum">     696 </span>                :            : {
<span class="lineNum">     697 </span>                :<span class="lineNoCov">          0 :     return BerkeleyBatch::Recover(wallet_path, callbackDataIn, recoverKVcallback, out_backup_filename);</span>
<a name="698"><span class="lineNum">     698 </span>                :            : }</a>
<span class="lineNum">     699 </span>                :            : 
<span class="lineNum">     700 </span>                :<span class="lineNoCov">          0 : bool WalletBatch::Recover(const fs::path&amp; wallet_path, std::string&amp; out_backup_filename)</span>
<span class="lineNum">     701 </span>                :            : {
<span class="lineNum">     702 </span>                :            :     // recover without a key filter callback
<span class="lineNum">     703 </span>                :            :     // results in recovering all record types
<span class="lineNum">     704 </span>                :<span class="lineNoCov">          0 :     return WalletBatch::Recover(wallet_path, nullptr, nullptr, out_backup_filename);</span>
<span class="lineNum">     705 </span>                :            : }
<span class="lineNum">     706 </span>                :            : 
<span class="lineNum">     707 </span>                :<span class="lineNoCov">          0 : bool WalletBatch::RecoverKeysOnlyFilter(void *callbackData, CDataStream ssKey, CDataStream ssValue)</span>
<span class="lineNum">     708 </span>                :            : {
<span class="lineNum">     709 </span>                :<span class="lineNoCov">          0 :     CWallet *dummyWallet = reinterpret_cast&lt;CWallet*&gt;(callbackData);</span>
<span class="lineNum">     710 </span>                :<span class="lineNoCov">          0 :     CWalletScanState dummyWss;</span>
<span class="lineNum">     711 </span>                :<span class="lineNoCov">          0 :     std::string strType, strErr;</span>
<span class="lineNum">     712 </span>                :            :     bool fReadOK;
<span class="lineNum">     713 </span>                :            :     {
<span class="lineNum">     714 </span>                :            :         // Required in LoadKeyMetadata():
<span class="lineNum">     715 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LOCK(dummyWallet-&gt;cs_wallet);</span>
<span class="lineNum">     716 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         fReadOK = ReadKeyValue(dummyWallet, ssKey, ssValue,</span>
<span class="lineNum">     717 </span>                :            :                                dummyWss, strType, strErr);
<span class="lineNum">     718 </span>                :            :     }
<span class="lineNum">     719 </span>  [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!IsKeyType(strType) &amp;&amp; strType != &quot;hdchain&quot;)</span>
<span class="lineNum">     720 </span>                :            :         return false;
<span class="lineNum">     721 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!fReadOK)</span>
<span class="lineNum">     722 </span>                :            :     {
<span class="lineNum">     723 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LogPrintf(&quot;WARNING: WalletBatch::Recover skipping %s: %s\n&quot;, strType, strErr);</span>
<span class="lineNum">     724 </span>                :            :         return false;
<span class="lineNum">     725 </span>                :            :     }
<span class="lineNum">     726 </span>                :            : 
<span class="lineNum">     727 </span>                :            :     return true;
<a name="728"><span class="lineNum">     728 </span>                :            : }</a>
<span class="lineNum">     729 </span>                :            : 
<span class="lineNum">     730 </span>                :<span class="lineCov">        497 : bool WalletBatch::VerifyEnvironment(const fs::path&amp; wallet_path, std::string&amp; errorStr)</span>
<span class="lineNum">     731 </span>                :            : {
<span class="lineNum">     732 </span>                :<span class="lineCov">        497 :     return BerkeleyBatch::VerifyEnvironment(wallet_path, errorStr);</span>
<a name="733"><span class="lineNum">     733 </span>                :            : }</a>
<span class="lineNum">     734 </span>                :            : 
<span class="lineNum">     735 </span>                :<span class="lineCov">        487 : bool WalletBatch::VerifyDatabaseFile(const fs::path&amp; wallet_path, std::string&amp; warningStr, std::string&amp; errorStr)</span>
<span class="lineNum">     736 </span>                :            : {
<span class="lineNum">     737 </span>                :<span class="lineCov">        487 :     return BerkeleyBatch::VerifyDatabaseFile(wallet_path, warningStr, errorStr, WalletBatch::Recover);</span>
<a name="738"><span class="lineNum">     738 </span>                :            : }</a>
<span class="lineNum">     739 </span>                :            : 
<span class="lineNum">     740 </span>                :<span class="lineCov">          3 : bool WalletBatch::WriteDestData(const std::string &amp;address, const std::string &amp;key, const std::string &amp;value)</span>
<span class="lineNum">     741 </span>                :            : {
<span class="lineNum">     742 </span>  [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          9 :     return WriteIC(std::make_pair(std::string(&quot;destdata&quot;), std::make_pair(address, key)), value);</span>
<a name="743"><span class="lineNum">     743 </span>                :            : }</a>
<span class="lineNum">     744 </span>                :            : 
<span class="lineNum">     745 </span>                :<span class="lineNoCov">          0 : bool WalletBatch::EraseDestData(const std::string &amp;address, const std::string &amp;key)</span>
<span class="lineNum">     746 </span>                :            : {
<span class="lineNum">     747 </span>  [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return EraseIC(std::make_pair(std::string(&quot;destdata&quot;), std::make_pair(address, key)));</span>
<span class="lineNum">     748 </span>                :            : }
<a name="749"><span class="lineNum">     749 </span>                :            : </a>
<span class="lineNum">     750 </span>                :            : 
<span class="lineNum">     751 </span>                :<span class="lineCov">       8455 : bool WalletBatch::WriteHDChain(const CHDChain&amp; chain)</span>
<span class="lineNum">     752 </span>                :            : {
<span class="lineNum">     753 </span>[<span class="branchCov" title="Branch 1 was taken 8455 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 8455 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">      16910 :     return WriteIC(std::string(&quot;hdchain&quot;), chain);</span>
<a name="754"><span class="lineNum">     754 </span>                :            : }</a>
<span class="lineNum">     755 </span>                :            : 
<span class="lineNum">     756 </span>                :<span class="lineCov">       3709 : bool WalletBatch::WriteWalletFlags(const uint64_t flags)</span>
<span class="lineNum">     757 </span>                :            : {
<span class="lineNum">     758 </span>[<span class="branchCov" title="Branch 1 was taken 3709 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 3709 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">       7418 :     return WriteIC(std::string(&quot;flags&quot;), flags);</span>
<a name="759"><span class="lineNum">     759 </span>                :            : }</a>
<span class="lineNum">     760 </span>                :            : 
<span class="lineNum">     761 </span>                :<span class="lineCov">         12 : bool WalletBatch::TxnBegin()</span>
<span class="lineNum">     762 </span>                :            : {
<span class="lineNum">     763 </span>                :<span class="lineCov">         12 :     return m_batch.TxnBegin();</span>
<a name="764"><span class="lineNum">     764 </span>                :            : }</a>
<span class="lineNum">     765 </span>                :            : 
<span class="lineNum">     766 </span>                :<span class="lineCov">         12 : bool WalletBatch::TxnCommit()</span>
<span class="lineNum">     767 </span>                :            : {
<span class="lineNum">     768 </span>                :<span class="lineCov">         12 :     return m_batch.TxnCommit();</span>
<a name="769"><span class="lineNum">     769 </span>                :            : }</a>
<span class="lineNum">     770 </span>                :            : 
<span class="lineNum">     771 </span>                :<span class="lineNoCov">          0 : bool WalletBatch::TxnAbort()</span>
<span class="lineNum">     772 </span>                :            : {
<span class="lineNum">     773 </span>                :<span class="lineNoCov">          0 :     return m_batch.TxnAbort();</span>
<a name="774"><span class="lineNum">     774 </span>                :            : }</a>
<span class="lineNum">     775 </span>                :            : 
<span class="lineNum">     776 </span>                :<span class="lineNoCov">          0 : bool WalletBatch::ReadVersion(int&amp; nVersion)</span>
<span class="lineNum">     777 </span>                :            : {
<span class="lineNum">     778 </span>                :<span class="lineNoCov">          0 :     return m_batch.ReadVersion(nVersion);</span>
<a name="779"><span class="lineNum">     779 </span>                :            : }</a>
<span class="lineNum">     780 </span>                :            : 
<span class="lineNum">     781 </span>                :<span class="lineNoCov">          0 : bool WalletBatch::WriteVersion(int nVersion)</span>
<a name="782"><span class="lineNum">     782 </span>                :            : {</a>
<span class="lineNum">     783 </span>                :<span class="lineNoCov">          0 :     return m_batch.WriteVersion(nVersion);</span>
<span class="lineNum">     784 </span>[<span class="branchCov" title="Branch 1 was taken 496 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 496 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       1984 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
